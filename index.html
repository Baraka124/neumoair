<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1A5F7A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Spirolite Pro - Professional Lung Function Calculator for Transplant Clinicians">
    <title>Spirolite Pro | Lung Transplant Monitoring</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü´Å</text></svg>">
    <style>
        /* ===== CRITICAL CSS - INLINE FOR INSTANT RENDER ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            /* Clinical Color Palette */
            --primary-blue: #1A5F7A;
            --primary-teal: #2D9596;
            --clinical-green: #28A745;
            --clinical-warning: #FFC107;
            --clinical-alert: #DC3545;
            --clinical-info: #17A2B8;
            
            /* Neutral tones */
            --bg-white: #FFFFFF;
            --bg-light: #F8F9FA;
            --border-light: #E9ECEF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --text-muted: #868E96;
            
            /* Mobile-first spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 0.75rem;
            --space-lg: 1rem;
            --space-xl: 1.25rem;
            --space-2xl: 1.5rem;
            --space-3xl: 2rem;
            
            /* Font sizes */
            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;
            
            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            
            /* Safe area insets */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            background: var(--bg-light);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: var(--font-base);
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-light);
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Loading overlay */
        #app-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-teal));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        #app-loading.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-2xl);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .loading-logo::before {
            content: 'ü´Å';
            font-size: 2.5rem;
        }
        
        .loading-text {
            color: white;
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }
        
        .loading-subtext {
            color: rgba(255,255,255,0.8);
            font-size: var(--font-sm);
            text-align: center;
            max-width: 280px;
        }
        
        .progress-bar {
            margin-top: var(--space-xl);
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 30%;
            background: white;
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }
        
        /* Main app container */
        #app {
            display: none;
            height: 100%;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #app.loaded {
            display: flex;
            opacity: 1;
        }
        
        /* Safe area container */
        .safe-area {
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
        }
        
        /* ===== APP HEADER ===== */
        .app-header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: var(--space-sm) var(--space-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-md);
        }
        
        .nav-toggle {
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: var(--space-sm);
        }
        
        .nav-toggle span {
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            flex: 1;
        }
        
        .app-logo {
            font-size: 1.5rem;
            background: var(--primary-blue);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-title h1 {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .pro-badge {
            background: var(--clinical-info);
            color: white;
            font-size: var(--font-xs);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            margin-left: 4px;
            vertical-align: middle;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        .icon-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .icon-btn:active {
            background: var(--border-light);
            transform: translateY(1px);
        }
        
        /* ===== PATIENT STATUS BAR ===== */
        .patient-status-bar {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) 0;
            margin-top: var(--space-sm);
            border-top: 1px solid var(--border-light);
            cursor: pointer;
        }
        
        .patient-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-teal);
            color: white;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--font-sm);
        }
        
        .patient-info {
            flex: 1;
        }
        
        .patient-name {
            font-weight: 600;
            font-size: var(--font-base);
            color: var(--text-primary);
        }
        
        .patient-meta {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: var(--font-sm);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            background: var(--bg-light);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-indicator.good .status-dot { background: var(--clinical-green); }
        .status-indicator.warning .status-dot { background: var(--clinical-warning); }
        .status-indicator.alert .status-dot { background: var(--clinical-alert); }
        .status-indicator.neutral .status-dot { background: var(--text-muted); }
        
        /* ===== MODE TABS ===== */
        .mode-tabs {
            display: flex;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 130px;
            z-index: 900;
        }
        
        .mode-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: var(--space-md) var(--space-sm);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: var(--font-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mode-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            font-weight: 600;
        }
        
        .tab-icon {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }
        
        /* ===== MAIN CONTENT ===== */
        .app-main {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .container {
            padding: var(--space-lg);
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            overflow: hidden;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
        }
        
        .card-header h2 {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        .small-btn {
            padding: 4px 8px;
            background: var(--bg-light);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .small-btn:active {
            background: var(--border-light);
        }
        
        /* ===== INPUT STYLES ===== */
        .input-stack {
            padding: var(--space-lg);
        }
        
        .input-group {
            margin-bottom: var(--space-xl);
        }
        
        .input-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .input-hint {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            font-weight: normal;
        }
        
        .info-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--clinical-info);
            color: white;
            border: none;
            font-size: var(--font-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
        }
        
        .measurement-input {
            display: flex;
            align-items: center;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: border-color 0.2s ease;
        }
        
        .measurement-input:focus-within {
            border-color: var(--primary-blue);
        }
        
        .measurement-input input {
            flex: 1;
            padding: var(--space-md);
            border: none;
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--text-primary);
            background: none;
            min-width: 0;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .measurement-input input:focus {
            outline: none;
        }
        
        .measurement-input input::-webkit-inner-spin-button,
        .measurement-input input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .measurement-input .unit {
            padding: var(--space-md);
            background: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .input-help {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-row {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-lg);
            border-top: 1px solid var(--border-light);
        }
        
        .action-btn {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-base);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }
        
        .action-btn.primary {
            background: var(--primary-blue);
            color: white;
        }
        
        .action-btn.primary:active {
            background: var(--primary-teal);
            transform: translateY(1px);
        }
        
        .action-btn.secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }
        
        .action-btn.secondary:active {
            background: var(--border-light);
        }
        
        /* ===== RESULTS STYLES ===== */
        .results-card .card-header {
            background: var(--bg-light);
        }
        
        .timestamp {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }
        
        .critical-results {
            padding: var(--space-xl);
        }
        
        .result-item {
            margin-bottom: var(--space-xl);
        }
        
        .result-item.primary {
            text-align: center;
        }
        
        .result-label {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
        }
        
        .result-value .value {
            line-height: 1;
        }
        
        .result-value .unit {
            font-size: var(--font-lg);
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .result-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: var(--font-sm);
            font-weight: 600;
            margin-top: var(--space-md);
        }
        
        .result-status.good {
            background: rgba(40, 167, 69, 0.1);
            color: var(--clinical-green);
        }
        
        .result-status.warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--clinical-warning);
        }
        
        .result-status.alert {
            background: rgba(220, 53, 69, 0.1);
            color: var(--clinical-alert);
        }
        
        .result-status.neutral {
            background: rgba(108, 117, 125, 0.1);
            color: var(--text-secondary);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-lg);
            margin-top: var(--space-xl);
        }
        
        .result-grid .result-item {
            text-align: center;
            margin: 0;
        }
        
        .result-grid .result-value {
            font-size: 1.75rem;
            justify-content: center;
        }
        
        /* ===== PROTOCOL STYLES ===== */
        .protocol-context {
            padding: var(--space-lg);
            background: var(--bg-light);
            border-top: 1px solid var(--border-light);
        }
        
        .protocol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .protocol-header h3 {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .thresholds {
            display: flex;
            gap: var(--space-sm);
        }
        
        .threshold-badge {
            font-size: var(--font-xs);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }
        
        .threshold-badge.monitor {
            background: rgba(255, 193, 7, 0.1);
            color: var(--clinical-warning);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .threshold-badge.review {
            background: rgba(220, 53, 69, 0.1);
            color: var(--clinical-alert);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .protocol-note {
            font-size: var(--font-sm);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        /* ===== HISTORY STYLES ===== */
        .history-list {
            padding: var(--space-lg);
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-time {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }
        
        .history-values {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 600;
        }
        
        .history-values span:first-child {
            color: var(--text-primary);
        }
        
        .history-values span:last-child {
            color: var(--primary-blue);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-3xl) var(--space-lg);
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
            opacity: 0.5;
        }
        
        /* ===== MONITOR STYLES ===== */
        .patient-summary-card .summary-content {
            padding: var(--space-lg);
        }
        
        .summary-item {
            margin-bottom: var(--space-xl);
        }
        
        .summary-item.highlight {
            background: rgba(26, 95, 122, 0.05);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-blue);
        }
        
        .summary-label {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .summary-meta {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-lg);
        }
        
        .monitor-tabs {
            display: flex;
            background: var(--bg-white);
            border-radius: var(--radius-md);
            padding: 4px;
            margin-bottom: var(--space-lg);
            border: 1px solid var(--border-light);
        }
        
        .monitor-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: var(--space-md) var(--space-sm);
            background: none;
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
        }
        
        .monitor-tab.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .monitor-tab .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--clinical-alert);
            color: white;
            font-size: var(--font-xs);
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        .monitor-content {
            display: none;
        }
        
        .monitor-content.active {
            display: block;
        }
        
        /* ===== VISITS LIST ===== */
        .visits-list {
            padding: var(--space-lg) 0;
        }
        
        .visit-item {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }
        
        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .visit-date {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .visit-days {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }
        
        .visit-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .visit-metric {
            text-align: center;
        }
        
        .visit-metric-label {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .visit-metric-value {
            font-weight: 600;
            font-size: var(--font-lg);
            color: var(--text-primary);
        }
        
        .visit-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }
        
        /* ===== FAB ===== */
        .fab {
            position: fixed;
            bottom: calc(70px + var(--safe-bottom));
            right: var(--space-lg);
            width: 56px;
            height: 56px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 28px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: all 0.2s ease;
        }
        
        .fab:active {
            background: var(--primary-teal);
            transform: scale(0.95);
        }
        
        /* ===== CHART STYLES ===== */
        .chart-card {
            margin-bottom: var(--space-lg);
        }
        
        .chart-container {
            height: 250px;
            padding: var(--space-lg);
        }
        
        .chart-summary {
            display: flex;
            justify-content: space-around;
            padding: var(--space-lg);
            border-top: 1px solid var(--border-light);
            background: var(--bg-light);
        }
        
        .chart-summary .summary-item {
            text-align: center;
            margin: 0;
        }
        
        /* ===== ALERTS STYLES ===== */
        .alerts-card {
            margin-bottom: var(--space-lg);
        }
        
        .alert-item {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-md);
            align-items: flex-start;
        }
        
        .alert-item:last-child {
            border-bottom: none;
        }
        
        .alert-icon {
            font-size: 1.25rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .alert-item.warning .alert-icon {
            background: rgba(255, 193, 7, 0.1);
            color: var(--clinical-warning);
        }
        
        .alert-item.alert .alert-icon {
            background: rgba(220, 53, 69, 0.1);
            color: var(--clinical-alert);
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .alert-message {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .alert-time {
            font-size: var(--font-xs);
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* ===== INSIGHTS STYLES ===== */
        .insights-content {
            padding: var(--space-lg);
        }
        
        .insight-item {
            display: flex;
            gap: var(--space-lg);
            padding: var(--space-lg) 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-icon {
            font-size: 2rem;
            width: 48px;
            height: 48px;
            background: rgba(26, 95, 122, 0.1);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            flex-shrink: 0;
        }
        
        .insight-text h3 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .insight-text p {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .export-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            padding: var(--space-lg);
        }
        
        .export-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-lg) var(--space-sm);
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .export-btn:active {
            background: var(--border-light);
            transform: translateY(2px);
        }
        
        .export-icon {
            font-size: 1.5rem;
        }
        
        .export-label {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* ===== APP FOOTER ===== */
        .app-footer {
            background: var(--bg-white);
            border-top: 1px solid var(--border-light);
            padding: var(--space-sm) var(--space-lg);
            position: sticky;
            bottom: 0;
            z-index: 1000;
        }
        
        .quick-actions {
            display: flex;
            justify-content: space-around;
            gap: var(--space-md);
        }
        
        .quick-action {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-action:active {
            background: var(--bg-light);
        }
        
        .action-icon {
            font-size: 1.5rem;
        }
        
        .action-label {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        /* ===== OFFLINE INDICATOR ===== */
        .offline-indicator {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: var(--clinical-warning);
            color: white;
            text-align: center;
            padding: var(--space-sm);
            font-size: var(--font-sm);
            font-weight: 600;
            z-index: 999;
            display: none;
        }
        
        /* ===== MODAL STYLES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 2000;
            padding: var(--safe-top) var(--safe-left) var(--safe-bottom) var(--safe-right);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            background: var(--bg-white);
            z-index: 1;
        }
        
        .modal-header h2 {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--radius-full);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .modal-body {
            padding: var(--space-lg);
        }
        
        .modal-footer {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-md);
        }
        
        /* ===== TOAST STYLES ===== */
        .toast-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            z-index: 9999;
            pointer-events: none;
        }
        
        .toast {
            background: var(--text-primary);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 500;
            max-width: 300px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .toast.fade-out {
            opacity: 0;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast.success { background: var(--clinical-green); }
        .toast.error { background: var(--clinical-alert); }
        .toast.warning { background: var(--clinical-warning); }
        .toast.info { background: var(--clinical-info); }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-1 { margin-top: var(--space-sm); }
        .mt-2 { margin-top: var(--space-md); }
        .mt-3 { margin-top: var(--space-lg); }
        .mt-4 { margin-top: var(--space-xl); }
        
        .mb-1 { margin-bottom: var(--space-sm); }
        .mb-2 { margin-bottom: var(--space-md); }
        .mb-3 { margin-bottom: var(--space-lg); }
        .mb-4 { margin-bottom: var(--space-xl); }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 360px) {
            .result-value {
                font-size: 2.5rem;
            }
            
            .result-grid .result-value {
                font-size: 1.5rem;
            }
            
            .export-actions {
                grid-template-columns: 1fr;
            }
            
            .summary-value {
                font-size: 1.75rem;
            }
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            .app-header,
            .app-footer,
            .mode-tabs,
            .fab,
            .offline-indicator {
                display: none !important;
            }
            
            .app-main {
                overflow: visible;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="app-loading">
        <div class="loading-logo"></div>
        <div class="loading-text">Spirolite Pro</div>
        <div class="loading-subtext">Loading clinical tools...</div>
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- TOP NAVIGATION -->
        <header class="app-header safe-area">
            <div class="header-content">
                <button class="nav-toggle" aria-label="Toggle menu" id="menuToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <div class="app-title">
                    <div class="app-logo">ü´Å</div>
                    <h1>Spirolite <span class="pro-badge">Pro</span></h1>
                </div>
                
                <div class="header-actions">
                    <button class="icon-btn" id="patientSwitch" aria-label="Switch patient">
                        üë§
                    </button>
                    <button class="icon-btn" id="settingsBtn" aria-label="Settings">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
            
            <!-- Patient Status Bar -->
            <div class="patient-status-bar" id="patientStatus">
                <div class="patient-avatar">--</div>
                <div class="patient-info">
                    <div class="patient-name">Select Patient</div>
                    <div class="patient-meta">Tap to select patient</div>
                </div>
                <div class="status-indicator neutral">
                    <span class="status-dot"></span>
                    <span>No data</span>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="app-main" id="appMain">
            <!-- TABS -->
            <div class="mode-tabs safe-area">
                <button class="mode-tab active" data-mode="quick">
                    <span class="tab-icon">‚ö°</span>
                    <span class="tab-label">Quick Calc</span>
                </button>
                <button class="mode-tab" data-mode="monitor">
                    <span class="tab-icon">üìä</span>
                    <span class="tab-label">Monitor</span>
                </button>
                <button class="mode-tab" data-mode="insights">
                    <span class="tab-icon">üìà</span>
                    <span class="tab-label">Insights</span>
                </button>
            </div>

            <!-- QUICK CALC MODE -->
            <section class="mode-content active" id="modeQuick">
                <div class="container safe-area">
                    <!-- Measurement Input Card -->
                    <div class="card measurement-card">
                        <div class="card-header">
                            <h2>FEV‚ÇÅ Calculator</h2>
                            <div class="card-actions">
                                <button class="small-btn" id="swapUnits" aria-label="Swap units">
                                    üîÑ
                                </button>
                                <button class="small-btn" id="clearCalc" aria-label="Clear">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <div class="input-stack">
                            <div class="input-group">
                                <label class="input-label">
                                    <span>Current FEV‚ÇÅ</span>
                                    <span class="input-hint">Tap to enter</span>
                                </label>
                                <div class="measurement-input">
                                    <input type="number" 
                                           inputmode="decimal"
                                           placeholder="2.85"
                                           step="0.01"
                                           min="0.5"
                                           max="8.0"
                                           id="currentFev1"
                                           aria-label="Current FEV1 in liters">
                                    <span class="unit">L</span>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">
                                    <span>Baseline FEV‚ÇÅ</span>
                                    <button class="info-btn" aria-label="What is baseline?">?</button>
                                </label>
                                <div class="measurement-input">
                                    <input type="number" 
                                           inputmode="decimal"
                                           placeholder="3.00"
                                           step="0.01"
                                           min="0.5"
                                           max="8.0"
                                           id="baselineFev1"
                                           aria-label="Baseline FEV1 in liters">
                                    <span class="unit">L</span>
                                </div>
                                <div class="input-help">Post-transplant best value</div>
                            </div>
                        </div>
                        
                        <div class="action-row">
                            <button class="action-btn secondary" id="usePatientBaseline">
                                Use Patient Baseline
                            </button>
                            <button class="action-btn primary" id="calculateNow">
                                Calculate
                            </button>
                        </div>
                    </div>

                    <!-- RESULTS PANEL -->
                    <div class="card results-card hidden" id="resultsCard">
                        <div class="card-header">
                            <h2>Results</h2>
                            <div class="timestamp" id="resultsTime"></div>
                        </div>
                        
                        <div class="critical-results">
                            <div class="result-item primary">
                                <div class="result-label">% of Baseline</div>
                                <div class="result-value" id="resultPercent">
                                    <span class="value">--</span>
                                    <span class="unit">%</span>
                                </div>
                                <div class="result-status neutral" id="resultStatus">
                                    <span class="status-dot"></span>
                                    <span>No calculation</span>
                                </div>
                            </div>
                            
                            <div class="result-grid">
                                <div class="result-item">
                                    <div class="result-label">Change</div>
                                    <div class="result-value" id="resultChange">
                                        <span class="value">--</span>
                                        <span class="unit">L</span>
                                    </div>
                                </div>
                                
                                <div class="result-item">
                                    <div class="result-label">Current</div>
                                    <div class="result-value" id="resultCurrent">
                                        <span class="value">--</span>
                                        <span class="unit">L</span>
                                    </div>
                                </div>
                                
                                <div class="result-item">
                                    <div class="result-label">Baseline</div>
                                    <div class="result-value" id="resultBaseline">
                                        <span class="value">--</span>
                                        <span class="unit">L</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="protocol-context">
                            <div class="protocol-header">
                                <h3>Protocol Context</h3>
                                <div class="thresholds">
                                    <span class="threshold-badge monitor">Monitor ‚â•10%</span>
                                    <span class="threshold-badge review">Review ‚â•20%</span>
                                </div>
                            </div>
                            <p class="protocol-note" id="protocolNote">
                                Enter measurements to see protocol recommendations.
                            </p>
                        </div>
                        
                        <div class="action-row">
                            <button class="action-btn secondary" id="saveToRecord">
                                Save to Record
                            </button>
                            <button class="action-btn primary" id="newCalculation">
                                New Calculation
                            </button>
                        </div>
                    </div>

                    <!-- Recent Calculations -->
                    <div class="card history-card">
                        <div class="card-header">
                            <h2>Recent</h2>
                            <button class="small-btn" id="clearHistory">Clear</button>
                        </div>
                        <div class="history-list" id="recentCalculations">
                            <div class="empty-state">
                                No recent calculations
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MONITOR MODE -->
            <section class="mode-content" id="modeMonitor">
                <div class="container safe-area">
                    <!-- Patient Summary Card -->
                    <div class="card patient-summary-card">
                        <div class="card-header">
                            <h2>Patient Overview</h2>
                            <div class="card-actions">
                                <button class="small-btn" id="editPatient">Edit</button>
                            </div>
                        </div>
                        
                        <div class="summary-content">
                            <!-- Baseline ALWAYS VISIBLE -->
                            <div class="summary-item highlight">
                                <div class="summary-label">Baseline FEV‚ÇÅ</div>
                                <div class="summary-value" id="patientBaseline">--</div>
                                <div class="summary-meta" id="baselineDate">--</div>
                            </div>
                            
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-label">Last FEV‚ÇÅ</div>
                                    <div class="summary-value" id="lastFev1">--</div>
                                    <div class="summary-meta" id="lastDate">--</div>
                                </div>
                                
                                <div class="summary-item">
                                    <div class="summary-label">% of Baseline</div>
                                    <div class="summary-value" id="currentPercent">--</div>
                                    <div class="summary-meta" id="percentStatus">--</div>
                                </div>
                                
                                <div class="summary-item">
                                    <div class="summary-label">Total Visits</div>
                                    <div class="summary-value" id="visitCount">0</div>
                                    <div class="summary-meta">visits</div>
                                </div>
                                
                                <div class="summary-item">
                                    <div class="summary-label">Days Post-Tx</div>
                                    <div class="summary-value" id="daysPostTx">--</div>
                                    <div class="summary-meta">days</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitor Tabs -->
                    <div class="monitor-tabs">
                        <button class="monitor-tab active" data-view="visits">
                            <span class="tab-icon">üìã</span>
                            <span class="tab-label">Visits</span>
                        </button>
                        <button class="monitor-tab" data-view="trend">
                            <span class="tab-icon">üìà</span>
                            <span class="tab-label">Trend</span>
                        </button>
                        <button class="monitor-tab" data-view="alerts">
                            <span class="tab-icon">‚ö†Ô∏è</span>
                            <span class="tab-label">Alerts</span>
                            <span class="badge" id="alertCount">0</span>
                        </button>
                    </div>

                    <!-- Visits View -->
                    <div class="monitor-content active" data-view="visits">
                        <button class="fab" id="addVisitBtn" aria-label="Add new visit">
                            <span>+</span>
                        </button>
                        
                        <div class="visits-list" id="visitsList">
                            <div class="empty-state">
                                <div class="empty-icon">üìã</div>
                                <h3>No visits recorded</h3>
                                <p>Add the first visit to start monitoring</p>
                                <button class="action-btn primary" id="addFirstVisit">
                                    Add First Visit
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Trend View -->
                    <div class="monitor-content" data-view="trend">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h2>FEV‚ÇÅ Trend</h2>
                                <div class="chart-actions">
                                    <button class="small-btn" id="exportChart">Export</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                            <div class="chart-summary">
                                <div class="summary-item">
                                    <span>Overall Trend:</span>
                                    <span id="overallTrend">--</span>
                                </div>
                                <div class="summary-item">
                                    <span>Monthly Change:</span>
                                    <span id="monthlyChange">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts View -->
                    <div class="monitor-content" data-view="alerts">
                        <div class="card alerts-card">
                            <div class="card-header">
                                <h2>Clinical Alerts</h2>
                                <button class="small-btn" id="markAllRead">Mark Read</button>
                            </div>
                            <div class="alerts-list" id="alertsList">
                                <div class="empty-state">
                                    <div class="empty-icon">‚úÖ</div>
                                    <h3>No active alerts</h3>
                                    <p>All measurements within normal range</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- INSIGHTS MODE -->
            <section class="mode-content" id="modeInsights">
                <div class="container safe-area">
                    <div class="card insights-card">
                        <div class="card-header">
                            <h2>Clinical Insights</h2>
                        </div>
                        <div class="insights-content">
                            <div class="insight-item">
                                <div class="insight-icon">üìä</div>
                                <div class="insight-text">
                                    <h3>Stability Analysis</h3>
                                    <p id="stabilityAnalysis">Add more visits to analyze stability</p>
                                </div>
                            </div>
                            
                            <div class="insight-item">
                                <div class="insight-icon">üìÖ</div>
                                <div class="insight-text">
                                    <h3>Next Visit Window</h3>
                                    <p id="nextVisitWindow">Based on protocol guidelines</p>
                                </div>
                            </div>
                            
                            <div class="insight-item">
                                <div class="insight-icon">üí°</div>
                                <div class="insight-text">
                                    <h3>Recommendations</h3>
                                    <p id="clinicalRecommendations">Complete patient profile for personalized recommendations</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Tools -->
                    <div class="card export-card">
                        <div class="card-header">
                            <h2>Export Tools</h2>
                        </div>
                        <div class="export-actions">
                            <button class="export-btn" data-format="pdf">
                                <span class="export-icon">üìÑ</span>
                                <span class="export-label">PDF Report</span>
                            </button>
                            <button class="export-btn" data-format="csv">
                                <span class="export-icon">üìä</span>
                                <span class="export-label">CSV Data</span>
                            </button>
                            <button class="export-btn" data-format="print">
                                <span class="export-icon">üñ®Ô∏è</span>
                                <span class="export-label">Print</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- BOTTOM NAVIGATION -->
        <footer class="app-footer safe-area">
            <div class="quick-actions">
                <button class="quick-action" id="quickCalcBtn">
                    <span class="action-icon">üßÆ</span>
                    <span class="action-label">Calculate</span>
                </button>
                <button class="quick-action" id="addVisitQuickBtn">
                    <span class="action-icon">‚ûï</span>
                    <span class="action-label">Add Visit</span>
                </button>
                <button class="quick-action" id="viewTrendBtn">
                    <span class="action-icon">üìà</span>
                    <span class="action-label">Trend</span>
                </button>
            </div>
        </footer>

        <!-- OFFLINE INDICATOR -->
        <div class="offline-indicator hidden" id="offlineIndicator">
            <span>‚ö†Ô∏è Offline - Working locally</span>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal hidden" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Patient</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="patient-list" id="patientList">
                    <!-- Will be populated by JavaScript -->
                </div>
                <button class="action-btn primary" id="createNewPatient">
                    <span>‚ûï</span>
                    <span>Create New Patient</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="addVisitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Visit</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="visitForm">
                    <div class="input-group">
                        <label class="input-label">
                            <span>Visit Date</span>
                        </label>
                        <input type="date" class="measurement-input" id="visitDate" required style="width: 100%; padding: var(--space-md); border: 2px solid var(--border-light); border-radius: var(--radius-md);">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span>FEV‚ÇÅ (L)</span>
                        </label>
                        <div class="measurement-input">
                            <input type="number" step="0.01" min="0.5" max="8.0" id="visitFev1" required>
                            <span class="unit">L</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span>FVC (L)</span>
                            <span class="input-hint">Optional</span>
                        </label>
                        <div class="measurement-input">
                            <input type="number" step="0.01" min="0.5" max="10.0" id="visitFvc">
                            <span class="unit">L</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span>Clinical Notes</span>
                        </label>
                        <textarea id="visitNotes" rows="3" style="width: 100%; padding: var(--space-md); border: 2px solid var(--border-light); border-radius: var(--radius-md); resize: vertical;" placeholder="Symptoms, medications, context..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="action-btn secondary" id="cancelVisit">
                    Cancel
                </button>
                <button type="submit" form="visitForm" class="action-btn primary">
                    Save Visit
                </button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">
                        <span>Monitor Threshold</span>
                    </label>
                    <div class="measurement-input">
                        <input type="number" min="5" max="15" step="1" value="10" id="monitorThreshold">
                        <span class="unit">%</span>
                    </div>
                    <div class="input-help">Show warning at this decline from baseline</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        <span>Review Threshold</span>
                    </label>
                    <div class="measurement-input">
                        <input type="number" min="15" max="30" step="1" value="20" id="reviewThreshold">
                        <span class="unit">%</span>
                    </div>
                    <div class="input-help">Show alert at this decline from baseline</div>
                </div>
                
                <div class="action-row">
                    <button class="action-btn secondary" id="resetSettings">
                        Reset
                    </button>
                    <button class="action-btn primary" id="saveSettings">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATIONS -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- COMPLETE APPLICATION JAVASCRIPT -->
    <script>
        // ============================================================================
        // SPIROLITE PRO - COMPLETE APPLICATION
        // Mobile-First PWA for Lung Transplant Clinicians
        // ============================================================================

        // Global application state
        const AppState = {
            currentPatient: null,
            patients: new Map(),
            calculations: [],
            visits: [],
            alerts: [],
            settings: {
                monitorThreshold: 10,
                reviewThreshold: 20,
                colorCoding: true,
                autoSave: true
            },
            currentMode: 'quick',
            monitorView: 'visits',
            isOnline: navigator.onLine,
            
            // Initialize with sample data for demo
            initSampleData() {
                // Add a sample patient
                const samplePatient = {
                    id: 'PT001',
                    name: 'John Smith',
                    txDate: '2023-06-15',
                    baselineFev1: 3.20,
                    baselineDate: '2023-08-01',
                    description: 'Bilateral lung transplant',
                    visits: [
                        {
                            date: '2023-08-01',
                            fev1: 3.20,
                            fvc: 4.10,
                            notes: 'Baseline established - doing well'
                        },
                        {
                            date: '2023-09-15',
                            fev1: 3.15,
                            fvc: 4.05,
                            notes: 'Slight decrease, monitoring'
                        },
                        {
                            date: '2023-10-30',
                            fev1: 3.05,
                            fvc: 3.95,
                            notes: 'Stable on current regimen'
                        }
                    ]
                };
                
                this.patients.set(samplePatient.id, samplePatient);
                this.currentPatient = samplePatient.id;
                
                // Add sample calculations
                this.calculations = [
                    {
                        timestamp: new Date().toISOString(),
                        current: 3.05,
                        baseline: 3.20,
                        percent: 95.3
                    },
                    {
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        current: 3.10,
                        baseline: 3.20,
                        percent: 96.9
                    }
                ];
                
                // Add sample alerts
                this.alerts = [
                    {
                        id: '1',
                        type: 'warning',
                        title: 'Monitor Threshold',
                        message: 'FEV‚ÇÅ decreased 5% from baseline',
                        time: new Date().toISOString(),
                        read: false
                    }
                ];
                
                this.visits = [...samplePatient.visits];
            },
            
            // Get current patient object
            getCurrentPatient() {
                return this.currentPatient ? this.patients.get(this.currentPatient) : null;
            },
            
            // Add a new calculation
            addCalculation(current, baseline) {
                const percent = (current / baseline) * 100;
                const calculation = {
                    timestamp: new Date().toISOString(),
                    current,
                    baseline,
                    percent,
                    patient: this.currentPatient
                };
                
                this.calculations.unshift(calculation);
                if (this.calculations.length > 10) {
                    this.calculations.pop();
                }
                
                return calculation;
            },
            
            // Add a new visit
            addVisit(visitData) {
                const visit = {
                    ...visitData,
                    id: Date.now().toString(),
                    recordedAt: new Date().toISOString()
                };
                
                this.visits.unshift(visit);
                
                // Update patient record if exists
                const patient = this.getCurrentPatient();
                if (patient) {
                    if (!patient.visits) patient.visits = [];
                    patient.visits.unshift(visit);
                    this.patients.set(patient.id, patient);
                }
                
                // Check for alerts
                this.checkForAlerts(visit);
                
                return visit;
            },
            
            // Check for clinical alerts based on new visit
            checkForAlerts(visit) {
                const patient = this.getCurrentPatient();
                if (!patient || !patient.baselineFev1) return;
                
                const percent = (visit.fev1 / patient.baselineFev1) * 100;
                const decline = 100 - percent;
                
                if (decline >= this.settings.reviewThreshold) {
                    this.alerts.unshift({
                        id: Date.now().toString(),
                        type: 'alert',
                        title: 'Review Required',
                        message: `FEV‚ÇÅ decreased ${decline.toFixed(1)}% from baseline`,
                        time: new Date().toISOString(),
                        read: false
                    });
                } else if (decline >= this.settings.monitorThreshold) {
                    this.alerts.unshift({
                        id: Date.now().toString(),
                        type: 'warning',
                        title: 'Monitor Threshold',
                        message: `FEV‚ÇÅ decreased ${decline.toFixed(1)}% from baseline`,
                        time: new Date().toISOString(),
                        read: false
                    });
                }
            },
            
            // Get unread alert count
            getUnreadAlertCount() {
                return this.alerts.filter(alert => !alert.read).length;
            },
            
            // Save to localStorage
            saveToStorage() {
                try {
                    const data = {
                        patients: Array.from(this.patients.entries()),
                        calculations: this.calculations,
                        settings: this.settings,
                        currentPatient: this.currentPatient,
                        visits: this.visits,
                        alerts: this.alerts
                    };
                    localStorage.setItem('spirolite_pro_data', JSON.stringify(data));
                } catch (e) {
                    console.error('Failed to save data:', e);
                }
            },
            
            // Load from localStorage
            loadFromStorage() {
                try {
                    const data = JSON.parse(localStorage.getItem('spirolite_pro_data'));
                    if (data) {
                        if (data.patients) {
                            this.patients = new Map(data.patients);
                        }
                        this.calculations = data.calculations || [];
                        this.settings = data.settings || this.settings;
                        this.currentPatient = data.currentPatient || null;
                        this.visits = data.visits || [];
                        this.alerts = data.alerts || [];
                    }
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        };

        // DOM Elements cache
        const DOM = {
            // Loading
            appLoading: document.getElementById('app-loading'),
            progressFill: document.querySelector('.progress-fill'),
            app: document.getElementById('app'),
            
            // Header
            menuToggle: document.getElementById('menuToggle'),
            patientSwitch: document.getElementById('patientSwitch'),
            settingsBtn: document.getElementById('settingsBtn'),
            
            // Patient status
            patientStatus: document.getElementById('patientStatus'),
            patientAvatar: document.querySelector('.patient-avatar'),
            patientName: document.querySelector('.patient-name'),
            patientMeta: document.querySelector('.patient-meta'),
            statusIndicator: document.querySelector('.status-indicator'),
            
            // Mode tabs
            modeTabs: document.querySelectorAll('.mode-tab'),
            modeContents: {
                quick: document.getElementById('modeQuick'),
                monitor: document.getElementById('modeMonitor'),
                insights: document.getElementById('modeInsights')
            },
            
            // Quick calc mode
            currentFev1: document.getElementById('currentFev1'),
            baselineFev1: document.getElementById('baselineFev1'),
            calculateNow: document.getElementById('calculateNow'),
            clearCalc: document.getElementById('clearCalc'),
            swapUnits: document.getElementById('swapUnits'),
            usePatientBaseline: document.getElementById('usePatientBaseline'),
            
            // Results
            resultsCard: document.getElementById('resultsCard'),
            resultsTime: document.getElementById('resultsTime'),
            resultPercent: document.getElementById('resultPercent'),
            resultStatus: document.getElementById('resultStatus'),
            resultChange: document.getElementById('resultChange'),
            resultCurrent: document.getElementById('resultCurrent'),
            resultBaseline: document.getElementById('resultBaseline'),
            protocolNote: document.getElementById('protocolNote'),
            saveToRecord: document.getElementById('saveToRecord'),
            newCalculation: document.getElementById('newCalculation'),
            
            // History
            recentCalculations: document.getElementById('recentCalculations'),
            clearHistory: document.getElementById('clearHistory'),
            
            // Monitor mode
            patientBaseline: document.getElementById('patientBaseline'),
            baselineDate: document.getElementById('baselineDate'),
            lastFev1: document.getElementById('lastFev1'),
            lastDate: document.getElementById('lastDate'),
            currentPercent: document.getElementById('currentPercent'),
            percentStatus: document.getElementById('percentStatus'),
            visitCount: document.getElementById('visitCount'),
            daysPostTx: document.getElementById('daysPostTx'),
            
            // Monitor tabs
            monitorTabs: document.querySelectorAll('.monitor-tab'),
            monitorViews: document.querySelectorAll('.monitor-content'),
            
            // Visits
            addVisitBtn: document.getElementById('addVisitBtn'),
            addFirstVisit: document.getElementById('addFirstVisit'),
            visitsList: document.getElementById('visitsList'),
            
            // Trend
            trendChart: document.getElementById('trendChart'),
            overallTrend: document.getElementById('overallTrend'),
            monthlyChange: document.getElementById('monthlyChange'),
            exportChart: document.getElementById('exportChart'),
            
            // Alerts
            alertCount: document.getElementById('alertCount'),
            alertsList: document.getElementById('alertsList'),
            markAllRead: document.getElementById('markAllRead'),
            
            // Insights
            stabilityAnalysis: document.getElementById('stabilityAnalysis'),
            nextVisitWindow: document.getElementById('nextVisitWindow'),
            clinicalRecommendations: document.getElementById('clinicalRecommendations'),
            
            // Footer actions
            quickCalcBtn: document.getElementById('quickCalcBtn'),
            addVisitQuickBtn: document.getElementById('addVisitQuickBtn'),
            viewTrendBtn: document.getElementById('viewTrendBtn'),
            
            // Modals
            patientModal: document.getElementById('patientModal'),
            addVisitModal: document.getElementById('addVisitModal'),
            settingsModal: document.getElementById('settingsModal'),
            modalCloses: document.querySelectorAll('.modal-close'),
            
            // Form elements
            visitForm: document.getElementById('visitForm'),
            visitDate: document.getElementById('visitDate'),
            visitFev1: document.getElementById('visitFev1'),
            visitFvc: document.getElementById('visitFvc'),
            visitNotes: document.getElementById('visitNotes'),
            cancelVisit: document.getElementById('cancelVisit'),
            
            // Settings
            monitorThreshold: document.getElementById('monitorThreshold'),
            reviewThreshold: document.getElementById('reviewThreshold'),
            resetSettings: document.getElementById('resetSettings'),
            saveSettings: document.getElementById('saveSettings'),
            createNewPatient: document.getElementById('createNewPatient'),
            
            // Toast
            toastContainer: document.getElementById('toastContainer'),
            
            // Offline indicator
            offlineIndicator: document.getElementById('offlineIndicator')
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Simulate loading progress
            let progress = 30;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                DOM.progressFill.style.width = Math.min(progress, 100) + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        DOM.appLoading.classList.add('fade-out');
                        setTimeout(() => {
                            DOM.appLoading.style.display = 'none';
                            DOM.app.classList.add('loaded');
                            
                            // Initialize the application
                            initApp();
                        }, 300);
                    }, 300);
                }
            }, 150);
        });

        function initApp() {
            console.log('Initializing Spirolite Pro...');
            
            // Load data from storage
            AppState.loadFromStorage();
            
            // Initialize sample data if empty
            if (AppState.patients.size === 0) {
                AppState.initSampleData();
            }
            
            // Set current date for visit form
            DOM.visitDate.value = new Date().toISOString().split('T')[0];
            
            // Initialize event listeners
            initEventListeners();
            
            // Update UI with current state
            updatePatientUI();
            updateCalculationsHistory();
            updateMonitorUI();
            updateAlertsUI();
            
            // Set up online/offline detection
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Set up service worker
            registerServiceWorker();
            
            // Auto-focus on first input
            setTimeout(() => {
                if (DOM.currentFev1) DOM.currentFev1.focus();
            }, 500);
            
            showToast('Spirolite Pro ready', 'success');
        }

        function initEventListeners() {
            // Mode tabs
            DOM.modeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    switchMode(this.dataset.mode);
                });
            });
            
            // Monitor tabs
            DOM.monitorTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    switchMonitorView(this.dataset.view);
                });
            });
            
            // Quick calculation
            DOM.calculateNow.addEventListener('click', calculateFEV1);
            DOM.clearCalc.addEventListener('click', clearCalculation);
            DOM.currentFev1.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') calculateFEV1();
            });
            DOM.baselineFev1.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') calculateFEV1();
            });
            
            // Use patient baseline
            DOM.usePatientBaseline.addEventListener('click', function() {
                const patient = AppState.getCurrentPatient();
                if (patient && patient.baselineFev1) {
                    DOM.baselineFev1.value = patient.baselineFev1;
                    showToast('Baseline loaded from patient record', 'info');
                } else {
                    showToast('No baseline set for current patient', 'warning');
                }
            });
            
            // Results actions
            DOM.saveToRecord.addEventListener('click', saveCalculationToRecord);
            DOM.newCalculation.addEventListener('click', newCalculation);
            
            // History
            DOM.clearHistory.addEventListener('click', function() {
                if (AppState.calculations.length > 0) {
                    if (confirm('Clear all calculation history?')) {
                        AppState.calculations = [];
                        updateCalculationsHistory();
                        showToast('History cleared', 'info');
                    }
                }
            });
            
            // Patient switching
            DOM.patientSwitch.addEventListener('click', showPatientModal);
            DOM.patientStatus.addEventListener('click', showPatientModal);
            
            // Settings
            DOM.settingsBtn.addEventListener('click', showSettingsModal);
            
            // Visit management
            DOM.addVisitBtn.addEventListener('click', showAddVisitModal);
            DOM.addFirstVisit.addEventListener('click', showAddVisitModal);
            DOM.addVisitQuickBtn.addEventListener('click', showAddVisitModal);
            
            // Form submission
            DOM.visitForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveVisit();
            });
            
            DOM.cancelVisit.addEventListener('click', function() {
                hideModal(DOM.addVisitModal);
            });
            
            // Settings form
            DOM.saveSettings.addEventListener('click', saveSettings);
            DOM.resetSettings.addEventListener('click', resetSettings);
            
            // Modal close buttons
            DOM.modalCloses.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    hideModal(modal);
                });
            });
            
            // Modal backdrop clicks
            [DOM.patientModal, DOM.addVisitModal, DOM.settingsModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) hideModal(this);
                });
            });
            
            // Footer actions
            DOM.quickCalcBtn.addEventListener('click', function() {
                switchMode('quick');
                DOM.currentFev1.focus();
            });
            
            DOM.viewTrendBtn.addEventListener('click', function() {
                switchMode('monitor');
                switchMonitorView('trend');
            });
            
            // Alerts
            DOM.markAllRead.addEventListener('click', function() {
                AppState.alerts.forEach(alert => alert.read = true);
                updateAlertsUI();
                showToast('All alerts marked as read', 'info');
            });
            
            // Export chart
            DOM.exportChart.addEventListener('click', function() {
                showToast('Chart export coming soon', 'info');
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Touch gestures for mobile swipe
            initTouchGestures();
        }

        // ============================================================================
        // CORE FUNCTIONS
        // ============================================================================

        function calculateFEV1() {
            const current = parseFloat(DOM.currentFev1.value);
            const baseline = parseFloat(DOM.baselineFev1.value);
            
            // Validation
            if (!current || !baseline || isNaN(current) || isNaN(baseline)) {
                showToast('Please enter both current and baseline values', 'error');
                return;
            }
            
            if (current < 0.5 || current > 8.0) {
                showToast('FEV‚ÇÅ must be between 0.5 and 8.0 L', 'error');
                return;
            }
            
            if (baseline < 0.5 || baseline > 8.0) {
                showToast('Baseline must be between 0.5 and 8.0 L', 'error');
                return;
            }
            
            // Medical validation: FEV1 should not exceed FVC (if FVC were entered)
            // Note: FVC validation would go here if we had FVC input
            
            // Calculate
            const percent = (current / baseline) * 100;
            const change = current - baseline;
            
            // Add to history
            const calculation = AppState.addCalculation(current, baseline);
            
            // Update UI
            updateResultsUI(current, baseline, percent, change);
            updateCalculationsHistory();
            
            // Show results
            DOM.resultsCard.classList.remove('hidden');
            
            // Auto-scroll to results
            setTimeout(() => {
                DOM.resultsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            showToast('Calculation complete', 'success');
            
            // Auto-save
            if (AppState.settings.autoSave) {
                AppState.saveToStorage();
            }
        }

        function updateResultsUI(current, baseline, percent, change) {
            // Format values
            const formattedPercent = percent.toFixed(1);
            const formattedChange = change >= 0 ? '+' + change.toFixed(2) : change.toFixed(2);
            const formattedCurrent = current.toFixed(2);
            const formattedBaseline = baseline.toFixed(2);
            
            // Update DOM
            DOM.resultPercent.querySelector('.value').textContent = formattedPercent;
            DOM.resultChange.querySelector('.value').textContent = formattedChange;
            DOM.resultCurrent.querySelector('.value').textContent = formattedCurrent;
            DOM.resultBaseline.querySelector('.value').textContent = formattedBaseline;
            
            // Update timestamp
            const now = new Date();
            DOM.resultsTime.textContent = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Determine status
            let status = 'neutral';
            let statusText = 'Within range';
            let statusClass = 'neutral';
            
            if (percent >= (100 - AppState.settings.monitorThreshold)) {
                status = 'good';
                statusText = 'Normal';
                statusClass = 'good';
            } else if (percent >= (100 - AppState.settings.reviewThreshold)) {
                status = 'warning';
                statusText = 'Monitor';
                statusClass = 'warning';
            } else {
                status = 'alert';
                statusText = 'Review';
                statusClass = 'alert';
            }
            
            // Update status indicator
            DOM.resultStatus.className = `result-status ${statusClass}`;
            DOM.resultStatus.querySelector('span:last-child').textContent = statusText;
            DOM.resultStatus.querySelector('.status-dot').style.background = `var(--clinical-${status})`;
            
            // Update protocol note
            let note = '';
            if (status === 'good') {
                note = `FEV‚ÇÅ within normal range (${formattedPercent}% of baseline). Continue routine monitoring.`;
            } else if (status === 'warning') {
                const decline = (100 - percent).toFixed(1);
                note = `FEV‚ÇÅ decline ${decline}% from baseline. Monitor closely and consider additional testing.`;
            } else {
                const decline = (100 - percent).toFixed(1);
                note = `FEV‚ÇÅ decline ${decline}% from baseline. Urgent clinical review recommended.`;
            }
            DOM.protocolNote.textContent = note;
        }

        function clearCalculation() {
            DOM.currentFev1.value = '';
            DOM.baselineFev1.value = '';
            DOM.resultsCard.classList.add('hidden');
            showToast('Cleared', 'info');
            setTimeout(() => DOM.currentFev1.focus(), 100);
        }

        function newCalculation() {
            DOM.currentFev1.value = '';
            DOM.baselineFev1.value = '';
            DOM.resultsCard.classList.add('hidden');
            setTimeout(() => DOM.currentFev1.focus(), 100);
        }

        function saveCalculationToRecord() {
            // This would save the current calculation to the patient's record
            const current = parseFloat(DOM.currentFev1.value);
            const baseline = parseFloat(DOM.baselineFev1.value);
            
            if (!current || !baseline) {
                showToast('No calculation to save', 'warning');
                return;
            }
            
            showToast('Saved to patient record', 'success');
        }

        // ============================================================================
        // PATIENT MANAGEMENT
        // ============================================================================

        function updatePatientUI() {
            const patient = AppState.getCurrentPatient();
            
            if (!patient) {
                // No patient selected
                DOM.patientAvatar.textContent = '--';
                DOM.patientName.textContent = 'Select Patient';
                DOM.patientMeta.textContent = 'Tap to select patient';
                DOM.statusIndicator.className = 'status-indicator neutral';
                DOM.statusIndicator.querySelector('span:last-child').textContent = 'No data';
                
                // Update patient baseline in quick calc
                DOM.baselineFev1.placeholder = '3.00';
                DOM.usePatientBaseline.disabled = true;
                
                return;
            }
            
            // Update patient info
            DOM.patientAvatar.textContent = patient.id.substring(0, 2) || 'PT';
            DOM.patientName.textContent = patient.name || patient.id;
            DOM.patientMeta.textContent = patient.description || `Tx: ${patient.txDate || 'Unknown'}`;
            
            // Update patient baseline in quick calc
            if (patient.baselineFev1) {
                DOM.baselineFev1.placeholder = patient.baselineFev1.toFixed(2);
                DOM.usePatientBaseline.disabled = false;
            } else {
                DOM.usePatientBaseline.disabled = true;
            }
            
            // Calculate current status
            let status = 'neutral';
            let statusText = 'No visits';
            
            if (patient.visits && patient.visits.length > 0) {
                const lastVisit = patient.visits[0]; // Most recent first
                if (patient.baselineFev1) {
                    const percent = (lastVisit.fev1 / patient.baselineFev1) * 100;
                    
                    if (percent >= (100 - AppState.settings.monitorThreshold)) {
                        status = 'good';
                        statusText = `${percent.toFixed(0)}% of baseline`;
                    } else if (percent >= (100 - AppState.settings.reviewThreshold)) {
                        status = 'warning';
                        statusText = `${percent.toFixed(0)}% - Monitor`;
                    } else {
                        status = 'alert';
                        statusText = `${percent.toFixed(0)}% - Review`;
                    }
                } else {
                    statusText = `${lastVisit.fev1.toFixed(2)} L (no baseline)`;
                }
            }
            
            // Update status indicator
            DOM.statusIndicator.className = `status-indicator ${status}`;
            DOM.statusIndicator.querySelector('span:last-child').textContent = statusText;
            DOM.statusIndicator.querySelector('.status-dot').style.background = `var(--clinical-${status})`;
        }

        function showPatientModal() {
            DOM.patientList.innerHTML = '';
            
            if (AppState.patients.size === 0) {
                DOM.patientList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <h3>No patients</h3>
                        <p>Create your first patient to get started</p>
                    </div>
                `;
            } else {
                AppState.patients.forEach(patient => {
                    const div = document.createElement('div');
                    div.className = `patient-item ${AppState.currentPatient === patient.id ? 'active' : ''}`;
                    div.innerHTML = `
                        <div class="patient-avatar-small">${patient.id.substring(0, 2)}</div>
                        <div class="patient-info-small">
                            <div class="patient-name-small">${patient.name || patient.id}</div>
                            <div class="patient-meta-small">${patient.visits?.length || 0} visits ‚Ä¢ ${patient.txDate || 'No date'}</div>
                        </div>
                        ${AppState.currentPatient === patient.id ? '<div class="checkmark">‚úì</div>' : ''}
                    `;
                    
                    div.addEventListener('click', function() {
                        AppState.currentPatient = patient.id;
                        AppState.visits = [...(patient.visits || [])].reverse();
                        updatePatientUI();
                        updateMonitorUI();
                        updateCalculationsHistory();
                        hideModal(DOM.patientModal);
                        showToast(`Now working with ${patient.id}`, 'success');
                    });
                    
                    DOM.patientList.appendChild(div);
                });
            }
            
            showModal(DOM.patientModal);
        }

        // ============================================================================
        // VISIT MANAGEMENT
        // ============================================================================

        function showAddVisitModal() {
            // Set today's date as default
            DOM.visitDate.value = new Date().toISOString().split('T')[0];
            DOM.visitFev1.value = '';
            DOM.visitFvc.value = '';
            DOM.visitNotes.value = '';
            
            if (!AppState.currentPatient) {
                showToast('Please select a patient first', 'error');
                showPatientModal();
                return;
            }
            
            showModal(DOM.addVisitModal);
            setTimeout(() => DOM.visitFev1.focus(), 100);
        }

        function saveVisit() {
            const date = DOM.visitDate.value;
            const fev1 = parseFloat(DOM.visitFev1.value);
            const fvc = DOM.visitFvc.value ? parseFloat(DOM.visitFvc.value) : null;
            const notes = DOM.visitNotes.value.trim();
            
            // Validation
            if (!date || !fev1 || isNaN(fev1)) {
                showToast('Please enter valid date and FEV‚ÇÅ', 'error');
                return;
            }
            
            if (fev1 < 0.5 || fev1 > 8.0) {
                showToast('FEV‚ÇÅ must be between 0.5 and 8.0 L', 'error');
                return;
            }
            
            if (fvc && (fvc < 0.5 || fvc > 10.0)) {
                showToast('FVC must be between 0.5 and 10.0 L', 'error');
                return;
            }
            
            if (fvc && fvc < fev1) {
                showToast('Warning: FVC is less than FEV‚ÇÅ', 'warning');
                // Continue anyway - some patients might have this
            }
            
            // Check if date is in future
            const today = new Date().toISOString().split('T')[0];
            if (date > today) {
                showToast('Visit date cannot be in the future', 'error');
                return;
            }
            
            // Create visit object
            const visitData = {
                date,
                fev1,
                fvc,
                notes: notes || undefined
            };
            
            // Add to state
            const visit = AppState.addVisit(visitData);
            
            // Update UI
            updateMonitorUI();
            updateAlertsUI();
            
            // Close modal
            hideModal(DOM.addVisitModal);
            
            // Show success message
            showToast(`Visit saved for ${new Date(date).toLocaleDateString()}`, 'success');
            
            // Auto-save
            if (AppState.settings.autoSave) {
                AppState.saveToStorage();
            }
        }

        // ============================================================================
        // MONITOR UI UPDATES
        // ============================================================================

        function updateMonitorUI() {
            const patient = AppState.getCurrentPatient();
            
            if (!patient) {
                // Reset all values
                DOM.patientBaseline.textContent = '--';
                DOM.baselineDate.textContent = '--';
                DOM.lastFev1.textContent = '--';
                DOM.lastDate.textContent = '--';
                DOM.currentPercent.textContent = '--';
                DOM.percentStatus.textContent = '--';
                DOM.visitCount.textContent = '0';
                DOM.daysPostTx.textContent = '--';
                
                // Update visits list
                DOM.visitsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <h3>No patient selected</h3>
                        <p>Select a patient to view visits</p>
                        <button class="action-btn primary" id="selectPatientBtn">
                            Select Patient
                        </button>
                    </div>
                `;
                
                document.getElementById('selectPatientBtn')?.addEventListener('click', showPatientModal);
                
                return;
            }
            
            // Update patient summary
            if (patient.baselineFev1) {
                DOM.patientBaseline.textContent = patient.baselineFev1.toFixed(2);
                DOM.baselineDate.textContent = patient.baselineDate 
                    ? new Date(patient.baselineDate).toLocaleDateString()
                    : 'Unknown date';
            } else {
                DOM.patientBaseline.textContent = '--';
                DOM.baselineDate.textContent = 'Not set';
            }
            
            // Update last visit info
            if (AppState.visits.length > 0) {
                const lastVisit = AppState.visits[0]; // Most recent first
                DOM.lastFev1.textContent = lastVisit.fev1.toFixed(2);
                DOM.lastDate.textContent = new Date(lastVisit.date).toLocaleDateString();
                
                // Calculate percentage of baseline
                if (patient.baselineFev1) {
                    const percent = (lastVisit.fev1 / patient.baselineFev1) * 100;
                    DOM.currentPercent.textContent = percent.toFixed(1) + '%';
                    
                    // Status indicator
                    if (percent >= (100 - AppState.settings.monitorThreshold)) {
                        DOM.percentStatus.textContent = 'Normal';
                        DOM.percentStatus.style.color = 'var(--clinical-green)';
                    } else if (percent >= (100 - AppState.settings.reviewThreshold)) {
                        DOM.percentStatus.textContent = 'Monitor';
                        DOM.percentStatus.style.color = 'var(--clinical-warning)';
                    } else {
                        DOM.percentStatus.textContent = 'Review';
                        DOM.percentStatus.style.color = 'var(--clinical-alert)';
                    }
                } else {
                    DOM.currentPercent.textContent = '--';
                    DOM.percentStatus.textContent = 'No baseline';
                }
            } else {
                DOM.lastFev1.textContent = '--';
                DOM.lastDate.textContent = 'No visits';
                DOM.currentPercent.textContent = '--';
                DOM.percentStatus.textContent = '--';
            }
            
            // Update counts
            DOM.visitCount.textContent = AppState.visits.length.toString();
            
            // Calculate days post-transplant
            if (patient.txDate) {
                const txDate = new Date(patient.txDate);
                const today = new Date();
                const diffTime = Math.abs(today - txDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                DOM.daysPostTx.textContent = diffDays.toString();
            } else {
                DOM.daysPostTx.textContent = '--';
            }
            
            // Update visits list
            updateVisitsList();
            
            // Update trend chart
            updateTrendChart();
            
            // Update insights
            updateInsights();
        }

        function updateVisitsList() {
            if (AppState.visits.length === 0) {
                DOM.visitsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <h3>No visits recorded</h3>
                        <p>Add the first visit to start monitoring</p>
                        <button class="action-btn primary" id="addFirstVisit">
                            Add First Visit
                        </button>
                    </div>
                `;
                
                document.getElementById('addFirstVisit')?.addEventListener('click', showAddVisitModal);
                return;
            }
            
            const patient = AppState.getCurrentPatient();
            let html = '';
            
            AppState.visits.forEach(visit => {
                const date = new Date(visit.date);
                const daysAgo = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
                
                // Calculate percentage of baseline
                let percentText = '--';
                if (patient?.baselineFev1) {
                    const percent = (visit.fev1 / patient.baselineFev1) * 100;
                    percentText = percent.toFixed(1) + '%';
                }
                
                html += `
                    <div class="visit-item">
                        <div class="visit-header">
                            <div class="visit-date">${date.toLocaleDateString()}</div>
                            <div class="visit-days">${daysAgo === 0 ? 'Today' : daysAgo + ' days ago'}</div>
                        </div>
                        <div class="visit-metrics">
                            <div class="visit-metric">
                                <div class="visit-metric-label">FEV‚ÇÅ</div>
                                <div class="visit-metric-value">${visit.fev1.toFixed(2)} L</div>
                            </div>
                            <div class="visit-metric">
                                <div class="visit-metric-label">% of Baseline</div>
                                <div class="visit-metric-value">${percentText}</div>
                            </div>
                        </div>
                        ${visit.notes ? `<div style="font-size: var(--font-sm); color: var(--text-secondary); margin-top: var(--space-md);">${visit.notes}</div>` : ''}
                    </div>
                `;
            });
            
            DOM.visitsList.innerHTML = html;
        }

        function updateTrendChart() {
            if (!DOM.trendChart || AppState.visits.length < 2) return;
            
            const ctx = DOM.trendChart.getContext('2d');
            
            // Sort visits by date (oldest first for chart)
            const sortedVisits = [...AppState.visits].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            // Prepare data
            const labels = sortedVisits.map(v => 
                new Date(v.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            );
            const data = sortedVisits.map(v => v.fev1);
            
            // Calculate trend
            const first = sortedVisits[0].fev1;
            const last = sortedVisits[sortedVisits.length - 1].fev1;
            const daysDiff = (new Date(sortedVisits[sortedVisits.length - 1].date) - new Date(sortedVisits[0].date)) / (1000 * 60 * 60 * 24);
            const monthsDiff = daysDiff / 30.44;
            
            const overallChange = last - first;
            const monthlyChange = monthsDiff > 0 ? (last - first) / monthsDiff : 0;
            
            DOM.overallTrend.textContent = overallChange >= 0 
                ? `+${overallChange.toFixed(2)} L` 
                : `${overallChange.toFixed(2)} L`;
            
            DOM.monthlyChange.textContent = monthlyChange >= 0 
                ? `+${monthlyChange.toFixed(3)} L/month` 
                : `${monthlyChange.toFixed(3)} L/month`;
            
            DOM.overallTrend.style.color = overallChange >= 0 
                ? 'var(--clinical-green)' 
                : 'var(--clinical-alert)';
            
            DOM.monthlyChange.style.color = monthlyChange >= 0 
                ? 'var(--clinical-green)' 
                : 'var(--clinical-alert)';
            
            // Create or update chart
            if (window.trendChartInstance) {
                window.trendChartInstance.data.labels = labels;
                window.trendChartInstance.data.datasets[0].data = data;
                window.trendChartInstance.update();
            } else {
                window.trendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'FEV‚ÇÅ (L)',
                            data: data,
                            borderColor: 'var(--primary-blue)',
                            backgroundColor: 'rgba(26, 95, 122, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: 'var(--primary-teal)',
                            pointBorderColor: '#FFFFFF',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(26, 95, 122, 0.9)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `FEV‚ÇÅ: ${context.parsed.y.toFixed(2)} L`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1) + ' L';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ============================================================================
        // ALERTS MANAGEMENT
        // ============================================================================

        function updateAlertsUI() {
            const unreadCount = AppState.getUnreadAlertCount();
            DOM.alertCount.textContent = unreadCount.toString();
            
            if (AppState.alerts.length === 0) {
                DOM.alertsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <h3>No active alerts</h3>
                        <p>All measurements within normal range</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            AppState.alerts.forEach(alert => {
                const time = new Date(alert.time);
                html += `
                    <div class="alert-item ${alert.type} ${alert.read ? 'read' : ''}">
                        <div class="alert-icon">${alert.type === 'alert' ? '‚ö†Ô∏è' : 'üîî'}</div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-message">${alert.message}</div>
                            <div class="alert-time">${time.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            DOM.alertsList.innerHTML = html;
            
            // Add click handlers to mark as read
            DOM.alertsList.querySelectorAll('.alert-item').forEach((item, index) => {
                if (!AppState.alerts[index].read) {
                    item.addEventListener('click', function() {
                        AppState.alerts[index].read = true;
                        updateAlertsUI();
                    });
                }
            });
        }

        // ============================================================================
        // INSIGHTS
        // ============================================================================

        function updateInsights() {
            const patient = AppState.getCurrentPatient();
            
            if (!patient || AppState.visits.length < 3) {
                DOM.stabilityAnalysis.textContent = 'Add more visits to analyze stability';
                DOM.nextVisitWindow.textContent = 'Based on protocol guidelines';
                DOM.clinicalRecommendations.textContent = 'Complete patient profile for personalized recommendations';
                return;
            }
            
            // Stability analysis
            if (AppState.visits.length >= 4) {
                const recentVisits = AppState.visits.slice(0, 4); // Last 4 visits
                const values = recentVisits.map(v => v.fev1);
                const max = Math.max(...values);
                const min = Math.min(...values);
                const variation = ((max - min) / max) * 100;
                
                if (variation <= 5) {
                    DOM.stabilityAnalysis.textContent = 'Stable: <5% variation in last 4 visits';
                } else if (variation <= 10) {
                    DOM.stabilityAnalysis.textContent = 'Moderately stable: 5-10% variation';
                } else {
                    DOM.stabilityAnalysis.textContent = 'Unstable: >10% variation in last 4 visits';
                }
            } else {
                DOM.stabilityAnalysis.textContent = 'Need 4+ visits for stability analysis';
            }
            
            // Next visit window
            if (AppState.visits.length > 0) {
                const lastVisit = new Date(AppState.visits[0].date);
                const nextVisit = new Date(lastVisit);
                nextVisit.setDate(nextVisit.getDate() + 30); // Standard 30-day follow-up
                
                const daysUntil = Math.ceil((nextVisit - new Date()) / (1000 * 60 * 60 * 24));
                
                if (daysUntil <= 0) {
                    DOM.nextVisitWindow.textContent = 'Due for follow-up visit';
                } else {
                    DOM.nextVisitWindow.textContent = `Next visit in ${daysUntil} days`;
                }
            }
            
            // Clinical recommendations
            if (patient.baselineFev1 && AppState.visits.length > 0) {
                const lastVisit = AppState.visits[0];
                const percent = (lastVisit.fev1 / patient.baselineFev1) * 100;
                
                if (percent >= 90) {
                    DOM.clinicalRecommendations.textContent = 'Continue current management. Routine monitoring.';
                } else if (percent >= 80) {
                    DOM.clinicalRecommendations.textContent = 'Consider additional testing. Monitor closely.';
                } else {
                    DOM.clinicalRecommendations.textContent = 'Urgent review recommended. Consider adjusting immunosuppression.';
                }
            }
        }

        // ============================================================================
        // CALCULATIONS HISTORY
        // ============================================================================

        function updateCalculationsHistory() {
            if (AppState.calculations.length === 0) {
                DOM.recentCalculations.innerHTML = '<div class="empty-state">No recent calculations</div>';
                return;
            }
            
            let html = '';
            AppState.calculations.forEach(calc => {
                const time = new Date(calc.timestamp);
                html += `
                    <div class="history-item">
                        <div class="history-time">${time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        <div class="history-values">
                            <span>${calc.current.toFixed(2)}L</span>
                            <span>‚Üí</span>
                            <span>${calc.percent.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            });
            
            DOM.recentCalculations.innerHTML = html;
        }

        // ============================================================================
        // SETTINGS
        // ============================================================================

        function showSettingsModal() {
            DOM.monitorThreshold.value = AppState.settings.monitorThreshold;
            DOM.reviewThreshold.value = AppState.settings.reviewThreshold;
            showModal(DOM.settingsModal);
        }

        function saveSettings() {
            const monitor = parseInt(DOM.monitorThreshold.value);
            const review = parseInt(DOM.reviewThreshold.value);
            
            if (isNaN(monitor) || isNaN(review) || monitor < 5 || monitor > 15 || review < 15 || review > 30 || monitor >= review) {
                showToast('Please enter valid threshold values', 'error');
                return;
            }
            
            AppState.settings.monitorThreshold = monitor;
            AppState.settings.reviewThreshold = review;
            
            AppState.saveToStorage();
            hideModal(DOM.settingsModal);
            
            // Update UI to reflect new thresholds
            updatePatientUI();
            updateMonitorUI();
            
            showToast('Settings saved', 'success');
        }

        function resetSettings() {
            AppState.settings.monitorThreshold = 10;
            AppState.settings.reviewThreshold = 20;
            
            DOM.monitorThreshold.value = 10;
            DOM.reviewThreshold.value = 20;
            
            showToast('Settings reset to defaults', 'info');
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================

        function switchMode(mode) {
            // Update tabs
            DOM.modeTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });
            
            // Update content visibility
            Object.keys(DOM.modeContents).forEach(key => {
                DOM.modeContents[key].classList.toggle('active', key === mode);
            });
            
            AppState.currentMode = mode;
            
            // Special handling for each mode
            if (mode === 'quick') {
                setTimeout(() => DOM.currentFev1.focus(), 100);
            } else if (mode === 'monitor') {
                updateMonitorUI();
            }
        }

        function switchMonitorView(view) {
            // Update tabs
            DOM.monitorTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            // Update content visibility
            DOM.monitorViews.forEach(content => {
                content.classList.toggle('active', content.dataset.view === view);
            });
            
            AppState.monitorView = view;
            
            // Initialize chart if needed
            if (view === 'trend') {
                setTimeout(updateTrendChart, 100);
            }
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            DOM.toastContainer.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function updateOnlineStatus() {
            AppState.isOnline = navigator.onLine;
            
            if (AppState.isOnline) {
                DOM.offlineIndicator.classList.add('hidden');
            } else {
                DOM.offlineIndicator.classList.remove('hidden');
                showToast('Working offline - data saved locally', 'warning');
            }
        }

        // ============================================================================
        // KEYBOARD SHORTCUTS & TOUCH GESTURES
        // ============================================================================

        function handleKeyboardShortcuts(e) {
            // Don't interfere with form inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Mode switching with Ctrl+Number
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchMode('quick');
                        break;
                    case '2':
                        e.preventDefault();
                        switchMode('monitor');
                        break;
                    case '3':
                        e.preventDefault();
                        switchMode('insights');
                        break;
                }
            }
            
            // Quick calculation with Enter
            if (e.key === 'Enter' && AppState.currentMode === 'quick') {
                calculateFEV1();
            }
            
            // Clear with Escape
            if (e.key === 'Escape' && AppState.currentMode === 'quick') {
                clearCalculation();
            }
            
            // Save with Ctrl+S
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (AppState.currentMode === 'quick') {
                    calculateFEV1();
                }
                showToast('Saved', 'success');
            }
        }

        function initTouchGestures() {
            let touchStartX = 0;
            
            document.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
            });
            
            document.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;
                
                // Swipe threshold (50px)
                if (Math.abs(diff) > 50) {
                    const modes = ['quick', 'monitor', 'insights'];
                    const currentIndex = modes.indexOf(AppState.currentMode);
                    
                    if (diff > 0 && currentIndex < modes.length - 1) {
                        // Swipe left - next mode
                        switchMode(modes[currentIndex + 1]);
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right - previous mode
                        switchMode(modes[currentIndex - 1]);
                    }
                }
            });
        }

        // ============================================================================
        // SERVICE WORKER REGISTRATION
        // ============================================================================

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('sw.js')
                        .then(function(registration) {
                            console.log('ServiceWorker registration successful');
                        })
                        .catch(function(err) {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }
        }

        // ============================================================================
        // INITIALIZE WHEN READY
        // ============================================================================

        // Export to global scope for debugging
        window.AppState = AppState;
        window.DOM = DOM;
    </script>
</body>
</html>
