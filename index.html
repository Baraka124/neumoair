<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1A5F7A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Professional lung function calculator for transplant monitoring">
    
    <title>PulmoMetrics | Lung Transplant Monitor</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- App Icon -->
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    
    <style>
        /* ===== CSS RESET ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc; color: #1f2937; line-height: 1.5;
            height: 100vh; height: -webkit-fill-available; overflow: hidden;
        }
        
        /* ===== VARIABLES ===== */
        :root {
            --primary: #1A5F7A;
            --primary-dark: #154B61;
            --primary-light: #2D9596;
            --secondary: #57C5B6;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --surface-elevated: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --success: #059669;
            --warning: #F59E0B;
            --alert: #DC2626;
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            
            --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem;
            --space-4: 1rem; --space-5: 1.5rem; --space-6: 2rem;
            
            --radius-sm: 6px; --radius-md: 10px; --radius-lg: 14px;
            --radius-xl: 20px; --radius-full: 9999px;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.12);
            
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #2D9596;
                --primary-dark: #1A5F7A;
                --background: #111827;
                --surface: #1F2937;
                --surface-elevated: #374151;
                --text-primary: #F9FAFB;
                --text-secondary: #D1D5DB;
                --text-tertiary: #9CA3AF;
                --border: #374151;
                --border-light: #4B5563;
            }
        }
        
        /* ===== APP CONTAINER ===== */
        .app-container {
            display: flex; flex-direction: column;
            height: 100vh; height: -webkit-fill-available;
            max-width: 800px; margin: 0 auto;
            background: var(--surface);
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .app-container {
                box-shadow: var(--shadow-xl);
                border-radius: var(--radius-lg);
                margin: var(--space-4) auto;
                height: calc(100vh - 2 * var(--space-4));
                max-height: 900px;
            }
        }
        
        /* ===== HEADER ===== */
        .app-header {
            background: var(--surface-elevated);
            padding: var(--space-4);
            padding-top: max(var(--space-4), env(safe-area-inset-top));
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(var(--surface-elevated-rgb), 0.95);
        }
        
        .header-content {
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .app-title {
            display: flex; align-items: center; gap: var(--space-2);
        }
        
        .app-logo {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 18px;
        }
        
        .app-name h1 {
            font-size: 1.25rem; font-weight: 700; color: var(--primary);
            line-height: 1.2;
        }
        
        .app-name span {
            font-size: 0.75rem; color: var(--text-secondary);
            font-weight: 500;
        }
        
        .header-actions {
            display: flex; gap: var(--space-2);
        }
        
        .header-btn {
            width: 40px; height: 40px;
            border-radius: var(--radius-md); border: 1px solid var(--border);
            background: var(--surface); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all var(--transition);
        }
        
        .header-btn:hover {
            background: var(--border-light); color: var(--primary);
            border-color: var(--primary); transform: translateY(-1px);
        }
        
        /* ===== PATIENT BAR ===== */
        .patient-bar {
            background: var(--surface); padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border); position: sticky;
            top: 73px; z-index: 99;
        }
        
        .patient-selector {
            display: flex; align-items: center; gap: var(--space-3);
        }
        
        .patient-avatar {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-full);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 0.875rem;
        }
        
        .patient-info { flex: 1; }
        
        .patient-id {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700; font-size: 1rem; color: var(--primary);
            display: block;
        }
        
        .patient-meta {
            font-size: 0.75rem; color: var(--text-secondary);
            display: flex; gap: var(--space-3); margin-top: 2px;
        }
        
        /* ===== NAVIGATION ===== */
        .app-nav {
            display: flex; background: var(--surface);
            border-bottom: 1px solid var(--border); padding: var(--space-2) var(--space-4);
            gap: var(--space-2); position: sticky; top: 143px; z-index: 98;
        }
        
        .nav-btn {
            flex: 1; padding: var(--space-3) var(--space-2);
            border: none; border-radius: var(--radius-lg);
            background: transparent; color: var(--text-secondary);
            font-weight: 600; font-size: 0.875rem; cursor: pointer;
            transition: all var(--transition);
            display: flex; flex-direction: column; align-items: center;
            gap: var(--space-1);
        }
        
        .nav-btn:hover {
            background: var(--border-light); color: var(--primary);
        }
        
        .nav-btn.active {
            background: var(--primary); color: white;
            box-shadow: 0 2px 8px rgba(26, 95, 122, 0.2);
        }
        
        .nav-icon { font-size: 1.25rem; opacity: 0.9; }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain; padding: var(--space-4);
        }
        
        /* ===== MODES ===== */
        .mode-section {
            display: none; animation: fadeIn var(--transition);
        }
        
        .mode-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== COMMON COMPONENTS ===== */
        .card {
            background: var(--surface-elevated); border-radius: var(--radius-xl);
            padding: var(--space-5); margin-bottom: var(--space-5);
            border: 1px solid var(--border); box-shadow: var(--shadow-md);
        }
        
        .section-title {
            font-size: 1.125rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: var(--space-5); display: flex;
            align-items: center; justify-content: space-between;
        }
        
        .badge {
            background: var(--primary-light); color: white;
            padding: var(--space-1) var(--space-3); border-radius: var(--radius-full);
            font-size: 0.75rem; font-weight: 600;
        }
        
        .input-group { position: relative; margin-bottom: var(--space-4); }
        
        .input-label {
            display: block; font-size: 0.75rem; font-weight: 600;
            color: var(--text-secondary); margin-bottom: var(--space-2);
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        
        .input-wrapper { position: relative; }
        
        .calc-input {
            width: 100%; padding: var(--space-4);
            border: 2px solid var(--border); border-radius: var(--radius-lg);
            font-family: 'SF Mono', monospace; font-size: 1.25rem;
            font-weight: 600; color: var(--text-primary); text-align: left;
            transition: all var(--transition); background: var(--surface);
        }
        
        .calc-input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        }
        
        .input-unit {
            position: absolute; right: var(--space-4); top: 50%;
            transform: translateY(-50%); color: var(--text-secondary);
            font-weight: 600; font-size: 0.875rem; pointer-events: none;
        }
        
        /* ===== QUICK CALC MODE ===== */
        .measurement-inputs {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: var(--space-4); margin-bottom: var(--space-5);
        }
        
        @media (max-width: 640px) {
            .measurement-inputs { grid-template-columns: 1fr; }
        }
        
        .comparison-selector {
            background: var(--background); border-radius: var(--radius-lg);
            padding: var(--space-4); margin: var(--space-5) 0;
            border: 1px solid var(--border);
        }
        
        .comparison-title {
            font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
            margin-bottom: var(--space-3); text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .comparison-options {
            display: flex; flex-direction: column; gap: var(--space-3);
        }
        
        .comparison-option {
            display: flex; align-items: center; padding: var(--space-3);
            border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); border: 1px solid transparent;
        }
        
        .comparison-option:hover {
            background: var(--surface); border-color: var(--border);
        }
        
        .comparison-option.selected {
            background: var(--surface); border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(26, 95, 122, 0.1);
        }
        
        .option-radio {
            margin-right: var(--space-3); width: 20px; height: 20px;
            accent-color: var(--primary);
        }
        
        .option-content { flex: 1; }
        
        .option-label {
            font-weight: 600; color: var(--text-primary);
            font-size: 0.875rem; margin-bottom: 2px;
        }
        
        .option-input {
            margin-top: var(--space-2); padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            width: 100%; font-family: 'SF Mono', monospace;
            font-size: 0.875rem; background: var(--surface);
            color: var(--text-primary);
        }
        
        .option-note {
            font-size: 0.75rem; color: var(--text-tertiary);
            margin-top: 2px; display: block;
        }
        
        /* Results Display */
        .results-container {
            margin-top: var(--space-5);
        }
        
        .results-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4); margin-bottom: var(--space-5);
        }
        
        @media (max-width: 480px) {
            .results-grid { grid-template-columns: 1fr; }
        }
        
        .result-card {
            background: var(--background); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: var(--space-4);
            text-align: center; transition: transform var(--transition);
        }
        
        .result-card:hover {
            transform: translateY(-2px); border-color: var(--primary);
        }
        
        .result-value {
            font-family: 'SF Mono', monospace; font-size: 1.75rem;
            font-weight: 700; line-height: 1; margin: var(--space-2) 0;
            color: var(--primary);
        }
        
        .result-label {
            font-size: 0.75rem; color: var(--text-secondary);
            font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em; display: block;
        }
        
        .result-unit {
            font-size: 0.75rem; color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        .comparison-results {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            padding: var(--space-5); margin-bottom: var(--space-5);
            border: 1px solid var(--border);
        }
        
        .metric-row {
            display: flex; justify-content: space-between;
            align-items: center; padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .metric-row:last-child { border-bottom: none; }
        
        .metric-label {
            font-size: 0.875rem; color: var(--text-secondary);
            font-weight: 500;
        }
        
        .metric-value {
            font-family: 'SF Mono', monospace; font-weight: 600;
            font-size: 1.125rem;
        }
        
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--alert); }
        .metric-value.neutral { color: var(--text-primary); }
        
        .metric-unit {
            font-size: 0.75rem; color: var(--text-tertiary);
            min-width: 60px; text-align: right;
        }
        
        /* Protocol Context */
        .protocol-context {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            padding: var(--space-5); margin-top: var(--space-5);
            border: 1px solid var(--border);
        }
        
        .threshold-display {
            display: flex; gap: var(--space-3); margin-bottom: var(--space-4);
        }
        
        .threshold-badge {
            padding: var(--space-1) var(--space-3); border-radius: var(--radius-full);
            font-size: 0.75rem; font-weight: 600; display: flex;
            align-items: center; gap: var(--space-1);
        }
        
        .threshold-badge.monitor {
            background: rgba(5, 150, 105, 0.1); color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .threshold-badge.review {
            background: rgba(245, 158, 11, 0.1); color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .threshold-badge.action {
            background: rgba(220, 38, 38, 0.1); color: var(--alert);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }
        
        .protocol-note {
            font-size: 0.875rem; line-height: 1.6; color: var(--text-secondary);
            padding: var(--space-4); background: var(--background);
            border-radius: var(--radius-md); border-left: 3px solid var(--primary);
        }
        
        /* ===== FIRST YEAR MONITOR MODE ===== */
        .visits-table-container {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            border: 1px solid var(--border); overflow: hidden;
            margin-bottom: var(--space-5);
        }
        
        .visits-table {
            width: 100%; border-collapse: collapse; font-size: 0.875rem;
        }
        
        .visits-table th {
            background: var(--background); color: var(--text-secondary);
            font-weight: 600; text-transform: uppercase; font-size: 0.75rem;
            letter-spacing: 0.05em; padding: var(--space-3) var(--space-4);
            text-align: left; border-bottom: 1px solid var(--border);
        }
        
        .visits-table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border-light);
        }
        
        .visits-table tr:hover { background: var(--background); }
        .visits-table tr.highlight {
            background: rgba(26, 95, 122, 0.05);
            border-left: 3px solid var(--primary);
        }
        
        .value-positive { color: var(--success); font-weight: 600; }
        .value-negative { color: var(--alert); font-weight: 600; }
        
        .visit-actions { display: flex; gap: var(--space-2); }
        
        .visit-action-btn {
            width: 28px; height: 28px; border-radius: var(--radius-sm);
            border: 1px solid var(--border); background: var(--surface);
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem;
        }
        
        .visit-action-btn:hover {
            background: var(--border-light); color: var(--primary);
        }
        
        .add-visit-form {
            background: var(--background); border-radius: var(--radius-lg);
            padding: var(--space-4); margin-bottom: var(--space-5);
            border: 1px solid var(--border);
        }
        
        .form-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-3); margin-bottom: var(--space-3);
        }
        
        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
        }
        
        .bulk-input-container { margin-top: var(--space-4); }
        
        .bulk-input-label {
            display: flex; align-items: center; gap: var(--space-2);
            font-size: 0.875rem; color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
        
        .bulk-textarea {
            width: 100%; min-height: 120px; padding: var(--space-3);
            border: 2px solid var(--border); border-radius: var(--radius-md);
            font-family: 'SF Mono', monospace; font-size: 0.875rem;
            background: var(--surface); color: var(--text-primary);
            resize: vertical;
        }
        
        .bulk-textarea:focus {
            outline: none; border-color: var(--primary);
        }
        
        .bulk-hint {
            font-size: 0.75rem; color: var(--text-tertiary);
            margin-top: var(--space-2);
        }
        
        /* Baseline Calculation */
        .baseline-card {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            padding: var(--space-5); margin-top: var(--space-5);
            border: 1px solid var(--border); border-left: 4px solid var(--primary);
        }
        
        .baseline-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: var(--space-4);
        }
        
        .baseline-title {
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
        }
        
        .baseline-values {
            display: flex; flex-direction: column; gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .baseline-value {
            display: flex; justify-content: space-between;
            padding: var(--space-2) 0; border-bottom: 1px solid var(--border-light);
        }
        
        .baseline-value:last-child { border-bottom: none; }
        
        .baseline-label { color: var(--text-secondary); font-weight: 500; }
        
        .baseline-number {
            font-family: 'SF Mono', monospace; font-weight: 600;
            color: var(--primary); font-size: 1.125rem;
        }
        
        .baseline-actions { display: flex; gap: var(--space-3); }
        
        /* ===== FULL STUDY MODE ===== */
        .timeline-setup {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            padding: var(--space-5); margin-bottom: var(--space-5);
            border: 1px solid var(--border);
        }
        
        .timeline-inputs {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: var(--space-4); margin-top: var(--space-4);
        }
        
        @media (max-width: 640px) {
            .timeline-inputs { grid-template-columns: 1fr; }
        }
        
        .date-input {
            padding: var(--space-3) var(--space-4); border: 2px solid var(--border);
            border-radius: var(--radius-md); font-family: inherit;
            font-size: 0.875rem; width: 100%; background: var(--surface);
            color: var(--text-primary);
        }
        
        .date-input:focus {
            outline: none; border-color: var(--primary);
        }
        
        .timeline-display {
            background: rgba(26, 95, 122, 0.05); border-radius: var(--radius-lg);
            padding: var(--space-4); margin-top: var(--space-4);
            border: 1px solid rgba(26, 95, 122, 0.1);
        }
        
        .timeline-row {
            display: flex; justify-content: space-between;
            padding: var(--space-2) 0; font-size: 0.875rem;
        }
        
        .timeline-label { color: var(--primary); font-weight: 500; }
        
        .timeline-value {
            font-family: 'SF Mono', monospace; font-weight: 600;
        }
        
        /* Clinical Notes */
        .clinical-notes-section { margin-top: var(--space-5); }
        
        .notes-textarea {
            width: 100%; min-height: 120px; padding: var(--space-4);
            border: 2px solid var(--border); border-radius: var(--radius-lg);
            font-family: inherit; font-size: 0.875rem; line-height: 1.6;
            resize: vertical; background: var(--surface);
            color: var(--text-primary);
        }
        
        .notes-textarea:focus {
            outline: none; border-color: var(--primary);
        }
        
        /* ===== REVIEW MODE ===== */
        .patient-summary {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            padding: var(--space-5); margin-bottom: var(--space-5);
            border: 1px solid var(--border);
        }
        
        .summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4); margin-top: var(--space-4);
        }
        
        .summary-item { text-align: center; padding: var(--space-3); }
        
        .summary-value {
            font-family: 'SF Mono', monospace; font-size: 1.5rem;
            font-weight: 700; color: var(--primary); line-height: 1;
            margin: var(--space-2) 0;
        }
        
        .summary-label {
            font-size: 0.75rem; color: var(--text-secondary);
            font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .visits-list {
            display: flex; flex-direction: column; gap: var(--space-3);
        }
        
        .visit-card {
            background: var(--surface-elevated); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: var(--space-4);
            display: flex; justify-content: space-between; align-items: center;
            transition: all var(--transition);
        }
        
        .visit-card:hover {
            border-color: var(--primary); transform: translateX(2px);
        }
        
        .visit-date {
            font-family: 'SF Mono', monospace; font-weight: 600;
            color: var(--text-primary);
        }
        
        .visit-values {
            display: flex; gap: var(--space-4);
            font-family: 'SF Mono', monospace;
        }
        
        .visit-fev1 {
            color: var(--primary); font-weight: 700; font-size: 1.125rem;
        }
        
        .visit-fvc { color: var(--secondary); font-weight: 600; }
        
        .empty-state {
            text-align: center; padding: var(--space-8) var(--space-4);
            color: var(--text-tertiary);
        }
        
        .empty-state-icon {
            font-size: 3rem; margin-bottom: var(--space-4); opacity: 0.3;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-bar {
            display: flex; gap: var(--space-3); margin-top: var(--space-5);
            padding-top: var(--space-5); border-top: 1px solid var(--border);
        }
        
        .action-btn {
            flex: 1; padding: var(--space-4); border: none;
            border-radius: var(--radius-lg); font-weight: 600;
            font-size: 0.875rem; cursor: pointer; transition: all var(--transition);
            display: flex; align-items: center; justify-content: center;
            gap: var(--space-2);
        }
        
        .action-btn:active { transform: translateY(1px); }
        
        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 12px rgba(26, 95, 122, 0.3);
        }
        
        .action-btn.primary:hover {
            box-shadow: 0 6px 20px rgba(26, 95, 122, 0.4);
            transform: translateY(-2px);
        }
        
        .action-btn.secondary {
            background: var(--surface); color: var(--text-secondary);
            border: 2px solid var(--border);
        }
        
        .action-btn.secondary:hover {
            background: var(--border-light); color: var(--text-primary);
            border-color: var(--text-tertiary);
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: var(--space-4);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: var(--surface-elevated); border-radius: var(--radius-xl);
            width: 100%; max-width: 440px; max-height: 90vh;
            overflow-y: auto; box-shadow: var(--shadow-xl);
            animation: slideUp var(--transition);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: var(--space-5); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem; font-weight: 700; color: var(--text-primary);
        }
        
        .modal-close {
            width: 32px; height: 32px; border-radius: var(--radius-full);
            border: none; background: var(--border-light);
            color: var(--text-secondary); display: flex;
            align-items: center; justify-content: center; cursor: pointer;
        }
        
        .modal-body { padding: var(--space-5); }
        .modal-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--border);
            display: flex; justify-content: flex-end; gap: var(--space-3);
        }
        
        /* ===== TOASTS ===== */
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: var(--space-2);
        }
        
        .toast {
            background: var(--surface-elevated); border-radius: var(--radius-lg);
            padding: var(--space-4); box-shadow: var(--shadow-xl);
            border-left: 4px solid var(--primary); min-width: 300px;
            max-width: 400px; animation: slideInRight var(--transition);
            display: flex; align-items: flex-start; gap: var(--space-3);
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast-icon { font-size: 1.25rem; flex-shrink: 0; }
        
        .toast-content { flex: 1; }
        
        .toast-title {
            font-weight: 600; color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 0.875rem; color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.error { border-left-color: var(--alert); }
        
        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        
        .loading { opacity: 0.6; pointer-events: none; }
        
        .text-center { text-align: center; }
        .text-mono { font-family: 'SF Mono', monospace; }
        
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-5 { margin-top: var(--space-5); }
        
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        
        /* ===== SAFE AREAS ===== */
        @supports (padding: max(0px)) {
            .main-content {
                padding-left: max(var(--space-4), env(safe-area-inset-left));
                padding-right: max(var(--space-4), env(safe-area-inset-right));
                padding-bottom: max(var(--space-4), env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-title">
                    <div class="app-logo">PM</div>
                    <div class="app-name">
                        <h1>PulmoMetrics</h1>
                        <span>Lung Transplant Monitor</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="settingsBtn" title="Settings">
                        ‚öôÔ∏è
                    </button>
                    <button class="header-btn" id="exportBtn" title="Export">
                        üì§
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Patient Bar -->
        <div class="patient-bar">
            <div class="patient-selector">
                <div class="patient-avatar" id="patientAvatar">PT</div>
                <div class="patient-info">
                    <span class="patient-id" id="patientId">No Patient Selected</span>
                    <div class="patient-meta">
                        <span>üìÖ TX: <span id="txDateDisplay">--</span></span>
                        <span>üìä Baseline: <span id="baselineDisplay">-- L</span></span>
                        <span>üîÑ Visits: <span id="visitsCount">0</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="newPatientBtn" title="New Patient">
                        üÜï
                    </button>
                    <button class="header-btn" id="patientListBtn" title="Patient List">
                        üë•
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="app-nav">
            <button class="nav-btn active" data-mode="quick">
                <span class="nav-icon">‚ö°</span>
                <span>Quick Calc</span>
            </button>
            <button class="nav-btn" data-mode="monitor">
                <span class="nav-icon">üìà</span>
                <span>First Year</span>
            </button>
            <button class="nav-btn" data-mode="full">
                <span class="nav-icon">üìã</span>
                <span>Full Study</span>
            </button>
            <button class="nav-btn" data-mode="review">
                <span class="nav-icon">üìä</span>
                <span>Review</span>
            </button>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Calc Mode -->
            <div id="modeQuick" class="mode-section active">
                <div class="card">
                    <div class="section-title">
                        <span>Quick Calculation</span>
                        <span class="badge">Current Visit</span>
                    </div>
                    
                    <div class="measurement-inputs">
                        <div class="input-group">
                            <div class="input-label">FEV‚ÇÅ</div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="8.0"
                                       class="calc-input" id="quickFev1"
                                       placeholder="2.85" autofocus>
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-label">FVC</div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="10.0"
                                       class="calc-input" id="quickFvc"
                                       placeholder="3.40">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Selector -->
                    <div class="comparison-selector">
                        <div class="comparison-title">Comparison Reference</div>
                        <div class="comparison-options">
                            <label class="comparison-option" id="optionNone">
                                <input type="radio" name="comparison" class="option-radio" value="none" checked>
                                <div class="option-content">
                                    <div class="option-label">Current values only</div>
                                    <div class="option-note">Show raw measurements without comparison</div>
                                </div>
                            </label>
                            
                            <label class="comparison-option" id="optionBaseline">
                                <input type="radio" name="comparison" class="option-radio" value="baseline">
                                <div class="option-content">
                                    <div class="option-label">vs Established Baseline</div>
                                    <input type="number" step="0.01" class="option-input" 
                                           id="baselineInput" placeholder="Enter baseline FEV‚ÇÅ (L)" disabled>
                                    <div class="option-note">Compare to post-transplant baseline value</div>
                                </div>
                            </label>
                            
                            <label class="comparison-option" id="optionLast">
                                <input type="radio" name="comparison" class="option-radio" value="last">
                                <div class="option-content">
                                    <div class="option-label">vs Last Visit</div>
                                    <div class="option-note" id="lastVisitNote">No previous visits found</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Results Container -->
                <div id="quickResults"></div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearQuickBtn">
                        <span>üóëÔ∏è</span>
                        <span>Clear</span>
                    </button>
                    <button class="action-btn primary" id="calculateQuickBtn">
                        <span>üßÆ</span>
                        <span>Calculate</span>
                    </button>
                </div>
            </div>
            
            <!-- First Year Monitor Mode -->
            <div id="modeMonitor" class="mode-section">
                <div class="card">
                    <div class="section-title">
                        <span>First Year Monitoring</span>
                        <span class="badge">Baseline Establishment</span>
                    </div>
                    
                    <!-- Visit Entry Form -->
                    <div class="add-visit-form">
                        <div class="form-row">
                            <div class="input-group">
                                <div class="input-label">Date</div>
                                <input type="date" class="date-input" id="visitDate">
                            </div>
                            <div class="input-group">
                                <div class="input-label">FEV‚ÇÅ</div>
                                <input type="number" step="0.01" class="calc-input" id="visitFev1"
                                       placeholder="2.85" style="font-size: 1rem;">
                            </div>
                            <div class="input-group">
                                <div class="input-label">FVC</div>
                                <input type="number" step="0.01" class="calc-input" id="visitFvc"
                                       placeholder="3.40" style="font-size: 1rem;">
                            </div>
                        </div>
                        <button class="action-btn secondary" id="addVisitBtn" style="width: 100%;">
                            <span>‚ûï</span>
                            <span>Add Visit</span>
                        </button>
                        
                        <!-- Bulk Entry -->
                        <div class="bulk-input-container">
                            <div class="bulk-input-label">
                                <span>üìã</span>
                                <span>Or enter multiple visits:</span>
                            </div>
                            <textarea class="bulk-textarea" id="bulkInput" 
                                      placeholder="Format (one per line):
2024-01-15, 2.85, 3.40
2024-03-10, 3.10, 3.80
2024-05-05, 2.95, 3.60"></textarea>
                            <div class="bulk-hint">
                                Format: YYYY-MM-DD, FEV‚ÇÅ, FVC (optional)
                            </div>
                            <button class="action-btn secondary mt-3" id="parseBulkBtn" style="width: 100%;">
                                <span>üì•</span>
                                <span>Parse Visits</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Visits Table -->
                    <div class="visits-table-container">
                        <table class="visits-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Days Post-Tx</th>
                                    <th>FEV‚ÇÅ (L)</th>
                                    <th>FVC (L)</th>
                                    <th>Œî FEV‚ÇÅ</th>
                                    <th>Œî %</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="visitsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center" style="padding: var(--space-6); color: var(--text-tertiary);">
                                        No visits added yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Baseline Calculation -->
                    <div class="baseline-card hidden" id="baselineCard">
                        <div class="baseline-header">
                            <div class="baseline-title">Baseline Calculation</div>
                            <button class="header-btn" id="calculateBaselineBtn">
                                üîÑ
                            </button>
                        </div>
                        
                        <div class="baseline-values" id="baselineValues">
                            <!-- Baseline calculation will be inserted here -->
                        </div>
                        
                        <div class="baseline-actions">
                            <button class="action-btn secondary" id="cancelBaselineBtn">
                                Cancel
                            </button>
                            <button class="action-btn primary" id="saveBaselineBtn">
                                Save as Baseline
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearVisitsBtn">
                        <span>üóëÔ∏è</span>
                        <span>Clear All</span>
                    </button>
                    <button class="action-btn primary" id="saveVisitsBtn">
                        <span>üíæ</span>
                        <span>Save Visits</span>
                    </button>
                </div>
            </div>
            
            <!-- Full Study Mode -->
            <div id="modeFull" class="mode-section">
                <div class="card">
                    <div class="section-title">
                        <span>Full Patient Study</span>
                        <span class="badge" id="fullPatientBadge">--</span>
                    </div>
                    
                    <!-- Timeline Setup -->
                    <div class="timeline-setup">
                        <div class="input-label">Patient Timeline</div>
                        <div class="timeline-inputs">
                            <div class="input-group">
                                <div class="input-label">Transplant Date</div>
                                <input type="date" class="date-input" id="txDate" max="">
                            </div>
                            <div class="input-group">
                                <div class="input-label">Baseline Established</div>
                                <input type="date" class="date-input" id="baselineDate" max="">
                            </div>
                        </div>
                        
                        <div class="timeline-display">
                            <div class="timeline-row">
                                <span class="timeline-label">Time Post-Transplant</span>
                                <span class="timeline-value" id="timePostTx">--</span>
                            </div>
                            <div class="timeline-row">
                                <span class="timeline-label">Time Since Baseline</span>
                                <span class="timeline-value" id="timeSinceBaseline">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Spirometry Inputs -->
                    <div class="measurement-inputs">
                        <div class="input-group">
                            <div class="input-label">Current FEV‚ÇÅ</div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" class="calc-input" id="stdFev1"
                                       placeholder="Enter FEV‚ÇÅ">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">Baseline FEV‚ÇÅ</div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" class="calc-input" id="stdBaselineFev1"
                                       placeholder="Enter baseline">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clinical Notes -->
                    <div class="clinical-notes-section">
                        <div class="input-label">Clinical Context</div>
                        <textarea class="notes-textarea" id="clinicalNotes"
                                  placeholder="Enter clinical context, symptoms, medications, or other relevant information..."></textarea>
                    </div>
                </div>
                
                <!-- Full Study Results -->
                <div id="fullResults"></div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearFullBtn">
                        <span>üóëÔ∏è</span>
                        <span>Clear All</span>
                    </button>
                    <button class="action-btn primary" id="calculateFullBtn">
                        <span>üßÆ</span>
                        <span>Calculate & Save</span>
                    </button>
                </div>
            </div>
            
            <!-- Review Mode -->
            <div id="modeReview" class="mode-section">
                <div class="card">
                    <div class="section-title">
                        <span>Patient Review</span>
                        <span class="badge" id="reviewPatientBadge">--</span>
                    </div>
                    
                    <!-- Patient Summary -->
                    <div class="patient-summary">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="reviewTxDays">--</div>
                                <div class="summary-label">Days Post-Tx</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="reviewVisits">--</div>
                                <div class="summary-label">Total Visits</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="reviewLastFev1">--</div>
                                <div class="summary-label">Last FEV‚ÇÅ</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="reviewBestFev1">--</div>
                                <div class="summary-label">Best FEV‚ÇÅ</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visit History -->
                    <div class="visits-list" id="reviewVisitsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>No visit history available</p>
                            <p class="bulk-hint mt-2">Start by entering measurements</p>
                        </div>
                    </div>
                </div>
                
                <!-- Review Actions -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="exportReviewBtn">
                        <span>üì§</span>
                        <span>Export Patient</span>
                    </button>
                    <button class="action-btn primary" id="newAnalysisBtn">
                        <span>üìù</span>
                        <span>New Analysis</span>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Modals will be inserted dynamically -->
    
    <!-- JavaScript -->
    <script>
    // ============================================
    // PULMOMETRICS - COMPLETE SPA PWA
    // ============================================
    
    class PulmoMetrics {
        constructor() {
            this.state = {
                mode: 'quick',
                currentPatient: null,
                patients: new Map(),
                settings: {
                    thresholds: { monitor: 10, review: 20, action: 35 }
                },
                sessionVisits: [] // Temporary visits for current session
            };
            
            this.init();
        }
        
        init() {
            this.setupEventListeners();
            this.loadState();
            this.setupPWA();
            this.setTodayDates();
            this.updateUI();
            
            console.log('üöÄ PulmoMetrics initialized');
        }
        
        setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
            });
            
            // Header actions
            document.getElementById('settingsBtn').addEventListener('click', () => this.showSettingsModal());
            document.getElementById('exportBtn').addEventListener('click', () => this.exportAllData());
            document.getElementById('newPatientBtn').addEventListener('click', () => this.showNewPatientModal());
            document.getElementById('patientListBtn').addEventListener('click', () => this.showPatientListModal());
            
            // Quick Calc Mode
            document.getElementById('calculateQuickBtn').addEventListener('click', () => this.calculateQuick());
            document.getElementById('clearQuickBtn').addEventListener('click', () => this.clearQuick());
            
            // Comparison selection
            ['optionNone', 'optionBaseline', 'optionLast'].forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => this.handleComparisonSelection(e));
            });
            document.getElementById('baselineInput').addEventListener('input', () => this.handleComparisonChange());
            
            // First Year Monitor Mode
            document.getElementById('addVisitBtn').addEventListener('click', () => this.addVisit());
            document.getElementById('parseBulkBtn').addEventListener('click', () => this.parseBulkVisits());
            document.getElementById('calculateBaselineBtn').addEventListener('click', () => this.calculateBaseline());
            document.getElementById('saveBaselineBtn').addEventListener('click', () => this.saveBaseline());
            document.getElementById('cancelBaselineBtn').addEventListener('click', () => this.hideBaselineCard());
            document.getElementById('clearVisitsBtn').addEventListener('click', () => this.clearVisits());
            document.getElementById('saveVisitsBtn').addEventListener('click', () => this.saveVisits());
            
            // Full Study Mode
            document.getElementById('txDate').addEventListener('change', () => this.updateTimeline());
            document.getElementById('baselineDate').addEventListener('change', () => this.updateTimeline());
            document.getElementById('calculateFullBtn').addEventListener('click', () => this.calculateFull());
            document.getElementById('clearFullBtn').addEventListener('click', () => this.clearFull());
            
            // Review Mode
            document.getElementById('exportReviewBtn').addEventListener('click', () => this.exportPatientData());
            document.getElementById('newAnalysisBtn').addEventListener('click', () => this.switchMode('quick'));
        }
        
        // ===== MODE MANAGEMENT =====
        switchMode(mode) {
            this.state.mode = mode;
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Show/hide modes
            document.querySelectorAll('.mode-section').forEach(section => {
                section.classList.toggle('active', section.id === `mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
            });
            
            // Load mode-specific data
            if (mode === 'monitor') {
                this.updateVisitsTable();
            } else if (mode === 'full') {
                this.loadPatientDataToFullMode();
            } else if (mode === 'review') {
                this.updateReviewMode();
            }
        }
        
        // ===== QUICK CALC MODE =====
        handleComparisonSelection(event) {
            const option = event.currentTarget;
            const radio = option.querySelector('.option-radio');
            radio.checked = true;
            
            // Update UI
            ['optionNone', 'optionBaseline', 'optionLast'].forEach(id => {
                const opt = document.getElementById(id);
                opt.classList.toggle('selected', opt.querySelector('.option-radio').checked);
            });
            
            // Enable/disable baseline input
            document.getElementById('baselineInput').disabled = radio.value !== 'baseline';
            
            if (radio.value === 'baseline') {
                document.getElementById('baselineInput').focus();
            }
        }
        
        handleComparisonChange() {
            // Just enable the input, calculation happens when Calculate is clicked
        }
        
        calculateQuick() {
            const fev1 = parseFloat(document.getElementById('quickFev1').value);
            const fvc = parseFloat(document.getElementById('quickFvc').value);
            
            if (!fev1 || !fvc) {
                this.showToast('Enter both FEV‚ÇÅ and FVC values', 'warning');
                return;
            }
            
            const ratio = (fev1 / fvc * 100).toFixed(1);
            const comparisonType = document.querySelector('input[name="comparison"]:checked').value;
            
            let html = `
                <div class="card">
                    <div class="section-title">
                        <span>Results</span>
                        <span class="badge">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-label">FEV‚ÇÅ</div>
                            <div class="result-value">${fev1.toFixed(2)}</div>
                            <div class="result-unit">Liters</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">FVC</div>
                            <div class="result-value">${fvc.toFixed(2)}</div>
                            <div class="result-unit">Liters</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">FEV‚ÇÅ/FVC</div>
                            <div class="result-value">${ratio}</div>
                            <div class="result-unit">Percentage</div>
                        </div>
                    </div>
            `;
            
            // Add comparison if selected
            if (comparisonType !== 'none') {
                let comparisonValue = null;
                let comparisonLabel = '';
                
                if (comparisonType === 'baseline') {
                    comparisonValue = parseFloat(document.getElementById('baselineInput').value);
                    if (!comparisonValue || isNaN(comparisonValue)) {
                        this.showToast('Enter baseline value for comparison', 'warning');
                        return;
                    }
                    comparisonLabel = 'Baseline';
                } else if (comparisonType === 'last') {
                    if (!this.state.currentPatient) {
                        this.showToast('No patient selected for last visit comparison', 'warning');
                        return;
                    }
                    const patient = this.state.patients.get(this.state.currentPatient);
                    if (!patient || patient.visits.length === 0) {
                        this.showToast('No previous visits found', 'warning');
                        return;
                    }
                    const lastVisit = patient.visits[patient.visits.length - 1];
                    comparisonValue = lastVisit.fev1;
                    comparisonLabel = 'Last Visit';
                }
                
                if (comparisonValue) {
                    const delta = fev1 - comparisonValue;
                    const percent = (delta / comparisonValue * 100).toFixed(1);
                    
                    html += `
                        <div class="comparison-results">
                            <div class="section-title">
                                <span>vs ${comparisonLabel}</span>
                                <span>${comparisonValue.toFixed(2)} L</span>
                            </div>
                            
                            <div class="metric-row">
                                <div class="metric-label">Absolute Change</div>
                                <div class="metric-value ${delta >= 0 ? 'positive' : 'negative'}">${Math.abs(delta).toFixed(2)}</div>
                                <div class="metric-unit">L</div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">Percentage Change</div>
                                <div class="metric-value ${parseFloat(percent) >= 0 ? 'positive' : 'negative'}">${Math.abs(percent)}</div>
                                <div class="metric-unit">%</div>
                            </div>
                        </div>
                        
                        <div class="protocol-context">
                            <div class="threshold-display">
                                <div class="threshold-badge monitor">Monitor ‚â•${this.state.settings.thresholds.monitor}%</div>
                                <div class="threshold-badge review">Review ‚â•${this.state.settings.thresholds.review}%</div>
                                <div class="threshold-badge action">Action ‚â•${this.state.settings.thresholds.action}%</div>
                            </div>
                            <div class="protocol-note">
                                <strong>Note:</strong> Objective measurements shown. Clinical interpretation required based on your protocol thresholds.
                            </div>
                        </div>
                    `;
                }
            }
            
            html += `</div>`;
            document.getElementById('quickResults').innerHTML = html;
            this.showToast('Calculation complete', 'success');
        }
        
        clearQuick() {
            document.getElementById('quickFev1').value = '';
            document.getElementById('quickFvc').value = '';
            document.getElementById('baselineInput').value = '';
            document.getElementById('quickResults').innerHTML = '';
            document.getElementById('quickFev1').focus();
        }
        
        // ===== FIRST YEAR MONITOR MODE =====
        addVisit() {
            const date = document.getElementById('visitDate').value;
            const fev1 = parseFloat(document.getElementById('visitFev1').value);
            const fvc = parseFloat(document.getElementById('visitFvc').value);
            
            if (!date || !fev1 || isNaN(fev1)) {
                this.showToast('Enter valid date and FEV‚ÇÅ value', 'warning');
                return;
            }
            
            const visit = {
                id: Date.now(),
                date,
                fev1,
                fvc: fvc || null,
                addedAt: new Date().toISOString()
            };
            
            this.state.sessionVisits.push(visit);
            this.updateVisitsTable();
            
            // Clear form
            document.getElementById('visitFev1').value = '';
            document.getElementById('visitFvc').value = '';
            document.getElementById('visitFev1').focus();
            
            this.showToast('Visit added', 'success');
        }
        
        parseBulkVisits() {
            const text = document.getElementById('bulkInput').value.trim();
            if (!text) {
                this.showToast('Enter visits to parse', 'warning');
                return;
            }
            
            const lines = text.split('\n');
            const newVisits = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                // Try different separators
                const parts = line.split(/[, \t]+/).filter(p => p);
                
                if (parts.length >= 2) {
                    const date = parts[0];
                    const fev1 = parseFloat(parts[1]);
                    const fvc = parts[2] ? parseFloat(parts[2]) : null;
                    
                    if (this.isValidDate(date) && !isNaN(fev1)) {
                        newVisits.push({
                            id: Date.now() + index,
                            date,
                            fev1,
                            fvc,
                            addedAt: new Date().toISOString()
                        });
                    } else {
                        errors.push(`Line ${index + 1}: Invalid format`);
                    }
                } else {
                    errors.push(`Line ${index + 1}: Requires at least date and FEV‚ÇÅ`);
                }
            });
            
            if (newVisits.length > 0) {
                this.state.sessionVisits.push(...newVisits);
                this.updateVisitsTable();
                this.showToast(`Parsed ${newVisits.length} visits`, 'success');
                document.getElementById('bulkInput').value = '';
                
                if (errors.length > 0) {
                    console.warn('Parse errors:', errors);
                }
            } else {
                this.showToast('Could not parse any valid visits', 'error');
            }
        }
        
        isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) return false;
            
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }
        
        updateVisitsTable() {
            const tbody = document.getElementById('visitsTableBody');
            
            if (this.state.sessionVisits.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: var(--space-6); color: var(--text-tertiary);">
                            No visits added yet
                        </td>
                    </tr>
                `;
                document.getElementById('baselineCard').classList.add('hidden');
                return;
            }
            
            // Sort visits by date
            const sortedVisits = [...this.state.sessionVisits].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            let html = '';
            let lastFev1 = null;
            
            sortedVisits.forEach((visit, index) => {
                const date = new Date(visit.date);
                const daysPostTx = this.state.currentPatient && this.state.patients.get(this.state.currentPatient)?.txDate
                    ? this.daysBetween(date, new Date(this.state.patients.get(this.state.currentPatient).txDate))
                    : '--';
                
                const delta = lastFev1 !== null ? visit.fev1 - lastFev1 : null;
                const deltaPercent = delta !== null ? ((delta / lastFev1) * 100).toFixed(1) : null;
                
                html += `
                    <tr>
                        <td class="text-mono">${date.toLocaleDateString()}</td>
                        <td class="text-mono">${daysPostTx}</td>
                        <td class="text-mono" style="font-weight: 600;">${visit.fev1.toFixed(2)}</td>
                        <td class="text-mono">${visit.fvc ? visit.fvc.toFixed(2) : '--'}</td>
                        <td class="text-mono ${delta !== null ? (delta >= 0 ? 'value-positive' : 'value-negative') : ''}">
                            ${delta !== null ? (delta >= 0 ? '+' : '') + delta.toFixed(2) : '--'}
                        </td>
                        <td class="text-mono ${deltaPercent !== null ? (parseFloat(deltaPercent) >= 0 ? 'value-positive' : 'value-negative') : ''}">
                            ${deltaPercent !== null ? (parseFloat(deltaPercent) >= 0 ? '+' : '') + deltaPercent + '%' : '--'}
                        </td>
                        <td>
                            <div class="visit-actions">
                                <button class="visit-action-btn" onclick="app.removeVisit(${visit.id})" title="Remove">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                lastFev1 = visit.fev1;
            });
            
            tbody.innerHTML = html;
            
            // Show baseline card if enough visits
            if (this.state.sessionVisits.length >= 2) {
                document.getElementById('baselineCard').classList.remove('hidden');
            }
        }
        
        removeVisit(id) {
            this.state.sessionVisits = this.state.sessionVisits.filter(v => v.id !== id);
            this.updateVisitsTable();
            this.showToast('Visit removed', 'success');
        }
        
        calculateBaseline() {
            if (this.state.sessionVisits.length < 2) {
                this.showToast('Need at least 2 visits', 'warning');
                return;
            }
            
            // Get two highest FEV‚ÇÅ values
            const sortedByFev1 = [...this.state.sessionVisits].sort((a, b) => b.fev1 - a.fev1);
            const highest = sortedByFev1[0];
            const secondHighest = sortedByFev1[1];
            const baseline = (highest.fev1 + secondHighest.fev1) / 2;
            
            const html = `
                <div class="baseline-value">
                    <span class="baseline-label">Highest FEV‚ÇÅ</span>
                    <span class="baseline-number">${highest.fev1.toFixed(2)} L</span>
                </div>
                <div class="baseline-value">
                    <span class="baseline-label">Second Highest</span>
                    <span class="baseline-number">${secondHighest.fev1.toFixed(2)} L</span>
                </div>
                <div class="baseline-value" style="border-top: 2px solid var(--primary); padding-top: var(--space-3);">
                    <span class="baseline-label" style="font-weight: 700;">Calculated Baseline</span>
                    <span class="baseline-number" style="font-size: 1.25rem;">${baseline.toFixed(2)} L</span>
                </div>
            `;
            
            document.getElementById('baselineValues').innerHTML = html;
        }
        
        saveBaseline() {
            if (!this.state.currentPatient) {
                this.showToast('Select a patient first', 'warning');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            // Calculate baseline from current session visits
            if (this.state.sessionVisits.length >= 2) {
                const sortedByFev1 = [...this.state.sessionVisits].sort((a, b) => b.fev1 - a.fev1);
                const baseline = (sortedByFev1[0].fev1 + sortedByFev1[1].fev1) / 2;
                
                patient.baselineFev1 = baseline;
                patient.baselineDate = new Date().toISOString().split('T')[0];
                patient.updatedAt = new Date().toISOString();
                
                this.saveState();
                this.updatePatientDisplay();
                this.showToast(`Baseline set to ${baseline.toFixed(2)} L`, 'success');
                this.hideBaselineCard();
            }
        }
        
        hideBaselineCard() {
            document.getElementById('baselineCard').classList.add('hidden');
        }
        
        clearVisits() {
            if (this.state.sessionVisits.length === 0) return;
            
            if (confirm('Clear all visits?')) {
                this.state.sessionVisits = [];
                this.updateVisitsTable();
                this.showToast('All visits cleared', 'success');
            }
        }
        
        saveVisits() {
            if (!this.state.currentPatient) {
                this.showToast('Select a patient first', 'warning');
                return;
            }
            
            if (this.state.sessionVisits.length === 0) {
                this.showToast('No visits to save', 'warning');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (patient) {
                // Add session visits to patient
                patient.visits = [...(patient.visits || []), ...this.state.sessionVisits];
                patient.updatedAt = new Date().toISOString();
                
                this.saveState();
                this.updatePatientDisplay();
                this.state.sessionVisits = [];
                this.updateVisitsTable();
                
                this.showToast(`Saved ${patient.visits.length} visits to ${patient.id}`, 'success');
            }
        }
        
        // ===== FULL STUDY MODE =====
        loadPatientDataToFullMode() {
            if (!this.state.currentPatient) return;
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            // Update patient badge
            document.getElementById('fullPatientBadge').textContent = patient.id;
            
            // Load patient data
            if (patient.txDate) {
                document.getElementById('txDate').value = patient.txDate;
            }
            if (patient.baselineDate) {
                document.getElementById('baselineDate').value = patient.baselineDate;
            }
            if (patient.baselineFev1) {
                document.getElementById('stdBaselineFev1').value = patient.baselineFev1;
            }
            
            this.updateTimeline();
        }
        
        updateTimeline() {
            const txDate = document.getElementById('txDate').value;
            const baselineDate = document.getElementById('baselineDate').value;
            
            if (txDate) {
                const daysPostTx = this.daysBetween(new Date(), new Date(txDate));
                document.getElementById('timePostTx').textContent = `${daysPostTx} days`;
            }
            
            if (baselineDate) {
                const daysSinceBaseline = this.daysBetween(new Date(), new Date(baselineDate));
                document.getElementById('timeSinceBaseline').textContent = `${daysSinceBaseline} days`;
            }
        }
        
        calculateFull() {
            const fev1 = parseFloat(document.getElementById('stdFev1').value);
            const baselineFev1 = parseFloat(document.getElementById('stdBaselineFev1').value);
            const notes = document.getElementById('clinicalNotes').value;
            
            if (!fev1 || !baselineFev1) {
                this.showToast('Enter both current and baseline FEV‚ÇÅ values', 'warning');
                return;
            }
            
            const delta = fev1 - baselineFev1;
            const percent = (delta / baselineFev1 * 100).toFixed(1);
            const daysSinceBaseline = document.getElementById('timeSinceBaseline').textContent.replace(' days', '');
            const monthlyRate = daysSinceBaseline !== '--' ? (delta / (parseInt(daysSinceBaseline) / 30.44)).toFixed(3) : '--';
            
            let html = `
                <div class="card">
                    <div class="section-title">
                        <span>Comprehensive Analysis</span>
                        <span class="badge">${new Date().toLocaleDateString()}</span>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-label">Current FEV‚ÇÅ</div>
                            <div class="result-value">${fev1.toFixed(2)}</div>
                            <div class="result-unit">Liters</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Baseline</div>
                            <div class="result-value">${baselineFev1.toFixed(2)}</div>
                            <div class="result-unit">Liters</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">Time Period</div>
                            <div class="result-value">${daysSinceBaseline}</div>
                            <div class="result-unit">Days</div>
                        </div>
                    </div>
                    
                    <div class="comparison-results">
                        <div class="section-title">
                            <span>vs Baseline</span>
                            <span>${baselineFev1.toFixed(2)} L</span>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">Cumulative Change</div>
                            <div class="metric-value ${delta >= 0 ? 'positive' : 'negative'}">${Math.abs(delta).toFixed(2)}</div>
                            <div class="metric-unit">L</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-label">Percentage Change</div>
                            <div class="metric-value ${parseFloat(percent) >= 0 ? 'positive' : 'negative'}">${Math.abs(percent)}</div>
                            <div class="metric-unit">%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-label">Monthly Rate</div>
                            <div class="metric-value ${monthlyRate !== '--' && parseFloat(monthlyRate) >= 0 ? 'positive' : 'negative'}">${Math.abs(monthlyRate)}</div>
                            <div class="metric-unit">L/month</div>
                        </div>
                    </div>
                    
                    <div class="protocol-context">
                        <div class="threshold-display">
                            <div class="threshold-badge monitor">Monitor ‚â•${this.state.settings.thresholds.monitor}%</div>
                            <div class="threshold-badge review">Review ‚â•${this.state.settings.thresholds.review}%</div>
                            <div class="threshold-badge action">Action ‚â•${this.state.settings.thresholds.action}%</div>
                        </div>
                        <div class="protocol-note">
                            <strong>Long-term Trend:</strong> Objective measurements shown. Clinical interpretation required based on your protocol thresholds.
                            ${notes ? `<br><br><strong>Clinical Notes:</strong> ${notes}` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('fullResults').innerHTML = html;
            this.showToast('Full analysis complete', 'success');
        }
        
        clearFull() {
            document.getElementById('txDate').value = '';
            document.getElementById('baselineDate').value = '';
            document.getElementById('stdFev1').value = '';
            document.getElementById('stdBaselineFev1').value = '';
            document.getElementById('clinicalNotes').value = '';
            document.getElementById('fullResults').innerHTML = '';
            document.getElementById('timePostTx').textContent = '--';
            document.getElementById('timeSinceBaseline').textContent = '--';
        }
        
        // ===== REVIEW MODE =====
        updateReviewMode() {
            if (!this.state.currentPatient) {
                document.getElementById('reviewPatientBadge').textContent = '--';
                document.getElementById('reviewVisitsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Select a patient to review</p>
                    </div>
                `;
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            document.getElementById('reviewPatientBadge').textContent = patient.id;
            
            // Update summary
            if (patient.txDate) {
                const daysPostTx = this.daysBetween(new Date(), new Date(patient.txDate));
                document.getElementById('reviewTxDays').textContent = daysPostTx;
            } else {
                document.getElementById('reviewTxDays').textContent = '--';
            }
            
            document.getElementById('reviewVisits').textContent = patient.visits ? patient.visits.length : 0;
            
            if (patient.visits && patient.visits.length > 0) {
                const lastVisit = patient.visits[patient.visits.length - 1];
                document.getElementById('reviewLastFev1').textContent = lastVisit.fev1.toFixed(2);
                
                // Find best FEV1
                const bestFev1 = Math.max(...patient.visits.map(v => v.fev1));
                document.getElementById('reviewBestFev1').textContent = bestFev1.toFixed(2);
                
                // Update visit list
                this.updateReviewVisitList(patient.visits);
            } else {
                document.getElementById('reviewLastFev1').textContent = '--';
                document.getElementById('reviewBestFev1').textContent = '--';
                document.getElementById('reviewVisitsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No visit history available</p>
                        <p class="bulk-hint mt-2">Start by entering measurements</p>
                    </div>
                `;
            }
        }
        
        updateReviewVisitList(visits) {
            const container = document.getElementById('reviewVisitsList');
            
            if (!visits || visits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No visit history available</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            [...visits].reverse().forEach(visit => {
                const date = new Date(visit.date);
                html += `
                    <div class="visit-card">
                        <div class="visit-date">
                            ${date.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'
                            })}
                        </div>
                        <div class="visit-values">
                            <span class="visit-fev1">${visit.fev1.toFixed(2)} L</span>
                            ${visit.fvc ? `<span style="color: var(--secondary);">${visit.fvc.toFixed(2)} L</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ===== PATIENT MANAGEMENT =====
        showNewPatientModal() {
            // Simple implementation - can be expanded with a proper modal
            const patientId = prompt('Enter Patient ID (e.g., PT001):');
            if (!patientId) return;
            
            const txDate = prompt('Transplant Date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!txDate) return;
            
            const patient = {
                id: patientId.toUpperCase(),
                txDate,
                description: '',
                visits: [],
                baselineFev1: null,
                baselineDate: null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            this.state.patients.set(patient.id, patient);
            this.state.currentPatient = patient.id;
            this.state.sessionVisits = []; // Clear session when switching patient
            
            this.updatePatientDisplay();
            this.saveState();
            this.showToast(`Patient ${patient.id} created`, 'success');
        }
        
        showPatientListModal() {
            // Simple implementation
            if (this.state.patients.size === 0) {
                alert('No patients yet');
                return;
            }
            
            let list = 'Select patient:\n\n';
            this.state.patients.forEach(patient => {
                list += `${patient.id} (${patient.visits ? patient.visits.length : 0} visits)\n`;
            });
            
            const choice = prompt(list + '\nEnter Patient ID:');
            if (choice && this.state.patients.has(choice.toUpperCase())) {
                this.state.currentPatient = choice.toUpperCase();
                this.state.sessionVisits = []; // Clear session when switching patient
                this.updatePatientDisplay();
                this.showToast(`Switched to ${choice}`, 'success');
            }
        }
        
        showSettingsModal() {
            // Simple settings - can be expanded
            const monitor = prompt('Monitor threshold (%):', this.state.settings.thresholds.monitor);
            const review = prompt('Review threshold (%):', this.state.settings.thresholds.review);
            const action = prompt('Action threshold (%):', this.state.settings.thresholds.action);
            
            if (monitor && review && action) {
                this.state.settings.thresholds = {
                    monitor: parseInt(monitor),
                    review: parseInt(review),
                    action: parseInt(action)
                };
                this.saveState();
                this.showToast('Settings updated', 'success');
            }
        }
        
        updatePatientDisplay() {
            const avatar = document.getElementById('patientAvatar');
            const patientId = document.getElementById('patientId');
            const txDateDisplay = document.getElementById('txDateDisplay');
            const baselineDisplay = document.getElementById('baselineDisplay');
            const visitsCount = document.getElementById('visitsCount');
            
            if (!this.state.currentPatient) {
                avatar.textContent = 'PT';
                patientId.textContent = 'No Patient Selected';
                txDateDisplay.textContent = '--';
                baselineDisplay.textContent = '-- L';
                visitsCount.textContent = '0';
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            avatar.textContent = patient.id.substring(0, 2);
            patientId.textContent = patient.id;
            
            if (patient.txDate) {
                txDateDisplay.textContent = new Date(patient.txDate).toLocaleDateString();
            } else {
                txDateDisplay.textContent = '--';
            }
            
            if (patient.baselineFev1) {
                baselineDisplay.textContent = `${patient.baselineFev1.toFixed(2)} L`;
            } else {
                baselineDisplay.textContent = '-- L';
            }
            
            visitsCount.textContent = patient.visits ? patient.visits.length : 0;
            
            // Update last visit note in Quick Calc
            if (patient.visits && patient.visits.length > 0) {
                const lastVisit = patient.visits[patient.visits.length - 1];
                const lastDate = new Date(lastVisit.date);
                document.getElementById('lastVisitNote').textContent = 
                    `${lastVisit.fev1.toFixed(2)} L on ${lastDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    })}`;
            } else {
                document.getElementById('lastVisitNote').textContent = 'No previous visits';
            }
            
            // Update baseline input if patient has baseline
            if (patient.baselineFev1) {
                document.getElementById('baselineInput').value = patient.baselineFev1;
            }
        }
        
        // ===== EXPORT/IMPORT =====
        exportPatientData() {
            if (!this.state.currentPatient) {
                this.showToast('Select a patient first', 'warning');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            const data = {
                patient: patient,
                exportedAt: new Date().toISOString(),
                app: 'PulmoMetrics'
            };
            
            this.downloadJSON(data, `pulmometrics-${patient.id}-${new Date().toISOString().split('T')[0]}.json`);
            this.showToast('Patient data exported', 'success');
        }
        
        exportAllData() {
            const data = {
                patients: Array.from(this.state.patients.values()),
                currentPatient: this.state.currentPatient,
                settings: this.state.settings,
                exportedAt: new Date().toISOString(),
                app: 'PulmoMetrics',
                version: '1.0.0'
            };
            
            this.downloadJSON(data, `pulmometrics-full-export-${new Date().toISOString().split('T')[0]}.json`);
            this.showToast('All data exported', 'success');
        }
        
        downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ===== UTILITIES =====
        daysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diff = Math.abs(d2 - d1);
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }
        
        showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå', info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        updateUI() {
            this.updatePatientDisplay();
            this.setTodayDates();
            
            // Auto-focus first input
            setTimeout(() => {
                const input = document.getElementById('quickFev1');
                if (input) input.focus();
            }, 100);
        }
        
        setTodayDates() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
                input.max = today;
            });
        }
        
        // ===== STATE MANAGEMENT =====
        loadState() {
            try {
                const saved = localStorage.getItem('pulmometrics_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    if (data.patients && Array.isArray(data.patients)) {
                        data.patients.forEach(patient => {
                            this.state.patients.set(patient.id, patient);
                        });
                    }
                    
                    if (data.currentPatient && this.state.patients.has(data.currentPatient)) {
                        this.state.currentPatient = data.currentPatient;
                    }
                    
                    if (data.settings) {
                        this.state.settings = data.settings;
                    }
                    
                    console.log('üìÅ Loaded state:', this.state.patients.size, 'patients');
                }
            } catch (error) {
                console.error('Failed to load state:', error);
            }
        }
        
        saveState() {
            try {
                const data = {
                    patients: Array.from(this.state.patients.values()),
                    currentPatient: this.state.currentPatient,
                    settings: this.state.settings,
                    savedAt: new Date().toISOString(),
                    version: '1.0.0'
                };
                
                localStorage.setItem('pulmometrics_state', JSON.stringify(data));
            } catch (error) {
                console.error('Failed to save state:', error);
                this.showToast('Failed to save data', 'error');
            }
        }
        
        // ===== PWA SETUP =====
        setupPWA() {
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('‚úÖ Service Worker registered'))
                    .catch(err => console.error('‚ùå Service Worker failed:', err));
            }
            
            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button
                const installBtn = document.createElement('button');
                installBtn.textContent = 'üì± Install App';
                installBtn.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px;
                    background: var(--primary); color: white;
                    padding: 10px 20px; border: none; border-radius: 25px;
                    font-weight: bold; z-index: 1000; cursor: pointer;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User ${outcome} the install`);
                    installBtn.remove();
                    deferredPrompt = null;
                });
                
                document.body.appendChild(installBtn);
            });
        }
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
        window.app = new PulmoMetrics();
        
        // Fix iOS 100vh issue
        function setVH() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);
    });
    </script>
</body>
</html>
