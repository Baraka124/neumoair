<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1E6EA6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Objective calculation tool for lung transplant monitoring. No diagnosis, just metrics.">
    
    <title>NeumoCalc | Lung Transplant Calculator</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            line-height: 1.6;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* ===== APP CONTAINER ===== */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
        }
        
        /* ===== WELCOME SCREEN ===== */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            background: linear-gradient(135deg, #1E6EA6 0%, #155588 100%);
            animation: fadeIn 1s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo {
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .logo-icon {
            font-size: 3rem;
        }
        
        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .welcome-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 3rem;
            max-width: 400px;
        }
        
        /* ===== MAIN APP (Hidden initially) ===== */
        .main-app {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #f8fafc;
            color: #1f2937;
        }
        
        /* ===== HEADER ===== */
        .app-header {
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .session-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .patient-id {
            font-weight: 600;
            color: #1E6EA6;
            font-family: 'Courier New', monospace;
        }
        
        .session-status {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: 1rem;
            padding-bottom: 100px; /* Space for bottom nav */
        }
        
        /* ===== SECTIONS ===== */
        .section {
            display: none;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section.active {
            display: block;
        }
        
        /* ===== CARD DESIGN ===== */
        .card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1E6EA6;
            margin-bottom: 0.5rem;
        }
        
        .card-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }
        
        /* ===== FORM ELEMENTS ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: white;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1E6EA6;
            box-shadow: 0 0 0 3px rgba(30, 110, 166, 0.1);
        }
        
        .form-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.375rem;
            font-style: italic;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 56px;
            width: 100%;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1E6EA6 0%, #155588 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 110, 166, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 110, 166, 0.4);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #1E6EA6;
            color: #1E6EA6;
        }
        
        .btn-outline:hover {
            background: #f0f9ff;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        /* ===== PATH SELECTION ===== */
        .path-selection {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 2rem 0;
        }
        
        @media (min-width: 640px) {
            .path-selection {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .path-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .path-card:hover {
            border-color: #1E6EA6;
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .path-card.active {
            border-color: #1E6EA6;
            background: #f0f9ff;
        }
        
        .path-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .path-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1E6EA6;
        }
        
        .path-desc {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* ===== RESULTS DISPLAY ===== */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .result-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, #1E6EA6, #059669);
        }
        
        .result-value {
            font-family: 'Courier New', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: #1E6EA6;
            margin-bottom: 0.25rem;
        }
        
        .result-label {
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
        
        .result-sub {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        /* ===== BOS INDICATOR ===== */
        .bos-indicator {
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            text-align: center;
        }
        
        .bos-indicator.bos0 {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .bos-indicator.bos0p {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 2px solid #f59e0b;
        }
        
        .bos-indicator.bos1 {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .bos-indicator.bos2-3 {
            background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%);
            color: #7f1d1d;
            border: 2px solid #dc2626;
        }
        
        .bos-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .bos-desc {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        /* ===== VISIT HISTORY ===== */
        .visit-input-row {
            background: #f9fafb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .visit-number {
            font-weight: 600;
            color: #1E6EA6;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .visit-number::before {
            content: 'üìÖ';
            font-size: 1.25rem;
        }
        
        /* ===== STABILITY VISUALIZATION ===== */
        .stability-chart {
            height: 200px;
            background: #f8fafc;
            border-radius: 12px;
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .chart-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #1E6EA6;
            opacity: 0.3;
        }
        
        .data-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #1E6EA6;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translate(-50%, 50%);
        }
        
        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 0.75rem;
            padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            display: flex;
            gap: 0.5rem;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        
        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            padding: 0.75rem 0.5rem;
            border-radius: 12px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 500;
            min-height: 64px;
        }
        
        .nav-btn i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
            font-style: normal;
        }
        
        .nav-btn.active {
            color: #1E6EA6;
            background: #f0f9ff;
        }
        
        .nav-btn:hover {
            background: #f9fafb;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #1f2937;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            border-left: 4px solid #1E6EA6;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast.success {
            border-left-color: #059669;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .toast.error {
            border-left-color: #dc2626;
        }
        
        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top-color: #1E6EA6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .welcome-title {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .card {
                padding: 1.25rem;
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        
        .font-mono {
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="app" id="welcomeScreen">
        <div class="welcome-screen">
            <div class="logo">
                <div class="logo-icon">ü´Å</div>
            </div>
            <h1 class="welcome-title">NeumoCalc</h1>
            <p class="welcome-subtitle">
                Objective calculation tool for lung transplant monitoring.<br>
                <em style="opacity: 0.8; font-size: 0.875rem;">No diagnosis, just metrics.</em>
            </p>
            
            <div style="width: 100%; max-width: 300px;">
                <button class="btn btn-primary" id="startSessionBtn">
                    Start New Session
                </button>
                <div class="form-hint mt-4" style="color: rgba(255,255,255,0.7);">
                    All calculations are session-based. Data is stored locally until export.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application (Hidden Initially) -->
    <div class="main-app" id="mainApp">
        <!-- Header -->
        <header class="app-header">
            <div class="session-info">
                <div class="patient-id" id="currentPatientId">--</div>
                <div class="session-status" id="sessionStatus">No active session</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline btn-sm" id="newSessionBtn" style="min-height: auto; padding: 0.5rem 1rem;">
                    New Patient
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Session Setup Section -->
            <section id="sectionSetup" class="section active">
                <div class="card">
                    <h2 class="card-title">Patient Session Setup</h2>
                    <p class="card-subtitle">All calculations are tied to this session</p>
                    
                    <div class="form-group">
                        <label class="form-label">Patient ID (for traceability only)</label>
                        <input type="text" class="form-control" id="inputPatientId" 
                               placeholder="e.g., NM-001, LTX-2024-01" maxlength="20">
                        <div class="form-hint">
                            Used only for session identification. No PHI.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Clinical Pathway</label>
                        <div class="path-selection">
                            <!-- Path A: Baseline from EHR -->
                            <div class="path-card" id="pathEHR">
                                <div class="path-icon">üìã</div>
                                <div class="path-title">Baseline from EHR</div>
                                <div class="path-desc">
                                    Enter known baseline values from medical record
                                </div>
                            </div>
                            
                            <!-- Path B: Establish Baseline -->
                            <div class="path-card" id="pathEstablish">
                                <div class="path-icon">üìä</div>
                                <div class="path-title">Establish Baseline</div>
                                <div class="path-desc">
                                    Analyze post-transplant visits to determine baseline
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" id="btnStartSession">
                            Start Session
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">Important Notes</h3>
                    <ul style="color: #6b7280; line-height: 1.6; padding-left: 1.25rem;">
                        <li>All data is stored locally in your browser</li>
                        <li>Sessions are temporary until exported</li>
                        <li>No patient identification data is collected</li>
                        <li>Tool provides objective metrics only - no diagnosis</li>
                        <li>Export calculations to your EHR system</li>
                    </ul>
                </div>
            </section>
            
            <!-- Path A: Baseline from EHR -->
            <section id="sectionPathA" class="section">
                <div class="card">
                    <h2 class="card-title">Baseline from Medical Record</h2>
                    <p class="card-subtitle">Enter established baseline values</p>
                    
                    <div class="form-group">
                        <label class="form-label">Baseline Date (When stable)</label>
                        <input type="date" class="form-control" id="baselineDate">
                        <div class="form-hint">
                            Typically 3-6 months post-transplant when patient stabilized
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">FEV‚ÇÅ Baseline (L)</label>
                            <input type="number" step="0.01" min="0.5" max="8.0" 
                                   class="form-control" id="baselineFev1">
                            <div class="form-hint">From clinical record</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">FVC Baseline (L)</label>
                            <input type="number" step="0.01" min="0.5" max="10.0" 
                                   class="form-control" id="baselineFvc">
                            <div class="form-hint">From clinical record</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="showSection('setup')">
                            Back
                        </button>
                        <button class="btn btn-primary" id="btnSaveBaseline">
                            Save Baseline & Continue
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Path B: Establish Baseline -->
            <section id="sectionPathB" class="section">
                <div class="card">
                    <h2 class="card-title">Establish New Baseline</h2>
                    <p class="card-subtitle">Enter 3-6 months of post-transplant visits</p>
                    
                    <div id="visitEntries">
                        <!-- Dynamic visit entries will be added here -->
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-outline" id="btnAddVisit">
                            + Add Visit
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('setup')">
                            Back
                        </button>
                        <button class="btn btn-primary" id="btnAnalyzeStability">
                            Analyze Stability
                        </button>
                    </div>
                </div>
                
                <!-- Stability Analysis Results -->
                <div class="card hidden" id="stabilityResults">
                    <h2 class="card-title">Stability Analysis</h2>
                    <p class="card-subtitle">Based on entered visit data</p>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-value" id="analysisVariation">--</div>
                            <div class="result-label">Variation</div>
                            <div class="result-sub">% (lower is better)</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="analysisVisits">--</div>
                            <div class="result-label">Visits</div>
                            <div class="result-sub">Analyzed</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="analysisDays">--</div>
                            <div class="result-label">Days</div>
                            <div class="result-sub">Monitoring period</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="analysisScore">--</div>
                            <div class="result-label">Stability</div>
                            <div class="result-sub">Score (0-100)</div>
                        </div>
                    </div>
                    
                    <!-- Suggested Baseline -->
                    <div class="form-group mt-6">
                        <label class="form-label">Suggested Baseline Values</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">FEV‚ÇÅ (L)</label>
                                <input type="number" step="0.01" class="form-control" 
                                       id="suggestedFev1">
                                <div class="form-hint">Average of top 2 values</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">FVC (L)</label>
                                <input type="number" step="0.01" class="form-control" 
                                       id="suggestedFvc">
                                <div class="form-hint">Corresponding FVC</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="document.getElementById('stabilityResults').classList.add('hidden')">
                            Adjust Visits
                        </button>
                        <button class="btn btn-success" id="btnAcceptBaseline">
                            Accept Baseline
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Main Calculator -->
            <section id="sectionCalculator" class="section">
                <!-- Current Status Card -->
                <div class="card">
                    <h2 class="card-title">Current Status</h2>
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-value" id="currentFev1Display">--</div>
                            <div class="result-label">Baseline FEV‚ÇÅ</div>
                            <div class="result-sub">Liters</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="currentFvcDisplay">--</div>
                            <div class="result-label">Baseline FVC</div>
                            <div class="result-sub">Liters</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="currentVisits">0</div>
                            <div class="result-label">Saved Visits</div>
                            <div class="result-sub">This session</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="currentDays">--</div>
                            <div class="result-label">Days</div>
                            <div class="result-sub">Since baseline</div>
                        </div>
                    </div>
                </div>
                
                <!-- New Measurement Card -->
                <div class="card">
                    <h2 class="card-title">New Measurement</h2>
                    <p class="card-subtitle">Enter current spirometry values</p>
                    
                    <div class="form-group">
                        <label class="form-label">Measurement Date</label>
                        <input type="date" class="form-control" id="measurementDate">
                        <div class="form-hint" id="dateContext"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">FEV‚ÇÅ (L)</label>
                            <input type="number" step="0.01" min="0.5" max="8.0" 
                                   class="form-control" id="measurementFev1" 
                                   placeholder="e.g., 2.85">
                            <div class="form-hint">Best value from PFT</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">FVC (L)</label>
                            <input type="number" step="0.01" min="0.5" max="10.0" 
                                   class="form-control" id="measurementFvc" 
                                   placeholder="e.g., 3.40">
                            <div class="form-hint">Best value from PFT</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Clinical Context</label>
                        <select class="form-control" id="measurementContext">
                            <option value="routine">Routine follow-up</option>
                            <option value="symptomatic">Symptomatic evaluation</option>
                            <option value="post-treatment">Post-treatment assessment</option>
                            <option value="concern">Clinical concern</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" id="btnCalculate">
                            Calculate Metrics
                        </button>
                        <button class="btn btn-outline" id="btnClear">
                            Clear
                        </button>
                    </div>
                </div>
                
                <!-- Results Card (Hidden Initially) -->
                <div class="card hidden" id="resultsCard">
                    <h2 class="card-title">Objective Metrics</h2>
                    <p class="card-subtitle">Calculated values for clinical documentation</p>
                    
                    <!-- Key Metrics -->
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-value" id="resultRatio">--</div>
                            <div class="result-label">FEV‚ÇÅ/FVC</div>
                            <div class="result-sub">Ratio %</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="resultChangeBaseline">--</div>
                            <div class="result-label">vs Baseline</div>
                            <div class="result-sub">% Change</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="resultChangeLast">--</div>
                            <div class="result-label">vs Last Visit</div>
                            <div class="result-sub">% Change</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value" id="resultRate">--</div>
                            <div class="result-label">Rate</div>
                            <div class="result-sub">L/month</div>
                        </div>
                    </div>
                    
                    <!-- BOS Indicator -->
                    <div class="bos-indicator bos0 mt-4" id="bosIndicator">
                        <div class="bos-title" id="bosTitle">BOS Stage</div>
                        <div class="bos-desc" id="bosDesc">Enter values to calculate</div>
                    </div>
                    
                    <!-- Save Action -->
                    <div class="btn-group mt-4">
                        <button class="btn btn-success" id="btnSaveVisit">
                            Save to Session
                        </button>
                        <button class="btn btn-outline" id="btnExportResults">
                            Export Results
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- History Section -->
            <section id="sectionHistory" class="section">
                <div class="card">
                    <h2 class="card-title">Visit History</h2>
                    <p class="card-subtitle" id="historySummary">No visits saved</p>
                    
                    <div id="historyList">
                        <div class="text-center" style="color: #6b7280; padding: 3rem 1rem;">
                            No visits recorded yet.<br>
                            <small>Save calculations to build history</small>
                        </div>
                    </div>
                    
                    <div class="btn-group mt-4">
                        <button class="btn btn-outline" id="btnExportHistory">
                            Export All as CSV
                        </button>
                        <button class="btn btn-outline" id="btnClearHistory">
                            Clear History
                        </button>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn" data-section="calculator">
                <i>üßÆ</i> Calculate
            </button>
            <button class="nav-btn" data-section="history">
                <i>üìä</i> History
            </button>
            <button class="nav-btn" data-section="export">
                <i>üì§</i> Export
            </button>
        </nav>
    </div>
    
    <!-- JavaScript -->
    <script>
    // ============================================
    // NEUMOCALC - Objective Lung Transplant Calculator
    // ============================================
    
    // Clinical Constants
    const BOS_THRESHOLDS = {
        0: 10,   // BOS 0-p threshold (% decline)
        1: 20,   // BOS 1 threshold
        2: 35    // BOS 2-3 threshold
    };
    
    const MEDICAL_RANGES = {
        FEV1: { min: 0.5, max: 8.0 },
        FVC: { min: 0.5, max: 10.0 }
    };
    
    // App State
    const state = {
        session: {
            id: null,
            patientId: null,
            startedAt: null,
            pathway: null // 'ehr' or 'establish'
        },
        baseline: {
            date: null,
            fev1: null,
            fvc: null,
            established: false
        },
        visits: [],
        currentPathway: null,
        visitEntries: [] // For establishing baseline
    };
    
    // DOM Elements
    const dom = {};
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        cacheElements();
        setupEventListeners();
        setupPWA();
        setDefaultDates();
        
        // Show welcome screen
        showWelcome();
    });
    
    function cacheElements() {
        // Welcome screen
        dom.startSessionBtn = document.getElementById('startSessionBtn');
        dom.welcomeScreen = document.getElementById('welcomeScreen');
        dom.mainApp = document.getElementById('mainApp');
        
        // Session setup
        dom.inputPatientId = document.getElementById('inputPatientId');
        dom.pathEHR = document.getElementById('pathEHR');
        dom.pathEstablish = document.getElementById('pathEstablish');
        dom.btnStartSession = document.getElementById('btnStartSession');
        dom.newSessionBtn = document.getElementById('newSessionBtn');
        
        // Path A (EHR)
        dom.baselineDate = document.getElementById('baselineDate');
        dom.baselineFev1 = document.getElementById('baselineFev1');
        dom.baselineFvc = document.getElementById('baselineFvc');
        dom.btnSaveBaseline = document.getElementById('btnSaveBaseline');
        
        // Path B (Establish)
        dom.visitEntries = document.getElementById('visitEntries');
        dom.btnAddVisit = document.getElementById('btnAddVisit');
        dom.btnAnalyzeStability = document.getElementById('btnAnalyzeStability');
        dom.stabilityResults = document.getElementById('stabilityResults');
        dom.suggestedFev1 = document.getElementById('suggestedFev1');
        dom.suggestedFvc = document.getElementById('suggestedFvc');
        dom.btnAcceptBaseline = document.getElementById('btnAcceptBaseline');
        
        // Calculator
        dom.measurementDate = document.getElementById('measurementDate');
        dom.measurementFev1 = document.getElementById('measurementFev1');
        dom.measurementFvc = document.getElementById('measurementFvc');
        dom.measurementContext = document.getElementById('measurementContext');
        dom.btnCalculate = document.getElementById('btnCalculate');
        dom.btnClear = document.getElementById('btnClear');
        dom.resultsCard = document.getElementById('resultsCard');
        dom.btnSaveVisit = document.getElementById('btnSaveVisit');
        dom.btnExportResults = document.getElementById('btnExportResults');
        
        // Display elements
        dom.currentPatientId = document.getElementById('currentPatientId');
        dom.sessionStatus = document.getElementById('sessionStatus');
        dom.currentFev1Display = document.getElementById('currentFev1Display');
        dom.currentFvcDisplay = document.getElementById('currentFvcDisplay');
        dom.currentVisits = document.getElementById('currentVisits');
        dom.currentDays = document.getElementById('currentDays');
        dom.dateContext = document.getElementById('dateContext');
        
        // Results
        dom.resultRatio = document.getElementById('resultRatio');
        dom.resultChangeBaseline = document.getElementById('resultChangeBaseline');
        dom.resultChangeLast = document.getElementById('resultChangeLast');
        dom.resultRate = document.getElementById('resultRate');
        dom.bosIndicator = document.getElementById('bosIndicator');
        dom.bosTitle = document.getElementById('bosTitle');
        dom.bosDesc = document.getElementById('bosDesc');
        
        // History
        dom.historySummary = document.getElementById('historySummary');
        dom.historyList = document.getElementById('historyList');
        dom.btnExportHistory = document.getElementById('btnExportHistory');
        dom.btnClearHistory = document.getElementById('btnClearHistory');
        
        // Analysis results
        dom.analysisVariation = document.getElementById('analysisVariation');
        dom.analysisVisits = document.getElementById('analysisVisits');
        dom.analysisDays = document.getElementById('analysisDays');
        dom.analysisScore = document.getElementById('analysisScore');
        
        // Bottom nav
        dom.navBtns = document.querySelectorAll('.nav-btn');
    }
    
    function setupEventListeners() {
        // Welcome screen
        dom.startSessionBtn.addEventListener('click', startNewSession);
        dom.newSessionBtn.addEventListener('click', showWelcome);
        
        // Pathway selection
        dom.pathEHR.addEventListener('click', () => selectPathway('ehr'));
        dom.pathEstablish.addEventListener('click', () => selectPathway('establish'));
        dom.btnStartSession.addEventListener('click', startSession);
        
        // Path A
        dom.btnSaveBaseline.addEventListener('click', saveBaselineFromEHR);
        
        // Path B
        dom.btnAddVisit.addEventListener('click', addVisitEntry);
        dom.btnAnalyzeStability.addEventListener('click', analyzeStability);
        dom.btnAcceptBaseline.addEventListener('click', acceptSuggestedBaseline);
        
        // Calculator
        dom.btnCalculate.addEventListener('click', calculateMetrics);
        dom.btnClear.addEventListener('click', clearMeasurement);
        dom.btnSaveVisit.addEventListener('click', saveVisit);
        dom.btnExportResults.addEventListener('click', exportResults);
        
        // History
        dom.btnExportHistory.addEventListener('click', exportHistory);
        dom.btnClearHistory.addEventListener('click', clearHistory);
        
        // Input events
        dom.measurementDate.addEventListener('change', updateDateContext);
        dom.measurementFev1.addEventListener('input', validateMedicalRange);
        dom.measurementFvc.addEventListener('input', validateMedicalRange);
        
        // Bottom navigation
        dom.navBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.dataset.section;
                showSection(section);
            });
        });
    }
    
    function setupPWA() {
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        
        // Handle offline/online
        window.addEventListener('online', () => {
            showToast('Back online', 'success');
        });
        
        window.addEventListener('offline', () => {
            showToast('Working offline', 'warning');
        });
    }
    
    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        
        // Set measurement date to today
        dom.measurementDate.value = today;
        dom.measurementDate.max = today;
        
        // Set baseline date to 6 months ago (typical stabilization)
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        dom.baselineDate.value = sixMonthsAgo.toISOString().split('T')[0];
    }
    
    // ===== WELCOME FLOW =====
    function showWelcome() {
        dom.welcomeScreen.style.display = 'flex';
        dom.mainApp.style.display = 'none';
        
        // Reset state
        resetSession();
    }
    
    function startNewSession() {
        dom.welcomeScreen.style.display = 'none';
        dom.mainApp.style.display = 'flex';
        
        // Show setup section
        showSection('setup');
    }
    
    // ===== SESSION MANAGEMENT =====
    function selectPathway(pathway) {
        state.currentPathway = pathway;
        
        // Update UI
        dom.pathEHR.classList.remove('active');
        dom.pathEstablish.classList.remove('active');
        
        if (pathway === 'ehr') {
            dom.pathEHR.classList.add('active');
        } else {
            dom.pathEstablish.classList.add('active');
        }
    }
    
    function startSession() {
        const patientId = dom.inputPatientId.value.trim();
        
        if (!patientId) {
            showToast('Please enter a patient ID for session tracking', 'warning');
            return;
        }
        
        if (!state.currentPathway) {
            showToast('Please select a clinical pathway', 'warning');
            return;
        }
        
        // Initialize session
        state.session = {
            id: 'session_' + Date.now(),
            patientId: patientId,
            startedAt: new Date().toISOString(),
            pathway: state.currentPathway
        };
        
        // Update UI
        dom.currentPatientId.textContent = patientId;
        dom.sessionStatus.textContent = 'Active session';
        
        // Show appropriate pathway
        if (state.currentPathway === 'ehr') {
            showSection('pathA');
        } else {
            // Initialize visit entries for establishing baseline
            state.visitEntries = [];
            addVisitEntry();
            addVisitEntry();
            addVisitEntry(); // Start with 3 entries
            showSection('pathB');
        }
    }
    
    // ===== PATH A: BASELINE FROM EHR =====
    function saveBaselineFromEHR() {
        const date = dom.baselineDate.value;
        const fev1 = parseFloat(dom.baselineFev1.value);
        const fvc = parseFloat(dom.baselineFvc.value);
        
        // Validation
        if (!date || !fev1 || !fvc) {
            showToast('Please enter all baseline values', 'error');
            return;
        }
        
        if (fev1 < MEDICAL_RANGES.FEV1.min || fev1 > MEDICAL_RANGES.FEV1.max) {
            showToast(`FEV‚ÇÅ must be between ${MEDICAL_RANGES.FEV1.min} and ${MEDICAL_RANGES.FEV1.max} L`, 'error');
            return;
        }
        
        if (fvc < MEDICAL_RANGES.FVC.min || fvc > MEDICAL_RANGES.FVC.max) {
            showToast(`FVC must be between ${MEDICAL_RANGES.FVC.min} and ${MEDICAL_RANGES.FVC.max} L`, 'error');
            return;
        }
        
        // Save baseline
        state.baseline = {
            date: date,
            fev1: fev1,
            fvc: fvc,
            established: true,
            source: 'ehr'
        };
        
        // Update display
        updateBaselineDisplay();
        
        // Show calculator
        showSection('calculator');
        showToast('Baseline saved. Ready for calculations.', 'success');
    }
    
    // ===== PATH B: ESTABLISH BASELINE =====
    function addVisitEntry() {
        const index = state.visitEntries.length + 1;
        
        const html = `
            <div class="visit-input-row" data-index="${index}">
                <div class="visit-number">Visit ${index}</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control visit-date" 
                               data-field="date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">FEV‚ÇÅ (L)</label>
                        <input type="number" step="0.01" class="form-control visit-fev1" 
                               data-field="fev1" placeholder="2.85" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">FVC (L)</label>
                        <input type="number" step="0.01" class="form-control visit-fvc" 
                               data-field="fvc" placeholder="3.40" required>
                    </div>
                </div>
                ${index > 3 ? `
                    <button type="button" class="btn btn-outline btn-sm mt-2 remove-visit" 
                            onclick="removeVisitEntry(${index})">
                        Remove
                    </button>
                ` : ''}
            </div>
        `;
        
        dom.visitEntries.insertAdjacentHTML('beforeend', html);
        state.visitEntries.push({ index: index });
        
        // Set default date for new entry
        const newEntry = dom.visitEntries.lastElementChild;
        const dateInput = newEntry.querySelector('.visit-date');
        if (dateInput) {
            // Set date to ~1 month after previous visit
            const prevEntry = state.visitEntries[state.visitEntries.length - 2];
            if (prevEntry && prevEntry.date) {
                const prevDate = new Date(prevEntry.date);
                prevDate.setMonth(prevDate.getMonth() + 1);
                dateInput.value = prevDate.toISOString().split('T')[0];
            } else {
                // First entry: set to 3 months post-TX (typical)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                dateInput.value = threeMonthsAgo.toISOString().split('T')[0];
            }
        }
    }
    
    function removeVisitEntry(index) {
        const entry = dom.visitEntries.querySelector(`[data-index="${index}"]`);
        if (entry) {
            entry.remove();
            state.visitEntries = state.visitEntries.filter(v => v.index !== index);
        }
    }
    
    function analyzeStability() {
        // Collect visit data
        const visits = [];
        const entries = dom.visitEntries.querySelectorAll('.visit-input-row');
        
        entries.forEach(entry => {
            const date = entry.querySelector('.visit-date').value;
            const fev1 = parseFloat(entry.querySelector('.visit-fev1').value);
            const fvc = parseFloat(entry.querySelector('.visit-fvc').value);
            
            if (date && fev1 && fvc) {
                visits.push({
                    date: date,
                    fev1: fev1,
                    fvc: fvc,
                    timestamp: new Date(date).getTime()
                });
            }
        });
        
        if (visits.length < 3) {
            showToast('Need at least 3 visits for stability analysis', 'warning');
            return;
        }
        
        // Sort by date
        visits.sort((a, b) => a.timestamp - b.timestamp);
        
        // Calculate statistics
        const fev1Values = visits.map(v => v.fev1);
        const maxFev1 = Math.max(...fev1Values);
        const minFev1 = Math.min(...fev1Values);
        const variation = ((maxFev1 - minFev1) / maxFev1 * 100).toFixed(1);
        
        // Calculate time span
        const firstDate = new Date(visits[0].date);
        const lastDate = new Date(visits[visits.length - 1].date);
        const daysDiff = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
        
        // Stability score (0-100, higher is more stable)
        const stabilityScore = Math.max(0, 100 - parseFloat(variation) * 2);
        
        // Find top 2 FEV1 values for suggested baseline (ISHLT protocol)
        const sortedByFev1 = [...visits].sort((a, b) => b.fev1 - a.fev1);
        const topTwo = sortedByFev1.slice(0, 2);
        const suggestedFev1 = (topTwo[0].fev1 + topTwo[1].fev1) / 2;
        
        // Find corresponding FVC (average of same visits)
        const suggestedFvc = (topTwo[0].fvc + topTwo[1].fvc) / 2;
        
        // Update display
        dom.analysisVariation.textContent = `${variation}%`;
        dom.analysisVisits.textContent = visits.length;
        dom.analysisDays.textContent = daysDiff;
        dom.analysisScore.textContent = Math.round(stabilityScore);
        dom.suggestedFev1.value = suggestedFev1.toFixed(2);
        dom.suggestedFvc.value = suggestedFvc.toFixed(2);
        
        // Show results
        dom.stabilityResults.classList.remove('hidden');
        
        // Scroll to results
        dom.stabilityResults.scrollIntoView({ behavior: 'smooth' });
    }
    
    function acceptSuggestedBaseline() {
        const fev1 = parseFloat(dom.suggestedFev1.value);
        const fvc = parseFloat(dom.suggestedFvc.value);
        
        if (!fev1 || !fvc) {
            showToast('Invalid baseline values', 'error');
            return;
        }
        
        // Use last visit date as baseline date
        const visits = [];
        const entries = dom.visitEntries.querySelectorAll('.visit-input-row');
        
        entries.forEach(entry => {
            const date = entry.querySelector('.visit-date').value;
            if (date) {
                visits.push({ date: date, timestamp: new Date(date).getTime() });
            }
        });
        
        visits.sort((a, b) => b.timestamp - a.timestamp);
        const baselineDate = visits.length > 0 ? visits[0].date : new Date().toISOString().split('T')[0];
        
        // Save baseline
        state.baseline = {
            date: baselineDate,
            fev1: fev1,
            fvc: fvc,
            established: true,
            source: 'calculated',
            basedOnVisits: state.visitEntries.length
        };
        
        // Update display
        updateBaselineDisplay();
        
        // Show calculator
        showSection('calculator');
        showToast('Baseline established using ISHLT protocol', 'success');
    }
    
    // ===== CALCULATOR FUNCTIONS =====
    function updateDateContext() {
        const date = dom.measurementDate.value;
        
        if (!date || !state.baseline.date) {
            dom.dateContext.textContent = '';
            return;
        }
        
        // Calculate days since baseline
        const baselineDate = new Date(state.baseline.date + 'T00:00:00');
        const measureDate = new Date(date + 'T00:00:00');
        const daysDiff = Math.floor((measureDate - baselineDate) / (1000 * 60 * 60 * 24));
        
        let context = `${daysDiff} days since baseline`;
        
        if (daysDiff < 0) {
            context = `${Math.abs(daysDiff)} days before baseline`;
        } else if (daysDiff < 30) {
            context += ' (<1 month)';
        } else {
            const months = (daysDiff / 30.44).toFixed(1);
            context += ` (${months} months)`;
        }
        
        dom.dateContext.textContent = context;
    }
    
    function validateMedicalRange() {
        const fev1 = parseFloat(dom.measurementFev1.value);
        const fvc = parseFloat(dom.measurementFvc.value);
        
        if (fev1 && (fev1 < MEDICAL_RANGES.FEV1.min || fev1 > MEDICAL_RANGES.FEV1.max)) {
            showToast(`FEV‚ÇÅ must be between ${MEDICAL_RANGES.FEV1.min}-${MEDICAL_RANGES.FEV1.max} L`, 'warning');
            return false;
        }
        
        if (fvc && (fvc < MEDICAL_RANGES.FVC.min || fvc > MEDICAL_RANGES.FVC.max)) {
            showToast(`FVC must be between ${MEDICAL_RANGES.FVC.min}-${MEDICAL_RANGES.FVC.max} L`, 'warning');
            return false;
        }
        
        return true;
    }
    
    function calculateMetrics() {
        // Validate baseline
        if (!state.baseline.established) {
            showToast('Please establish baseline first', 'error');
            return;
        }
        
        // Get inputs
        const date = dom.measurementDate.value;
        const fev1 = parseFloat(dom.measurementFev1.value);
        const fvc = parseFloat(dom.measurementFvc.value);
        const context = dom.measurementContext.value;
        
        // Validation
        if (!date || !fev1 || !fvc) {
            showToast('Please enter all measurement values', 'error');
            return;
        }
        
        if (!validateMedicalRange()) {
            return;
        }
        
        // Calculate metrics
        const ratio = fvc > 0 ? ((fev1 / fvc) * 100).toFixed(1) : 0;
        const changeFromBaseline = ((fev1 - state.baseline.fev1) / state.baseline.fev1 * 100).toFixed(1);
        
        // Calculate change from last visit
        let changeFromLast = '--';
        if (state.visits.length > 0) {
            const lastVisit = state.visits[state.visits.length - 1];
            changeFromLast = ((fev1 - lastVisit.fev1) / lastVisit.fev1 * 100).toFixed(1);
        }
        
        // Calculate rate of decline (L/month)
        let rate = '--';
        if (state.visits.length > 0) {
            const lastVisit = state.visits[state.visits.length - 1];
            const lastDate = new Date(lastVisit.date + 'T00:00:00');
            const currentDate = new Date(date + 'T00:00:00');
            const daysDiff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff > 0) {
                const fev1Change = fev1 - lastVisit.fev1;
                const monthsDiff = daysDiff / 30.44;
                rate = (fev1Change / monthsDiff).toFixed(3);
            }
        }
        
        // Determine BOS stage
        const decline = Math.abs(parseFloat(changeFromBaseline));
        let bosStage = 'BOS 0';
        let bosColor = 'bos0';
        let bosDescription = 'Normal (decline <10%)';
        
        if (decline >= BOS_THRESHOLDS[2]) {
            bosStage = 'BOS 2-3';
            bosColor = 'bos2-3';
            bosDescription = 'Moderate/Severe (decline ‚â•35%)';
        } else if (decline >= BOS_THRESHOLDS[1]) {
            bosStage = 'BOS 1';
            bosColor = 'bos1';
            bosDescription = 'Mild (decline ‚â•20%)';
        } else if (decline >= BOS_THRESHOLDS[0]) {
            bosStage = 'BOS 0-p';
            bosColor = 'bos0p';
            bosDescription = 'Potential (decline ‚â•10%)';
        }
        
        // Store current measurement
        state.currentMeasurement = {
            date: date,
            fev1: fev1,
            fvc: fvc,
            ratio: ratio,
            changeFromBaseline: changeFromBaseline,
            changeFromLast: changeFromLast,
            rate: rate,
            bosStage: bosStage,
            context: context,
            timestamp: new Date().toISOString()
        };
        
        // Update results display
        dom.resultRatio.textContent = `${ratio}%`;
        dom.resultChangeBaseline.textContent = `${parseFloat(changeFromBaseline) > 0 ? '+' : ''}${changeFromBaseline}%`;
        dom.resultChangeLast.textContent = changeFromLast !== '--' ? 
            `${parseFloat(changeFromLast) > 0 ? '+' : ''}${changeFromLast}%` : '--';
        dom.resultRate.textContent = rate !== '--' ? `${parseFloat(rate) > 0 ? '+' : ''}${rate}` : '--';
        
        // Update BOS indicator
        dom.bosIndicator.className = `bos-indicator ${bosColor}`;
        dom.bosTitle.textContent = bosStage;
        dom.bosDesc.textContent = bosDescription;
        
        // Show results
        dom.resultsCard.classList.remove('hidden');
        
        // Scroll to results
        dom.resultsCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        showToast('Metrics calculated', 'success');
    }
    
    function saveVisit() {
        if (!state.currentMeasurement) {
            showToast('No calculation to save', 'error');
            return;
        }
        
        // Add to visits
        const visit = {
            ...state.currentMeasurement,
            visitNumber: state.visits.length + 1
        };
        
        state.visits.push(visit);
        state.currentMeasurement = null;
        
        // Update UI
        updateBaselineDisplay();
        updateHistoryDisplay();
        
        // Clear and hide results
        clearMeasurement();
        dom.resultsCard.classList.add('hidden');
        
        showToast(`Visit ${visit.visitNumber} saved`, 'success');
    }
    
    function clearMeasurement() {
        dom.measurementFev1.value = '';
        dom.measurementFvc.value = '';
        dom.measurementContext.value = 'routine';
        
        // Keep date as is (usually current date)
        setDefaultDates();
    }
    
    function updateBaselineDisplay() {
        if (state.baseline.established) {
            dom.currentFev1Display.textContent = state.baseline.fev1.toFixed(2);
            dom.currentFvcDisplay.textContent = state.baseline.fvc.toFixed(2);
            dom.currentVisits.textContent = state.visits.length;
            
            // Calculate days since baseline
            if (state.baseline.date) {
                const baselineDate = new Date(state.baseline.date + 'T00:00:00');
                const today = new Date();
                const daysDiff = Math.floor((today - baselineDate) / (1000 * 60 * 60 * 24));
                dom.currentDays.textContent = Math.max(0, daysDiff);
            }
        }
    }
    
    // ===== HISTORY MANAGEMENT =====
    function updateHistoryDisplay() {
        if (state.visits.length === 0) {
            dom.historySummary.textContent = 'No visits saved';
            dom.historyList.innerHTML = `
                <div class="text-center" style="color: #6b7280; padding: 3rem 1rem;">
                    No visits recorded yet.<br>
                    <small>Save calculations to build history</small>
                </div>
            `;
            return;
        }
        
        // Update summary
        const firstDate = new Date(state.visits[0].date);
        const lastDate = new Date(state.visits[state.visits.length - 1].date);
        const daysDiff = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
        dom.historySummary.textContent = `${state.visits.length} visits over ${daysDiff} days`;
        
        // Build history list
        let html = '';
        
        state.visits.slice().reverse().forEach((visit, index) => {
            const displayIndex = state.visits.length - index;
            const prevVisit = state.visits[displayIndex - 2]; // Previous chronological visit
            
            html += `
                <div class="visit-input-row" style="margin-bottom: 1rem;">
                    <div class="visit-number">Visit ${visit.visitNumber}</div>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.75rem;">
                        ${new Date(visit.date).toLocaleDateString()} ‚Ä¢ ${visit.context}
                    </div>
                    
                    <div class="results-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="result-card">
                            <div class="result-value">${visit.fev1.toFixed(2)}</div>
                            <div class="result-label">FEV‚ÇÅ</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value">${visit.fvc.toFixed(2)}</div>
                            <div class="result-label">FVC</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value">${visit.changeFromBaseline}%</div>
                            <div class="result-label">vs Baseline</div>
                        </div>
                        <div class="result-card">
                            <div class="result-value">${visit.bosStage}</div>
                            <div class="result-label">BOS</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        dom.historyList.innerHTML = html;
    }
    
    function clearHistory() {
        if (!confirm('Clear all visit history? This cannot be undone.')) {
            return;
        }
        
        state.visits = [];
        updateBaselineDisplay();
        updateHistoryDisplay();
        
        showToast('History cleared', 'success');
    }
    
    // ===== EXPORT FUNCTIONS =====
    function exportResults() {
        if (!state.currentMeasurement) {
            showToast('No results to export', 'warning');
            return;
        }
        
        const data = {
            patientId: state.session.patientId,
            baseline: state.baseline,
            measurement: state.currentMeasurement,
            exportedAt: new Date().toISOString()
        };
        
        const json = JSON.stringify(data, null, 2);
        downloadFile(json, `neumocalc-${state.session.patientId}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        
        showToast('Results exported as JSON', 'success');
    }
    
    function exportHistory() {
        if (state.visits.length === 0) {
            showToast('No history to export', 'warning');
            return;
        }
        
        let csv = 'Visit,Date,FEV‚ÇÅ (L),FVC (L),Ratio (%),Change from Baseline (%),BOS Stage,Context\n';
        
        state.visits.forEach(visit => {
            csv += `${visit.visitNumber},${visit.date},${visit.fev1},${visit.fvc},${visit.ratio},${visit.changeFromBaseline},${visit.bosStage},${visit.context}\n`;
        });
        
        downloadFile(csv, `neumocalc-${state.session.patientId}-history-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        
        showToast('History exported as CSV', 'success');
    }
    
    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // ===== UI UTILITIES =====
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(`section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Update bottom nav
        dom.navBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.section === sectionId);
        });
    }
    
    function showToast(message, type = 'info') {
        // Remove existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function resetSession() {
        state.session = {
            id: null,
            patientId: null,
            startedAt: null,
            pathway: null
        };
        
        state.baseline = {
            date: null,
            fev1: null,
            fvc: null,
            established: false
        };
        
        state.visits = [];
        state.visitEntries = [];
        state.currentPathway = null;
        
        // Reset UI
        dom.inputPatientId.value = '';
        dom.pathEHR.classList.remove('active');
        dom.pathEstablish.classList.remove('active');
        dom.currentPatientId.textContent = '--';
        dom.sessionStatus.textContent = 'No active session';
        
        updateBaselineDisplay();
        updateHistoryDisplay();
    }
    
    // Fix iOS 100vh issue
    function setVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    
    // Make functions available globally for inline event handlers
    window.removeVisitEntry = removeVisitEntry;
    window.showSection = showSection;
    
    console.log('üöÄ NeumoCalc PWA loaded successfully');
    </script>
</body>
</html>
