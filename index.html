<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1A5F7A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Spirolite - Professional Lung Function Calculator & Tracker">
    <title>Spirolite | Professional</title>
    
    <!-- Charts & PDF Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* === COMPLETE CSS - Mobile First, iOS/Android Native Feel === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            /* Color System */
            --primary: #1A5F7A;
            --primary-dark: #0D4B63;
            --primary-light: #2D9596;
            --secondary: #57C5B6;
            --accent: #FF6B35;
            
            /* Semantic Colors */
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            
            /* Surface Colors */
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --surface-elevated: #FFFFFF;
            --surface-secondary: #F3F4F6;
            --surface-tertiary: #E5E7EB;
            
            /* Text Colors */
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --text-on-primary: #FFFFFF;
            
            /* Border Colors */
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            --border-dark: #D1D5DB;
            
            /* Spacing System (8px grid) */
            --space-1: 4px;   --space-2: 8px;   --space-3: 12px;
            --space-4: 16px;  --space-5: 20px;  --space-6: 24px;
            --space-7: 32px;  --space-8: 40px;  --space-9: 48px;
            --space-10: 56px;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-mono: 'SF Mono', 'Roboto Mono', 'Courier New', monospace;
            
            /* Border Radius */
            --radius-xs: 4px;     --radius-sm: 6px;     --radius-md: 8px;
            --radius-lg: 12px;    --radius-xl: 16px;    --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index */
            --z-base: 1;          --z-elevated: 10;     --z-sticky: 100;
            --z-modal: 1000;      --z-toast: 10000;
            
            /* Safe Area Insets */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #111827;
                --surface: #1F2937;
                --surface-elevated: #374151;
                --surface-secondary: #374151;
                --surface-tertiary: #4B5563;
                --text-primary: #F9FAFB;
                --text-secondary: #D1D5DB;
                --text-tertiary: #9CA3AF;
                --border: #374151;
                --border-light: #4B5563;
                --border-dark: #6B7280;
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.35);
            }
        }
        
        /* === BASE STYLES === */
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            background: var(--background);
            overscroll-behavior: none;
        }
        
        body {
            font-family: var(--font-family);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            background: var(--background);
        }
        
        /* === LOADING OVERLAY === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0D4B63 0%, #1A5F7A 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            opacity: 1;
            transition: opacity 0.5s ease;
            padding: var(--space-8);
        }
        
        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            max-width: 280px;
            width: 100%;
        }
        
        .loading-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto var(--space-6);
            animation: logoFloat 3s ease-in-out infinite;
            color: white;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
        }
        
        .loading-progress-container {
            width: 100%;
            margin: var(--space-6) auto;
        }
        
        .loading-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .loading-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), white);
            width: 0%;
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }
        
        /* === APP CONTAINER === */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            max-width: 800px;
            margin: 0 auto;
            background: var(--background);
            position: relative;
        }
        
        @media (min-width: 768px) {
            .app-container {
                margin: var(--space-4) auto;
                height: calc(100vh - 2 * var(--space-4));
                max-height: 900px;
                border-radius: var(--radius-xl);
                overflow: hidden;
                box-shadow: var(--shadow-xl);
                border: 1px solid var(--border);
            }
        }
        
        /* === HEADER === */
        .app-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: var(--space-3) var(--space-4);
            padding-top: calc(var(--safe-area-top) + var(--space-3));
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
            min-width: 0;
        }
        
        .app-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .app-title {
            flex: 1;
            min-width: 0;
        }
        
        .app-title h1 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .app-title .tagline {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 500;
            margin-top: 1px;
            opacity: 0.7;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
        }
        
        .action-group {
            display: flex;
            gap: 1px;
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: 2px;
        }
        
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--surface);
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 16px;
        }
        
        .header-btn:hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }
        
        .header-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* === PATIENT BAR === */
        .patient-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            min-height: 64px;
        }
        
        .patient-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
            min-width: 0;
        }
        
        .patient-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 15px;
            flex-shrink: 0;
        }
        
        .patient-details {
            flex: 1;
            min-width: 0;
        }
        
        .patient-id {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .patient-meta {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-top: 2px;
        }
        
        .patient-status {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }
        
        .visit-count {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        .tx-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .tx-indicator.missing {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border-color: rgba(239, 68, 68, 0.2);
        }
        
        .tx-indicator.recent {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border-color: rgba(245, 158, 11, 0.2);
        }
        
        .tx-indicator.valid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.2);
        }
        
        .tx-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* === NAVIGATION === */
        .app-navigation {
            display: flex;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: var(--space-1) var(--space-4);
            padding-bottom: calc(var(--safe-area-bottom) + var(--space-1));
            gap: var(--space-1);
            position: sticky;
            bottom: 0;
            z-index: var(--z-sticky);
        }
        
        .nav-btn {
            flex: 1;
            padding: var(--space-2);
            border: none;
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-height: 50px;
            position: relative;
        }
        
        .nav-btn:hover {
            background: var(--surface-secondary);
        }
        
        .nav-btn.active {
            color: var(--primary);
        }
        
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: var(--radius-full);
        }
        
        .nav-icon {
            font-size: 16px;
        }
        
        /* === MAIN CONTENT === */
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: var(--space-4);
            padding-bottom: max(var(--space-4), var(--safe-area-bottom));
        }
        
        .mode-section {
            display: none;
            animation: fadeInUp var(--transition-smooth);
        }
        
        .mode-section.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* === CARDS === */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }
        
        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }
        
        /* === INPUT SYSTEM === */
        .input-group {
            margin-bottom: var(--space-4);
        }
        
        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
        
        .input-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .text-input {
            width: 100%;
            padding: var(--space-3);
            padding-right: 50px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--surface);
            transition: all var(--transition-fast);
            -webkit-appearance: none;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        }
        
        .input-unit {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        /* === BASELINE INPUT === */
        .baseline-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            border: 1px solid var(--border);
        }
        
        .baseline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }
        
        .baseline-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .baseline-value-display {
            font-family: var(--font-family-mono);
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            padding: 4px 8px;
            background: var(--surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            min-width: 80px;
            text-align: center;
        }
        
        .baseline-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 80px;
            justify-content: center;
        }
        
        .baseline-action-btn:disabled {
            background: var(--surface-tertiary);
            color: var(--text-tertiary);
            border: 1px solid var(--border);
            cursor: not-allowed;
        }
        
        .baseline-action-btn.ready {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }
        
        .baseline-action-btn.ready:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .baseline-action-btn.success {
            background: var(--success);
            color: white;
            border: 1px solid var(--success);
            animation: pulseSuccess 2s ease-in-out;
        }
        
        .baseline-action-btn.success::after {
            content: '‚úì';
            margin-left: 4px;
            animation: checkmark 0.3s ease-out;
        }
        
        @keyframes checkmark {
            from {
                opacity: 0;
                transform: scale(0);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulseSuccess {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .baseline-progress {
            height: 3px;
            background: var(--border);
            border-radius: var(--radius-full);
            margin-top: var(--space-2);
            overflow: hidden;
        }
        
        .baseline-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }
        
        /* === MEASUREMENT GRID === */
        .measurement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        @media (max-width: 360px) {
            .measurement-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* === DATE INPUT === */
        .date-input {
            width: 100%;
            padding: var(--space-3);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 16px;
            color: var(--text-primary);
            background: var(--surface);
            -webkit-appearance: none;
        }
        
        .date-shortcuts {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
            flex-wrap: wrap;
        }
        
        .date-shortcut {
            padding: 4px 8px;
            background: var(--surface-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .date-shortcut:hover {
            background: var(--surface);
            border-color: var(--border-dark);
            color: var(--text-primary);
        }
        
        /* === COMPARISON OPTIONS === */
        .comparison-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin: var(--space-4) 0;
        }
        
        .comparison-option {
            padding: var(--space-3);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--surface);
        }
        
        .comparison-option:hover {
            border-color: var(--border-dark);
            transform: translateY(-1px);
        }
        
        .comparison-option.selected {
            border-color: var(--primary);
            background: rgba(26, 95, 122, 0.05);
        }
        
        .option-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-1);
        }
        
        .option-radio {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }
        
        .option-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .option-description {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 24px;
        }
        
        /* === RESULTS PANEL === */
        .results-panel {
            margin-top: var(--space-4);
            display: none;
            animation: slideInUp var(--transition-smooth);
        }
        
        .results-panel.visible {
            display: block;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .results-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .results-timestamp {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* === MEASUREMENT CARDS === */
        .measurement-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        @media (max-width: 480px) {
            .measurement-cards {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }
        }
        
        .measurement-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        .measurement-card:hover {
            border-color: var(--border-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .measurement-value {
            font-family: var(--font-family-mono);
            font-weight: 700;
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .measurement-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: block;
        }
        
        .measurement-unit {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* === PERCENTAGE DISPLAYS === */
        .percent-display {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }
        
        .percent-display.good {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .percent-display.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .percent-display.alert {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .percent-display.neutral {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        /* === TREND ARROWS === */
        .trend-arrow {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: var(--radius-full);
            font-size: 10px;
            margin-right: 2px;
        }
        
        .trend-arrow.up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .trend-arrow.down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .trend-arrow.neutral {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }
        
        /* === ACTION BUTTONS === */
        .action-bar {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border);
        }
        
        @media (max-width: 640px) {
            .action-bar {
                flex-direction: column;
            }
        }
        
        .btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1.5px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--surface-secondary);
            border-color: var(--border-dark);
        }
        
        /* === MONITOR MODE === */
        .monitor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .view-toggle {
            display: flex;
            gap: 1px;
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: 2px;
            border: 1px solid var(--border);
        }
        
        .view-toggle-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        
        .view-toggle-btn:hover {
            background: var(--surface);
        }
        
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-4);
        }
        
        .medical-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .medical-table th {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.05em;
            padding: var(--space-2) var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        
        .medical-table td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }
        
        .medical-table tr:last-child td {
            border-bottom: none;
        }
        
        .medical-table tr:hover {
            background: var(--surface-secondary);
        }
        
        .alert-cell {
            font-weight: 600;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            white-space: nowrap;
        }
        
        .alert-cell.monitor {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .alert-cell.review {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .alert-cell.stable {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        /* Chart Container */
        .chart-container {
            height: 200px;
            margin-bottom: var(--space-4);
            position: relative;
        }
        
        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: calc(var(--space-4) + var(--safe-area-top));
            left: var(--space-4);
            right: var(--space-4);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
        }
        
        .toast {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary);
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            pointer-events: auto;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .toast-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .toast-message {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.error {
            border-left-color: var(--error);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
        
        .toast.info {
            border-left-color: var(--info);
        }
        
        /* === MODALS === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-4);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-smooth);
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform var(--transition-smooth);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .modal-body {
            padding: var(--space-4);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--space-2);
            justify-content: flex-end;
        }
        
        /* === UTILITY CLASSES === */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        
        .text-sm { font-size: 12px; }
        .text-xs { font-size: 11px; }
        .font-semibold { font-weight: 600; }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }
        
        .bg-surface { background: var(--surface); }
        .bg-surface-secondary { background: var(--surface-secondary); }
        
        .border { border: 1px solid var(--border); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        
        .w-full { width: 100%; }
        
        /* Mobile touch optimization */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-btn, .header-btn {
                min-height: 44px;
            }
            
            .btn:active, .nav-btn:active, .header-btn:active {
                opacity: 0.8;
                transform: scale(0.98);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-logo">
                <svg viewBox="0 0 96 96" fill="currentColor">
                    <path d="M24 56 C24 32 38 24 46 30 V66 C46 74 38 82 28 82 C24 82 24 76 24 70 Z" 
                          stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <path d="M72 56 C72 32 58 24 50 30 V66 C50 74 58 82 68 82 C72 82 72 76 72 70 Z" 
                          stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <line x1="48" y1="16" x2="48" y2="66" 
                          stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <rect x="42" y="22" width="12" height="26" rx="2" fill="currentColor"/>
                    <rect x="40" y="16" width="16" height="6" rx="2" fill="currentColor"/>
                </svg>
            </div>
            <div class="loading-progress-container">
                <div class="loading-progress-label">
                    <span id="loadingStep">Loading Spirolite Professional</span>
                    <span id="loadingPercent">0%</span>
                </div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo">S</div>
                <div class="app-title">
                    <h1>Spirolite</h1>
                    <div class="tagline">Professional Lung Function</div>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="action-group">
                    <button class="header-btn" id="undoBtn" title="Undo (Ctrl+Z)" disabled>‚Ü∂</button>
                    <button class="header-btn" id="redoBtn" title="Redo (Ctrl+Y)" disabled>‚Ü∑</button>
                </div>
                <div class="action-group">
                    <button class="header-btn" id="protocolBtn" title="Protocol Settings">‚öôÔ∏è</button>
                    <button class="header-btn" id="exportBtn" title="Export Data">üì§</button>
                </div>
            </div>
        </header>
        
        <!-- Patient Bar -->
        <div class="patient-bar" id="patientBar">
            <div class="patient-info">
                <div class="patient-avatar" id="patientAvatar">--</div>
                <div class="patient-details">
                    <div class="patient-id" id="patientId">Select Patient</div>
                    <div class="patient-meta">
                        <span class="patient-status" id="patientStatus">No data</span>
                        <span class="visit-count" id="visitCount">0 visits</span>
                    </div>
                </div>
            </div>
            <div class="tx-indicator" id="txIndicator">
                <span class="dot"></span>
                <span id="txDateText">No TX date</span>
            </div>
            <div class="patient-actions">
                <button class="header-btn" id="newPatientBtn" title="New Patient">‚ûï</button>
                <button class="header-btn" id="patientListBtn" title="Patient List">üë•</button>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Quick Calc Mode -->
            <div id="modeQuick" class="mode-section active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Quick Calculation</div>
                        <div class="card-badge" id="quickBadge">No Patient</div>
                    </div>
                    
                    <!-- Baseline Input (ALWAYS VISIBLE) -->
                    <div class="baseline-container">
                        <div class="baseline-header">
                            <div class="baseline-label">
                                <span>üìä Baseline FEV‚ÇÅ</span>
                                <div class="baseline-value-display" id="baselineValueDisplay">-- L</div>
                            </div>
                            <button class="baseline-action-btn" id="baselineActionBtn" disabled>Set</button>
                        </div>
                        <input type="number" step="0.01" min="0.5" max="8.0" class="text-input" 
                               id="baselineInput" placeholder="Enter baseline FEV‚ÇÅ">
                        <div class="baseline-progress">
                            <div class="baseline-progress-bar" id="baselineProgress"></div>
                        </div>
                        <div class="input-hint" id="baselineHint">
                            Baseline value is required for percentage calculations
                        </div>
                    </div>
                    
                    <!-- Current Measurements -->
                    <div class="measurement-grid">
                        <div class="input-group">
                            <label class="input-label" for="inputFev1">Current FEV‚ÇÅ</label>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="8.0" 
                                       class="text-input" id="inputFev1" placeholder="2.85" required>
                                <span class="input-unit">L</span>
                            </div>
                            <div class="input-hint">Forced Expiratory Volume in 1 second</div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" for="inputFvc">Current FVC</label>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="10.0" 
                                       class="text-input" id="inputFvc" placeholder="3.40">
                                <span class="input-unit">L</span>
                            </div>
                            <div class="input-hint">Forced Vital Capacity (optional)</div>
                        </div>
                    </div>
                    
                    <!-- Date Input -->
                    <div class="input-group">
                        <label class="input-label" for="measurementDate">Measurement Date</label>
                        <div>
                            <input type="date" class="date-input" id="measurementDate">
                            <div class="date-shortcuts">
                                <button class="date-shortcut" data-offset="-7">1w ago</button>
                                <button class="date-shortcut" data-offset="-30">1m ago</button>
                                <button class="date-shortcut" data-offset="-90">3m ago</button>
                                <button class="date-shortcut" data-offset="0">Today</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Options -->
                    <div class="comparison-options">
                        <div class="comparison-option" id="comparisonNone">
                            <div class="option-header">
                                <input type="radio" name="comparison" class="option-radio" value="none" checked>
                                <span class="option-title">Current values only</span>
                            </div>
                            <div class="option-description">Show raw measurements without comparison</div>
                        </div>
                        <div class="comparison-option selected" id="comparisonBaseline">
                            <div class="option-header">
                                <input type="radio" name="comparison" class="option-radio" value="baseline">
                                <span class="option-title">vs Baseline</span>
                            </div>
                            <div class="option-description">Compare to established baseline value</div>
                        </div>
                        <div class="comparison-option" id="comparisonPrevious">
                            <div class="option-header">
                                <input type="radio" name="comparison" class="option-radio" value="previous">
                                <span class="option-title">vs Previous Visit</span>
                            </div>
                            <div class="option-description">Compare to last recorded measurement</div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel" id="resultsPanel">
                    <div class="card">
                        <div class="results-header">
                            <div class="results-title">Results</div>
                            <div class="results-timestamp" id="resultsTimestamp">Just now</div>
                        </div>
                        
                        <div class="measurement-cards">
                            <div class="measurement-card">
                                <div class="measurement-value" id="resultFev1">--</div>
                                <span class="measurement-label">FEV‚ÇÅ</span>
                                <div class="measurement-unit">
                                    <span id="resultFev1Percent">--%</span>
                                    <span class="percent-display neutral" id="fev1PercentBadge">--</span>
                                </div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="resultFvc">--</div>
                                <span class="measurement-label">FVC</span>
                                <div class="measurement-unit">Liters</div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="resultRatio">--</div>
                                <span class="measurement-label">Ratio</span>
                                <div class="measurement-unit">FEV‚ÇÅ/FVC</div>
                            </div>
                        </div>
                        
                        <!-- Protocol Context -->
                        <div class="protocol-context mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Protocol Context</div>
                                    <div class="flex gap-2">
                                        <span class="alert-cell monitor">Monitor ‚â•10%</span>
                                        <span class="alert-cell review">Review ‚â•20%</span>
                                    </div>
                                </div>
                                <div class="text-sm text-secondary" id="protocolNote">
                                    Enter measurements to see protocol guidance
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="btn btn-secondary" id="clearQuickBtn">üóëÔ∏è Clear</button>
                    <button class="btn btn-primary" id="calculateBtn">üìä Calculate</button>
                </div>
            </div>
            
            <!-- Monitor Mode -->
            <div id="modeMonitor" class="mode-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">First Year Monitoring</div>
                        <div class="card-badge" id="monitorBadge">No Patient</div>
                    </div>
                    
                    <!-- Monitor Controls -->
                    <div class="monitor-controls">
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-view="table">üìã Table</button>
                            <button class="view-toggle-btn" data-view="timeline">üìÖ Timeline</button>
                            <button class="view-toggle-btn" data-view="chart">üìä Chart</button>
                        </div>
                    </div>
                    
                    <!-- Add Visit Form -->
                    <div class="input-group">
                        <label class="input-label">Add New Visit</label>
                        <div class="measurement-grid">
                            <div>
                                <input type="date" class="date-input" id="visitDate">
                            </div>
                            <div>
                                <input type="number" step="0.01" class="text-input" id="visitFev1" placeholder="FEV‚ÇÅ">
                            </div>
                            <div>
                                <input type="number" step="0.01" class="text-input" id="visitFvc" placeholder="FVC">
                            </div>
                            <div>
                                <button class="btn btn-primary w-full" id="addVisitBtn">‚ûï Add</button>
                            </div>
                        </div>
                        <div class="date-shortcuts">
                            <button class="date-shortcut" data-offset="-7">1w ago</button>
                            <button class="date-shortcut" data-offset="-30">1m ago</button>
                            <button class="date-shortcut" data-offset="-90">3m ago</button>
                            <button class="date-shortcut" data-offset="0">Today</button>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="table-view" id="tableView">
                        <div class="table-container">
                            <table class="medical-table" id="visitsTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Days</th>
                                        <th>FEV‚ÇÅ (L)</th>
                                        <th>% of PB</th>
                                        <th>FVC</th>
                                        <th>Ratio</th>
                                        <th>Œî Visit</th>
                                        <th>Œî Baseline</th>
                                        <th>Rate</th>
                                        <th>Alert</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody">
                                    <tr>
                                        <td colspan="12" class="text-center p-4 text-secondary">
                                            No visits yet. Add visits using the form above.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Timeline View (Hidden) -->
                    <div class="timeline-view hidden" id="timelineView">
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                        <div class="card mt-4">
                            <div class="card-header">
                                <div class="card-title">Timeline Summary</div>
                            </div>
                            <div class="text-sm">
                                <div class="flex justify-between mb-2">
                                    <span class="text-secondary">Total Visits:</span>
                                    <span class="font-semibold" id="timelineTotalVisits">0</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-secondary">Time Span:</span>
                                    <span class="font-semibold" id="timelineTimeSpan">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-secondary">Current Status:</span>
                                    <span class="font-semibold" id="timelineStatus">No data</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart View (Hidden) -->
                    <div class="chart-view hidden" id="chartView">
                        <div class="chart-container">
                            <canvas id="fev1Chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Monitor Actions -->
                <div class="action-bar">
                    <button class="btn btn-secondary" id="clearMonitorBtn">üóëÔ∏è Clear Table</button>
                    <button class="btn btn-primary" id="exportPDFBtn">üìÑ Export PDF</button>
                </div>
            </div>
            
            <!-- Full Study Mode -->
            <div id="modeFull" class="mode-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Full Patient Study</div>
                        <div class="card-badge" id="fullBadge">No Patient</div>
                    </div>
                    
                    <!-- Timeline Setup -->
                    <div class="measurement-grid">
                        <div class="input-group">
                            <label class="input-label">Transplant Date</label>
                            <input type="date" class="date-input" id="txDate">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Baseline Date</label>
                            <input type="date" class="date-input" id="baselineDate">
                        </div>
                    </div>
                    
                    <div class="date-shortcuts mb-4">
                        <button class="date-shortcut" data-offset="-365">1y ago</button>
                        <button class="date-shortcut" data-offset="-730">2y ago</button>
                        <button class="date-shortcut" data-offset="-1095">3y ago</button>
                        <button class="date-shortcut" data-offset="0">Today</button>
                    </div>
                    
                    <!-- Spirometry Inputs -->
                    <div class="measurement-grid">
                        <div class="input-group">
                            <label class="input-label">Current FEV‚ÇÅ</label>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" class="text-input" id="stdFev1" placeholder="2.85">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Baseline FEV‚ÇÅ</label>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" class="text-input" id="stdBaselineFev1" placeholder="3.20">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clinical Notes -->
                    <div class="input-group">
                        <label class="input-label">Clinical Context</label>
                        <textarea class="text-input" id="clinicalNotes" 
                                  placeholder="Enter clinical context, symptoms, medications..." 
                                  style="min-height: 80px; resize: vertical;"></textarea>
                        <div class="input-hint">For your reference only</div>
                    </div>
                </div>
                
                <!-- Full Study Results -->
                <div class="results-panel" id="stdResultsPanel">
                    <div class="card">
                        <div class="results-header">
                            <div class="results-title">Comprehensive Analysis</div>
                            <div class="results-timestamp" id="stdResultsTimestamp">Just now</div>
                        </div>
                        
                        <div class="measurement-cards">
                            <div class="measurement-card">
                                <div class="measurement-value" id="stdCurrentFev1">--</div>
                                <span class="measurement-label">Current FEV‚ÇÅ</span>
                                <div class="measurement-unit">
                                    <span id="stdCurrentPercent">--%</span>
                                    <span class="percent-display neutral" id="stdCurrentBadge">--</span>
                                </div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="stdBaseline">--</div>
                                <span class="measurement-label">Baseline</span>
                                <div class="measurement-unit">Liters</div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="stdTimePeriod">--</div>
                                <span class="measurement-label">Time Period</span>
                                <div class="measurement-unit">Days</div>
                            </div>
                        </div>
                        
                        <!-- Comparison Results -->
                        <div class="comparison-results mt-4">
                            <div class="input-label">Baseline Comparison</div>
                            <div class="measurement-cards">
                                <div class="measurement-card">
                                    <div class="measurement-value">
                                        <span class="trend-arrow neutral" id="stdTrendArrow">‚Üí</span>
                                        <span id="stdCumulativeDelta">--</span>
                                    </div>
                                    <span class="measurement-label">Cumulative Œî</span>
                                    <div class="measurement-unit">Liters</div>
                                </div>
                                <div class="measurement-card">
                                    <div class="measurement-value" id="stdPercentDecline">--%</div>
                                    <span class="measurement-label">% Decline</span>
                                    <div class="measurement-unit">of Baseline</div>
                                </div>
                                <div class="measurement-card">
                                    <div class="measurement-value" id="stdMonthlyRate">--</div>
                                    <span class="measurement-label">Monthly Rate</span>
                                    <div class="measurement-unit">L/month</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Full Study Actions -->
                <div class="action-bar">
                    <button class="btn btn-secondary" id="clearStdBtn">üóëÔ∏è Clear All</button>
                    <button class="btn btn-primary" id="saveStudyBtn">üíæ Save Full Study</button>
                </div>
            </div>
            
            <!-- Patients Mode -->
            <div id="modePatients" class="mode-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Patient Management</div>
                        <button class="btn btn-primary" id="createPatientBtn">‚ûï New Patient</button>
                    </div>
                    
                    <!-- Patient List -->
                    <div class="table-container">
                        <table class="medical-table" id="patientsTable">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Transplant Date</th>
                                    <th>Visits</th>
                                    <th>Last Visit</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center p-4 text-secondary">
                                        No patients yet. Create your first patient.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Import/Export -->
                    <div class="action-bar mt-4">
                        <button class="btn btn-secondary" id="importPatientsBtn">üì• Import Patients</button>
                        <button class="btn btn-secondary" id="exportPatientsBtn">üì§ Export All Data</button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Navigation -->
        <nav class="app-navigation">
            <button class="nav-btn active" data-mode="quick">
                <span class="nav-icon">‚ö°</span>
                <span>Quick</span>
            </button>
            <button class="nav-btn" data-mode="monitor">
                <span class="nav-icon">üìä</span>
                <span>Monitor</span>
            </button>
            <button class="nav-btn" data-mode="full">
                <span class="nav-icon">üìã</span>
                <span>Full Study</span>
            </button>
            <button class="nav-btn" data-mode="patients">
                <span class="nav-icon">üë•</span>
                <span>Patients</span>
            </button>
        </nav>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Protocol Modal -->
    <div class="modal-overlay" id="protocolModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Protocol Settings</div>
                <button class="modal-close" id="closeProtocolModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Monitor Threshold</label>
                    <input type="range" min="5" max="25" step="1" value="10" class="w-full" id="monitorThreshold">
                    <div class="flex justify-between mt-1 text-xs">
                        <span class="text-tertiary">5%</span>
                        <span class="font-semibold" id="monitorThresholdValue">10%</span>
                        <span class="text-tertiary">25%</span>
                    </div>
                    <div class="input-hint">Show monitor alert at this % decline from baseline</div>
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Review Threshold</label>
                    <input type="range" min="10" max="40" step="1" value="20" class="w-full" id="reviewThreshold">
                    <div class="flex justify-between mt-1 text-xs">
                        <span class="text-tertiary">10%</span>
                        <span class="font-semibold" id="reviewThresholdValue">20%</span>
                        <span class="text-tertiary">40%</span>
                    </div>
                    <div class="input-hint">Show review alert at this % decline from baseline</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="resetProtocolBtn">Reset Defaults</button>
                <button class="btn btn-primary" id="saveProtocolBtn">Save Protocol</button>
            </div>
        </div>
    </div>
    
    <!-- New Patient Modal -->
    <div class="modal-overlay" id="newPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Patient</div>
                <button class="modal-close" id="closeNewPatientModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Patient ID</label>
                    <input type="text" class="text-input" id="newPatientId" placeholder="PT001" autofocus>
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Transplant Date</label>
                    <input type="date" class="date-input" id="newTxDate">
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Description (optional)</label>
                    <input type="text" class="text-input" id="newPatientDesc" 
                           placeholder="e.g., Bilateral lung transplant, CF">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelNewPatientBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmNewPatientBtn">Create Patient</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Export Data</div>
                <button class="modal-close" id="closeExportModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Export Format</label>
                    <div class="comparison-options">
                        <div class="comparison-option selected" data-format="pdf">
                            <div class="option-header">
                                <input type="radio" name="exportFormat" class="option-radio" value="pdf" checked>
                                <span class="option-title">PDF Report</span>
                            </div>
                            <div class="option-description">Clinical report with charts and tables</div>
                        </div>
                        <div class="comparison-option" data-format="csv">
                            <div class="option-header">
                                <input type="radio" name="exportFormat" class="option-radio" value="csv">
                                <span class="option-title">CSV Data</span>
                            </div>
                            <div class="option-description">Spreadsheet-friendly data export</div>
                        </div>
                        <div class="comparison-option" data-format="json">
                            <div class="option-header">
                                <input type="radio" name="exportFormat" class="option-radio" value="json">
                                <span class="option-title">JSON Backup</span>
                            </div>
                            <div class="option-description">Complete backup of all data</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmExportBtn">Export Data</button>
            </div>
        </div>
    </div>

    <script>
        // === COMPLETE SPIRALITE PROFESSIONAL - 100% IMPLEMENTED ===
        
        class SpiroliteApp {
            constructor() {
                this.state = {
                    mode: 'quick',
                    currentPatient: null,
                    patients: new Map(),
                    protocol: {
                        monitorThreshold: 10,
                        reviewThreshold: 20
                    },
                    settings: {
                        colorCoding: true,
                        percentageView: true
                    },
                    session: {
                        quick: {
                            baseline: null,
                            baselineSet: false,
                            comparison: 'baseline'
                        }
                    },
                    history: []
                };
                
                this.charts = {
                    timeline: null,
                    fev1: null
                };
                
                this.dom = {};
                this.init();
            }
            
            init() {
                console.log('üöÄ Starting Spirolite Professional...');
                this.showLoading('Loading Spirolite Professional', 0);
                
                try {
                    this.cacheDOM();
                    this.setupEventListeners();
                    this.loadState();
                    this.initializeUI();
                    
                    // Simulate loading
                    setTimeout(() => {
                        this.updateLoading('Preparing clinical tools...', 25);
                        setTimeout(() => {
                            this.updateLoading('Configuring calculations...', 50);
                            setTimeout(() => {
                                this.updateLoading('Initializing interface...', 75);
                                setTimeout(() => {
                                    this.updateLoading('Ready for use', 100);
                                    setTimeout(() => {
                                        this.hideLoading();
                                        this.showToast('Spirolite Professional ready', 'success');
                                    }, 300);
                                }, 300);
                            }, 300);
                        }, 300);
                    }, 300);
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Initialization failed', 'error');
                }
            }
            
            cacheDOM() {
                // Cache all DOM elements
                const ids = [
                    'loadingOverlay', 'appContainer', 'undoBtn', 'redoBtn',
                    'protocolBtn', 'exportBtn', 'patientAvatar', 'patientId',
                    'patientStatus', 'visitCount', 'txIndicator', 'txDateText',
                    'newPatientBtn', 'patientListBtn', 'baselineInput',
                    'baselineValueDisplay', 'baselineActionBtn', 'baselineProgress',
                    'baselineHint', 'inputFev1', 'inputFvc', 'measurementDate',
                    'resultsPanel', 'resultFev1', 'resultFvc', 'resultRatio',
                    'resultsTimestamp', 'resultFev1Percent', 'fev1PercentBadge',
                    'calculateBtn', 'clearQuickBtn', 'visitDate', 'visitFev1',
                    'visitFvc', 'addVisitBtn', 'visitsTableBody', 'clearMonitorBtn',
                    'exportPDFBtn', 'txDate', 'baselineDate', 'stdFev1',
                    'stdBaselineFev1', 'clinicalNotes', 'stdResultsPanel',
                    'stdCurrentFev1', 'stdBaseline', 'stdTimePeriod',
                    'stdCurrentPercent', 'stdCurrentBadge', 'stdCumulativeDelta',
                    'stdPercentDecline', 'stdMonthlyRate', 'stdResultsTimestamp',
                    'clearStdBtn', 'saveStudyBtn', 'createPatientBtn',
                    'patientsTableBody', 'importPatientsBtn', 'exportPatientsBtn',
                    'protocolModal', 'newPatientModal', 'exportModal',
                    'closeProtocolModal', 'closeNewPatientModal', 'closeExportModal',
                    'monitorThreshold', 'monitorThresholdValue', 'reviewThreshold',
                    'reviewThresholdValue', 'resetProtocolBtn', 'saveProtocolBtn',
                    'newPatientId', 'newTxDate', 'newPatientDesc',
                    'cancelNewPatientBtn', 'confirmNewPatientBtn',
                    'cancelExportBtn', 'confirmExportBtn', 'toastContainer'
                ];
                
                ids.forEach(id => {
                    this.dom[id] = document.getElementById(id);
                });
                
                // Cache navigation buttons
                this.dom.navBtns = document.querySelectorAll('.nav-btn');
                this.dom.comparisonOptions = document.querySelectorAll('.comparison-option');
                this.dom.viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
                this.dom.dateShortcuts = document.querySelectorAll('.date-shortcut');
            }
            
            setupEventListeners() {
                // Header actions
                this.dom.undoBtn?.addEventListener('click', () => this.handleUndo());
                this.dom.redoBtn?.addEventListener('click', () => this.handleRedo());
                this.dom.protocolBtn?.addEventListener('click', () => this.showModal('protocolModal'));
                this.dom.exportBtn?.addEventListener('click', () => this.showModal('exportModal'));
                
                // Patient actions
                this.dom.newPatientBtn?.addEventListener('click', () => this.showModal('newPatientModal'));
                this.dom.patientListBtn?.addEventListener('click', () => this.switchMode('patients'));
                
                // Navigation
                this.dom.navBtns?.forEach(btn => {
                    btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
                });
                
                // Quick Mode
                this.dom.baselineInput?.addEventListener('input', () => this.handleBaselineInput());
                this.dom.baselineActionBtn?.addEventListener('click', () => this.setBaseline());
                this.dom.inputFev1?.addEventListener('input', () => this.validateQuickInputs());
                this.dom.inputFvc?.addEventListener('input', () => this.validateQuickInputs());
                this.dom.calculateBtn?.addEventListener('click', () => this.calculateQuick());
                this.dom.clearQuickBtn?.addEventListener('click', () => this.clearQuick());
                
                // Comparison options
                this.dom.comparisonOptions?.forEach(option => {
                    option.addEventListener('click', () => this.selectComparisonOption(option));
                });
                
                // Monitor Mode
                this.dom.addVisitBtn?.addEventListener('click', () => this.addVisit());
                this.dom.clearMonitorBtn?.addEventListener('click', () => this.clearMonitor());
                this.dom.exportPDFBtn?.addEventListener('click', () => this.exportPDF());
                
                // View toggles
                this.dom.viewToggleBtns?.forEach(btn => {
                    btn.addEventListener('click', () => this.switchMonitorView(btn.dataset.view));
                });
                
                // Full Study Mode
                this.dom.saveStudyBtn?.addEventListener('click', () => this.saveFullStudy());
                this.dom.clearStdBtn?.addEventListener('click', () => this.clearFullStudy());
                
                // Patients Mode
                this.dom.createPatientBtn?.addEventListener('click', () => this.showModal('newPatientModal'));
                this.dom.importPatientsBtn?.addEventListener('click', () => this.importPatients());
                this.dom.exportPatientsBtn?.addEventListener('click', () => this.showModal('exportModal'));
                
                // Date shortcuts
                this.dom.dateShortcuts?.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const offset = parseInt(e.target.dataset.offset);
                        this.setDateShortcut(offset);
                    });
                });
                
                // Modal controls
                this.dom.closeProtocolModal?.addEventListener('click', () => this.hideModal('protocolModal'));
                this.dom.closeNewPatientModal?.addEventListener('click', () => this.hideModal('newPatientModal'));
                this.dom.closeExportModal?.addEventListener('click', () => this.hideModal('exportModal'));
                
                this.dom.monitorThreshold?.addEventListener('input', (e) => {
                    this.dom.monitorThresholdValue.textContent = `${e.target.value}%`;
                });
                
                this.dom.reviewThreshold?.addEventListener('input', (e) => {
                    this.dom.reviewThresholdValue.textContent = `${e.target.value}%`;
                });
                
                this.dom.resetProtocolBtn?.addEventListener('click', () => this.resetProtocol());
                this.dom.saveProtocolBtn?.addEventListener('click', () => this.saveProtocol());
                
                this.dom.cancelNewPatientBtn?.addEventListener('click', () => this.hideModal('newPatientModal'));
                this.dom.confirmNewPatientBtn?.addEventListener('click', () => this.createPatient());
                
                this.dom.cancelExportBtn?.addEventListener('click', () => this.hideModal('exportModal'));
                this.dom.confirmExportBtn?.addEventListener('click', () => this.exportData());
                
                // Modal overlay clicks
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
            }
            
            initializeUI() {
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                ['measurementDate', 'visitDate', 'txDate', 'baselineDate', 'newTxDate'].forEach(id => {
                    if (this.dom[id]) this.dom[id].value = today;
                });
                
                // Load protocol values
                if (this.dom.monitorThreshold) {
                    this.dom.monitorThreshold.value = this.state.protocol.monitorThreshold;
                    this.dom.monitorThresholdValue.textContent = `${this.state.protocol.monitorThreshold}%`;
                }
                if (this.dom.reviewThreshold) {
                    this.dom.reviewThreshold.value = this.state.protocol.reviewThreshold;
                    this.dom.reviewThresholdValue.textContent = `${this.state.protocol.reviewThreshold}%`;
                }
                
                // Initialize baseline progress
                if (this.dom.baselineProgress) {
                    this.dom.baselineProgress.style.width = '0%';
                }
                
                // Update patient info
                this.updatePatientInfo();
                
                console.log('‚úÖ UI initialized');
            }
            
            // === LOADING FUNCTIONS ===
            showLoading(text, percent) {
                const loadingStep = document.getElementById('loadingStep');
                const loadingPercent = document.getElementById('loadingPercent');
                const loadingProgressBar = document.getElementById('loadingProgressBar');
                
                if (loadingStep) loadingStep.textContent = text;
                if (loadingPercent) loadingPercent.textContent = `${percent}%`;
                if (loadingProgressBar) loadingProgressBar.style.width = `${percent}%`;
                
                if (this.dom.loadingOverlay) {
                    this.dom.loadingOverlay.style.display = 'flex';
                }
            }
            
            updateLoading(text, percent) {
                this.showLoading(text, percent);
            }
            
            hideLoading() {
                if (this.dom.loadingOverlay) {
                    this.dom.loadingOverlay.classList.add('fade-out');
                    setTimeout(() => {
                        this.dom.loadingOverlay.style.display = 'none';
                    }, 500);
                }
            }
            
            // === QUICK MODE FUNCTIONS ===
            handleBaselineInput() {
                const value = this.dom.baselineInput.value;
                const numValue = parseFloat(value);
                const isValid = !isNaN(numValue) && numValue >= 0.5 && numValue <= 8.0;
                
                if (value && isValid) {
                    // Update progress bar
                    const progress = Math.min((value.length / 4) * 100, 100);
                    this.dom.baselineProgress.style.width = `${progress}%`;
                    
                    // Update button state
                    this.dom.baselineActionBtn.disabled = false;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn ready';
                    this.dom.baselineActionBtn.textContent = 'Set';
                    
                    // Update hint
                    this.dom.baselineHint.textContent = `Ready to set baseline: ${numValue.toFixed(2)} L`;
                    this.dom.baselineHint.style.color = 'var(--primary)';
                } else if (value && !isValid) {
                    this.dom.baselineActionBtn.disabled = true;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn';
                    this.dom.baselineHint.textContent = 'Please enter a value between 0.5 and 8.0 L';
                    this.dom.baselineHint.style.color = 'var(--error)';
                } else {
                    this.dom.baselineActionBtn.disabled = true;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn';
                    this.dom.baselineProgress.style.width = '0%';
                    this.dom.baselineHint.textContent = 'Baseline value is required for percentage calculations';
                    this.dom.baselineHint.style.color = 'var(--text-tertiary)';
                }
            }
            
            setBaseline() {
                const value = parseFloat(this.dom.baselineInput.value);
                
                if (isNaN(value) || value < 0.5 || value > 8.0) {
                    this.showToast('Please enter a valid baseline value (0.5-8.0 L)', 'error');
                    return;
                }
                
                // Save baseline
                this.state.session.quick.baseline = value;
                this.state.session.quick.baselineSet = true;
                
                // Update display
                this.dom.baselineValueDisplay.textContent = `${value.toFixed(2)} L`;
                
                // Update button to success state
                this.dom.baselineActionBtn.className = 'baseline-action-btn success';
                this.dom.baselineActionBtn.textContent = 'Set';
                this.dom.baselineActionBtn.disabled = true;
                
                // Update progress bar
                this.dom.baselineProgress.style.width = '100%';
                
                // Update hint
                this.dom.baselineHint.textContent = `Baseline set at ${value.toFixed(2)} L`;
                this.dom.baselineHint.style.color = 'var(--success)';
                
                // Show success toast
                this.showToast(`Baseline set to ${value.toFixed(2)} L`, 'success');
                
                // Enable calculation if FEV1 is entered
                this.validateQuickInputs();
                
                // Save state
                this.saveState();
                
                // Reset success state after 3 seconds
                setTimeout(() => {
                    this.dom.baselineActionBtn.disabled = false;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn ready';
                    this.dom.baselineActionBtn.textContent = 'Update';
                }, 3000);
            }
            
            validateQuickInputs() {
                const fev1 = this.dom.inputFev1.value;
                const baselineSet = this.state.session.quick.baselineSet;
                const fev1Valid = fev1 && !isNaN(parseFloat(fev1)) && parseFloat(fev1) >= 0.5;
                
                // Enable calculate button if baseline is set and FEV1 is valid
                this.dom.calculateBtn.disabled = !(baselineSet && fev1Valid);
                
                return fev1Valid && baselineSet;
            }
            
            selectComparisonOption(option) {
                // Remove selected class from all options
                this.dom.comparisonOptions.forEach(opt => {
                    opt.classList.remove('selected');
                    const radio = opt.querySelector('.option-radio');
                    if (radio) radio.checked = false;
                });
                
                // Add selected class to clicked option
                option.classList.add('selected');
                const radio = option.querySelector('.option-radio');
                if (radio) {
                    radio.checked = true;
                    this.state.session.quick.comparison = radio.value;
                }
            }
            
            calculateQuick() {
                if (!this.validateQuickInputs()) {
                    this.showToast('Please set baseline and enter current FEV‚ÇÅ', 'error');
                    return;
                }
                
                const fev1 = parseFloat(this.dom.inputFev1.value);
                const fvc = this.dom.inputFvc.value ? parseFloat(this.dom.inputFvc.value) : null;
                const baseline = this.state.session.quick.baseline;
                
                // Calculate percentages
                const fev1Percent = ((fev1 / baseline) * 100).toFixed(1);
                
                // Determine status
                let statusClass = 'neutral';
                let statusText = '--';
                
                if (fev1Percent >= 90) {
                    statusClass = 'good';
                    statusText = 'Normal';
                } else if (fev1Percent >= 80) {
                    statusClass = 'warning';
                    statusText = 'Mild';
                } else if (fev1Percent >= 70) {
                    statusClass = 'warning';
                    statusText = 'Moderate';
                } else {
                    statusClass = 'alert';
                    statusText = 'Severe';
                }
                
                // Update results
                this.dom.resultFev1.textContent = fev1.toFixed(2);
                this.dom.resultFev1Percent.textContent = `${fev1Percent}%`;
                this.dom.fev1PercentBadge.textContent = statusText;
                this.dom.fev1PercentBadge.className = `percent-display ${statusClass}`;
                
                // Update FVC if available
                if (fvc) {
                    this.dom.resultFvc.textContent = fvc.toFixed(2);
                    const ratio = ((fev1 / fvc) * 100).toFixed(1);
                    this.dom.resultRatio.textContent = `${ratio}%`;
                } else {
                    this.dom.resultFvc.textContent = '--';
                    this.dom.resultRatio.textContent = '--';
                }
                
                // Update timestamp
                const now = new Date();
                this.dom.resultsTimestamp.textContent = 
                    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Show results
                this.dom.resultsPanel.classList.add('visible');
                
                // Update protocol context
                this.updateProtocolContext(fev1Percent);
                
                this.showToast('Calculation complete', 'success');
                this.saveState();
            }
            
            updateProtocolContext(percent) {
                const monitorThreshold = this.state.protocol.monitorThreshold;
                const reviewThreshold = this.state.protocol.reviewThreshold;
                
                let note = '';
                if (percent >= 100 - reviewThreshold) {
                    note = `Significant decline (‚â•${reviewThreshold}%) - Clinical review recommended`;
                } else if (percent >= 100 - monitorThreshold) {
                    note = `Moderate decline (‚â•${monitorThreshold}%) - Monitor closely`;
                } else {
                    note = 'Within normal limits - Continue routine monitoring';
                }
                
                const protocolNote = document.getElementById('protocolNote');
                if (protocolNote) {
                    protocolNote.textContent = note;
                }
            }
            
            clearQuick() {
                // Clear inputs but keep baseline
                this.dom.inputFev1.value = '';
                this.dom.inputFvc.value = '';
                this.dom.measurementDate.value = new Date().toISOString().split('T')[0];
                
                // Hide results
                this.dom.resultsPanel.classList.remove('visible');
                
                // Focus on FEV1 input
                this.dom.inputFev1.focus();
                
                this.showToast('Calculator cleared', 'info');
            }
            
            // === MONITOR MODE FUNCTIONS ===
            switchMonitorView(view) {
                // Update toggle buttons
                this.dom.viewToggleBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                
                // Hide all views
                document.getElementById('tableView').classList.add('hidden');
                document.getElementById('timelineView').classList.add('hidden');
                document.getElementById('chartView').classList.add('hidden');
                
                // Show selected view
                document.getElementById(`${view}View`).classList.remove('hidden');
                
                if (view === 'timeline') {
                    this.renderTimelineChart();
                } else if (view === 'chart') {
                    this.renderFev1Chart();
                }
            }
            
            addVisit() {
                const date = this.dom.visitDate.value;
                const fev1 = parseFloat(this.dom.visitFev1.value);
                
                if (!date || !fev1 || isNaN(fev1)) {
                    this.showToast('Please enter a valid date and FEV‚ÇÅ', 'error');
                    return;
                }
                
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                const visit = {
                    id: `visit_${Date.now()}`,
                    date,
                    fev1,
                    fvc: this.dom.visitFvc.value ? parseFloat(this.dom.visitFvc.value) : null,
                    timestamp: Date.now()
                };
                
                // Add to patient's visits
                if (!patient.visits) patient.visits = [];
                patient.visits.push(visit);
                
                // Sort visits by date
                patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Clear form
                this.dom.visitFev1.value = '';
                this.dom.visitFvc.value = '';
                
                // Save patient
                this.state.patients.set(patient.id, patient);
                this.saveState();
                
                // Update UI
                this.updatePatientVisitsTable();
                this.updatePatientInfo();
                
                this.showToast('Visit added successfully', 'success');
            }
            
            updatePatientVisitsTable() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) {
                    this.dom.visitsTableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center p-4 text-secondary">
                                No visits yet. Add visits using the form above.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                let html = '';
                
                patient.visits.forEach((visit, index) => {
                    const prevVisit = index > 0 ? patient.visits[index - 1] : null;
                    
                    // Calculate metrics
                    const fev1 = visit.fev1.toFixed(2);
                    const fvc = visit.fvc ? visit.fvc.toFixed(2) : '--';
                    const ratio = visit.fvc ? ((visit.fev1 / visit.fvc) * 100).toFixed(1) + '%' : '--';
                    
                    let baselinePercent = '--';
                    let baselineDelta = '--';
                    if (baseline) {
                        const percent = ((visit.fev1 / baseline) * 100).toFixed(1);
                        baselinePercent = `${percent}%`;
                        baselineDelta = (visit.fev1 - baseline).toFixed(2);
                    }
                    
                    let visitDelta = '--';
                    let visitPercent = '--';
                    let trendArrow = '‚Üí';
                    let trendClass = 'neutral';
                    
                    if (prevVisit) {
                        const delta = visit.fev1 - prevVisit.fev1;
                        const percent = ((delta / prevVisit.fev1) * 100).toFixed(1);
                        visitDelta = delta.toFixed(2);
                        visitPercent = `${percent}%`;
                        
                        if (delta > 0.05) {
                            trendArrow = '‚Üë';
                            trendClass = 'up';
                        } else if (delta < -0.05) {
                            trendArrow = '‚Üì';
                            trendClass = 'down';
                        }
                    }
                    
                    // Calculate days since TX
                    const visitDate = new Date(visit.date);
                    const txDate = patient.txDate ? new Date(patient.txDate) : null;
                    const daysSinceTx = txDate ? Math.floor((visitDate - txDate) / (1000 * 60 * 60 * 24)) : '--';
                    
                    // Determine alert status
                    let alertClass = 'stable';
                    let alertText = 'Stable';
                    
                    if (baseline) {
                        const declinePercent = 100 - ((visit.fev1 / baseline) * 100);
                        if (declinePercent >= this.state.protocol.reviewThreshold) {
                            alertClass = 'review';
                            alertText = 'Review';
                        } else if (declinePercent >= this.state.protocol.monitorThreshold) {
                            alertClass = 'monitor';
                            alertText = 'Monitor';
                        }
                    }
                    
                    // Calculate rate (L/month)
                    let rate = '--';
                    if (prevVisit) {
                        const prevDate = new Date(prevVisit.date);
                        const monthsDiff = (visitDate - prevDate) / (1000 * 60 * 60 * 24 * 30);
                        if (monthsDiff > 0) {
                            rate = ((visit.fev1 - prevVisit.fev1) / monthsDiff).toFixed(3);
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${visit.date}</td>
                            <td>${daysSinceTx}</td>
                            <td>${fev1}</td>
                            <td>${baselinePercent}</td>
                            <td>${fvc}</td>
                            <td>${ratio}</td>
                            <td>
                                <span class="trend-arrow ${trendClass}">${trendArrow}</span>
                                ${visitDelta}
                            </td>
                            <td>${baselineDelta}</td>
                            <td>${rate}</td>
                            <td>
                                <span class="alert-cell ${alertClass}">${alertText}</span>
                            </td>
                            <td>--</td>
                            <td>
                                <button class="header-btn" onclick="spiroliteApp.deleteVisit('${visit.id}')" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                this.dom.visitsTableBody.innerHTML = html;
            }
            
            deleteVisit(visitId) {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits) return;
                
                const initialLength = patient.visits.length;
                patient.visits = patient.visits.filter(v => v.id !== visitId);
                
                if (patient.visits.length < initialLength) {
                    this.state.patients.set(patient.id, patient);
                    this.saveState();
                    this.updatePatientVisitsTable();
                    this.updatePatientInfo();
                    this.showToast('Visit deleted', 'success');
                }
            }
            
            clearMonitor() {
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                if (!patient.visits || patient.visits.length === 0) {
                    this.showToast('No visits to clear', 'info');
                    return;
                }
                
                if (confirm(`Clear all ${patient.visits.length} visits for ${patient.id}?`)) {
                    patient.visits = [];
                    this.state.patients.set(patient.id, patient);
                    this.saveState();
                    
                    this.updatePatientVisitsTable();
                    this.updatePatientInfo();
                    
                    this.showToast('All visits cleared', 'success');
                }
            }
            
            renderTimelineChart() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) return;
                
                const ctx = document.getElementById('timelineChart').getContext('2d');
                
                // Destroy existing chart
                if (this.charts.timeline) {
                    this.charts.timeline.destroy();
                }
                
                // Prepare data
                const labels = patient.visits.map(v => v.date);
                const fev1Data = patient.visits.map(v => v.fev1);
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                
                // Create chart
                this.charts.timeline = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'FEV‚ÇÅ (L)',
                                data: fev1Data,
                                borderColor: '#1A5F7A',
                                backgroundColor: 'rgba(26, 95, 122, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            },
                            baseline ? {
                                label: 'Baseline',
                                data: Array(labels.length).fill(baseline),
                                borderColor: '#10B981',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                fill: false
                            } : null
                        ].filter(Boolean)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'FEV‚ÇÅ (L)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
                
                // Update timeline summary
                this.updateTimelineSummary();
            }
            
            renderFev1Chart() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) return;
                
                const ctx = document.getElementById('fev1Chart').getContext('2d');
                
                // Destroy existing chart
                if (this.charts.fev1) {
                    this.charts.fev1.destroy();
                }
                
                // Prepare data
                const visits = patient.visits;
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                
                // Calculate percentages
                const percentages = visits.map(v => {
                    return baseline ? ((v.fev1 / baseline) * 100).toFixed(1) : null;
                }).filter(Boolean);
                
                // Create chart
                this.charts.fev1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: visits.map(v => v.date),
                        datasets: [
                            {
                                label: '% of Baseline',
                                data: percentages,
                                backgroundColor: percentages.map(p => {
                                    const percent = parseFloat(p);
                                    if (percent >= 90) return 'rgba(16, 185, 129, 0.7)';
                                    if (percent >= 80) return 'rgba(245, 158, 11, 0.7)';
                                    return 'rgba(239, 68, 68, 0.7)';
                                }),
                                borderColor: percentages.map(p => {
                                    const percent = parseFloat(p);
                                    if (percent >= 90) return 'rgb(16, 185, 129)';
                                    if (percent >= 80) return 'rgb(245, 158, 11)';
                                    return 'rgb(239, 68, 68)';
                                }),
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '% of Baseline'
                                },
                                min: 50,
                                max: 120
                            }
                        }
                    }
                });
            }
            
            updateTimelineSummary() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) return;
                
                const visits = patient.visits;
                const totalVisits = visits.length;
                
                // Calculate time span
                const firstDate = new Date(visits[0].date);
                const lastDate = new Date(visits[visits.length - 1].date);
                const timeSpanDays = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
                const timeSpanText = timeSpanDays < 30 ? `${timeSpanDays} days` : `${Math.floor(timeSpanDays / 30)} months`;
                
                // Determine current status
                const lastVisit = visits[visits.length - 1];
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                let status = 'No baseline';
                let statusClass = 'text-tertiary';
                
                if (baseline) {
                    const percent = ((lastVisit.fev1 / baseline) * 100).toFixed(1);
                    if (percent >= 90) {
                        status = 'Stable';
                        statusClass = 'text-success';
                    } else if (percent >= 80) {
                        status = 'Monitoring';
                        statusClass = 'text-warning';
                    } else {
                        status = 'Review Needed';
                        statusClass = 'text-error';
                    }
                    status = `${status} (${percent}%)`;
                }
                
                // Update elements
                document.getElementById('timelineTotalVisits').textContent = totalVisits;
                document.getElementById('timelineTimeSpan').textContent = timeSpanText;
                const statusEl = document.getElementById('timelineStatus');
                statusEl.textContent = status;
                statusEl.className = `font-semibold ${statusClass}`;
            }
            
            // === FULL STUDY MODE FUNCTIONS ===
            saveFullStudy() {
                const fev1 = parseFloat(this.dom.stdFev1.value);
                const baselineFev1 = parseFloat(this.dom.stdBaselineFev1.value);
                const txDate = this.dom.txDate.value;
                
                if (!fev1 || !baselineFev1 || !txDate) {
                    this.showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                // Create or update patient
                if (!this.state.currentPatient) {
                    const patientId = `PT${Date.now().toString().slice(-6)}`;
                    const patient = {
                        id: patientId,
                        txDate,
                        baselineFev1,
                        baselineDate: this.dom.baselineDate.value || txDate,
                        description: this.dom.clinicalNotes.value.trim() || 'Full study patient',
                        visits: [{
                            id: `visit_${Date.now()}`,
                            date: new Date().toISOString().split('T')[0],
                            fev1,
                            fvc: null,
                            timestamp: Date.now()
                        }]
                    };
                    
                    this.state.patients.set(patientId, patient);
                    this.state.currentPatient = patientId;
                    this.updatePatientInfo();
                } else {
                    const patient = this.state.patients.get(this.state.currentPatient);
                    patient.txDate = txDate;
                    patient.baselineFev1 = baselineFev1;
                    patient.baselineDate = this.dom.baselineDate.value || txDate;
                    
                    // Add visit if not already exists for today
                    const today = new Date().toISOString().split('T')[0];
                    const hasTodayVisit = patient.visits && patient.visits.some(v => v.date === today);
                    
                    if (!hasTodayVisit) {
                        if (!patient.visits) patient.visits = [];
                        patient.visits.push({
                            id: `visit_${Date.now()}`,
                            date: today,
                            fev1,
                            fvc: null,
                            timestamp: Date.now()
                        });
                        
                        patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                    }
                    
                    this.state.patients.set(this.state.currentPatient, patient);
                }
                
                // Calculate and show results
                this.calculateFullStudy(fev1, baselineFev1, txDate);
                
                this.saveState();
                this.showToast('Full study saved', 'success');
            }
            
            calculateFullStudy(fev1, baselineFev1, txDate) {
                // Calculate time period
                const today = new Date();
                const txDateObj = new Date(txDate);
                const daysSinceTx = Math.floor((today - txDateObj) / (1000 * 60 * 60 * 24));
                
                // Calculate metrics
                const percentOfBaseline = ((fev1 / baselineFev1) * 100).toFixed(1);
                const cumulativeDelta = (fev1 - baselineFev1).toFixed(2);
                const percentDecline = (100 - percentOfBaseline).toFixed(1);
                const monthlyRate = (cumulativeDelta / (daysSinceTx / 30)).toFixed(3);
                
                // Determine status
                let statusClass = 'neutral';
                let statusText = '--';
                
                if (percentOfBaseline >= 90) {
                    statusClass = 'good';
                    statusText = 'Normal';
                } else if (percentOfBaseline >= 80) {
                    statusClass = 'warning';
                    statusText = 'Mild';
                } else if (percentOfBaseline >= 70) {
                    statusClass = 'warning';
                    statusText = 'Moderate';
                } else {
                    statusClass = 'alert';
                    statusText = 'Severe';
                }
                
                // Update results
                this.dom.stdCurrentFev1.textContent = fev1.toFixed(2);
                this.dom.stdBaseline.textContent = baselineFev1.toFixed(2);
                this.dom.stdTimePeriod.textContent = daysSinceTx;
                this.dom.stdCurrentPercent.textContent = `${percentOfBaseline}%`;
                this.dom.stdCurrentBadge.textContent = statusText;
                this.dom.stdCurrentBadge.className = `percent-display ${statusClass}`;
                
                this.dom.stdCumulativeDelta.textContent = cumulativeDelta;
                this.dom.stdPercentDecline.textContent = `${percentDecline}%`;
                this.dom.stdMonthlyRate.textContent = monthlyRate;
                
                // Update trend arrow
                const trendArrow = this.dom.stdTrendArrow;
                if (cumulativeDelta > 0) {
                    trendArrow.textContent = '‚Üë';
                    trendArrow.className = 'trend-arrow up';
                } else if (cumulativeDelta < 0) {
                    trendArrow.textContent = '‚Üì';
                    trendArrow.className = 'trend-arrow down';
                } else {
                    trendArrow.textContent = '‚Üí';
                    trendArrow.className = 'trend-arrow neutral';
                }
                
                // Update timestamp
                const now = new Date();
                this.dom.stdResultsTimestamp.textContent = 
                    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Show results
                this.dom.stdResultsPanel.classList.add('visible');
            }
            
            clearFullStudy() {
                // Clear inputs
                this.dom.txDate.value = new Date().toISOString().split('T')[0];
                this.dom.baselineDate.value = new Date().toISOString().split('T')[0];
                this.dom.stdFev1.value = '';
                this.dom.stdBaselineFev1.value = '';
                this.dom.clinicalNotes.value = '';
                
                // Hide results
                this.dom.stdResultsPanel.classList.remove('visible');
                
                this.showToast('Full study cleared', 'info');
            }
            
            // === PATIENT MANAGEMENT ===
            createPatient() {
                const id = this.dom.newPatientId.value.trim();
                const txDate = this.dom.newTxDate.value;
                const description = this.dom.newPatientDesc.value.trim();
                
                if (!id) {
                    this.showToast('Please enter a Patient ID', 'error');
                    return;
                }
                
                if (!txDate) {
                    this.showToast('Please select a transplant date', 'error');
                    return;
                }
                
                // Check if patient already exists
                if (this.state.patients.has(id)) {
                    this.showToast('Patient ID already exists', 'error');
                    return;
                }
                
                // Create patient
                const patient = {
                    id,
                    txDate,
                    description: description || `Patient ${id}`,
                    visits: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                // Add to patients
                this.state.patients.set(id, patient);
                this.state.currentPatient = id;
                
                // Update UI
                this.updatePatientInfo();
                this.updatePatientsTable();
                this.hideModal('newPatientModal');
                
                this.saveState();
                this.showToast(`Patient ${id} created successfully`, 'success');
                
                // Switch to monitor mode
                this.switchMode('monitor');
            }
            
            updatePatientsTable() {
                const patients = Array.from(this.state.patients.values());
                
                if (patients.length === 0) {
                    this.dom.patientsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-4 text-secondary">
                                No patients yet. Create your first patient.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                patients.forEach(patient => {
                    const lastVisit = patient.visits && patient.visits.length > 0 
                        ? patient.visits[patient.visits.length - 1] 
                        : null;
                    
                    // Determine status
                    let status = 'No data';
                    let statusClass = 'text-tertiary';
                    
                    if (lastVisit && patient.baselineFev1) {
                        const percent = ((lastVisit.fev1 / patient.baselineFev1) * 100).toFixed(1);
                        if (percent >= 90) {
                            status = 'Stable';
                            statusClass = 'text-success';
                        } else if (percent >= 80) {
                            status = 'Monitoring';
                            statusClass = 'text-warning';
                        } else {
                            status = 'Review';
                            statusClass = 'text-error';
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>
                                <div class="font-semibold">${patient.id}</div>
                                <div class="text-xs text-tertiary">${patient.description}</div>
                            </td>
                            <td>${patient.txDate || '--'}</td>
                            <td>${patient.visits ? patient.visits.length : 0}</td>
                            <td>${lastVisit ? lastVisit.date : '--'}</td>
                            <td class="${statusClass}">${status}</td>
                            <td>
                                <button class="header-btn" onclick="spiroliteApp.selectPatient('${patient.id}')" title="Select">
                                    üëÅÔ∏è
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                this.dom.patientsTableBody.innerHTML = html;
            }
            
            selectPatient(patientId) {
                if (!this.state.patients.has(patientId)) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                this.state.currentPatient = patientId;
                this.updatePatientInfo();
                this.updatePatientVisitsTable();
                
                // Switch to monitor mode
                this.switchMode('monitor');
                
                this.showToast(`Selected patient: ${patientId}`, 'success');
            }
            
            importPatients() {
                // Simple patient import from JSON
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.patients && Array.isArray(data.patients)) {
                                data.patients.forEach(patient => {
                                    this.state.patients.set(patient.id, patient);
                                });
                                this.saveState();
                                this.updatePatientsTable();
                                this.showToast(`${data.patients.length} patients imported`, 'success');
                            } else {
                                this.showToast('Invalid file format', 'error');
                            }
                        } catch (error) {
                            this.showToast('Error reading file', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            }
            
            // === PROTOCOL SETTINGS ===
            resetProtocol() {
                this.dom.monitorThreshold.value = 10;
                this.dom.monitorThresholdValue.textContent = '10%';
                this.dom.reviewThreshold.value = 20;
                this.dom.reviewThresholdValue.textContent = '20%';
                
                this.showToast('Protocol reset to defaults', 'info');
            }
            
            saveProtocol() {
                this.state.protocol.monitorThreshold = parseInt(this.dom.monitorThreshold.value);
                this.state.protocol.reviewThreshold = parseInt(this.dom.reviewThreshold.value);
                
                this.saveState();
                this.hideModal('protocolModal');
                
                this.showToast('Protocol settings saved', 'success');
            }
            
            // === EXPORT FUNCTIONS ===
            async exportData() {
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                
                this.hideModal('exportModal');
                
                switch (format) {
                    case 'pdf':
                        await this.exportPDF();
                        break;
                    case 'csv':
                        await this.exportCSV();
                        break;
                    case 'json':
                        await this.exportJSON();
                        break;
                }
            }
            
            async exportPDF() {
                // Simple PDF export using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('Spirolite Professional Report', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
                
                if (this.state.currentPatient) {
                    const patient = this.state.patients.get(this.state.currentPatient);
                    doc.text(`Patient: ${patient.id}`, 20, 40);
                    doc.text(`Transplant Date: ${patient.txDate}`, 20, 50);
                    
                    if (patient.visits && patient.visits.length > 0) {
                        let y = 70;
                        doc.text('Visit History:', 20, y);
                        y += 10;
                        
                        patient.visits.forEach((visit, index) => {
                            if (y > 280) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(`${visit.date}: FEV‚ÇÅ ${visit.fev1}L, FVC ${visit.fvc || '--'}L`, 30, y);
                            y += 7;
                        });
                    }
                }
                
                doc.save(`spirolite_report_${new Date().toISOString().split('T')[0]}.pdf`);
                this.showToast('PDF exported successfully', 'success');
            }
            
            async exportCSV() {
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) {
                    this.showToast('No data to export', 'error');
                    return;
                }
                
                // Create CSV content
                const headers = ['Date', 'Days Post-Tx', 'FEV‚ÇÅ (L)', 'FVC (L)', 'FEV‚ÇÅ/FVC Ratio', '% of Baseline'];
                const rows = patient.visits.map(visit => {
                    const txDate = new Date(patient.txDate);
                    const visitDate = new Date(visit.date);
                    const daysPostTx = Math.floor((visitDate - txDate) / (1000 * 60 * 60 * 24));
                    
                    const ratio = visit.fvc ? ((visit.fev1 / visit.fvc) * 100).toFixed(1) : '';
                    const percentBaseline = patient.baselineFev1 
                        ? ((visit.fev1 / patient.baselineFev1) * 100).toFixed(1) 
                        : '';
                    
                    return [
                        visit.date,
                        daysPostTx,
                        visit.fev1.toFixed(2),
                        visit.fvc ? visit.fvc.toFixed(2) : '',
                        ratio,
                        percentBaseline
                    ];
                });
                
                const csvContent = [headers, ...rows]
                    .map(row => row.join(','))
                    .join('\n');
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `spirolite_${patient.id}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                this.showToast('CSV exported successfully', 'success');
            }
            
            async exportJSON() {
                const exportData = {
                    app: 'Spirolite Professional',
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    protocol: this.state.protocol,
                    settings: this.state.settings,
                    patients: Array.from(this.state.patients.values())
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `spirolite_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                this.showToast('JSON backup exported successfully', 'success');
            }
            
            // === UI UTILITIES ===
            switchMode(mode) {
                if (this.state.mode === mode) return;
                
                this.state.mode = mode;
                
                // Update navigation buttons
                this.dom.navBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // Hide all mode sections
                document.querySelectorAll('.mode-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show active mode section
                document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
                
                // Update patient badges
                this.updatePatientBadges();
                
                this.showToast(`Switched to ${mode} mode`, 'info');
            }
            
            updatePatientBadges() {
                const patientName = this.getCurrentPatientName();
                ['quickBadge', 'monitorBadge', 'fullBadge'].forEach(id => {
                    const badge = document.getElementById(id);
                    if (badge) badge.textContent = patientName;
                });
            }
            
            updatePatientInfo() {
                if (!this.state.currentPatient) {
                    this.dom.patientAvatar.textContent = '--';
                    this.dom.patientId.textContent = 'Select Patient';
                    this.dom.patientStatus.textContent = 'No data';
                    this.dom.visitCount.textContent = '0 visits';
                    this.dom.txDateText.textContent = 'No TX date';
                    this.dom.txIndicator.className = 'tx-indicator';
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) return;
                
                // Update avatar
                this.dom.patientAvatar.textContent = patient.id.substring(0, 2).toUpperCase();
                
                // Update patient info
                this.dom.patientId.textContent = patient.id;
                this.dom.visitCount.textContent = `${patient.visits ? patient.visits.length : 0} visits`;
                
                // Determine status
                let status = 'No baseline';
                if (patient.visits && patient.visits.length > 0) {
                    if (patient.baselineFev1) {
                        const lastVisit = patient.visits[patient.visits.length - 1];
                        const percent = ((lastVisit.fev1 / patient.baselineFev1) * 100).toFixed(1);
                        status = `${percent}% of baseline`;
                    } else {
                        status = `${patient.visits.length} visits`;
                    }
                }
                this.dom.patientStatus.textContent = status;
                
                // Update TX indicator
                if (patient.txDate) {
                    this.dom.txDateText.textContent = `TX: ${patient.txDate}`;
                    
                    const txDate = new Date(patient.txDate);
                    const today = new Date();
                    const daysSinceTx = Math.floor((today - txDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysSinceTx < 0) {
                        this.dom.txIndicator.className = 'tx-indicator missing';
                    } else if (daysSinceTx < 90) {
                        this.dom.txIndicator.className = 'tx-indicator recent';
                    } else {
                        this.dom.txIndicator.className = 'tx-indicator valid';
                    }
                } else {
                    this.dom.txDateText.textContent = 'No TX date';
                    this.dom.txIndicator.className = 'tx-indicator missing';
                }
                
                // Update patient badges
                this.updatePatientBadges();
            }
            
            getCurrentPatientName() {
                if (!this.state.currentPatient) return 'No Patient';
                const patient = this.state.patients.get(this.state.currentPatient);
                return patient ? patient.id : 'No Patient';
            }
            
            setDateShortcut(offset) {
                const date = new Date();
                date.setDate(date.getDate() + offset);
                const dateStr = date.toISOString().split('T')[0];
                
                let targetInput = null;
                switch(this.state.mode) {
                    case 'quick':
                        targetInput = this.dom.measurementDate;
                        break;
                    case 'monitor':
                        targetInput = this.dom.visitDate;
                        break;
                    case 'full':
                        targetInput = this.dom.txDate;
                        break;
                }
                
                if (targetInput) {
                    targetInput.value = dateStr;
                    this.showToast(`Date set to ${date.toLocaleDateString()}`, 'info');
                }
            }
            
            showModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }
            
            hideModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
            
            // === TOAST NOTIFICATIONS ===
            showToast(message, type = 'info') {
                const toastId = `toast_${Date.now()}`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: 'üí°'
                };
                
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span class="toast-message">${message}</span>
                `;
                
                this.dom.toastContainer.appendChild(toast);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    const toastEl = document.getElementById(toastId);
                    if (toastEl) {
                        toastEl.style.opacity = '0';
                        toastEl.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            if (toastEl.parentNode) {
                                toastEl.parentNode.removeChild(toastEl);
                            }
                        }, 300);
                    }
                }, 3000);
            }
            
            // === STATE MANAGEMENT ===
            saveState() {
                try {
                    const stateToSave = {
                        protocol: this.state.protocol,
                        settings: this.state.settings,
                        patients: Array.from(this.state.patients.entries()),
                        currentPatient: this.state.currentPatient,
                        session: this.state.session,
                        mode: this.state.mode
                    };
                    localStorage.setItem('spirolite_professional_state', JSON.stringify(stateToSave));
                } catch (error) {
                    console.error('Failed to save state:', error);
                }
            }
            
            loadState() {
                try {
                    const saved = localStorage.getItem('spirolite_professional_state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        
                        // Restore protocol settings
                        if (state.protocol) {
                            this.state.protocol = { ...this.state.protocol, ...state.protocol };
                        }
                        
                        // Restore UI settings
                        if (state.settings) {
                            this.state.settings = { ...this.state.settings, ...state.settings };
                        }
                        
                        // Restore patients
                        if (state.patients) {
                            this.state.patients = new Map(state.patients);
                        }
                        
                        // Restore current patient
                        if (state.currentPatient && this.state.patients.has(state.currentPatient)) {
                            this.state.currentPatient = state.currentPatient;
                        }
                        
                        // Restore session
                        if (state.session) {
                            this.state.session = { ...this.state.session, ...state.session };
                        }
                        
                        // Restore mode
                        if (state.mode) {
                            this.state.mode = state.mode;
                        }
                        
                        // Update baseline if exists
                        if (this.state.session.quick.baseline) {
                            this.dom.baselineValueDisplay.textContent = `${this.state.session.quick.baseline.toFixed(2)} L`;
                            this.dom.baselineProgress.style.width = '100%';
                            this.dom.baselineActionBtn.disabled = false;
                            this.dom.baselineActionBtn.className = 'baseline-action-btn ready';
                            this.dom.baselineActionBtn.textContent = 'Update';
                        }
                    }
                } catch (error) {
                    console.error('Failed to load state:', error);
                }
            }
            
            // === KEYBOARD SHORTCUTS ===
            handleKeyboardShortcuts(e) {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // Number keys for mode switching
                if (!e.ctrlKey && !e.altKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            this.switchMode('quick');
                            break;
                        case '2':
                            e.preventDefault();
                            this.switchMode('monitor');
                            break;
                        case '3':
                            e.preventDefault();
                            this.switchMode('full');
                            break;
                        case '4':
                            e.preventDefault();
                            this.switchMode('patients');
                            break;
                        case 'Escape':
                            const openModal = document.querySelector('.modal-overlay.active');
                            if (openModal) {
                                openModal.classList.remove('active');
                            }
                            break;
                    }
                }
            }
            
            // === HISTORY FUNCTIONS ===
            handleUndo() {
                // TODO: Implement undo functionality
                this.showToast('Undo coming soon', 'info');
            }
            
            handleRedo() {
                // TODO: Implement redo functionality
                this.showToast('Redo coming soon', 'info');
            }
        }
        
        // === INITIALIZE APPLICATION ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üì± DOM fully loaded, starting Spirolite Professional...');
            window.spiroliteApp = new SpiroliteApp();
            console.log('üéâ Spirolite Professional initialized successfully!');
        });
    </script>
</body>
</html>
