<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1E6EA6">
    <meta name="description" content="Objective lung function calculator for transplant monitoring">
    
    <title>PulmoCalc | Objective Transplant Metrics</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    
    <style>
        /* ===== CSS RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.5;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
        }
        
        /* ===== PATIENT CONTEXT HEADER ===== */
        .context-header {
            background: white;
            padding: 0.75rem 1rem;
            padding-top: max(0.75rem, env(safe-area-inset-top));
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .patient-context {
            flex: 1;
        }
        
        .patient-id-input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'SF Mono', monospace;
            font-size: 0.9375rem;
            font-weight: 600;
            color: #1E6EA6;
        }
        
        .patient-id-input:focus {
            outline: none;
            border-color: #1E6EA6;
        }
        
        .date-indicators {
            display: flex;
            gap: 0.5rem;
            font-size: 0.6875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .date-indicator {
            padding: 0.125rem 0.375rem;
            background: #f3f4f6;
            border-radius: 4px;
        }
        
        .context-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 0.75rem;
        }
        
        .context-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: #f3f4f6;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .context-btn:hover {
            background: #e5e7eb;
            color: #1E6EA6;
        }
        
        /* ===== MODE SELECTOR ===== */
        .mode-selector {
            display: flex;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .mode-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 12px;
            background: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .mode-btn:hover {
            background: #f3f4f6;
        }
        
        .mode-btn.active {
            background: #1E6EA6;
            color: white;
            box-shadow: 0 2px 8px rgba(30, 110, 166, 0.2);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: 1rem;
        }
        
        /* ===== QUICK CALC MODE ===== */
        .calculator-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .calc-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calc-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        @media (max-width: 640px) {
            .calc-inputs {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        .input-group {
            position: relative;
        }
        
        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .calc-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'SF Mono', 'Courier New', monospace;
            color: #1f2937;
            text-align: center;
            transition: all 0.2s;
            background: white;
            -moz-appearance: textfield;
        }
        
        .calc-input::-webkit-outer-spin-button,
        .calc-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .calc-input:focus {
            outline: none;
            border-color: #1E6EA6;
            box-shadow: 0 0 0 3px rgba(30, 110, 166, 0.1);
        }
        
        .input-unit {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }
        
        /* ===== COMPARISON SELECTOR ===== */
        .comparison-selector {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
        }
        
        .comparison-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .comparison-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .comparison-option {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .comparison-option:hover {
            background: #f1f5f9;
        }
        
        .comparison-option.selected {
            background: #e0f2fe;
            border: 1px solid #bae6fd;
        }
        
        .option-radio {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
        }
        
        .option-content {
            flex: 1;
        }
        
        .option-label {
            font-weight: 500;
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        .option-input {
            margin-top: 0.25rem;
            padding: 0.375rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 100%;
            font-family: 'SF Mono', monospace;
        }
        
        .option-note {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }
        
        /* ===== RESULTS PANEL ===== */
        .results-panel {
            margin-top: 1.5rem;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .results-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        
        @media (max-width: 480px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .data-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .data-card:hover {
            transform: translateY(-2px);
        }
        
        .data-value {
            font-family: 'SF Mono', 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 0.25rem 0;
        }
        
        .data-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-unit {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        /* Comparison Metrics */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
        
        .metric-value {
            font-family: 'SF Mono', 'Courier New', monospace;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .metric-value.negative {
            color: #dc2626;
        }
        
        .metric-value.positive {
            color: #059669;
        }
        
        .metric-unit {
            font-size: 0.75rem;
            color: #6b7280;
            min-width: 60px;
            text-align: right;
        }
        
        /* Threshold Indicator */
        .threshold-indicator {
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            border: 1px solid;
        }
        
        .threshold-indicator.info {
            background: #f0f9ff;
            border-color: #bae6fd;
            color: #0369a1;
        }
        
        .threshold-indicator.notice {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .threshold-indicator.alert {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .threshold-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .threshold-content {
            flex: 1;
        }
        
        .threshold-message {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .threshold-reference {
            font-size: 0.75rem;
            color: inherit;
            opacity: 0.9;
        }
        
        /* ===== STANDARD MODE ===== */
        .timeline-setup {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .timeline-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        @media (max-width: 640px) {
            .timeline-inputs {
                grid-template-columns: 1fr;
            }
        }
        
        .timeline-display {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #bae6fd;
        }
        
        .timeline-row {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            font-size: 0.875rem;
        }
        
        .timeline-label {
            color: #1E6EA6;
            font-weight: 500;
        }
        
        .timeline-value {
            font-family: 'SF Mono', monospace;
            font-weight: 600;
        }
        
        /* Clinical Notes */
        .notes-section {
            margin-top: 1.5rem;
        }
        
        .notes-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.875rem;
            min-height: 100px;
            resize: vertical;
        }
        
        .notes-textarea:focus {
            outline: none;
            border-color: #1E6EA6;
        }
        
        /* ===== REVIEW MODE ===== */
        .trend-chart {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-style: italic;
        }
        
        .visit-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .visit-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .visit-date {
            font-family: 'SF Mono', monospace;
            font-weight: 600;
            color: #1f2937;
        }
        
        .visit-values {
            display: flex;
            gap: 1rem;
            font-family: 'SF Mono', monospace;
        }
        
        .visit-fev1 {
            color: #1E6EA6;
            font-weight: 600;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-bar {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .action-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #1E6EA6 0%, #155588 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(30, 110, 166, 0.2);
        }
        
        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 110, 166, 0.3);
        }
        
        .action-btn.secondary {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        
        .action-btn.secondary:hover {
            background: #e5e7eb;
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .font-mono {
            font-family: 'SF Mono', 'Courier New', monospace;
        }
        
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        
        /* ===== SAFE AREA SUPPORT ===== */
        @supports (padding: max(0px)) {
            .main-content {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Patient Context Header -->
        <header class="context-header">
            <div class="patient-context">
                <input type="text" 
                       class="patient-id-input" 
                       id="patientId"
                       placeholder="Enter Patient ID (e.g., PT001)"
                       maxlength="10">
                <div class="date-indicators">
                    <div class="date-indicator" id="txDateIndicator">TX: --</div>
                    <div class="date-indicator" id="lastVisitIndicator">Last: --</div>
                    <div class="date-indicator" id="daysSinceIndicator">-- days</div>
                </div>
            </div>
            <div class="context-actions">
                <button class="context-btn" id="saveContextBtn" title="Save Patient">
                    üíæ
                </button>
                <button class="context-btn" id="newPatientBtn" title="New Patient">
                    üÜï
                </button>
                <button class="context-btn" id="exportContextBtn" title="Export">
                    üì§
                </button>
            </div>
        </header>
        
        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="quick">
                ‚ö° Quick Calc
            </button>
            <button class="mode-btn" data-mode="standard">
                üìã Full Study
            </button>
            <button class="mode-btn" data-mode="review">
                üìä Review
            </button>
        </div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- ===== QUICK CALC MODE ===== -->
            <div id="modeQuick">
                <div class="calculator-card">
                    <div class="calc-title">Current Spirometry</div>
                    
                    <div class="calc-inputs">
                        <div class="input-group">
                            <div class="input-label">FEV‚ÇÅ</div>
                            <input type="number" 
                                   step="0.01" 
                                   min="0.5" 
                                   max="8.0" 
                                   class="calc-input" 
                                   id="inputFev1"
                                   placeholder="2.85"
                                   autofocus>
                            <span class="input-unit">L</span>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-label">FVC</div>
                            <input type="number" 
                                   step="0.01" 
                                   min="0.5" 
                                   max="10.0" 
                                   class="calc-input" 
                                   id="inputFvc"
                                   placeholder="3.40">
                            <span class="input-unit">L</span>
                        </div>
                    </div>
                    
                    <!-- Comparison Selector -->
                    <div class="comparison-selector">
                        <div class="comparison-title">Compare To</div>
                        <div class="comparison-options">
                            <label class="comparison-option" id="optionNone">
                                <input type="radio" name="comparison" class="option-radio" value="none" checked>
                                <div class="option-content">
                                    <div class="option-label">Show raw values only</div>
                                    <div class="option-note">No comparison, just current measurements</div>
                                </div>
                            </label>
                            
                            <label class="comparison-option" id="optionBaseline">
                                <input type="radio" name="comparison" class="option-radio" value="baseline">
                                <div class="option-content">
                                    <div class="option-label">vs Baseline</div>
                                    <input type="number" 
                                           step="0.01" 
                                           class="option-input" 
                                           id="baselineInput"
                                           placeholder="Enter baseline FEV‚ÇÅ (L)">
                                    <div class="option-note">Post-transplant established baseline</div>
                                </div>
                            </label>
                            
                            <label class="comparison-option" id="optionLast">
                                <input type="radio" name="comparison" class="option-radio" value="last">
                                <div class="option-content">
                                    <div class="option-label">vs Last Visit</div>
                                    <div class="option-note" id="lastVisitNote">No previous visits found</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel hidden" id="resultsPanel">
                    <!-- Raw Measurements -->
                    <div class="results-section">
                        <div class="section-header">
                            <div class="section-title">Current Measurements</div>
                        </div>
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-label">FEV‚ÇÅ</div>
                                <div class="data-value" id="resultFev1">--</div>
                                <div class="data-unit">L</div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">FVC</div>
                                <div class="data-value" id="resultFvc">--</div>
                                <div class="data-unit">L</div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">FEV‚ÇÅ/FVC</div>
                                <div class="data-value" id="resultRatio">--</div>
                                <div class="data-unit">%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Section -->
                    <div class="results-section hidden" id="comparisonSection">
                        <div class="section-header">
                            <div class="section-title" id="comparisonTitle">Comparison</div>
                            <div class="section-subtitle" id="comparisonSubtitle"></div>
                        </div>
                        
                        <div class="comparison-metrics">
                            <div class="metric-row">
                                <div class="metric-label">Absolute Œî</div>
                                <div class="metric-value" id="resultDelta">--</div>
                                <div class="metric-unit">L</div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">Relative Œî</div>
                                <div class="metric-value" id="resultPercent">--</div>
                                <div class="metric-unit">%</div>
                            </div>
                            <div class="metric-row" id="rateRow">
                                <div class="metric-label">Rate of Change</div>
                                <div class="metric-value" id="resultRate">--</div>
                                <div class="metric-unit">L/month</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Threshold Indicator -->
                    <div class="threshold-indicator hidden" id="thresholdIndicator">
                        <div class="threshold-icon">‚ÑπÔ∏è</div>
                        <div class="threshold-content">
                            <div class="threshold-message" id="thresholdMessage"></div>
                            <div class="threshold-reference" id="thresholdReference"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearQuickBtn">
                        üóëÔ∏è Clear
                    </button>
                    <button class="action-btn secondary" id="saveQuickBtn">
                        üíæ Save
                    </button>
                    <button class="action-btn primary" id="copyResultsBtn">
                        üìã Copy Results
                    </button>
                </div>
            </div>
            
            <!-- ===== STANDARD MODE ===== -->
            <div id="modeStandard" class="hidden">
                <div class="calculator-card">
                    <div class="calc-title">Full Patient Study</div>
                    
                    <!-- Timeline Setup -->
                    <div class="timeline-setup">
                        <div class="input-label">Patient Timeline</div>
                        <div class="timeline-inputs">
                            <div class="input-group">
                                <div class="input-label">Transplant Date</div>
                                <input type="date" 
                                       class="calc-input" 
                                       id="txDate"
                                       style="font-size: 1rem; padding: 0.75rem;">
                            </div>
                            <div class="input-group">
                                <div class="input-label">Baseline Date</div>
                                <input type="date" 
                                       class="calc-input" 
                                       id="baselineDate"
                                       style="font-size: 1rem; padding: 0.75rem;">
                            </div>
                        </div>
                        
                        <div class="timeline-display">
                            <div class="timeline-row">
                                <span class="timeline-label">Time Post-Tx</span>
                                <span class="timeline-value" id="timePostTx">--</span>
                            </div>
                            <div class="timeline-row">
                                <span class="timeline-label">Time Since Baseline</span>
                                <span class="timeline-value" id="timeSinceBaseline">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Spirometry Inputs -->
                    <div class="calc-inputs">
                        <div class="input-group">
                            <div class="input-label">Current FEV‚ÇÅ</div>
                            <input type="number" 
                                   step="0.01" 
                                   class="calc-input" 
                                   id="stdFev1"
                                   placeholder="Enter FEV‚ÇÅ">
                            <span class="input-unit">L</span>
                        </div>
                        <div class="input-group">
                            <div class="input-label">Baseline FEV‚ÇÅ</div>
                            <input type="number" 
                                   step="0.01" 
                                   class="calc-input" 
                                   id="stdBaselineFev1"
                                   placeholder="Enter baseline">
                            <span class="input-unit">L</span>
                        </div>
                    </div>
                    
                    <!-- Clinical Notes -->
                    <div class="notes-section">
                        <div class="input-label">Clinical Context</div>
                        <textarea class="notes-textarea" 
                                  id="clinicalNotes"
                                  placeholder="Enter clinical context, symptoms, medications, or other relevant information"></textarea>
                    </div>
                </div>
                
                <!-- Standard Results -->
                <div class="results-panel hidden" id="stdResultsPanel">
                    <div class="results-section">
                        <div class="section-header">
                            <div class="section-title">Comprehensive Analysis</div>
                        </div>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <div class="data-label">Current FEV‚ÇÅ</div>
                                <div class="data-value" id="stdCurrentFev1">--</div>
                                <div class="data-unit">L</div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">Baseline</div>
                                <div class="data-value" id="stdBaseline">--</div>
                                <div class="data-unit">L</div>
                            </div>
                            <div class="data-card">
                                <div class="data-label">Time Period</div>
                                <div class="data-value" id="stdTimePeriod">--</div>
                                <div class="data-unit">days</div>
                            </div>
                        </div>
                        
                        <div class="comparison-metrics mt-4">
                            <div class="metric-row">
                                <div class="metric-label">Cumulative Œî</div>
                                <div class="metric-value" id="stdCumulativeDelta">--</div>
                                <div class="metric-unit">L</div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">% Decline</div>
                                <div class="metric-value" id="stdPercentDecline">--</div>
                                <div class="metric-unit">%</div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">Monthly Rate</div>
                                <div class="metric-value" id="stdMonthlyRate">--</div>
                                <div class="metric-unit">L/month</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Standard Actions -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearStdBtn">
                        üóëÔ∏è Clear All
                    </button>
                    <button class="action-btn primary" id="saveStudyBtn">
                        üíæ Save Full Study
                    </button>
                </div>
            </div>
            
            <!-- ===== REVIEW MODE ===== -->
            <div id="modeReview" class="hidden">
                <div class="calculator-card">
                    <div class="calc-title">Patient Review: <span id="reviewPatientId">--</span></div>
                    
                    <!-- Trend Visualization Placeholder -->
                    <div class="trend-chart">
                        üìà Trend visualization would appear here
                        <div style="font-size: 0.75rem; margin-top: 0.5rem;">
                            (Multiple data points required)
                        </div>
                    </div>
                    
                    <!-- Visit History -->
                    <div class="visit-list" id="visitList">
                        <!-- Dynamically populated -->
                        <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                            No visits recorded for this patient
                        </div>
                    </div>
                </div>
                
                <!-- Review Actions -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="exportAllBtn">
                        üì§ Export All Data
                    </button>
                    <button class="action-btn primary" id="newReviewBtn">
                        üìù New Analysis
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Patient Save Modal -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Save Patient Data</div>
            </div>
            <div class="modal-body">
                <div class="input-label">Patient ID</div>
                <input type="text" 
                       class="patient-id-input" 
                       style="width: 100%;"
                       id="modalPatientId"
                       placeholder="PT001">
                
                <div style="margin-top: 1rem;">
                    <div class="input-label">Description (Optional)</div>
                    <input type="text" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px;"
                           id="modalDescription"
                           placeholder="e.g., Bilateral lung, 2023">
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelSaveBtn">
                    Cancel
                </button>
                <button class="action-btn primary" id="confirmSaveBtn">
                    Save Patient
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
    // ============================================
    // PULMOCALC - OBJECTIVE TRANSPLANT CALCULATOR
    // ============================================
    
    // Clinical Reference (Informational Only)
    const ISHLT_THRESHOLDS = {
        BOS_0p: 10,   // ‚â•10% decline - consider for potential BOS
        BOS_1: 20,    // ‚â•20% decline - consider for possible BOS
        BOS_2_3: 35,  // ‚â•35% decline - consider for moderate BOS
        BOS_3: 50     // ‚â•50% decline - consider for severe BOS
    };
    
    // App State
    const state = {
        // Current patient context
        currentPatient: {
            id: null,
            txDate: null,      // Transplant date
            baselineDate: null, // Baseline established date (different from TX!)
            baselineFev1: null,
            description: null,
            lastVisit: null
        },
        
        // Current calculation session
        currentSession: {
            mode: 'quick',
            fev1: null,
            fvc: null,
            comparisonType: 'none',
            comparisonValue: null,
            date: new Date().toISOString().split('T')[0]
        },
        
        // Patient database (local storage)
        patients: {},
        
        // Visit history for current patient
        visits: []
    };
    
    // DOM Elements
    const el = {};
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });
    
    function initializeApp() {
        cacheElements();
        setupEventListeners();
        loadFromStorage();
        setupUI();
        
        console.log('ü´Å PulmoCalc initialized');
    }
    
    function cacheElements() {
        // Context header
        el.patientId = document.getElementById('patientId');
        el.txDateIndicator = document.getElementById('txDateIndicator');
        el.lastVisitIndicator = document.getElementById('lastVisitIndicator');
        el.daysSinceIndicator = document.getElementById('daysSinceIndicator');
        el.saveContextBtn = document.getElementById('saveContextBtn');
        el.newPatientBtn = document.getElementById('newPatientBtn');
        el.exportContextBtn = document.getElementById('exportContextBtn');
        
        // Mode selector
        el.modeBtns = document.querySelectorAll('.mode-btn');
        
        // Quick Calc Mode
        el.inputFev1 = document.getElementById('inputFev1');
        el.inputFvc = document.getElementById('inputFvc');
        el.baselineInput = document.getElementById('baselineInput');
        el.lastVisitNote = document.getElementById('lastVisitNote');
        
        // Comparison options
        el.optionNone = document.getElementById('optionNone');
        el.optionBaseline = document.getElementById('optionBaseline');
        el.optionLast = document.getElementById('optionLast');
        
        // Results
        el.resultsPanel = document.getElementById('resultsPanel');
        el.resultFev1 = document.getElementById('resultFev1');
        el.resultFvc = document.getElementById('resultFvc');
        el.resultRatio = document.getElementById('resultRatio');
        el.comparisonSection = document.getElementById('comparisonSection');
        el.comparisonTitle = document.getElementById('comparisonTitle');
        el.comparisonSubtitle = document.getElementById('comparisonSubtitle');
        el.resultDelta = document.getElementById('resultDelta');
        el.resultPercent = document.getElementById('resultPercent');
        el.resultRate = document.getElementById('resultRate');
        el.rateRow = document.getElementById('rateRow');
        el.thresholdIndicator = document.getElementById('thresholdIndicator');
        el.thresholdMessage = document.getElementById('thresholdMessage');
        el.thresholdReference = document.getElementById('thresholdReference');
        
        // Quick actions
        el.clearQuickBtn = document.getElementById('clearQuickBtn');
        el.saveQuickBtn = document.getElementById('saveQuickBtn');
        el.copyResultsBtn = document.getElementById('copyResultsBtn');
        
        // Standard Mode
        el.txDate = document.getElementById('txDate');
        el.baselineDate = document.getElementById('baselineDate');
        el.timePostTx = document.getElementById('timePostTx');
        el.timeSinceBaseline = document.getElementById('timeSinceBaseline');
        el.stdFev1 = document.getElementById('stdFev1');
        el.stdBaselineFev1 = document.getElementById('stdBaselineFev1');
        el.clinicalNotes = document.getElementById('clinicalNotes');
        el.stdResultsPanel = document.getElementById('stdResultsPanel');
        el.stdCurrentFev1 = document.getElementById('stdCurrentFev1');
        el.stdBaseline = document.getElementById('stdBaseline');
        el.stdTimePeriod = document.getElementById('stdTimePeriod');
        el.stdCumulativeDelta = document.getElementById('stdCumulativeDelta');
        el.stdPercentDecline = document.getElementById('stdPercentDecline');
        el.stdMonthlyRate = document.getElementById('stdMonthlyRate');
        el.clearStdBtn = document.getElementById('clearStdBtn');
        el.saveStudyBtn = document.getElementById('saveStudyBtn');
        
        // Review Mode
        el.reviewPatientId = document.getElementById('reviewPatientId');
        el.visitList = document.getElementById('visitList');
        el.exportAllBtn = document.getElementById('exportAllBtn');
        el.newReviewBtn = document.getElementById('newReviewBtn');
        
        // Modals
        el.saveModal = document.getElementById('saveModal');
        el.modalPatientId = document.getElementById('modalPatientId');
        el.modalDescription = document.getElementById('modalDescription');
        el.cancelSaveBtn = document.getElementById('cancelSaveBtn');
        el.confirmSaveBtn = document.getElementById('confirmSaveBtn');
    }
    
    function setupEventListeners() {
        // Context header
        el.patientId.addEventListener('change', updatePatientContext);
        el.saveContextBtn.addEventListener('click', showSaveModal);
        el.newPatientBtn.addEventListener('click', newPatient);
        el.exportContextBtn.addEventListener('click', exportPatientData);
        
        // Mode selection
        el.modeBtns.forEach(btn => {
            btn.addEventListener('click', () => switchMode(btn.dataset.mode));
        });
        
        // Quick Calc inputs
        el.inputFev1.addEventListener('input', handleQuickInput);
        el.inputFvc.addEventListener('input', handleQuickInput);
        el.baselineInput.addEventListener('input', handleComparisonChange);
        
        // Comparison selection
        [el.optionNone, el.optionBaseline, el.optionLast].forEach(option => {
            option.addEventListener('click', handleComparisonSelection);
        });
        
        // Quick actions
        el.clearQuickBtn.addEventListener('click', clearQuickCalc);
        el.saveQuickBtn.addEventListener('click', saveQuickVisit);
        el.copyResultsBtn.addEventListener('click', copyResults);
        
        // Standard mode
        el.txDate.addEventListener('change', updateTimeline);
        el.baselineDate.addEventListener('change', updateTimeline);
        el.stdFev1.addEventListener('input', handleStandardInput);
        el.stdBaselineFev1.addEventListener('input', handleStandardInput);
        el.clearStdBtn.addEventListener('click', clearStandard);
        el.saveStudyBtn.addEventListener('click', saveFullStudy);
        
        // Review mode
        el.newReviewBtn.addEventListener('click', () => switchMode('quick'));
        
        // Modal
        el.cancelSaveBtn.addEventListener('click', () => hideModal('saveModal'));
        el.confirmSaveBtn.addEventListener('click', savePatient);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);
    }
    
    function loadFromStorage() {
        try {
            const saved = localStorage.getItem('pulmocalc_data');
            if (saved) {
                const data = JSON.parse(saved);
                state.patients = data.patients || {};
                console.log('üìÅ Loaded patient database');
            }
        } catch (e) {
            console.warn('Failed to load saved data:', e);
        }
    }
    
    function saveToStorage() {
        try {
            const data = {
                patients: state.patients,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem('pulmocalc_data', JSON.stringify(data));
        } catch (e) {
            console.warn('Failed to save data:', e);
        }
    }
    
    // ===== PATIENT MANAGEMENT =====
    function updatePatientContext() {
        const patientId = el.patientId.value.trim().toUpperCase();
        
        if (!patientId) {
            clearPatientContext();
            return;
        }
        
        // Load patient data if exists
        if (state.patients[patientId]) {
            const patient = state.patients[patientId];
            state.currentPatient = { ...patient };
            state.visits = patient.visits || [];
            
            // Update UI
            el.txDateIndicator.textContent = `TX: ${patient.txDate || '--'}`;
            
            if (patient.lastVisit) {
                const lastDate = new Date(patient.lastVisit.date);
                el.lastVisitIndicator.textContent = `Last: ${lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                
                const daysSince = dateDiffInDays(new Date(), lastDate);
                el.daysSinceIndicator.textContent = `${daysSince} days`;
                
                // Update last visit note
                el.lastVisitNote.textContent = `${patient.lastVisit.fev1} L on ${lastDate.toLocaleDateString()}`;
            } else {
                el.lastVisitIndicator.textContent = 'Last: --';
                el.daysSinceIndicator.textContent = '-- days';
                el.lastVisitNote.textContent = 'No previous visits';
            }
            
            // Auto-fill baseline if exists
            if (patient.baselineFev1) {
                el.baselineInput.value = patient.baselineFev1;
            }
            
            // Update review mode
            if (state.currentSession.mode === 'review') {
                updateReviewMode();
            }
            
            showToast(`Loaded patient ${patientId}`, 'success');
        } else {
            // New patient
            state.currentPatient = {
                id: patientId,
                txDate: null,
                baselineDate: null,
                baselineFev1: null,
                description: null,
                lastVisit: null
            };
            state.visits = [];
            
            el.txDateIndicator.textContent = 'TX: --';
            el.lastVisitIndicator.textContent = 'Last: --';
            el.daysSinceIndicator.textContent = '-- days';
            el.lastVisitNote.textContent = 'No previous visits';
            
            showToast(`New patient ${patientId}`, 'info');
        }
    }
    
    function clearPatientContext() {
        state.currentPatient = {
            id: null,
            txDate: null,
            baselineDate: null,
            baselineFev1: null,
            description: null,
            lastVisit: null
        };
        state.visits = [];
        
        el.txDateIndicator.textContent = 'TX: --';
        el.lastVisitIndicator.textContent = 'Last: --';
        el.daysSinceIndicator.textContent = '-- days';
        el.lastVisitNote.textContent = 'No previous visits';
        el.baselineInput.value = '';
    }
    
    function showSaveModal() {
        if (!el.inputFev1.value && !el.stdFev1.value) {
            showToast('Enter values first', 'warning');
            return;
        }
        
        const currentId = el.patientId.value.trim().toUpperCase();
        if (!currentId) {
            showToast('Enter Patient ID first', 'warning');
            return;
        }
        
        el.modalPatientId.value = currentId;
        el.modalDescription.value = state.currentPatient.description || '';
        showModal('saveModal');
    }
    
    function savePatient() {
        const patientId = el.modalPatientId.value.trim().toUpperCase();
        if (!patientId.match(/^PT\d{3,}$/)) {
            showToast('Patient ID must be PT followed by numbers (e.g., PT001)', 'error');
            return;
        }
        
        // Save/update patient data
        state.patients[patientId] = {
            ...state.currentPatient,
            id: patientId,
            description: el.modalDescription.value.trim() || null,
            visits: state.visits,
            lastVisit: state.visits.length > 0 ? state.visits[state.visits.length - 1] : null,
            updatedAt: new Date().toISOString()
        };
        
        saveToStorage();
        hideModal('saveModal');
        updatePatientContext();
        
        showToast(`Patient ${patientId} saved`, 'success');
    }
    
    function newPatient() {
        if (state.visits.length > 0 && !confirm('Start new patient? Current data will be saved.')) {
            return;
        }
        
        // Generate new patient ID
        let newId = 'PT001';
        let counter = 1;
        while (state.patients[`PT${counter.toString().padStart(3, '0')}`]) {
            counter++;
        }
        newId = `PT${counter.toString().padStart(3, '0')}`;
        
        el.patientId.value = newId;
        updatePatientContext();
        clearQuickCalc();
        
        showToast(`New patient: ${newId}`, 'success');
    }
    
    // ===== QUICK CALC MODE =====
    function handleQuickInput() {
        const fev1 = parseFloat(el.inputFev1.value);
        const fvc = parseFloat(el.inputFvc.value);
        
        if (!fev1 || !fvc) {
            el.resultsPanel.classList.add('hidden');
            return;
        }
        
        state.currentSession.fev1 = fev1;
        state.currentSession.fvc = fvc;
        
        calculateQuick();
    }
    
    function handleComparisonSelection(e) {
        const radio = e.currentTarget.querySelector('.option-radio');
        radio.checked = true;
        
        state.currentSession.comparisonType = radio.value;
        
        // Update UI
        [el.optionNone, el.optionBaseline, el.optionLast].forEach(opt => {
            opt.classList.toggle('selected', opt.querySelector('.option-radio').checked);
        });
        
        // Enable/disable baseline input
        el.baselineInput.disabled = radio.value !== 'baseline';
        
        if (radio.value === 'baseline') {
            el.baselineInput.focus();
        }
        
        // Recalculate if we have values
        if (state.currentSession.fev1 && state.currentSession.fvc) {
            calculateQuick();
        }
    }
    
    function handleComparisonChange() {
        if (state.currentSession.comparisonType === 'baseline') {
            state.currentSession.comparisonValue = parseFloat(el.baselineInput.value);
            if (state.currentSession.fev1 && state.currentSession.fvc) {
                calculateQuick();
            }
        }
    }
    
    function calculateQuick() {
        const fev1 = state.currentSession.fev1;
        const fvc = state.currentSession.fvc;
        
        // Always show raw measurements
        el.resultFev1.textContent = fev1.toFixed(2);
        el.resultFvc.textContent = fvc.toFixed(2);
        el.resultRatio.textContent = (fev1 / fvc * 100).toFixed(1);
        
        // Handle comparisons
        if (state.currentSession.comparisonType === 'none') {
            el.comparisonSection.classList.add('hidden');
            el.thresholdIndicator.classList.add('hidden');
        } else {
            let comparisonValue = null;
            let comparisonLabel = '';
            let daysBetween = null;
            
            if (state.currentSession.comparisonType === 'baseline') {
                comparisonValue = state.currentSession.comparisonValue;
                if (!comparisonValue) {
                    el.comparisonSection.classList.add('hidden');
                    return;
                }
                comparisonLabel = 'Baseline';
                
                // Try to get days from patient data
                if (state.currentPatient.baselineDate) {
                    daysBetween = dateDiffInDays(new Date(), new Date(state.currentPatient.baselineDate));
                }
            } else if (state.currentSession.comparisonType === 'last') {
                if (!state.currentPatient.lastVisit) {
                    el.comparisonSection.classList.add('hidden');
                    return;
                }
                comparisonValue = state.currentPatient.lastVisit.fev1;
                comparisonLabel = 'Last Visit';
                daysBetween = dateDiffInDays(new Date(), new Date(state.currentPatient.lastVisit.date));
            }
            
            // Calculate comparisons
            const absoluteChange = fev1 - comparisonValue;
            const percentChange = (absoluteChange / comparisonValue * 100);
            
            // Update UI
            el.comparisonTitle.textContent = `vs ${comparisonLabel}`;
            el.comparisonSubtitle.textContent = `(${comparisonValue.toFixed(2)} L)`;
            
            el.resultDelta.textContent = Math.abs(absoluteChange).toFixed(2);
            el.resultDelta.classList.toggle('negative', absoluteChange < 0);
            el.resultDelta.classList.toggle('positive', absoluteChange > 0);
            
            el.resultPercent.textContent = Math.abs(percentChange).toFixed(1);
            el.resultPercent.classList.toggle('negative', percentChange < 0);
            el.resultPercent.classList.toggle('positive', percentChange > 0);
            
            // Calculate rate if we have days
            if (daysBetween) {
                const months = daysBetween / 30.44;
                const rate = absoluteChange / months;
                el.resultRate.textContent = Math.abs(rate).toFixed(3);
                el.resultRate.classList.toggle('negative', rate < 0);
                el.resultRate.classList.toggle('positive', rate > 0);
                el.rateRow.style.display = 'flex';
            } else {
                el.rateRow.style.display = 'none';
            }
            
            el.comparisonSection.classList.remove('hidden');
            
            // Show threshold context (INFORMATIONAL ONLY)
            const decline = Math.abs(percentChange);
            if (decline >= ISHLT_THRESHOLDS.BOS_3) {
                el.thresholdMessage.textContent = `${decline.toFixed(1)}% decline from reference`;
                el.thresholdReference.textContent = 'Meets ISHLT threshold for severe BOS consideration';
                el.thresholdIndicator.className = 'threshold-indicator alert';
            } else if (decline >= ISHLT_THRESHOLDS.BOS_2_3) {
                el.thresholdMessage.textContent = `${decline.toFixed(1)}% decline from reference`;
                el.thresholdReference.textContent = 'Meets ISHLT threshold for moderate BOS consideration';
                el.thresholdIndicator.className = 'threshold-indicator alert';
            } else if (decline >= ISHLT_THRESHOLDS.BOS_1) {
                el.thresholdMessage.textContent = `${decline.toFixed(1)}% decline from reference`;
                el.thresholdReference.textContent = 'Meets ISHLT threshold for possible BOS consideration';
                el.thresholdIndicator.className = 'threshold-indicator notice';
            } else if (decline >= ISHLT_THRESHOLDS.BOS_0p) {
                el.thresholdMessage.textContent = `${decline.toFixed(1)}% decline from reference`;
                el.thresholdReference.textContent = 'Meets ISHLT threshold for potential BOS consideration';
                el.thresholdIndicator.className = 'threshold-indicator notice';
            } else if (decline >= 5) {
                el.thresholdMessage.textContent = `${decline.toFixed(1)}% decline from reference`;
                el.thresholdReference.textContent = 'Monitor trend for changes';
                el.thresholdIndicator.className = 'threshold-indicator info';
            } else {
                el.thresholdMessage.textContent = `${Math.abs(percentChange).toFixed(1)}% change from reference`;
                el.thresholdReference.textContent = 'Within normal monitoring range';
                el.thresholdIndicator.className = 'threshold-indicator info';
            }
            el.thresholdIndicator.classList.remove('hidden');
        }
        
        el.resultsPanel.classList.remove('hidden');
    }
    
    function clearQuickCalc() {
        el.inputFev1.value = '';
        el.inputFvc.value = '';
        el.baselineInput.value = '';
        el.resultsPanel.classList.add('hidden');
        el.inputFev1.focus();
    }
    
    function saveQuickVisit() {
        if (!state.currentSession.fev1 || !state.currentSession.fvc) {
            showToast('Enter values first', 'warning');
            return;
        }
        
        if (!state.currentPatient.id) {
            showToast('Enter Patient ID first', 'warning');
            return;
        }
        
        const visit = {
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            fev1: state.currentSession.fev1,
            fvc: state.currentSession.fvc,
            comparisonType: state.currentSession.comparisonType,
            comparisonValue: state.currentSession.comparisonValue,
            calculatedAt: new Date().toISOString()
        };
        
        state.visits.push(visit);
        state.currentPatient.lastVisit = visit;
        
        // Update patient in database
        if (state.patients[state.currentPatient.id]) {
            state.patients[state.currentPatient.id].visits = state.visits;
            state.patients[state.currentPatient.id].lastVisit = visit;
        }
        
        saveToStorage();
        updatePatientContext();
        
        showToast('Visit saved', 'success');
    }
    
    // ===== STANDARD MODE =====
    function updateTimeline() {
        const txDate = el.txDate.value;
        const baselineDate = el.baselineDate.value;
        
        if (txDate) {
            state.currentPatient.txDate = txDate;
            const daysPostTx = dateDiffInDays(new Date(), new Date(txDate));
            el.timePostTx.textContent = `${daysPostTx} days`;
        }
        
        if (baselineDate) {
            state.currentPatient.baselineDate = baselineDate;
            const daysSinceBaseline = dateDiffInDays(new Date(), new Date(baselineDate));
            el.timeSinceBaseline.textContent = `${daysSinceBaseline} days`;
            
            // Auto-set baseline FEV1 if we have a value
            if (el.stdBaselineFev1.value) {
                state.currentPatient.baselineFev1 = parseFloat(el.stdBaselineFev1.value);
            }
        }
    }
    
    function handleStandardInput() {
        const currentFev1 = parseFloat(el.stdFev1.value);
        const baselineFev1 = parseFloat(el.stdBaselineFev1.value);
        
        if (!currentFev1 || !baselineFev1) {
            el.stdResultsPanel.classList.add('hidden');
            return;
        }
        
        // Calculate days between
        let daysBetween = null;
        if (state.currentPatient.baselineDate) {
            daysBetween = dateDiffInDays(new Date(), new Date(state.currentPatient.baselineDate));
        }
        
        // Update results
        el.stdCurrentFev1.textContent = currentFev1.toFixed(2);
        el.stdBaseline.textContent = baselineFev1.toFixed(2);
        el.stdTimePeriod.textContent = daysBetween || '--';
        
        const delta = currentFev1 - baselineFev1;
        const percent = (delta / baselineFev1 * 100);
        
        el.stdCumulativeDelta.textContent = Math.abs(delta).toFixed(2);
        el.stdCumulativeDelta.classList.toggle('negative', delta < 0);
        el.stdCumulativeDelta.classList.toggle('positive', delta > 0);
        
        el.stdPercentDecline.textContent = Math.abs(percent).toFixed(1);
        el.stdPercentDecline.classList.toggle('negative', percent < 0);
        el.stdPercentDecline.classList.toggle('positive', percent > 0);
        
        if (daysBetween) {
            const months = daysBetween / 30.44;
            const rate = delta / months;
            el.stdMonthlyRate.textContent = Math.abs(rate).toFixed(3);
            el.stdMonthlyRate.classList.toggle('negative', rate < 0);
            el.stdMonthlyRate.classList.toggle('positive', rate > 0);
        } else {
            el.stdMonthlyRate.textContent = '--';
        }
        
        el.stdResultsPanel.classList.remove('hidden');
    }
    
    function clearStandard() {
        el.txDate.value = '';
        el.baselineDate.value = '';
        el.stdFev1.value = '';
        el.stdBaselineFev1.value = '';
        el.clinicalNotes.value = '';
        el.stdResultsPanel.classList.add('hidden');
        
        state.currentPatient.txDate = null;
        state.currentPatient.baselineDate = null;
        state.currentPatient.baselineFev1 = null;
    }
    
    function saveFullStudy() {
        if (!el.stdFev1.value || !el.stdBaselineFev1.value) {
            showToast('Enter values first', 'warning');
            return;
        }
        
        if (!state.currentPatient.id) {
            showToast('Enter Patient ID first', 'warning');
            return;
        }
        
        const study = {
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            fev1: parseFloat(el.stdFev1.value),
            baselineFev1: parseFloat(el.stdBaselineFev1.value),
            txDate: state.currentPatient.txDate,
            baselineDate: state.currentPatient.baselineDate,
            clinicalNotes: el.clinicalNotes.value,
            calculatedAt: new Date().toISOString(),
            type: 'full_study'
        };
        
        state.visits.push(study);
        state.currentPatient.lastVisit = {
            date: study.date,
            fev1: study.fev1
        };
        
        // Update patient data
        state.patients[state.currentPatient.id] = {
            ...state.currentPatient,
            visits: state.visits,
            updatedAt: new Date().toISOString()
        };
        
        saveToStorage();
        
        showToast('Full study saved', 'success');
        clearStandard();
    }
    
    // ===== REVIEW MODE =====
    function updateReviewMode() {
        if (!state.currentPatient.id) {
            el.reviewPatientId.textContent = '--';
            return;
        }
        
        el.reviewPatientId.textContent = state.currentPatient.id;
        
        // Update visit list
        if (state.visits.length === 0) {
            el.visitList.innerHTML = `
                <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                    No visits recorded for this patient
                </div>
            `;
            return;
        }
        
        let html = '';
        state.visits.forEach((visit, index) => {
            const date = new Date(visit.date);
            html += `
                <div class="visit-card">
                    <div class="visit-date">
                        ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                    </div>
                    <div class="visit-values">
                        <span class="visit-fev1">${visit.fev1.toFixed(2)} L</span>
                        ${visit.fvc ? `<span style="color: #059669;">${visit.fvc.toFixed(2)} L</span>` : ''}
                    </div>
                </div>
            `;
        });
        
        el.visitList.innerHTML = html;
    }
    
    // ===== UTILITY FUNCTIONS =====
    function switchMode(mode) {
        state.currentSession.mode = mode;
        
        // Update UI
        el.modeBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        // Show/hide modes
        document.getElementById('modeQuick').classList.toggle('hidden', mode !== 'quick');
        document.getElementById('modeStandard').classList.toggle('hidden', mode !== 'standard');
        document.getElementById('modeReview').classList.toggle('hidden', mode !== 'review');
        
        if (mode === 'review') {
            updateReviewMode();
        }
    }
    
    function dateDiffInDays(date1, date2) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        const diff = Math.abs(d1 - d2);
        return Math.floor(diff / (1000 * 60 * 60 * 24));
    }
    
    function copyResults() {
        if (!state.currentSession.fev1) {
            showToast('Calculate first', 'warning');
            return;
        }
        
        let text = `Patient: ${state.currentPatient.id || '--'}\n`;
        text += `Date: ${new Date().toLocaleDateString()}\n\n`;
        
        text += `FEV‚ÇÅ: ${state.currentSession.fev1.toFixed(2)} L\n`;
        text += `FVC: ${state.currentSession.fvc.toFixed(2)} L\n`;
        text += `FEV‚ÇÅ/FVC: ${(state.currentSession.fev1 / state.currentSession.fvc * 100).toFixed(1)}%\n\n`;
        
        if (state.currentSession.comparisonType !== 'none' && state.currentSession.comparisonValue) {
            const delta = state.currentSession.fev1 - state.currentSession.comparisonValue;
            const percent = (delta / state.currentSession.comparisonValue * 100);
            
            text += `Comparison: vs ${state.currentSession.comparisonType === 'baseline' ? 'Baseline' : 'Last Visit'}\n`;
            text += `Reference: ${state.currentSession.comparisonValue.toFixed(2)} L\n`;
            text += `Œî FEV‚ÇÅ: ${delta.toFixed(2)} L (${percent.toFixed(1)}%)\n`;
        }
        
        text += `\n---\nGenerated by PulmoCalc`;
        
        navigator.clipboard.writeText(text).then(() => {
            showToast('Results copied to clipboard', 'success');
        });
    }
    
    function exportPatientData() {
        if (!state.currentPatient.id) {
            showToast('Select patient first', 'warning');
            return;
        }
        
        const data = {
            patient: state.currentPatient,
            visits: state.visits,
            exportedAt: new Date().toISOString()
        };
        
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pulmocalc-${state.currentPatient.id}-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Patient data exported', 'success');
    }
    
    function showModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }
    
    function hideModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    function showToast(message, type = 'info') {
        // Remove existing
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();
        
        // Create
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #1f2937;
            padding: 1rem 1.25rem;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
            border-left: 4px solid #1E6EA6;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
        `;
        
        const colors = {
            success: '#059669',
            warning: '#f59e0b',
            error: '#dc2626',
            info: '#1E6EA6'
        };
        
        toast.style.borderLeftColor = colors[type] || colors.info;
        
        const icons = {
            success: '‚úÖ',
            warning: '‚ö†Ô∏è',
            error: '‚ùå',
            info: '‚ÑπÔ∏è'
        };
        
        toast.innerHTML = `
            <span style="font-size: 1.25rem;">${icons[type] || icons.info}</span>
            <span>${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function handleKeyboardShortcuts(e) {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            if (state.currentSession.mode === 'quick') {
                saveQuickVisit();
            } else if (state.currentSession.mode === 'standard') {
                saveFullStudy();
            }
        }
        
        // Escape to clear
        if (e.key === 'Escape') {
            if (state.currentSession.mode === 'quick') {
                clearQuickCalc();
            } else if (state.currentSession.mode === 'standard') {
                clearStandard();
            }
        }
        
        // Tab through comparison options
        if (e.key === 'Tab' && state.currentSession.mode === 'quick') {
            if (document.activeElement === el.inputFvc) {
                e.preventDefault();
                el.optionBaseline.querySelector('.option-radio').focus();
            }
        }
    }
    
    function setupUI() {
        // Set today's date for inputs
        const today = new Date().toISOString().split('T')[0];
        el.txDate.max = today;
        el.baselineDate.max = today;
        
        // Auto-focus
        setTimeout(() => el.inputFev1.focus(), 100);
    }
    
    // Fix iOS 100vh issue
    function setVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    
    console.log('‚ú® PulmoCalc ready - Objective transplant calculator');
    </script>
</body>
</html>
