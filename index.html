<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1A5F7A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Spirolite - Clinical Lung Function Calculator & Tracker">
    <title>Spirolite | Professional</title>
    
    <!-- PWA Assets -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* === CSS RESET & NATIVE VARIABLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            /* Enhanced Color System */
            --primary: #1A5F7A;
            --primary-dark: #0D4B63;
            --primary-light: #2D9596;
            --secondary: #57C5B6;
            --accent: #FF6B35;
            
            /* Semantic Colors */
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --info-light: #93C5FD;
            
            /* Surface Colors - iOS inspired */
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --surface-elevated: #FFFFFF;
            --surface-secondary: #F3F4F6;
            --surface-tertiary: #E5E7EB;
            
            /* Text Colors */
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --text-on-primary: #FFFFFF;
            
            /* Border Colors */
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            --border-dark: #D1D5DB;
            
            /* Chart Colors */
            --chart-primary: #1A5F7A;
            --chart-secondary: #57C5B6;
            --chart-success: #10B981;
            --chart-warning: #F59E0B;
            --chart-error: #EF4444;
            
            /* Spacing System (8px grid) */
            --space-0: 0px;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-7: 32px;
            --space-8: 40px;
            --space-9: 48px;
            --space-10: 56px;
            
            /* Typography - System fonts for native feel */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-mono: 'SF Mono', 'Roboto Mono', 'Courier New', monospace;
            
            /* Border Radius - iOS inspired */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-full: 9999px;
            
            /* Shadows - Material Design & iOS hybrid */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
            
            /* Elevation */
            --elevation-1: 0 1px 3px rgba(0, 0, 0, 0.12);
            --elevation-2: 0 4px 12px rgba(0, 0, 0, 0.15);
            --elevation-3: 0 8px 24px rgba(0, 0, 0, 0.18);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Z-index */
            --z-base: 1;
            --z-elevated: 10;
            --z-sticky: 100;
            --z-modal: 1000;
            --z-toast: 10000;
            
            /* Safe Area Insets for iPhone X+ */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            
            /* Protocol Thresholds */
            --threshold-monitor: 10;
            --threshold-review: 20;
        }
        
        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #111827;
                --surface: #1F2937;
                --surface-elevated: #374151;
                --surface-secondary: #374151;
                --surface-tertiary: #4B5563;
                
                --text-primary: #F9FAFB;
                --text-secondary: #D1D5DB;
                --text-tertiary: #9CA3AF;
                
                --border: #374151;
                --border-light: #4B5563;
                --border-dark: #6B7280;
                
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.35);
                --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.4);
            }
        }
        
        /* === BASE STYLES === */
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            background: var(--background);
            overscroll-behavior: none;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-family);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            background: var(--background);
        }
        
        /* === LOADING OVERLAY (ENHANCED) === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0D4B63 0%, #1A5F7A 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            opacity: 1;
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            padding: var(--space-8);
            padding-top: calc(var(--safe-area-top) + var(--space-8));
            padding-bottom: calc(var(--safe-area-bottom) + var(--space-8));
        }
        
        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            max-width: 280px;
            width: 100%;
        }
        
        .loading-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto var(--space-6);
            animation: logoFloat 3s ease-in-out infinite;
            color: white;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
        }
        
        .loading-progress-container {
            width: 100%;
            margin: var(--space-6) auto;
        }
        
        .loading-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .loading-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), white);
            width: 0%;
            border-radius: var(--radius-full);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* === APP CONTAINER (MOBILE FIRST) === */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            max-width: 800px;
            margin: 0 auto;
            background: var(--background);
            position: relative;
        }
        
        @media (min-width: 768px) {
            .app-container {
                margin: var(--space-4) auto;
                height: calc(100vh - 2 * var(--space-4));
                max-height: 900px;
                border-radius: var(--radius-xl);
                overflow: hidden;
                box-shadow: var(--shadow-xl);
                border: 1px solid var(--border);
            }
        }
        
        /* === ENHANCED HEADER === */
        .app-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: var(--space-3) var(--space-4);
            padding-top: calc(var(--safe-area-top) + var(--space-3));
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            min-height: 60px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
            min-width: 0;
        }
        
        /* Logo & Title - Cleaner */
        .app-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-md);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }
        
        .app-title {
            flex: 1;
            min-width: 0;
        }
        
        .app-title h1 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            display: flex;
            align-items: baseline;
            gap: var(--space-1);
        }
        
        .app-title .tagline {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 500;
            margin-top: 1px;
            opacity: 0.7;
        }
        
        /* Header Actions - Organized */
        .header-actions {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
            align-items: center;
        }
        
        .action-group {
            display: flex;
            gap: 1px;
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: 2px;
            border: 1px solid var(--border);
        }
        
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--surface);
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 16px;
            position: relative;
        }
        
        .header-btn:hover,
        .header-btn:active {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }
        
        .header-btn:active {
            transform: scale(0.95);
        }
        
        .header-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .undo-redo-container {
            display: flex;
            gap: 1px;
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: 2px;
        }
        
        .undo-btn,
        .redo-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: var(--surface);
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-fast);
        }
        
        .undo-btn:disabled,
        .redo-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .undo-btn:not(:disabled):hover,
        .redo-btn:not(:disabled):hover {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }
        
        /* === PATIENT BAR (MOBILE OPTIMIZED) === */
        .patient-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            position: sticky;
            top: 60px;
            z-index: var(--z-sticky);
            transition: transform var(--transition-smooth);
            min-height: 64px;
        }
        
        .patient-bar.hidden {
            transform: translateY(-100%);
        }
        
        .patient-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
            min-width: 0;
        }
        
        .patient-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 15px;
            flex-shrink: 0;
        }
        
        .patient-details {
            flex: 1;
            min-width: 0;
        }
        
        .patient-id {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .patient-meta {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-top: 2px;
        }
        
        .patient-status {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }
        
        .visit-count {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* TX Date Indicator - Always Visible */
        .tx-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .tx-indicator.missing {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border-color: rgba(239, 68, 68, 0.2);
        }
        
        .tx-indicator.recent {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border-color: rgba(245, 158, 11, 0.2);
        }
        
        .tx-indicator.valid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.2);
        }
        
        .tx-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* Patient Actions */
        .patient-actions {
            display: flex;
            gap: var(--space-1);
        }
        
        /* === NAVIGATION (iOS Tab Bar Style) === */
        .app-navigation {
            display: flex;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: var(--space-1) var(--space-4);
            padding-bottom: calc(var(--safe-area-bottom) + var(--space-1));
            gap: var(--space-1);
            position: sticky;
            bottom: 0;
            z-index: var(--z-sticky);
            box-shadow: 0 -1px 0 var(--border);
        }
        
        .nav-btn {
            flex: 1;
            padding: var(--space-2);
            border: none;
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-height: 50px;
            position: relative;
        }
        
        .nav-btn:hover {
            background: var(--surface-secondary);
        }
        
        .nav-btn.active {
            color: var(--primary);
        }
        
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: var(--radius-full);
        }
        
        .nav-icon {
            font-size: 16px;
        }
        
        /* === MAIN CONTENT (Optimized for Mobile) === */
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: var(--space-4);
            padding-bottom: max(var(--space-4), var(--safe-area-bottom));
        }
        
        .mode-section {
            display: none;
            animation: fadeInUp var(--transition-smooth);
        }
        
        .mode-section.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* === CARDS (iOS Style) === */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }
        
        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }
        
        /* === INPUT SYSTEM (Mobile Optimized) === */
        .input-group {
            margin-bottom: var(--space-4);
        }
        
        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            padding: 0 2px;
        }
        
        .input-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
            padding: 0 2px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .text-input {
            width: 100%;
            padding: var(--space-3);
            padding-right: 50px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--surface);
            transition: all var(--transition-fast);
            -webkit-appearance: none;
            appearance: none;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        }
        
        .text-input.invalid {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .input-unit {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        /* === ENHANCED BASELINE INPUT (Mobile First) === */
        .baseline-container {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            border: 1px solid var(--border);
        }
        
        .baseline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }
        
        .baseline-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .baseline-value-display {
            font-family: var(--font-family-mono);
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
            padding: 4px 8px;
            background: var(--surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            min-width: 80px;
            text-align: center;
        }
        
        /* THREE-STATE BASELINE BUTTON */
        .baseline-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 80px;
            justify-content: center;
        }
        
        /* State 1: Disabled */
        .baseline-action-btn:disabled {
            background: var(--surface-tertiary);
            color: var(--text-tertiary);
            border: 1px solid var(--border);
            cursor: not-allowed;
        }
        
        /* State 2: Ready (Blue) */
        .baseline-action-btn.ready {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }
        
        .baseline-action-btn.ready:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        /* State 3: Success (Green) */
        .baseline-action-btn.success {
            background: var(--success);
            color: white;
            border: 1px solid var(--success);
            animation: pulseSuccess 2s ease-in-out;
        }
        
        .baseline-action-btn.success::after {
            content: 'âœ“';
            margin-left: 4px;
            animation: checkmark 0.3s ease-out;
        }
        
        @keyframes checkmark {
            from {
                opacity: 0;
                transform: scale(0);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulseSuccess {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Progress indicator for baseline */
        .baseline-progress {
            height: 3px;
            background: var(--border);
            border-radius: var(--radius-full);
            margin-top: var(--space-2);
            overflow: hidden;
        }
        
        .baseline-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }
        
        .baseline-progress-bar.success {
            background: var(--success);
        }
        
        /* === MEASUREMENT INPUTS (Side by Side on Mobile) === */
        .measurement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        @media (max-width: 360px) {
            .measurement-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* === DATE INPUT WITH SHORTCUTS === */
        .date-input-container {
            position: relative;
        }
        
        .date-input {
            width: 100%;
            padding: var(--space-3);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 16px;
            color: var(--text-primary);
            background: var(--surface);
            -webkit-appearance: none;
            appearance: none;
        }
        
        .date-shortcuts {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
            flex-wrap: wrap;
        }
        
        .date-shortcut {
            padding: 4px 8px;
            background: var(--surface-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .date-shortcut:hover {
            background: var(--surface);
            border-color: var(--border-dark);
            color: var(--text-primary);
        }
        
        /* === COMPARISON OPTIONS === */
        .comparison-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin: var(--space-4) 0;
        }
        
        .comparison-option {
            padding: var(--space-3);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--surface);
        }
        
        .comparison-option:hover {
            border-color: var(--border-dark);
            transform: translateY(-1px);
        }
        
        .comparison-option.selected {
            border-color: var(--primary);
            background: rgba(26, 95, 122, 0.05);
        }
        
        .option-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-1);
        }
        
        .option-radio {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }
        
        .option-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .option-description {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 24px;
        }
        
        /* === RESULTS PANEL === */
        .results-panel {
            margin-top: var(--space-4);
            display: none;
            animation: slideInUp var(--transition-smooth);
        }
        
        .results-panel.visible {
            display: block;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .results-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .results-timestamp {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* === MEASUREMENT CARDS (3-column on mobile) === */
        .measurement-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        @media (max-width: 480px) {
            .measurement-cards {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }
        }
        
        .measurement-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        .measurement-card:hover {
            border-color: var(--border-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .measurement-value {
            font-family: var(--font-family-mono);
            font-weight: 700;
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .measurement-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: block;
        }
        
        .measurement-unit {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* === PERCENTAGE DISPLAYS === */
        .percent-display {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }
        
        .percent-display.good {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .percent-display.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .percent-display.alert {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .percent-display.neutral {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        /* Color-blind mode patterns */
        .color-blind .percent-display.good {
            background: repeating-linear-gradient(
                45deg,
                rgba(16, 185, 129, 0.1),
                rgba(16, 185, 129, 0.1) 4px,
                rgba(16, 185, 129, 0.05) 4px,
                rgba(16, 185, 129, 0.05) 8px
            );
        }
        
        .color-blind .percent-display.warning {
            background: repeating-linear-gradient(
                45deg,
                rgba(245, 158, 11, 0.1),
                rgba(245, 158, 11, 0.1) 4px,
                rgba(245, 158, 11, 0.05) 4px,
                rgba(245, 158, 11, 0.05) 8px
            );
        }
        
        .color-blind .percent-display.alert {
            background: repeating-linear-gradient(
                45deg,
                rgba(239, 68, 68, 0.1),
                rgba(239, 68, 68, 0.1) 4px,
                rgba(239, 68, 68, 0.05) 4px,
                rgba(239, 68, 68, 0.05) 8px
            );
        }
        
        /* === TREND ARROWS === */
        .trend-arrow {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: var(--radius-full);
            font-size: 10px;
            margin-right: 2px;
        }
        
        .trend-arrow.up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .trend-arrow.down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .trend-arrow.neutral {
            background: var(--surface-secondary);
            color: var(--text-secondary);
        }
        
        /* === ACTION BUTTONS (iOS Style) === */
        .action-bar {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border);
        }
        
        @media (max-width: 640px) {
            .action-bar {
                flex-direction: column;
            }
        }
        
        .btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1.5px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--surface-secondary);
            border-color: var(--border-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-error {
            background: var(--error);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        /* === FLOATING ACTION BUTTON (Android Style) === */
        .fab-container {
            position: fixed;
            bottom: calc(var(--space-4) + var(--safe-area-bottom));
            right: var(--space-4);
            z-index: var(--z-elevated);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--primary);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: calc(var(--space-4) + var(--safe-area-top));
            left: var(--space-4);
            right: var(--space-4);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
        }
        
        .toast {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary);
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            pointer-events: auto;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .toast-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .toast-message {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--space-1);
            font-size: 14px;
        }
        
        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }
        
        .toast.error {
            border-left-color: var(--error);
        }
        
        .toast.info {
            border-left-color: var(--info);
        }
        
        /* === MONITOR MODE SPECIFIC === */
        .monitor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .view-toggle {
            display: flex;
            gap: 1px;
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: 2px;
            border: 1px solid var(--border);
        }
        
        .view-toggle-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        
        .view-toggle-btn:hover {
            background: var(--surface);
        }
        
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .density-controls {
            display: flex;
            gap: 1px;
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: 2px;
        }
        
        .density-btn {
            padding: 4px 8px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .density-btn.active {
            background: var(--surface);
            color: var(--text-primary);
        }
        
        /* Table Views */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-4);
        }
        
        .medical-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .medical-table th {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.05em;
            padding: var(--space-2) var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        
        .medical-table td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }
        
        .medical-table tr:last-child td {
            border-bottom: none;
        }
        
        .medical-table tr:hover {
            background: var(--surface-secondary);
        }
        
        /* Density variations */
        .table-density-compact .medical-table td,
        .table-density-compact .medical-table th {
            padding: 6px 8px;
            font-size: 11px;
        }
        
        .table-density-summary .medical-table td {
            padding: 8px 12px;
        }
        
        /* Alert cells */
        .alert-cell {
            font-weight: 600;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            white-space: nowrap;
        }
        
        .alert-cell.monitor {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .alert-cell.review {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .alert-cell.stable {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        /* Timeline View */
        .timeline-container {
            position: relative;
            padding: var(--space-4);
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: var(--space-4);
        }
        
        .chart-container {
            height: 200px;
            margin-bottom: var(--space-4);
            position: relative;
        }
        
        .milestones {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        
        .milestone {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            padding: 4px 8px;
            background: var(--surface-secondary);
            border-radius: var(--radius-full);
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .milestone-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* Protocol Context */
        .protocol-context {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-top: var(--space-3);
            border-left: 4px solid var(--primary);
        }
        
        .protocol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }
        
        .protocol-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .threshold-display {
            display: flex;
            gap: var(--space-2);
        }
        
        .threshold-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: var(--radius-full);
        }
        
        .threshold-badge.monitor {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .threshold-badge.review {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .protocol-note {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* === MODALS === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-4);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-smooth);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform var(--transition-smooth);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--surface-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .modal-body {
            padding: var(--space-4);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--space-2);
            justify-content: flex-end;
        }
        
        /* === ENTRY MODE SELECTOR === */
        .entry-mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-2);
            margin: var(--space-4) 0;
        }
        
        @media (max-width: 640px) {
            .entry-mode-selector {
                grid-template-columns: 1fr;
            }
        }
        
        .entry-mode-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .entry-mode-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .entry-mode-card.active {
            border-color: var(--primary);
            background: rgba(26, 95, 122, 0.05);
        }
        
        .entry-mode-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: var(--space-2);
        }
        
        .entry-mode-title {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .entry-mode-desc {
            font-size: 10px;
            color: var(--text-tertiary);
            line-height: 1.3;
        }
        
        /* === VISIT ENTRY FORMS === */
        .visit-entry-form {
            margin-bottom: var(--space-4);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        
        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }
        }
        
        .clinical-notes-input {
            width: 100%;
            padding: var(--space-3);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 14px;
            color: var(--text-primary);
            background: var(--surface);
            min-height: 80px;
            resize: vertical;
        }
        
        .bulk-textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family-mono);
            font-size: 12px;
            color: var(--text-primary);
            background: var(--surface);
            min-height: 120px;
            resize: vertical;
        }
        
        /* === SPREADSHEET TABLE === */
        .spreadsheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-bottom: var(--space-3);
        }
        
        .spreadsheet-table th {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            padding: var(--space-2);
            text-align: left;
            border: 1px solid var(--border);
        }
        
        .spreadsheet-table td {
            padding: var(--space-2);
            border: 1px solid var(--border);
            background: var(--surface);
        }
        
        .editable-cell {
            outline: none;
            min-width: 60px;
        }
        
        .editable-cell:focus {
            background: var(--surface-secondary);
            box-shadow: inset 0 0 0 2px var(--primary);
        }
        
        /* === ACCESSIBILITY CONTROLS === */
        .accessibility-controls {
            position: fixed;
            bottom: calc(var(--space-4) + var(--safe-area-bottom) + 60px);
            right: var(--space-4);
            z-index: var(--z-elevated);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .accessibility-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .accessibility-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* === COLOR-BLIND MODE === */
        .color-blind .trend-arrow.up::before {
            content: "â†‘";
            margin-right: 2px;
        }
        
        .color-blind .trend-arrow.down::before {
            content: "â†“";
            margin-right: 2px;
        }
        
        .color-blind .alert-cell.monitor::before {
            content: "âš  ";
        }
        
        .color-blind .alert-cell.review::before {
            content: "ðŸ”´ ";
        }
        
        .color-blind .alert-cell.stable::before {
            content: "âœ“ ";
        }
        
        /* === HIGH CONTRAST MODE === */
        .high-contrast {
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-tertiary: #666666;
            --surface: #FFFFFF;
            --surface-secondary: #F0F0F0;
            --border: #000000;
            --primary: #000000;
            --success: #006400;
            --warning: #8B4513;
            --error: #8B0000;
        }
        
        @media (prefers-color-scheme: dark) {
            .high-contrast {
                --text-primary: #FFFFFF;
                --text-secondary: #CCCCCC;
                --text-tertiary: #999999;
                --surface: #000000;
                --surface-secondary: #222222;
                --border: #FFFFFF;
                --primary: #FFFFFF;
                --success: #90EE90;
                --warning: #FFA500;
                --error: #FF6347;
            }
        }
        
        /* === PROGRESSIVE DISCLOSURE FOR MOBILE === */
        .collapsible-section {
            margin-bottom: var(--space-4);
        }
        
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3);
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            border: 1px solid var(--border);
        }
        
        .collapsible-content {
            padding: var(--space-3);
            background: var(--surface);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border: 1px solid var(--border);
            border-top: none;
            display: none;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        /* === MOBILE OPTIMIZATION UTILITIES === */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, .nav-btn, .header-btn {
                min-height: 44px;
            }
            
            /* Remove hover effects on mobile */
            .btn:hover, .nav-btn:hover, .header-btn:hover {
                transform: none;
            }
            
            /* Active state for touch feedback */
            .btn:active, .nav-btn:active, .header-btn:active {
                opacity: 0.8;
                transform: scale(0.98);
            }
        }
        
        /* Safe area adjustments */
        @supports (padding: max(0px)) {
            .app-header {
                padding-top: max(var(--space-3), var(--safe-area-top));
            }
            
            .app-navigation {
                padding-bottom: max(var(--space-1), var(--safe-area-bottom));
            }
            
            .fab-container {
                bottom: max(var(--space-4), var(--safe-area-bottom));
            }
        }
        
        /* === DARK MODE ENHANCEMENTS === */
        @media (prefers-color-scheme: dark) {
            .text-input,
            .date-input,
            .clinical-notes-input,
            .bulk-textarea {
                background: var(--surface-elevated);
            }
            
            .btn-secondary {
                background: var(--surface-elevated);
            }
            
            .measurement-card {
                background: var(--surface-elevated);
            }
        }
        
        /* === ACCESSIBILITY === */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* === UTILITY CLASSES === */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: var(--space-2);
        }
        
        .gap-3 {
            gap: var(--space-3);
        }
        
        .mt-2 {
            margin-top: var(--space-2);
        }
        
        .mt-3 {
            margin-top: var(--space-3);
        }
        
        .mt-4 {
            margin-top: var(--space-4);
        }
        
        .mb-2 {
            margin-bottom: var(--space-2);
        }
        
        .mb-3 {
            margin-bottom: var(--space-3);
        }
        
        .mb-4 {
            margin-bottom: var(--space-4);
        }
        
        .p-3 {
            padding: var(--space-3);
        }
        
        .p-4 {
            padding: var(--space-4);
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-sm {
            font-size: 12px;
        }
        
        .text-xs {
            font-size: 11px;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .text-primary {
            color: var(--text-primary);
        }
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        .text-tertiary {
            color: var(--text-tertiary);
        }
        
        .bg-surface {
            background: var(--surface);
        }
        
        .bg-surface-secondary {
            background: var(--surface-secondary);
        }
        
        .border {
            border: 1px solid var(--border);
        }
        
        .rounded-md {
            border-radius: var(--radius-md);
        }
        
        .rounded-lg {
            border-radius: var(--radius-lg);
        }
        
        .w-full {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-logo">
                <svg viewBox="0 0 96 96" fill="currentColor">
                    <path d="M24 56 C24 32 38 24 46 30 V66 C46 74 38 82 28 82 C24 82 24 76 24 70 Z" 
                          stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <path d="M72 56 C72 32 58 24 50 30 V66 C50 74 58 82 68 82 C72 82 72 76 72 70 Z" 
                          stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <line x1="48" y1="16" x2="48" y2="66" 
                          stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <rect x="42" y="22" width="12" height="26" rx="2" fill="currentColor"/>
                    <rect x="40" y="16" width="16" height="6" rx="2" fill="currentColor"/>
                </svg>
            </div>
            <div class="loading-progress-container">
                <div class="loading-progress-label">
                    <span id="loadingStep">Loading Spirolite Professional</span>
                    <span id="loadingPercent">0%</span>
                </div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo">S</div>
                <div class="app-title">
                    <h1>Spirolite</h1>
                    <div class="tagline">Professional Lung Function</div>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="action-group">
                    <button class="header-btn" id="undoBtn" title="Undo (Ctrl+Z)" disabled>
                        â†¶
                    </button>
                    <button class="header-btn" id="redoBtn" title="Redo (Ctrl+Y)" disabled>
                        â†·
                    </button>
                </div>
                <div class="action-group">
                    <button class="header-btn" id="protocolBtn" title="Protocol Settings">
                        âš™ï¸
                    </button>
                    <button class="header-btn" id="exportBtn" title="Export Data">
                        ðŸ“¤
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Patient Bar (Always Visible) -->
        <div class="patient-bar" id="patientBar">
            <div class="patient-info">
                <div class="patient-avatar" id="patientAvatar">--</div>
                <div class="patient-details">
                    <div class="patient-id" id="patientId">Select Patient</div>
                    <div class="patient-meta">
                        <span class="patient-status" id="patientStatus">No data</span>
                        <span class="visit-count" id="visitCount">0 visits</span>
                    </div>
                </div>
            </div>
            <div class="tx-indicator" id="txIndicator">
                <span class="dot"></span>
                <span id="txDateText">No TX date</span>
            </div>
            <div class="patient-actions">
                <button class="header-btn" id="newPatientBtn" title="New Patient">
                    âž•
                </button>
                <button class="header-btn" id="patientListBtn" title="Patient List">
                    ðŸ‘¥
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Quick Calc Mode -->
            <div id="modeQuick" class="mode-section active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Quick Calculation</div>
                        <div class="card-badge" id="quickBadge">No Patient</div>
                    </div>
                    
                    <!-- Always Visible Baseline Input -->
                    <div class="baseline-container">
                        <div class="baseline-header">
                            <div class="baseline-label">
                                <span>ðŸ“Š Baseline FEVâ‚</span>
                                <div class="baseline-value-display" id="baselineValueDisplay">
                                    -- L
                                </div>
                            </div>
                            <button class="baseline-action-btn" id="baselineActionBtn" disabled>
                                Set
                            </button>
                        </div>
                        <input type="number" 
                               step="0.01" 
                               min="0.5" 
                               max="8.0"
                               class="text-input"
                               id="baselineInput"
                               placeholder="Enter baseline FEVâ‚"
                               aria-label="Baseline FEVâ‚ in liters">
                        <div class="baseline-progress">
                            <div class="baseline-progress-bar" id="baselineProgress"></div>
                        </div>
                        <div class="input-hint" id="baselineHint">
                            Baseline value is required for percentage calculations
                        </div>
                    </div>
                    
                    <!-- Current Measurements -->
                    <div class="measurement-grid">
                        <div class="input-group">
                            <label class="input-label" for="inputFev1">
                                Current FEVâ‚
                                <span class="input-hint">Forced Expiratory Volume in 1 second</span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" 
                                       step="0.01" 
                                       min="0.5" 
                                       max="8.0"
                                       class="text-input"
                                       id="inputFev1"
                                       placeholder="2.85"
                                       required
                                       aria-label="Current FEVâ‚ in liters">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" for="inputFvc">
                                Current FVC
                                <span class="input-hint">Forced Vital Capacity (optional)</span>
                            </label>
                            <div class="input-wrapper">
                                <input type="number" 
                                       step="0.01" 
                                       min="0.5" 
                                       max="10.0"
                                       class="text-input"
                                       id="inputFvc"
                                       placeholder="3.40"
                                       aria-label="Current FVC in liters">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date Input -->
                    <div class="input-group">
                        <label class="input-label" for="measurementDate">Measurement Date</label>
                        <div class="date-input-container">
                            <input type="date" 
                                   class="date-input"
                                   id="measurementDate"
                                   aria-label="Measurement date">
                            <div class="date-shortcuts">
                                <button class="date-shortcut" data-offset="-7">1w ago</button>
                                <button class="date-shortcut" data-offset="-30">1m ago</button>
                                <button class="date-shortcut" data-offset="-90">3m ago</button>
                                <button class="date-shortcut" data-offset="0">Today</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Options -->
                    <div class="comparison-options">
                        <div class="comparison-option" id="comparisonNone">
                            <div class="option-header">
                                <input type="radio" name="comparison" class="option-radio" value="none" checked>
                                <span class="option-title">Current values only</span>
                            </div>
                            <div class="option-description">
                                Show raw measurements without comparison
                            </div>
                        </div>
                        <div class="comparison-option" id="comparisonBaseline">
                            <div class="option-header">
                                <input type="radio" name="comparison" class="option-radio" value="baseline">
                                <span class="option-title">vs Baseline</span>
                            </div>
                            <div class="option-description">
                                Compare to established baseline value
                            </div>
                        </div>
                        <div class="comparison-option" id="comparisonPrevious">
                            <div class="option-header">
                                <input type="radio" name="comparison" class="option-radio" value="previous">
                                <span class="option-title">vs Previous Visit</span>
                            </div>
                            <div class="option-description">
                                Compare to last recorded measurement
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Results -->
                <div class="results-panel" id="resultsPanel">
                    <div class="card">
                        <div class="results-header">
                            <div class="results-title">Results</div>
                            <div class="results-timestamp" id="resultsTimestamp">Just now</div>
                        </div>
                        
                        <div class="measurement-cards">
                            <div class="measurement-card">
                                <div class="measurement-value" id="resultFev1">--</div>
                                <span class="measurement-label">FEVâ‚</span>
                                <div class="measurement-unit">
                                    <span id="resultFev1Percent">--%</span>
                                    <span class="percent-display neutral" id="fev1PercentBadge">--</span>
                                </div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="resultFvc">--</div>
                                <span class="measurement-label">FVC</span>
                                <div class="measurement-unit">Liters</div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="resultRatio">--</div>
                                <span class="measurement-label">Ratio</span>
                                <div class="measurement-unit">FEVâ‚/FVC</div>
                            </div>
                        </div>
                        
                        <!-- Comparison Results -->
                        <div class="comparison-results" id="comparisonResults">
                            <div class="input-label">Comparison Analysis</div>
                            <div class="measurement-cards">
                                <div class="measurement-card">
                                    <div class="measurement-value">
                                        <span class="trend-arrow neutral" id="trendArrow">â†’</span>
                                        <span id="resultVisitDelta">--</span>
                                    </div>
                                    <span class="measurement-label">Î” from Last</span>
                                    <div class="measurement-unit">
                                        <span id="resultVisitPercent">--%</span>
                                    </div>
                                </div>
                                <div class="measurement-card">
                                    <div class="measurement-value" id="resultBaselinePercent">--%</div>
                                    <span class="measurement-label">% of Baseline</span>
                                    <div class="measurement-unit">
                                        <span id="resultBaselineDelta">-- L</span>
                                    </div>
                                </div>
                                <div class="measurement-card">
                                    <div class="measurement-value" id="resultRateChange">--</div>
                                    <span class="measurement-label">Rate of Change</span>
                                    <div class="measurement-unit">L/month</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Protocol Context -->
                        <div class="protocol-context" id="protocolContext">
                            <div class="protocol-header">
                                <div class="protocol-title">Protocol Context</div>
                                <div class="threshold-display">
                                    <div class="threshold-badge monitor">Monitor â‰¥<span id="thresholdMonitorValue">10</span>%</div>
                                    <div class="threshold-badge review">Review â‰¥<span id="thresholdReviewValue">20</span>%</div>
                                </div>
                            </div>
                            <div class="protocol-note" id="protocolNote">
                                Using protocol thresholds for clinical context.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="btn btn-secondary" id="clearQuickBtn">
                        ðŸ—‘ï¸ Clear
                    </button>
                    <button class="btn btn-primary" id="calculateBtn">
                        ðŸ“Š Calculate
                    </button>
                </div>
            </div>
            
            <!-- Monitor Mode -->
            <div id="modeMonitor" class="mode-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">First Year Monitoring</div>
                        <div class="card-badge" id="monitorBadge">No Patient</div>
                    </div>
                    
                    <!-- Monitor Controls -->
                    <div class="monitor-controls">
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-view="table">
                                ðŸ“‹ Table
                            </button>
                            <button class="view-toggle-btn" data-view="timeline">
                                ðŸ“… Timeline
                            </button>
                            <button class="view-toggle-btn" data-view="chart">
                                ðŸ“Š Chart
                            </button>
                        </div>
                        
                        <div class="density-controls">
                            <button class="density-btn active" data-density="compact">Compact</button>
                            <button class="density-btn" data-density="detailed">Detailed</button>
                            <button class="density-btn" data-density="summary">Summary</button>
                        </div>
                    </div>
                    
                    <!-- Entry Mode Selector -->
                    <div class="entry-mode-selector" id="entryModeSelector">
                        <div class="entry-mode-card active" data-mode="single">
                            <div class="entry-mode-icon">âž•</div>
                            <div class="entry-mode-title">Single Entry</div>
                            <div class="entry-mode-desc">Enter one visit at a time</div>
                        </div>
                        <div class="entry-mode-card" data-mode="bulk">
                            <div class="entry-mode-icon">ðŸ“¥</div>
                            <div class="entry-mode-title">Bulk Import</div>
                            <div class="entry-mode-desc">Paste multiple visits</div>
                        </div>
                        <div class="entry-mode-card" data-mode="spreadsheet">
                            <div class="entry-mode-icon">ðŸ“‹</div>
                            <div class="entry-mode-title">Spreadsheet</div>
                            <div class="entry-mode-desc">Table-style data entry</div>
                        </div>
                    </div>
                    
                    <!-- Single Entry Form -->
                    <div class="visit-entry-form" id="singleEntryForm">
                        <div class="form-row">
                            <div>
                                <label class="input-label">Date</label>
                                <input type="date" class="date-input" id="visitDate">
                            </div>
                            <div>
                                <label class="input-label">FEVâ‚ (L)</label>
                                <input type="number" step="0.01" class="text-input" id="visitFev1" placeholder="2.85">
                            </div>
                            <div>
                                <label class="input-label">FVC (L)</label>
                                <input type="number" step="0.01" class="text-input" id="visitFvc" placeholder="3.40">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" id="addVisitBtn" style="height: 42px;">
                                    âž• Add
                                </button>
                            </div>
                        </div>
                        
                        <div class="date-shortcuts">
                            <button class="date-shortcut" data-offset="-7">1w ago</button>
                            <button class="date-shortcut" data-offset="-30">1m ago</button>
                            <button class="date-shortcut" data-offset="-90">3m ago</button>
                            <button class="date-shortcut" data-offset="0">Today</button>
                        </div>
                        
                        <div class="mt-3">
                            <label class="input-label">Clinical Notes</label>
                            <textarea class="clinical-notes-input" id="visitNotes" 
                                      placeholder="Symptoms, medications, context..."></textarea>
                            <div class="input-hint">Notes will appear as tooltips in the table</div>
                        </div>
                    </div>
                    
                    <!-- Bulk Import Form (Hidden) -->
                    <div class="visit-entry-form hidden" id="bulkEntryForm">
                        <label class="input-label">Bulk Import</label>
                        <textarea class="bulk-textarea" id="bulkImport" 
                                  placeholder="Format: YYYY-MM-DD, FEV1, FVC (optional), NOTES (optional)
Example:
2024-01-15, 2.85, 3.40, Doing well
2024-03-10, 3.10, 3.80, Post-antibiotics"></textarea>
                        <button class="btn btn-secondary mt-3" id="importBulkBtn">
                            ðŸ“¥ Import Visits
                        </button>
                    </div>
                    
                    <!-- Spreadsheet Form (Hidden) -->
                    <div class="visit-entry-form hidden" id="spreadsheetEntryForm">
                        <label class="input-label">Spreadsheet Entry</label>
                        <div class="table-container">
                            <table class="spreadsheet-table" id="spreadsheetTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>FEVâ‚ (L)</th>
                                        <th>FVC (L)</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="spreadsheetBody">
                                    <tr>
                                        <td class="editable-cell" contenteditable="true" data-field="date"></td>
                                        <td class="editable-cell" contenteditable="true" data-field="fev1"></td>
                                        <td class="editable-cell" contenteditable="true" data-field="fvc"></td>
                                        <td class="editable-cell" contenteditable="true" data-field="notes"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="action-bar mt-3" style="border-top: none; margin-top: 0; padding-top: 0;">
                            <button class="btn btn-secondary" id="addSpreadsheetRowBtn">
                                âž• Add Row
                            </button>
                            <button class="btn btn-primary" id="saveSpreadsheetBtn">
                                ðŸ’¾ Save All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="table-view" id="tableView">
                        <div class="table-container table-density-compact" id="visitsTableContainer">
                            <table class="medical-table" id="visitsTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Days</th>
                                        <th>FEVâ‚ (L)</th>
                                        <th>% of PB</th>
                                        <th>FVC</th>
                                        <th>Ratio</th>
                                        <th>Î” Visit</th>
                                        <th>Î” Baseline</th>
                                        <th>Rate</th>
                                        <th>Alert</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody">
                                    <tr>
                                        <td colspan="11" class="text-center p-4 text-secondary">
                                            No visits yet. Add visits using the form above.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Timeline View (Hidden) -->
                    <div class="timeline-view hidden" id="timelineView">
                        <div class="timeline-container">
                            <div class="chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                            <div class="milestones" id="timelineMilestones"></div>
                            <div class="protocol-context mt-3">
                                <div class="protocol-header">
                                    <div class="protocol-title">Timeline Summary</div>
                                </div>
                                <div class="protocol-note">
                                    <div class="flex justify-between mb-2">
                                        <span>Total Visits:</span>
                                        <span class="font-semibold" id="timelineTotalVisits">0</span>
                                    </div>
                                    <div class="flex justify-between mb-2">
                                        <span>Time Span:</span>
                                        <span class="font-semibold" id="timelineTimeSpan">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Current Status:</span>
                                        <span class="font-semibold" id="timelineStatus">No data</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart View (Hidden) -->
                    <div class="chart-view hidden" id="chartView">
                        <div class="chart-container">
                            <canvas id="fev1Chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Monitor Actions -->
                <div class="action-bar">
                    <button class="btn btn-secondary" id="clearMonitorBtn">
                        ðŸ—‘ï¸ Clear Table
                    </button>
                    <button class="btn btn-primary" id="exportPDFBtn">
                        ðŸ“„ Export PDF
                    </button>
                </div>
            </div>
            
            <!-- Full Study Mode -->
            <div id="modeFull" class="mode-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Full Patient Study</div>
                        <div class="card-badge" id="fullBadge">No Patient</div>
                    </div>
                    
                    <!-- Timeline Setup -->
                    <div class="measurement-grid">
                        <div class="input-group">
                            <label class="input-label">Transplant Date</label>
                            <input type="date" class="date-input" id="txDate">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Baseline Date</label>
                            <input type="date" class="date-input" id="baselineDate">
                        </div>
                    </div>
                    
                    <div class="date-shortcuts mb-4">
                        <button class="date-shortcut" data-offset="-365">1y ago</button>
                        <button class="date-shortcut" data-offset="-730">2y ago</button>
                        <button class="date-shortcut" data-offset="-1095">3y ago</button>
                        <button class="date-shortcut" data-offset="0">Today</button>
                    </div>
                    
                    <!-- Spirometry Inputs -->
                    <div class="measurement-grid">
                        <div class="input-group">
                            <label class="input-label">Current FEVâ‚</label>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" class="text-input" id="stdFev1" placeholder="2.85">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Baseline FEVâ‚</label>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" class="text-input" id="stdBaselineFev1" placeholder="3.20">
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clinical Notes -->
                    <div class="input-group">
                        <label class="input-label">Clinical Context</label>
                        <textarea class="clinical-notes-input" id="clinicalNotes"
                                  placeholder="Enter clinical context, symptoms, medications, or other relevant information..."></textarea>
                        <div class="input-hint">For your reference only</div>
                    </div>
                </div>
                
                <!-- Full Study Results -->
                <div class="results-panel" id="stdResultsPanel">
                    <div class="card">
                        <div class="results-header">
                            <div class="results-title">Comprehensive Analysis</div>
                            <div class="results-timestamp" id="stdResultsTimestamp">Just now</div>
                        </div>
                        
                        <div class="measurement-cards">
                            <div class="measurement-card">
                                <div class="measurement-value" id="stdCurrentFev1">--</div>
                                <span class="measurement-label">Current FEVâ‚</span>
                                <div class="measurement-unit">
                                    <span id="stdCurrentPercent">--%</span>
                                    <span class="percent-display neutral" id="stdCurrentBadge">--</span>
                                </div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="stdBaseline">--</div>
                                <span class="measurement-label">Baseline</span>
                                <div class="measurement-unit">Liters</div>
                            </div>
                            <div class="measurement-card">
                                <div class="measurement-value" id="stdTimePeriod">--</div>
                                <span class="measurement-label">Time Period</span>
                                <div class="measurement-unit">Days</div>
                            </div>
                        </div>
                        
                        <!-- Comparison Results -->
                        <div class="comparison-results mt-4">
                            <div class="input-label">Baseline Comparison</div>
                            <div class="measurement-cards">
                                <div class="measurement-card">
                                    <div class="measurement-value">
                                        <span class="trend-arrow neutral" id="stdTrendArrow">â†’</span>
                                        <span id="stdCumulativeDelta">--</span>
                                    </div>
                                    <span class="measurement-label">Cumulative Î”</span>
                                    <div class="measurement-unit">Liters</div>
                                </div>
                                <div class="measurement-card">
                                    <div class="measurement-value" id="stdPercentDecline">--%</div>
                                    <span class="measurement-label">% Decline</span>
                                    <div class="measurement-unit">of Baseline</div>
                                </div>
                                <div class="measurement-card">
                                    <div class="measurement-value" id="stdMonthlyRate">--</div>
                                    <span class="measurement-label">Monthly Rate</span>
                                    <div class="measurement-unit">L/month</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Protocol Context -->
                        <div class="protocol-context mt-4">
                            <div class="protocol-header">
                                <div class="protocol-title">Long-term Trend Analysis</div>
                            </div>
                            <div class="protocol-note" id="stdProtocolNote">
                                Using protocol thresholds for clinical context.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Full Study Actions -->
                <div class="action-bar">
                    <button class="btn btn-secondary" id="clearStdBtn">
                        ðŸ—‘ï¸ Clear All
                    </button>
                    <button class="btn btn-primary" id="saveStudyBtn">
                        ðŸ’¾ Save Full Study
                    </button>
                </div>
            </div>
            
            <!-- Patients Mode -->
            <div id="modePatients" class="mode-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Patient Management</div>
                        <button class="btn btn-primary" id="createPatientBtn">
                            âž• New Patient
                        </button>
                    </div>
                    
                    <!-- Patient List -->
                    <div class="table-container">
                        <table class="medical-table" id="patientsTable">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Transplant Date</th>
                                    <th>Visits</th>
                                    <th>Last Visit</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center p-4 text-secondary">
                                        No patients yet. Create your first patient.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Import/Export -->
                    <div class="action-bar mt-4">
                        <button class="btn btn-secondary" id="importPatientsBtn">
                            ðŸ“¥ Import Patients
                        </button>
                        <button class="btn btn-secondary" id="exportPatientsBtn">
                            ðŸ“¤ Export All Data
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Navigation -->
        <nav class="app-navigation">
            <button class="nav-btn active" data-mode="quick">
                <span class="nav-icon">âš¡</span>
                <span>Quick</span>
            </button>
            <button class="nav-btn" data-mode="monitor">
                <span class="nav-icon">ðŸ“Š</span>
                <span>Monitor</span>
            </button>
            <button class="nav-btn" data-mode="full">
                <span class="nav-icon">ðŸ“‹</span>
                <span>Full Study</span>
            </button>
            <button class="nav-btn" data-mode="patients">
                <span class="nav-icon">ðŸ‘¥</span>
                <span>Patients</span>
            </button>
        </nav>
    </div>
    
    <!-- Floating Action Buttons -->
    <div class="fab-container" id="fabContainer">
        <button class="fab" id="newVisitFab" title="New Visit">
            âž•
        </button>
        <button class="fab" id="quickCalcFab" title="Quick Calculate">
            ðŸ“Š
        </button>
    </div>
    
    <!-- Accessibility Controls -->
    <div class="accessibility-controls" id="accessibilityControls">
        <button class="accessibility-btn" id="colorBlindBtn" title="Color Blind Mode">
            ðŸŽ¨
        </button>
        <button class="accessibility-btn" id="highContrastBtn" title="High Contrast">
            ðŸ‘ï¸
        </button>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="protocolModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Protocol Settings</div>
                <button class="modal-close" id="closeProtocolModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Monitor Threshold</label>
                    <input type="range" min="5" max="25" step="1" value="10" class="w-full" id="monitorThreshold">
                    <div class="flex justify-between mt-1">
                        <span class="text-xs text-tertiary">5%</span>
                        <span class="text-xs font-semibold" id="monitorThresholdValue">10%</span>
                        <span class="text-xs text-tertiary">25%</span>
                    </div>
                    <div class="input-hint">Show monitor alert at this % decline from baseline</div>
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Review Threshold</label>
                    <input type="range" min="10" max="40" step="1" value="20" class="w-full" id="reviewThreshold">
                    <div class="flex justify-between mt-1">
                        <span class="text-xs text-tertiary">10%</span>
                        <span class="text-xs font-semibold" id="reviewThresholdValue">20%</span>
                        <span class="text-xs text-tertiary">40%</span>
                    </div>
                    <div class="input-hint">Show review alert at this % decline from baseline</div>
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Stability Visits</label>
                    <input type="number" min="2" max="10" step="1" value="4" class="text-input" id="stabilityVisits">
                    <div class="input-hint">Number of visits required to establish stability</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="resetProtocolBtn">
                    Reset Defaults
                </button>
                <button class="btn btn-primary" id="saveProtocolBtn">
                    Save Protocol
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="newPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Patient</div>
                <button class="modal-close" id="closeNewPatientModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Patient ID</label>
                    <input type="text" class="text-input" id="newPatientId" placeholder="PT001" autofocus>
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Transplant Date</label>
                    <input type="date" class="date-input" id="newTxDate">
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Initial Baseline FEVâ‚ (optional)</label>
                    <input type="number" step="0.01" class="text-input" id="newPatientBaseline" placeholder="3.20">
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Description (optional)</label>
                    <textarea class="clinical-notes-input" id="newPatientDesc" 
                              placeholder="e.g., Bilateral lung transplant, CF, age 42"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelNewPatientBtn">
                    Cancel
                </button>
                <button class="btn btn-primary" id="confirmNewPatientBtn">
                    Create Patient
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Export Data</div>
                <button class="modal-close" id="closeExportModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Export Format</label>
                    <div class="comparison-options">
                        <div class="comparison-option selected" data-format="pdf">
                            <div class="option-header">
                                <input type="radio" name="exportFormat" class="option-radio" value="pdf" checked>
                                <span class="option-title">PDF Report</span>
                            </div>
                            <div class="option-description">
                                Clinical report with charts and tables
                            </div>
                        </div>
                        <div class="comparison-option" data-format="csv">
                            <div class="option-header">
                                <input type="radio" name="exportFormat" class="option-radio" value="csv">
                                <span class="option-title">CSV Data</span>
                            </div>
                            <div class="option-description">
                                Spreadsheet-friendly data export
                            </div>
                        </div>
                        <div class="comparison-option" data-format="json">
                            <div class="option-header">
                                <input type="radio" name="exportFormat" class="option-radio" value="json">
                                <span class="option-title">JSON Backup</span>
                            </div>
                            <div class="option-description">
                                Complete backup of all data
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group mt-4">
                    <label class="input-label">Data Range</label>
                    <select class="text-input" id="exportRange">
                        <option value="current">Current Patient Only</option>
                        <option value="all">All Patients</option>
                        <option value="range">Date Range...</option>
                    </select>
                </div>
                
                <div class="input-group mt-4 hidden" id="dateRangeGroup">
                    <div class="measurement-grid">
                        <div>
                            <label class="input-label">From Date</label>
                            <input type="date" class="date-input" id="exportFromDate">
                        </div>
                        <div>
                            <label class="input-label">To Date</label>
                            <input type="date" class="date-input" id="exportToDate">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportBtn">
                    Cancel
                </button>
                <button class="btn btn-primary" id="confirmExportBtn">
                    Export Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // === COMPLETE SPIRALITE PROFESSIONAL IMPLEMENTATION ===
        
        class HistoryManager {
            constructor() {
                this.stack = [];
                this.index = -1;
                this.maxSize = 50;
            }
            
            push(state, action) {
                if (this.index < this.stack.length - 1) {
                    this.stack = this.stack.slice(0, this.index + 1);
                }
                
                this.stack.push({
                    state: JSON.parse(JSON.stringify(state)),
                    action,
                    timestamp: Date.now()
                });
                
                if (this.stack.length > this.maxSize) {
                    this.stack.shift();
                }
                
                this.index = this.stack.length - 1;
            }
            
            canUndo() { return this.index > 0; }
            canRedo() { return this.index < this.stack.length - 1; }
            
            undo() {
                if (this.canUndo()) {
                    this.index--;
                    return this.stack[this.index];
                }
                return null;
            }
            
            redo() {
                if (this.canRedo()) {
                    this.index++;
                    return this.stack[this.index];
                }
                return null;
            }
        }
        
        class SpiroliteApp {
            constructor() {
                this.state = {
                    mode: 'quick',
                    currentPatient: null,
                    patients: new Map(),
                    protocol: {
                        monitorThreshold: 10,
                        reviewThreshold: 20,
                        stabilityVisits: 4,
                        stabilityThreshold: 5
                    },
                    settings: {
                        colorBlindMode: false,
                        highContrastMode: false,
                        colorCoding: true,
                        percentageView: true,
                        language: 'en',
                        density: 'compact'
                    },
                    session: {
                        quick: {
                            baseline: null,
                            baselineSet: false,
                            comparison: 'none',
                            lastVisit: null
                        },
                        monitor: {
                            view: 'table',
                            entryMode: 'single',
                            visits: []
                        },
                        full: {
                            txDate: null,
                            baselineDate: null,
                            fev1: null,
                            baselineFev1: null
                        }
                    },
                    history: []
                };
                
                this.historyManager = new HistoryManager();
                this.dom = {};
                this.charts = {};
                this.isLoading = true;
                this.currentToastId = 0;
                
                // Initialize
                this.init();
            }
            
            async init() {
                console.log('ðŸš€ Initializing Spirolite Professional...');
                this.showLoading('Loading Spirolite Professional', 0);
                
                try {
                    await this.cacheDOM();
                    this.setupEventListeners();
                    this.loadState();
                    this.initializeUI();
                    this.setupCharts();
                    
                    // Simulate loading
                    await this.simulateLoading();
                    
                    this.hideLoading();
                    this.showToast('Spirolite Professional ready', 'success');
                    this.isLoading = false;
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Initialization failed', 'error');
                }
            }
            
            async cacheDOM() {
                // Core elements
                this.dom = {
                    loadingOverlay: document.getElementById('loadingOverlay'),
                    appContainer: document.getElementById('appContainer'),
                    mainContent: document.getElementById('mainContent'),
                    
                    // Header elements
                    undoBtn: document.getElementById('undoBtn'),
                    redoBtn: document.getElementById('redoBtn'),
                    protocolBtn: document.getElementById('protocolBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    
                    // Patient bar
                    patientBar: document.getElementById('patientBar'),
                    patientAvatar: document.getElementById('patientAvatar'),
                    patientId: document.getElementById('patientId'),
                    patientStatus: document.getElementById('patientStatus'),
                    visitCount: document.getElementById('visitCount'),
                    txIndicator: document.getElementById('txIndicator'),
                    txDateText: document.getElementById('txDateText'),
                    newPatientBtn: document.getElementById('newPatientBtn'),
                    patientListBtn: document.getElementById('patientListBtn'),
                    
                    // Navigation
                    navBtns: document.querySelectorAll('.nav-btn'),
                    
                    // Quick Mode
                    baselineInput: document.getElementById('baselineInput'),
                    baselineValueDisplay: document.getElementById('baselineValueDisplay'),
                    baselineActionBtn: document.getElementById('baselineActionBtn'),
                    baselineProgress: document.getElementById('baselineProgress'),
                    baselineHint: document.getElementById('baselineHint'),
                    
                    inputFev1: document.getElementById('inputFev1'),
                    inputFvc: document.getElementById('inputFvc'),
                    measurementDate: document.getElementById('measurementDate'),
                    
                    comparisonOptions: document.querySelectorAll('.comparison-option'),
                    
                    resultsPanel: document.getElementById('resultsPanel'),
                    resultFev1: document.getElementById('resultFev1'),
                    resultFvc: document.getElementById('resultFvc'),
                    resultRatio: document.getElementById('resultRatio'),
                    resultsTimestamp: document.getElementById('resultsTimestamp'),
                    resultFev1Percent: document.getElementById('resultFev1Percent'),
                    fev1PercentBadge: document.getElementById('fev1PercentBadge'),
                    
                    calculateBtn: document.getElementById('calculateBtn'),
                    clearQuickBtn: document.getElementById('clearQuickBtn'),
                    
                    // Monitor Mode
                    monitorControls: document.querySelector('.monitor-controls'),
                    viewToggleBtns: document.querySelectorAll('.view-toggle-btn'),
                    densityBtns: document.querySelectorAll('.density-btn'),
                    
                    entryModeSelector: document.getElementById('entryModeSelector'),
                    entryModeCards: document.querySelectorAll('.entry-mode-card'),
                    
                    singleEntryForm: document.getElementById('singleEntryForm'),
                    bulkEntryForm: document.getElementById('bulkEntryForm'),
                    spreadsheetEntryForm: document.getElementById('spreadsheetEntryForm'),
                    
                    visitDate: document.getElementById('visitDate'),
                    visitFev1: document.getElementById('visitFev1'),
                    visitFvc: document.getElementById('visitFvc'),
                    visitNotes: document.getElementById('visitNotes'),
                    addVisitBtn: document.getElementById('addVisitBtn'),
                    
                    bulkImport: document.getElementById('bulkImport'),
                    importBulkBtn: document.getElementById('importBulkBtn'),
                    
                    spreadsheetBody: document.getElementById('spreadsheetBody'),
                    addSpreadsheetRowBtn: document.getElementById('addSpreadsheetRowBtn'),
                    saveSpreadsheetBtn: document.getElementById('saveSpreadsheetBtn'),
                    
                    visitsTable: document.getElementById('visitsTable'),
                    visitsTableBody: document.getElementById('visitsTableBody'),
                    visitsTableContainer: document.getElementById('visitsTableContainer'),
                    
                    tableView: document.getElementById('tableView'),
                    timelineView: document.getElementById('timelineView'),
                    chartView: document.getElementById('chartView'),
                    
                    timelineChart: document.getElementById('timelineChart'),
                    fev1Chart: document.getElementById('fev1Chart'),
                    
                    clearMonitorBtn: document.getElementById('clearMonitorBtn'),
                    exportPDFBtn: document.getElementById('exportPDFBtn'),
                    
                    // Full Study Mode
                    txDate: document.getElementById('txDate'),
                    baselineDate: document.getElementById('baselineDate'),
                    stdFev1: document.getElementById('stdFev1'),
                    stdBaselineFev1: document.getElementById('stdBaselineFev1'),
                    clinicalNotes: document.getElementById('clinicalNotes'),
                    
                    stdResultsPanel: document.getElementById('stdResultsPanel'),
                    stdCurrentFev1: document.getElementById('stdCurrentFev1'),
                    stdBaseline: document.getElementById('stdBaseline'),
                    stdTimePeriod: document.getElementById('stdTimePeriod'),
                    stdCurrentPercent: document.getElementById('stdCurrentPercent'),
                    stdCurrentBadge: document.getElementById('stdCurrentBadge'),
                    stdCumulativeDelta: document.getElementById('stdCumulativeDelta'),
                    stdPercentDecline: document.getElementById('stdPercentDecline'),
                    stdMonthlyRate: document.getElementById('stdMonthlyRate'),
                    stdResultsTimestamp: document.getElementById('stdResultsTimestamp'),
                    
                    clearStdBtn: document.getElementById('clearStdBtn'),
                    saveStudyBtn: document.getElementById('saveStudyBtn'),
                    
                    // Patients Mode
                    createPatientBtn: document.getElementById('createPatientBtn'),
                    patientsTableBody: document.getElementById('patientsTableBody'),
                    importPatientsBtn: document.getElementById('importPatientsBtn'),
                    exportPatientsBtn: document.getElementById('exportPatientsBtn'),
                    
                    // Modals
                    protocolModal: document.getElementById('protocolModal'),
                    newPatientModal: document.getElementById('newPatientModal'),
                    exportModal: document.getElementById('exportModal'),
                    
                    // Modal buttons
                    closeProtocolModal: document.getElementById('closeProtocolModal'),
                    closeNewPatientModal: document.getElementById('closeNewPatientModal'),
                    closeExportModal: document.getElementById('closeExportModal'),
                    
                    monitorThreshold: document.getElementById('monitorThreshold'),
                    monitorThresholdValue: document.getElementById('monitorThresholdValue'),
                    reviewThreshold: document.getElementById('reviewThreshold'),
                    reviewThresholdValue: document.getElementById('reviewThresholdValue'),
                    stabilityVisits: document.getElementById('stabilityVisits'),
                    
                    resetProtocolBtn: document.getElementById('resetProtocolBtn'),
                    saveProtocolBtn: document.getElementById('saveProtocolBtn'),
                    
                    newPatientId: document.getElementById('newPatientId'),
                    newTxDate: document.getElementById('newTxDate'),
                    newPatientBaseline: document.getElementById('newPatientBaseline'),
                    newPatientDesc: document.getElementById('newPatientDesc'),
                    
                    cancelNewPatientBtn: document.getElementById('cancelNewPatientBtn'),
                    confirmNewPatientBtn: document.getElementById('confirmNewPatientBtn'),
                    
                    exportRange: document.getElementById('exportRange'),
                    exportFromDate: document.getElementById('exportFromDate'),
                    exportToDate: document.getElementById('exportToDate'),
                    dateRangeGroup: document.getElementById('dateRangeGroup'),
                    cancelExportBtn: document.getElementById('cancelExportBtn'),
                    confirmExportBtn: document.getElementById('confirmExportBtn'),
                    
                    // FABs
                    fabContainer: document.getElementById('fabContainer'),
                    newVisitFab: document.getElementById('newVisitFab'),
                    quickCalcFab: document.getElementById('quickCalcFab'),
                    
                    // Accessibility
                    accessibilityControls: document.getElementById('accessibilityControls'),
                    colorBlindBtn: document.getElementById('colorBlindBtn'),
                    highContrastBtn: document.getElementById('highContrastBtn'),
                    
                    // Toast
                    toastContainer: document.getElementById('toastContainer')
                };
                
                console.log('âœ… DOM elements cached');
            }
            
            setupEventListeners() {
                // Header actions
                this.dom.undoBtn.addEventListener('click', () => this.handleUndo());
                this.dom.redoBtn.addEventListener('click', () => this.handleRedo());
                this.dom.protocolBtn.addEventListener('click', () => this.showProtocolModal());
                this.dom.exportBtn.addEventListener('click', () => this.showExportModal());
                
                // Patient actions
                this.dom.newPatientBtn.addEventListener('click', () => this.showNewPatientModal());
                this.dom.patientListBtn.addEventListener('click', () => this.switchMode('patients'));
                
                // Navigation
                this.dom.navBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
                });
                
                // Quick Mode
                this.dom.baselineInput.addEventListener('input', () => this.handleBaselineInput());
                this.dom.baselineActionBtn.addEventListener('click', () => this.setBaseline());
                this.dom.inputFev1.addEventListener('input', () => this.validateQuickInputs());
                this.dom.inputFvc.addEventListener('input', () => this.validateQuickInputs());
                
                this.dom.calculateBtn.addEventListener('click', () => this.calculateQuick());
                this.dom.clearQuickBtn.addEventListener('click', () => this.clearQuick());
                
                // Comparison options
                this.dom.comparisonOptions.forEach(option => {
                    option.addEventListener('click', () => this.selectComparisonOption(option));
                });
                
                // Monitor Mode
                this.dom.viewToggleBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.switchMonitorView(btn.dataset.view));
                });
                
                this.dom.densityBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.setTableDensity(btn.dataset.density));
                });
                
                this.dom.entryModeCards.forEach(card => {
                    card.addEventListener('click', () => this.switchEntryMode(card.dataset.mode));
                });
                
                this.dom.addVisitBtn.addEventListener('click', () => this.addVisit());
                this.dom.importBulkBtn.addEventListener('click', () => this.importBulk());
                this.dom.addSpreadsheetRowBtn.addEventListener('click', () => this.addSpreadsheetRow());
                this.dom.saveSpreadsheetBtn.addEventListener('click', () => this.saveSpreadsheet());
                this.dom.clearMonitorBtn.addEventListener('click', () => this.clearMonitor());
                this.dom.exportPDFBtn.addEventListener('click', () => this.exportPDF());
                
                // Full Study Mode
                this.dom.saveStudyBtn.addEventListener('click', () => this.saveFullStudy());
                this.dom.clearStdBtn.addEventListener('click', () => this.clearFullStudy());
                
                // Patients Mode
                this.dom.createPatientBtn.addEventListener('click', () => this.showNewPatientModal());
                this.dom.importPatientsBtn.addEventListener('click', () => this.importPatients());
                this.dom.exportPatientsBtn.addEventListener('click', () => this.showExportModal());
                
                // Date shortcuts
                document.querySelectorAll('.date-shortcut').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const offset = parseInt(e.target.dataset.offset);
                        this.setDateShortcut(offset);
                    });
                });
                
                // Modal controls
                this.dom.closeProtocolModal.addEventListener('click', () => this.hideProtocolModal());
                this.dom.closeNewPatientModal.addEventListener('click', () => this.hideNewPatientModal());
                this.dom.closeExportModal.addEventListener('click', () => this.hideExportModal());
                
                this.dom.monitorThreshold.addEventListener('input', (e) => {
                    this.dom.monitorThresholdValue.textContent = `${e.target.value}%`;
                });
                
                this.dom.reviewThreshold.addEventListener('input', (e) => {
                    this.dom.reviewThresholdValue.textContent = `${e.target.value}%`;
                });
                
                this.dom.resetProtocolBtn.addEventListener('click', () => this.resetProtocol());
                this.dom.saveProtocolBtn.addEventListener('click', () => this.saveProtocol());
                
                this.dom.cancelNewPatientBtn.addEventListener('click', () => this.hideNewPatientModal());
                this.dom.confirmNewPatientBtn.addEventListener('click', () => this.createPatient());
                
                this.dom.exportRange.addEventListener('change', (e) => {
                    this.dom.dateRangeGroup.classList.toggle('hidden', e.target.value !== 'range');
                });
                
                this.dom.cancelExportBtn.addEventListener('click', () => this.hideExportModal());
                this.dom.confirmExportBtn.addEventListener('click', () => this.exportData());
                
                // FABs
                this.dom.newVisitFab.addEventListener('click', () => this.handleNewVisitFab());
                this.dom.quickCalcFab.addEventListener('click', () => this.handleQuickCalcFab());
                
                // Accessibility
                this.dom.colorBlindBtn.addEventListener('click', () => this.toggleColorBlindMode());
                this.dom.highContrastBtn.addEventListener('click', () => this.toggleHighContrastMode());
                
                // Modal overlay clicks
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
                
                // Window resize
                window.addEventListener('resize', () => this.handleResize());
                
                console.log('âœ… Event listeners set up');
            }
            
            initializeUI() {
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                if (this.dom.measurementDate) this.dom.measurementDate.value = today;
                if (this.dom.visitDate) this.dom.visitDate.value = today;
                if (this.dom.txDate) this.dom.txDate.value = today;
                if (this.dom.baselineDate) this.dom.baselineDate.value = today;
                if (this.dom.newTxDate) this.dom.newTxDate.value = today;
                if (this.dom.exportFromDate) this.dom.exportFromDate.value = today;
                if (this.dom.exportToDate) this.dom.exportToDate.value = today;
                
                // Load protocol values
                this.dom.monitorThreshold.value = this.state.protocol.monitorThreshold;
                this.dom.monitorThresholdValue.textContent = `${this.state.protocol.monitorThreshold}%`;
                this.dom.reviewThreshold.value = this.state.protocol.reviewThreshold;
                this.dom.reviewThresholdValue.textContent = `${this.state.protocol.reviewThreshold}%`;
                this.dom.stabilityVisits.value = this.state.protocol.stabilityVisits;
                
                // Initialize baseline progress
                this.dom.baselineProgress.style.width = '0%';
                
                // Update UI based on settings
                this.updateAccessibilityUI();
                
                console.log('âœ… UI initialized');
            }
            
            setupCharts() {
                // Initialize chart contexts
                this.charts = {
                    timeline: null,
                    fev1: null
                };
                
                console.log('âœ… Charts initialized');
            }
            
            async simulateLoading() {
                const steps = [
                    { text: 'Loading application core...', percent: 25 },
                    { text: 'Preparing clinical tools...', percent: 50 },
                    { text: 'Configuring calculations...', percent: 75 },
                    { text: 'Initializing interface...', percent: 100 }
                ];
                
                for (const step of steps) {
                    this.updateLoading(step.text, step.percent);
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
            
            showLoading(text, percent) {
                const loadingStep = document.getElementById('loadingStep');
                const loadingPercent = document.getElementById('loadingPercent');
                const loadingProgressBar = document.getElementById('loadingProgressBar');
                
                if (loadingStep) loadingStep.textContent = text;
                if (loadingPercent) loadingPercent.textContent = `${percent}%`;
                if (loadingProgressBar) loadingProgressBar.style.width = `${percent}%`;
                
                if (this.dom.loadingOverlay) {
                    this.dom.loadingOverlay.style.display = 'flex';
                }
            }
            
            updateLoading(text, percent) {
                this.showLoading(text, percent);
            }
            
            hideLoading() {
                if (this.dom.loadingOverlay) {
                    this.dom.loadingOverlay.classList.add('fade-out');
                    setTimeout(() => {
                        this.dom.loadingOverlay.style.display = 'none';
                    }, 500);
                }
            }
            
            // === QUICK MODE FUNCTIONS ===
            
            handleBaselineInput() {
                const value = this.dom.baselineInput.value;
                const numValue = parseFloat(value);
                const isValid = !isNaN(numValue) && numValue >= 0.5 && numValue <= 8.0;
                
                if (value && isValid) {
                    // Update progress bar
                    const progress = Math.min((value.length / 4) * 100, 100);
                    this.dom.baselineProgress.style.width = `${progress}%`;
                    
                    // Update button state
                    this.dom.baselineActionBtn.disabled = false;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn ready';
                    this.dom.baselineActionBtn.textContent = 'Set';
                    
                    // Update hint
                    this.dom.baselineHint.textContent = `Ready to set baseline: ${numValue.toFixed(2)} L`;
                    this.dom.baselineHint.style.color = 'var(--primary)';
                } else if (value && !isValid) {
                    this.dom.baselineActionBtn.disabled = true;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn';
                    this.dom.baselineHint.textContent = 'Please enter a value between 0.5 and 8.0 L';
                    this.dom.baselineHint.style.color = 'var(--error)';
                } else {
                    this.dom.baselineActionBtn.disabled = true;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn';
                    this.dom.baselineProgress.style.width = '0%';
                    this.dom.baselineHint.textContent = 'Baseline value is required for percentage calculations';
                    this.dom.baselineHint.style.color = 'var(--text-tertiary)';
                }
            }
            
            setBaseline() {
                const value = parseFloat(this.dom.baselineInput.value);
                
                if (isNaN(value) || value < 0.5 || value > 8.0) {
                    this.showToast('Please enter a valid baseline value (0.5-8.0 L)', 'error');
                    return;
                }
                
                // Save baseline
                this.state.session.quick.baseline = value;
                this.state.session.quick.baselineSet = true;
                
                // Update display
                this.dom.baselineValueDisplay.textContent = `${value.toFixed(2)} L`;
                
                // Update button to success state
                this.dom.baselineActionBtn.className = 'baseline-action-btn success';
                this.dom.baselineActionBtn.textContent = 'Set';
                this.dom.baselineActionBtn.disabled = true;
                
                // Update progress bar
                this.dom.baselineProgress.style.width = '100%';
                this.dom.baselineProgress.classList.add('success');
                
                // Update hint
                this.dom.baselineHint.textContent = `Baseline set at ${value.toFixed(2)} L`;
                this.dom.baselineHint.style.color = 'var(--success)';
                
                // Show success toast
                this.showToast(`Baseline set to ${value.toFixed(2)} L`, 'success');
                
                // Enable calculation if FEV1 is entered
                this.validateQuickInputs();
                
                // Save state
                this.saveState();
                
                // Reset success state after 3 seconds
                setTimeout(() => {
                    this.dom.baselineActionBtn.disabled = false;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn ready';
                    this.dom.baselineActionBtn.textContent = 'Update';
                    this.dom.baselineProgress.classList.remove('success');
                }, 3000);
                
                // Push to history
                this.historyManager.push(this.state, 'Baseline set');
                this.updateUndoRedoButtons();
            }
            
            validateQuickInputs() {
                const fev1 = this.dom.inputFev1.value;
                const baselineSet = this.state.session.quick.baselineSet;
                const fev1Valid = fev1 && !isNaN(parseFloat(fev1)) && parseFloat(fev1) >= 0.5;
                
                // Enable calculate button if baseline is set and FEV1 is valid
                this.dom.calculateBtn.disabled = !(baselineSet && fev1Valid);
                
                return fev1Valid && baselineSet;
            }
            
            selectComparisonOption(option) {
                // Remove selected class from all options
                this.dom.comparisonOptions.forEach(opt => {
                    opt.classList.remove('selected');
                    const radio = opt.querySelector('.option-radio');
                    if (radio) radio.checked = false;
                });
                
                // Add selected class to clicked option
                option.classList.add('selected');
                const radio = option.querySelector('.option-radio');
                if (radio) {
                    radio.checked = true;
                    this.state.session.quick.comparison = radio.value;
                }
            }
            
            calculateQuick() {
                if (!this.validateQuickInputs()) {
                    this.showToast('Please set baseline and enter current FEVâ‚', 'error');
                    return;
                }
                
                const fev1 = parseFloat(this.dom.inputFev1.value);
                const fvc = this.dom.inputFvc.value ? parseFloat(this.dom.inputFvc.value) : null;
                const baseline = this.state.session.quick.baseline;
                
                // Calculate percentages
                const fev1Percent = ((fev1 / baseline) * 100).toFixed(1);
                
                // Determine status
                let statusClass = 'neutral';
                let statusText = '--';
                
                if (fev1Percent >= 90) {
                    statusClass = 'good';
                    statusText = 'Normal';
                } else if (fev1Percent >= 80) {
                    statusClass = 'warning';
                    statusText = 'Mild';
                } else if (fev1Percent >= 70) {
                    statusClass = 'warning';
                    statusText = 'Moderate';
                } else {
                    statusClass = 'alert';
                    statusText = 'Severe';
                }
                
                // Update results
                this.dom.resultFev1.textContent = fev1.toFixed(2);
                this.dom.resultFev1Percent.textContent = `${fev1Percent}%`;
                this.dom.fev1PercentBadge.textContent = statusText;
                this.dom.fev1PercentBadge.className = `percent-display ${statusClass}`;
                
                // Update FVC if available
                if (fvc) {
                    this.dom.resultFvc.textContent = fvc.toFixed(2);
                    const ratio = ((fev1 / fvc) * 100).toFixed(1);
                    this.dom.resultRatio.textContent = `${ratio}%`;
                } else {
                    this.dom.resultFvc.textContent = '--';
                    this.dom.resultRatio.textContent = '--';
                }
                
                // Update timestamp
                const now = new Date();
                this.dom.resultsTimestamp.textContent = 
                    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Show results
                this.dom.resultsPanel.classList.add('visible');
                
                // Scroll to results
                this.dom.resultsPanel.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                // Update protocol context
                this.updateProtocolContext(fev1Percent);
                
                this.showToast('Calculation complete', 'success');
                this.saveState();
                
                // Push to history
                this.historyManager.push(this.state, 'Quick calculation');
                this.updateUndoRedoButtons();
            }
            
            updateProtocolContext(percent) {
                const monitorThreshold = this.state.protocol.monitorThreshold;
                const reviewThreshold = this.state.protocol.reviewThreshold;
                
                let note = '';
                if (percent >= 100 - reviewThreshold) {
                    note = `Significant decline (â‰¥${reviewThreshold}%) - Clinical review recommended`;
                } else if (percent >= 100 - monitorThreshold) {
                    note = `Moderate decline (â‰¥${monitorThreshold}%) - Monitor closely`;
                } else {
                    note = 'Within normal limits - Continue routine monitoring';
                }
                
                const protocolNote = document.getElementById('protocolNote');
                if (protocolNote) {
                    protocolNote.textContent = note;
                }
                
                // Update threshold display
                const monitorValue = document.getElementById('thresholdMonitorValue');
                const reviewValue = document.getElementById('thresholdReviewValue');
                if (monitorValue) monitorValue.textContent = monitorThreshold;
                if (reviewValue) reviewValue.textContent = reviewThreshold;
            }
            
            clearQuick() {
                // Clear inputs but keep baseline
                this.dom.inputFev1.value = '';
                this.dom.inputFvc.value = '';
                this.dom.measurementDate.value = new Date().toISOString().split('T')[0];
                
                // Hide results
                this.dom.resultsPanel.classList.remove('visible');
                
                // Focus on FEV1 input
                this.dom.inputFev1.focus();
                
                this.showToast('Calculator cleared', 'info');
            }
            
            // === MONITOR MODE FUNCTIONS ===
            
            switchMonitorView(view) {
                // Update toggle buttons
                this.dom.viewToggleBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                
                // Hide all views
                this.dom.tableView.classList.add('hidden');
                this.dom.timelineView.classList.add('hidden');
                this.dom.chartView.classList.add('hidden');
                
                // Show selected view
                if (view === 'table') {
                    this.dom.tableView.classList.remove('hidden');
                } else if (view === 'timeline') {
                    this.dom.timelineView.classList.remove('hidden');
                    this.renderTimelineChart();
                } else if (view === 'chart') {
                    this.dom.chartView.classList.remove('hidden');
                    this.renderFev1Chart();
                }
                
                this.state.session.monitor.view = view;
            }
            
            setTableDensity(density) {
                // Update density buttons
                this.dom.densityBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.density === density);
                });
                
                // Update table class
                this.dom.visitsTableContainer.className = `table-container table-density-${density}`;
                
                this.state.settings.density = density;
                this.saveState();
            }
            
            switchEntryMode(mode) {
                // Update entry mode cards
                this.dom.entryModeCards.forEach(card => {
                    card.classList.toggle('active', card.dataset.mode === mode);
                });
                
                // Hide all forms
                this.dom.singleEntryForm.classList.add('hidden');
                this.dom.bulkEntryForm.classList.add('hidden');
                this.dom.spreadsheetEntryForm.classList.add('hidden');
                
                // Show selected form
                if (mode === 'single') {
                    this.dom.singleEntryForm.classList.remove('hidden');
                } else if (mode === 'bulk') {
                    this.dom.bulkEntryForm.classList.remove('hidden');
                } else if (mode === 'spreadsheet') {
                    this.dom.spreadsheetEntryForm.classList.remove('hidden');
                }
                
                this.state.session.monitor.entryMode = mode;
            }
            
            addVisit() {
                const date = this.dom.visitDate.value;
                const fev1 = parseFloat(this.dom.visitFev1.value);
                
                if (!date || !fev1 || isNaN(fev1)) {
                    this.showToast('Please enter a valid date and FEVâ‚', 'error');
                    return;
                }
                
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                const visit = {
                    id: `visit_${Date.now()}`,
                    date,
                    fev1,
                    fvc: this.dom.visitFvc.value ? parseFloat(this.dom.visitFvc.value) : null,
                    notes: this.dom.visitNotes.value.trim(),
                    timestamp: Date.now()
                };
                
                // Add to patient's visits
                if (!patient.visits) patient.visits = [];
                patient.visits.push(visit);
                
                // Sort visits by date
                patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Clear form
                this.dom.visitFev1.value = '';
                this.dom.visitFvc.value = '';
                this.dom.visitNotes.value = '';
                
                // Save patient
                this.state.patients.set(patient.id, patient);
                this.saveState();
                
                // Update UI
                this.updatePatientVisitsTable();
                this.updatePatientInfo();
                
                this.showToast('Visit added successfully', 'success');
                
                // Push to history
                this.historyManager.push(this.state, 'Visit added');
                this.updateUndoRedoButtons();
            }
            
            importBulk() {
                const text = this.dom.bulkImport.value.trim();
                if (!text) {
                    this.showToast('Please enter data to import', 'error');
                    return;
                }
                
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                const lines = text.split('\n');
                let importedCount = 0;
                let errorCount = 0;
                
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed.startsWith('#')) continue;
                    
                    const parts = trimmed.split(',').map(part => part.trim());
                    if (parts.length < 2) {
                        errorCount++;
                        continue;
                    }
                    
                    const date = parts[0];
                    const fev1 = parseFloat(parts[1]);
                    const fvc = parts[2] ? parseFloat(parts[2]) : null;
                    const notes = parts[3] || '';
                    
                    if (!date || isNaN(fev1)) {
                        errorCount++;
                        continue;
                    }
                    
                    const visit = {
                        id: `visit_${Date.now()}_${importedCount}`,
                        date,
                        fev1,
                        fvc,
                        notes,
                        timestamp: Date.now()
                    };
                    
                    if (!patient.visits) patient.visits = [];
                    patient.visits.push(visit);
                    importedCount++;
                }
                
                // Sort visits by date
                patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Save patient
                this.state.patients.set(patient.id, patient);
                this.saveState();
                
                // Update UI
                this.updatePatientVisitsTable();
                this.updatePatientInfo();
                
                // Clear textarea
                this.dom.bulkImport.value = '';
                
                // Show result
                let message = `Imported ${importedCount} visits`;
                if (errorCount > 0) {
                    message += `, ${errorCount} errors`;
                }
                this.showToast(message, importedCount > 0 ? 'success' : 'warning');
                
                // Push to history
                this.historyManager.push(this.state, 'Bulk import');
                this.updateUndoRedoButtons();
            }
            
            addSpreadsheetRow() {
                const tbody = this.dom.spreadsheetBody;
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="editable-cell" contenteditable="true" data-field="date"></td>
                    <td class="editable-cell" contenteditable="true" data-field="fev1"></td>
                    <td class="editable-cell" contenteditable="true" data-field="fvc"></td>
                    <td class="editable-cell" contenteditable="true" data-field="notes"></td>
                `;
                tbody.appendChild(newRow);
                
                // Focus on first cell of new row
                const firstCell = newRow.querySelector('.editable-cell');
                if (firstCell) firstCell.focus();
            }
            
            saveSpreadsheet() {
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                const rows = this.dom.spreadsheetBody.querySelectorAll('tr');
                let savedCount = 0;
                let errorCount = 0;
                
                // Clear existing visits
                patient.visits = [];
                
                for (const row of rows) {
                    const cells = row.querySelectorAll('.editable-cell');
                    if (cells.length < 4) continue;
                    
                    const date = cells[0].textContent.trim();
                    const fev1 = parseFloat(cells[1].textContent);
                    const fvc = cells[2].textContent.trim() ? parseFloat(cells[2].textContent) : null;
                    const notes = cells[3].textContent.trim();
                    
                    if (!date || isNaN(fev1)) {
                        errorCount++;
                        continue;
                    }
                    
                    const visit = {
                        id: `visit_${Date.now()}_${savedCount}`,
                        date,
                        fev1,
                        fvc,
                        notes,
                        timestamp: Date.now()
                    };
                    
                    patient.visits.push(visit);
                    savedCount++;
                }
                
                // Sort visits by date
                patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Save patient
                this.state.patients.set(patient.id, patient);
                this.saveState();
                
                // Update UI
                this.updatePatientVisitsTable();
                this.updatePatientInfo();
                
                // Show result
                let message = `Saved ${savedCount} visits`;
                if (errorCount > 0) {
                    message += `, ${errorCount} invalid rows`;
                }
                this.showToast(message, savedCount > 0 ? 'success' : 'warning');
                
                // Push to history
                this.historyManager.push(this.state, 'Spreadsheet save');
                this.updateUndoRedoButtons();
            }
            
            updatePatientVisitsTable() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) {
                    this.dom.visitsTableBody.innerHTML = `
                        <tr>
                            <td colspan="11" class="text-center p-4 text-secondary">
                                No visits yet. Add visits using the form above.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                let html = '';
                
                patient.visits.forEach((visit, index) => {
                    const prevVisit = index > 0 ? patient.visits[index - 1] : null;
                    
                    // Calculate metrics
                    const fev1 = visit.fev1.toFixed(2);
                    const fvc = visit.fvc ? visit.fvc.toFixed(2) : '--';
                    const ratio = visit.fvc ? ((visit.fev1 / visit.fvc) * 100).toFixed(1) + '%' : '--';
                    
                    let baselinePercent = '--';
                    let baselineDelta = '--';
                    if (baseline) {
                        const percent = ((visit.fev1 / baseline) * 100).toFixed(1);
                        baselinePercent = `${percent}%`;
                        baselineDelta = (visit.fev1 - baseline).toFixed(2);
                    }
                    
                    let visitDelta = '--';
                    let visitPercent = '--';
                    let trendArrow = 'â†’';
                    let trendClass = 'neutral';
                    
                    if (prevVisit) {
                        const delta = visit.fev1 - prevVisit.fev1;
                        const percent = ((delta / prevVisit.fev1) * 100).toFixed(1);
                        visitDelta = delta.toFixed(2);
                        visitPercent = `${percent}%`;
                        
                        if (delta > 0.05) {
                            trendArrow = 'â†‘';
                            trendClass = 'up';
                        } else if (delta < -0.05) {
                            trendArrow = 'â†“';
                            trendClass = 'down';
                        }
                    }
                    
                    // Calculate days since TX
                    const visitDate = new Date(visit.date);
                    const txDate = patient.txDate ? new Date(patient.txDate) : null;
                    const daysSinceTx = txDate ? Math.floor((visitDate - txDate) / (1000 * 60 * 60 * 24)) : '--';
                    
                    // Determine alert status
                    let alertClass = 'stable';
                    let alertText = 'Stable';
                    
                    if (baseline) {
                        const declinePercent = 100 - ((visit.fev1 / baseline) * 100);
                        if (declinePercent >= this.state.protocol.reviewThreshold) {
                            alertClass = 'review';
                            alertText = 'Review';
                        } else if (declinePercent >= this.state.protocol.monitorThreshold) {
                            alertClass = 'monitor';
                            alertText = 'Monitor';
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${visit.date}</td>
                            <td>${daysSinceTx}</td>
                            <td>${fev1}</td>
                            <td>${baselinePercent}</td>
                            <td>${fvc}</td>
                            <td>${ratio}</td>
                            <td>
                                <span class="trend-arrow ${trendClass}">${trendArrow}</span>
                                ${visitDelta}
                            </td>
                            <td>${baselineDelta}</td>
                            <td>${visitPercent}</td>
                            <td>
                                <span class="alert-cell ${alertClass}">${alertText}</span>
                            </td>
                            <td title="${visit.notes || 'No notes'}">
                                ${visit.notes ? 'ðŸ“' : ''}
                            </td>
                        </tr>
                    `;
                });
                
                this.dom.visitsTableBody.innerHTML = html;
            }
            
            renderTimelineChart() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) return;
                
                const ctx = this.dom.timelineChart.getContext('2d');
                
                // Destroy existing chart
                if (this.charts.timeline) {
                    this.charts.timeline.destroy();
                }
                
                // Prepare data
                const labels = patient.visits.map(v => v.date);
                const fev1Data = patient.visits.map(v => v.fev1);
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                
                // Create chart
                this.charts.timeline = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'FEVâ‚ (L)',
                                data: fev1Data,
                                borderColor: 'var(--chart-primary)',
                                backgroundColor: 'rgba(26, 95, 122, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.3
                            },
                            baseline ? {
                                label: 'Baseline',
                                data: Array(labels.length).fill(baseline),
                                borderColor: 'var(--chart-success)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                fill: false
                            } : null
                        ].filter(Boolean)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'FEVâ‚ (L)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
                
                // Update timeline summary
                this.updateTimelineSummary();
            }
            
            renderFev1Chart() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) return;
                
                const ctx = this.dom.fev1Chart.getContext('2d');
                
                // Destroy existing chart
                if (this.charts.fev1) {
                    this.charts.fev1.destroy();
                }
                
                // Prepare data
                const visits = patient.visits;
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                
                // Calculate percentages
                const percentages = visits.map(v => {
                    return baseline ? ((v.fev1 / baseline) * 100).toFixed(1) : null;
                }).filter(Boolean);
                
                // Create chart
                this.charts.fev1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: visits.map(v => v.date),
                        datasets: [
                            {
                                label: '% of Baseline',
                                data: percentages,
                                backgroundColor: percentages.map(p => {
                                    const percent = parseFloat(p);
                                    if (percent >= 90) return 'rgba(16, 185, 129, 0.7)';
                                    if (percent >= 80) return 'rgba(245, 158, 11, 0.7)';
                                    return 'rgba(239, 68, 68, 0.7)';
                                }),
                                borderColor: percentages.map(p => {
                                    const percent = parseFloat(p);
                                    if (percent >= 90) return 'rgb(16, 185, 129)';
                                    if (percent >= 80) return 'rgb(245, 158, 11)';
                                    return 'rgb(239, 68, 68)';
                                }),
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '% of Baseline'
                                },
                                min: 50,
                                max: 120
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            }
            
            updateTimelineSummary() {
                if (!this.state.currentPatient) return;
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) return;
                
                const visits = patient.visits;
                const totalVisits = visits.length;
                
                // Calculate time span
                const firstDate = new Date(visits[0].date);
                const lastDate = new Date(visits[visits.length - 1].date);
                const timeSpanDays = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
                const timeSpanText = timeSpanDays < 30 ? `${timeSpanDays} days` : `${Math.floor(timeSpanDays / 30)} months`;
                
                // Calculate average interval
                let totalInterval = 0;
                for (let i = 1; i < visits.length; i++) {
                    const prevDate = new Date(visits[i - 1].date);
                    const currDate = new Date(visits[i].date);
                    totalInterval += Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
                }
                const avgInterval = totalVisits > 1 ? Math.floor(totalInterval / (totalVisits - 1)) : 0;
                const avgIntervalText = avgInterval < 30 ? `${avgInterval} days` : `${Math.floor(avgInterval / 30)} months`;
                
                // Determine current status
                const lastVisit = visits[visits.length - 1];
                const baseline = patient.baselineFev1 || this.state.session.quick.baseline;
                let status = 'No baseline';
                let statusClass = 'text-tertiary';
                
                if (baseline) {
                    const percent = ((lastVisit.fev1 / baseline) * 100).toFixed(1);
                    if (percent >= 90) {
                        status = 'Stable';
                        statusClass = 'text-success';
                    } else if (percent >= 80) {
                        status = 'Monitoring';
                        statusClass = 'text-warning';
                    } else {
                        status = 'Review Needed';
                        statusClass = 'text-error';
                    }
                    status = `${status} (${percent}%)`;
                }
                
                // Update elements
                const totalVisitsEl = document.getElementById('timelineTotalVisits');
                const timeSpanEl = document.getElementById('timelineTimeSpan');
                const statusEl = document.getElementById('timelineStatus');
                
                if (totalVisitsEl) totalVisitsEl.textContent = totalVisits;
                if (timeSpanEl) timeSpanEl.textContent = timeSpanText;
                if (statusEl) {
                    statusEl.textContent = status;
                    statusEl.className = `font-semibold ${statusClass}`;
                }
            }
            
            clearMonitor() {
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                if (!patient.visits || patient.visits.length === 0) {
                    this.showToast('No visits to clear', 'info');
                    return;
                }
                
                if (confirm(`Clear all ${patient.visits.length} visits for ${patient.id}?`)) {
                    patient.visits = [];
                    this.state.patients.set(patient.id, patient);
                    this.saveState();
                    
                    this.updatePatientVisitsTable();
                    this.updatePatientInfo();
                    
                    this.showToast('All visits cleared', 'success');
                    
                    // Push to history
                    this.historyManager.push(this.state, 'Monitor cleared');
                    this.updateUndoRedoButtons();
                }
            }
            
            // === FULL STUDY MODE FUNCTIONS ===
            
            saveFullStudy() {
                const fev1 = parseFloat(this.dom.stdFev1.value);
                const baselineFev1 = parseFloat(this.dom.stdBaselineFev1.value);
                const txDate = this.dom.txDate.value;
                
                if (!fev1 || !baselineFev1 || !txDate) {
                    this.showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                // Create or update patient
                if (!this.state.currentPatient) {
                    const patientId = `PT${Date.now().toString().slice(-6)}`;
                    const patient = {
                        id: patientId,
                        txDate,
                        baselineFev1,
                        baselineDate: this.dom.baselineDate.value || txDate,
                        description: this.dom.clinicalNotes.value.trim() || 'Full study patient',
                        visits: [{
                            id: `visit_${Date.now()}`,
                            date: new Date().toISOString().split('T')[0],
                            fev1,
                            fvc: null,
                            notes: 'Initial full study measurement',
                            timestamp: Date.now()
                        }]
                    };
                    
                    this.state.patients.set(patientId, patient);
                    this.state.currentPatient = patientId;
                    this.updatePatientInfo();
                } else {
                    const patient = this.state.patients.get(this.state.currentPatient);
                    patient.txDate = txDate;
                    patient.baselineFev1 = baselineFev1;
                    patient.baselineDate = this.dom.baselineDate.value || txDate;
                    
                    // Add visit if not already exists for today
                    const today = new Date().toISOString().split('T')[0];
                    const hasTodayVisit = patient.visits && patient.visits.some(v => v.date === today);
                    
                    if (!hasTodayVisit) {
                        if (!patient.visits) patient.visits = [];
                        patient.visits.push({
                            id: `visit_${Date.now()}`,
                            date: today,
                            fev1,
                            fvc: null,
                            notes: 'Full study measurement',
                            timestamp: Date.now()
                        });
                        
                        patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                    }
                    
                    this.state.patients.set(this.state.currentPatient, patient);
                }
                
                // Calculate and show results
                this.calculateFullStudy(fev1, baselineFev1, txDate);
                
                this.saveState();
                this.showToast('Full study saved', 'success');
                
                // Push to history
                this.historyManager.push(this.state, 'Full study saved');
                this.updateUndoRedoButtons();
            }
            
            calculateFullStudy(fev1, baselineFev1, txDate) {
                // Calculate time period
                const today = new Date();
                const txDateObj = new Date(txDate);
                const daysSinceTx = Math.floor((today - txDateObj) / (1000 * 60 * 60 * 24));
                
                // Calculate metrics
                const percentOfBaseline = ((fev1 / baselineFev1) * 100).toFixed(1);
                const cumulativeDelta = (fev1 - baselineFev1).toFixed(2);
                const percentDecline = (100 - percentOfBaseline).toFixed(1);
                const monthlyRate = (cumulativeDelta / (daysSinceTx / 30)).toFixed(3);
                
                // Determine status
                let statusClass = 'neutral';
                let statusText = '--';
                
                if (percentOfBaseline >= 90) {
                    statusClass = 'good';
                    statusText = 'Normal';
                } else if (percentOfBaseline >= 80) {
                    statusClass = 'warning';
                    statusText = 'Mild';
                } else if (percentOfBaseline >= 70) {
                    statusClass = 'warning';
                    statusText = 'Moderate';
                } else {
                    statusClass = 'alert';
                    statusText = 'Severe';
                }
                
                // Update results
                this.dom.stdCurrentFev1.textContent = fev1.toFixed(2);
                this.dom.stdBaseline.textContent = baselineFev1.toFixed(2);
                this.dom.stdTimePeriod.textContent = daysSinceTx;
                this.dom.stdCurrentPercent.textContent = `${percentOfBaseline}%`;
                this.dom.stdCurrentBadge.textContent = statusText;
                this.dom.stdCurrentBadge.className = `percent-display ${statusClass}`;
                
                this.dom.stdCumulativeDelta.textContent = cumulativeDelta;
                this.dom.stdPercentDecline.textContent = `${percentDecline}%`;
                this.dom.stdMonthlyRate.textContent = monthlyRate;
                
                // Update trend arrow
                const trendArrow = this.dom.stdTrendArrow;
                if (cumulativeDelta > 0) {
                    trendArrow.textContent = 'â†‘';
                    trendArrow.className = 'trend-arrow up';
                } else if (cumulativeDelta < 0) {
                    trendArrow.textContent = 'â†“';
                    trendArrow.className = 'trend-arrow down';
                } else {
                    trendArrow.textContent = 'â†’';
                    trendArrow.className = 'trend-arrow neutral';
                }
                
                // Update timestamp
                const now = new Date();
                this.dom.stdResultsTimestamp.textContent = 
                    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Update protocol note
                const protocolNote = document.getElementById('stdProtocolNote');
                if (protocolNote) {
                    if (percentDecline >= this.state.protocol.reviewThreshold) {
                        protocolNote.textContent = `Significant decline (${percentDecline}%) - Clinical review strongly recommended`;
                    } else if (percentDecline >= this.state.protocol.monitorThreshold) {
                        protocolNote.textContent = `Moderate decline (${percentDecline}%) - Close monitoring required`;
                    } else {
                        protocolNote.textContent = 'Within acceptable limits - Continue routine follow-up';
                    }
                }
                
                // Show results
                this.dom.stdResultsPanel.classList.add('visible');
                
                // Scroll to results
                this.dom.stdResultsPanel.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }
            
            clearFullStudy() {
                // Clear inputs
                this.dom.txDate.value = new Date().toISOString().split('T')[0];
                this.dom.baselineDate.value = new Date().toISOString().split('T')[0];
                this.dom.stdFev1.value = '';
                this.dom.stdBaselineFev1.value = '';
                this.dom.clinicalNotes.value = '';
                
                // Hide results
                this.dom.stdResultsPanel.classList.remove('visible');
                
                this.showToast('Full study cleared', 'info');
            }
            
            // === PATIENT MANAGEMENT ===
            
            showNewPatientModal() {
                // Reset form
                this.dom.newPatientId.value = '';
                this.dom.newTxDate.value = new Date().toISOString().split('T')[0];
                this.dom.newPatientBaseline.value = '';
                this.dom.newPatientDesc.value = '';
                
                // Show modal
                this.dom.newPatientModal.classList.add('active');
                this.dom.newPatientId.focus();
            }
            
            hideNewPatientModal() {
                this.dom.newPatientModal.classList.remove('active');
            }
            
            createPatient() {
                const id = this.dom.newPatientId.value.trim();
                const txDate = this.dom.newTxDate.value;
                const baseline = this.dom.newPatientBaseline.value ? parseFloat(this.dom.newPatientBaseline.value) : null;
                const description = this.dom.newPatientDesc.value.trim();
                
                if (!id) {
                    this.showToast('Please enter a Patient ID', 'error');
                    return;
                }
                
                if (!txDate) {
                    this.showToast('Please select a transplant date', 'error');
                    return;
                }
                
                // Check if patient already exists
                if (this.state.patients.has(id)) {
                    this.showToast('Patient ID already exists', 'error');
                    return;
                }
                
                // Create patient
                const patient = {
                    id,
                    txDate,
                    baselineFev1: baseline,
                    baselineDate: txDate,
                    description: description || `Patient ${id}`,
                    visits: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                // Add to patients
                this.state.patients.set(id, patient);
                this.state.currentPatient = id;
                
                // Update UI
                this.updatePatientInfo();
                this.updatePatientsTable();
                this.hideNewPatientModal();
                
                // If baseline was provided, set it in quick mode too
                if (baseline) {
                    this.state.session.quick.baseline = baseline;
                    this.state.session.quick.baselineSet = true;
                    this.dom.baselineValueDisplay.textContent = `${baseline.toFixed(2)} L`;
                }
                
                this.saveState();
                this.showToast(`Patient ${id} created successfully`, 'success');
                
                // Switch to monitor mode
                this.switchMode('monitor');
                
                // Push to history
                this.historyManager.push(this.state, 'Patient created');
                this.updateUndoRedoButtons();
            }
            
            updatePatientsTable() {
                const patients = Array.from(this.state.patients.values());
                
                if (patients.length === 0) {
                    this.dom.patientsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-4 text-secondary">
                                No patients yet. Create your first patient.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                patients.forEach(patient => {
                    const lastVisit = patient.visits && patient.visits.length > 0 
                        ? patient.visits[patient.visits.length - 1] 
                        : null;
                    
                    // Determine status
                    let status = 'No data';
                    let statusClass = 'text-tertiary';
                    
                    if (lastVisit && patient.baselineFev1) {
                        const percent = ((lastVisit.fev1 / patient.baselineFev1) * 100).toFixed(1);
                        if (percent >= 90) {
                            status = 'Stable';
                            statusClass = 'text-success';
                        } else if (percent >= 80) {
                            status = 'Monitoring';
                            statusClass = 'text-warning';
                        } else {
                            status = 'Review';
                            statusClass = 'text-error';
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>
                                <div class="font-semibold">${patient.id}</div>
                                <div class="text-xs text-tertiary">${patient.description}</div>
                            </td>
                            <td>${patient.txDate || '--'}</td>
                            <td>${patient.visits ? patient.visits.length : 0}</td>
                            <td>${lastVisit ? lastVisit.date : '--'}</td>
                            <td class="${statusClass}">${status}</td>
                            <td>
                                <button class="header-btn" onclick="spiroliteApp.selectPatient('${patient.id}')" title="Select">
                                    ðŸ‘ï¸
                                </button>
                                <button class="header-btn" onclick="spiroliteApp.editPatient('${patient.id}')" title="Edit">
                                    âœï¸
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                this.dom.patientsTableBody.innerHTML = html;
            }
            
            selectPatient(patientId) {
                if (!this.state.patients.has(patientId)) {
                    this.showToast('Patient not found', 'error');
                    return;
                }
                
                this.state.currentPatient = patientId;
                this.updatePatientInfo();
                this.updatePatientVisitsTable();
                
                // Switch to monitor mode
                this.switchMode('monitor');
                
                this.showToast(`Selected patient: ${patientId}`, 'success');
            }
            
            editPatient(patientId) {
                // TODO: Implement patient editing
                this.showToast('Patient editing coming soon', 'info');
            }
            
            importPatients() {
                // TODO: Implement patient import
                this.showToast('Patient import coming soon', 'info');
            }
            
            // === PROTOCOL SETTINGS ===
            
            showProtocolModal() {
                this.dom.protocolModal.classList.add('active');
            }
            
            hideProtocolModal() {
                this.dom.protocolModal.classList.remove('active');
            }
            
            resetProtocol() {
                this.dom.monitorThreshold.value = 10;
                this.dom.monitorThresholdValue.textContent = '10%';
                this.dom.reviewThreshold.value = 20;
                this.dom.reviewThresholdValue.textContent = '20%';
                this.dom.stabilityVisits.value = 4;
                
                this.showToast('Protocol reset to defaults', 'info');
            }
            
            saveProtocol() {
                this.state.protocol.monitorThreshold = parseInt(this.dom.monitorThreshold.value);
                this.state.protocol.reviewThreshold = parseInt(this.dom.reviewThreshold.value);
                this.state.protocol.stabilityVisits = parseInt(this.dom.stabilityVisits.value);
                
                this.saveState();
                this.hideProtocolModal();
                
                this.showToast('Protocol settings saved', 'success');
                
                // Update any displayed protocol values
                this.updateProtocolContext();
            }
            
            // === EXPORT FUNCTIONS ===
            
            showExportModal() {
                this.dom.exportModal.classList.add('active');
            }
            
            hideExportModal() {
                this.dom.exportModal.classList.remove('active');
            }
            
            async exportData() {
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                const range = this.dom.exportRange.value;
                
                if (range === 'range') {
                    const fromDate = this.dom.exportFromDate.value;
                    const toDate = this.dom.exportToDate.value;
                    
                    if (!fromDate || !toDate) {
                        this.showToast('Please select date range', 'error');
                        return;
                    }
                    
                    if (new Date(fromDate) > new Date(toDate)) {
                        this.showToast('From date must be before to date', 'error');
                        return;
                    }
                }
                
                this.hideExportModal();
                
                switch (format) {
                    case 'pdf':
                        await this.exportPDF();
                        break;
                    case 'csv':
                        await this.exportCSV();
                        break;
                    case 'json':
                        await this.exportJSON();
                        break;
                }
            }
            
            async exportPDF() {
                // TODO: Implement PDF export using jsPDF
                this.showToast('PDF export coming soon', 'info');
            }
            
            async exportCSV() {
                if (!this.state.currentPatient) {
                    this.showToast('Please select a patient first', 'error');
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient || !patient.visits || patient.visits.length === 0) {
                    this.showToast('No data to export', 'error');
                    return;
                }
                
                // Create CSV content
                const headers = ['Date', 'Days Post-Tx', 'FEVâ‚ (L)', 'FVC (L)', 'FEVâ‚/FVC Ratio', '% of Baseline', 'Notes'];
                const rows = patient.visits.map(visit => {
                    const txDate = new Date(patient.txDate);
                    const visitDate = new Date(visit.date);
                    const daysPostTx = Math.floor((visitDate - txDate) / (1000 * 60 * 60 * 24));
                    
                    const ratio = visit.fvc ? ((visit.fev1 / visit.fvc) * 100).toFixed(1) : '';
                    const percentBaseline = patient.baselineFev1 
                        ? ((visit.fev1 / patient.baselineFev1) * 100).toFixed(1) 
                        : '';
                    
                    return [
                        visit.date,
                        daysPostTx,
                        visit.fev1.toFixed(2),
                        visit.fvc ? visit.fvc.toFixed(2) : '',
                        ratio,
                        percentBaseline,
                        `"${visit.notes || ''}"`
                    ];
                });
                
                const csvContent = [headers, ...rows]
                    .map(row => row.join(','))
                    .join('\n');
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `spirolite_${patient.id}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                this.showToast('CSV exported successfully', 'success');
            }
            
            async exportJSON() {
                const exportData = {
                    app: 'Spirolite Professional',
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    protocol: this.state.protocol,
                    settings: this.state.settings,
                    patients: Array.from(this.state.patients.values())
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `spirolite_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                this.showToast('JSON backup exported successfully', 'success');
            }
            
            // === UI UTILITIES ===
            
            switchMode(mode) {
                if (this.state.mode === mode) return;
                
                this.state.mode = mode;
                
                // Update navigation buttons
                this.dom.navBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // Hide all mode sections
                document.querySelectorAll('.mode-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show active mode section
                const activeSection = document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
                if (activeSection) {
                    activeSection.classList.add('active');
                }
                
                // Update patient badges
                this.updatePatientBadges();
                
                // Update FAB visibility
                this.updateFABVisibility();
                
                // Focus appropriate input
                setTimeout(() => {
                    if (mode === 'quick' && this.dom.inputFev1) {
                        this.dom.inputFev1.focus();
                    } else if (mode === 'monitor' && this.dom.visitFev1) {
                        this.dom.visitFev1.focus();
                    } else if (mode === 'full' && this.dom.stdFev1) {
                        this.dom.stdFev1.focus();
                    }
                }, 100);
                
                this.showToast(`Switched to ${mode} mode`, 'info');
            }
            
            updatePatientBadges() {
                const patientName = this.getCurrentPatientName();
                const badges = [
                    document.getElementById('quickBadge'),
                    document.getElementById('monitorBadge'),
                    document.getElementById('fullBadge')
                ];
                
                badges.forEach(badge => {
                    if (badge) {
                        badge.textContent = patientName;
                    }
                });
            }
            
            updatePatientInfo() {
                if (!this.state.currentPatient) {
                    this.dom.patientAvatar.textContent = '--';
                    this.dom.patientId.textContent = 'Select Patient';
                    this.dom.patientStatus.textContent = 'No data';
                    this.dom.visitCount.textContent = '0 visits';
                    this.dom.txDateText.textContent = 'No TX date';
                    this.dom.txIndicator.className = 'tx-indicator';
                    return;
                }
                
                const patient = this.state.patients.get(this.state.currentPatient);
                if (!patient) return;
                
                // Update avatar
                this.dom.patientAvatar.textContent = patient.id.substring(0, 2).toUpperCase();
                
                // Update patient info
                this.dom.patientId.textContent = patient.id;
                this.dom.visitCount.textContent = `${patient.visits ? patient.visits.length : 0} visits`;
                
                // Determine status
                let status = 'No baseline';
                if (patient.visits && patient.visits.length > 0) {
                    if (patient.baselineFev1) {
                        const lastVisit = patient.visits[patient.visits.length - 1];
                        const percent = ((lastVisit.fev1 / patient.baselineFev1) * 100).toFixed(1);
                        status = `${percent}% of baseline`;
                    } else {
                        status = `${patient.visits.length} visits`;
                    }
                }
                this.dom.patientStatus.textContent = status;
                
                // Update TX indicator
                if (patient.txDate) {
                    this.dom.txDateText.textContent = `TX: ${patient.txDate}`;
                    
                    const txDate = new Date(patient.txDate);
                    const today = new Date();
                    const daysSinceTx = Math.floor((today - txDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysSinceTx < 0) {
                        this.dom.txIndicator.className = 'tx-indicator missing';
                    } else if (daysSinceTx < 90) {
                        this.dom.txIndicator.className = 'tx-indicator recent';
                    } else {
                        this.dom.txIndicator.className = 'tx-indicator valid';
                    }
                } else {
                    this.dom.txDateText.textContent = 'No TX date';
                    this.dom.txIndicator.className = 'tx-indicator missing';
                }
                
                // Update patient badges
                this.updatePatientBadges();
            }
            
            getCurrentPatientName() {
                if (!this.state.currentPatient) return 'No Patient';
                const patient = this.state.patients.get(this.state.currentPatient);
                return patient ? patient.id : 'No Patient';
            }
            
            updateFABVisibility() {
                // Show FABs based on mode
                const showNewVisit = this.state.mode === 'monitor';
                const showQuickCalc = this.state.mode === 'quick';
                
                this.dom.newVisitFab.style.display = showNewVisit ? 'flex' : 'none';
                this.dom.quickCalcFab.style.display = showQuickCalc ? 'flex' : 'none';
                
                // Show/hide container based on if any FAB is visible
                const hasVisibleFAB = showNewVisit || showQuickCalc;
                this.dom.fabContainer.style.display = hasVisibleFAB ? 'flex' : 'none';
            }
            
            handleNewVisitFab() {
                // Switch to single entry mode and focus on FEV1 input
                this.switchEntryMode('single');
                setTimeout(() => {
                    this.dom.visitFev1.focus();
                }, 100);
            }
            
            handleQuickCalcFab() {
                // Trigger calculation
                this.calculateQuick();
            }
            
            setDateShortcut(offset) {
                const date = new Date();
                date.setDate(date.getDate() + offset);
                const dateStr = date.toISOString().split('T')[0];
                
                let targetInput = null;
                switch(this.state.mode) {
                    case 'quick':
                        targetInput = this.dom.measurementDate;
                        break;
                    case 'monitor':
                        targetInput = this.dom.visitDate;
                        break;
                    case 'full':
                        targetInput = this.dom.txDate;
                        break;
                }
                
                if (targetInput) {
                    targetInput.value = dateStr;
                    this.showToast(`Date set to ${date.toLocaleDateString()}`, 'info');
                }
            }
            
            // === ACCESSIBILITY ===
            
            toggleColorBlindMode() {
                this.state.settings.colorBlindMode = !this.state.settings.colorBlindMode;
                this.updateAccessibilityUI();
                this.saveState();
                
                const isActive = this.state.settings.colorBlindMode;
                this.dom.colorBlindBtn.classList.toggle('active', isActive);
                this.showToast(`Color blind mode ${isActive ? 'enabled' : 'disabled'}`, 'info');
            }
            
            toggleHighContrastMode() {
                this.state.settings.highContrastMode = !this.state.settings.highContrastMode;
                this.updateAccessibilityUI();
                this.saveState();
                
                const isActive = this.state.settings.highContrastMode;
                this.dom.highContrastBtn.classList.toggle('active', isActive);
                this.showToast(`High contrast mode ${isActive ? 'enabled' : 'disabled'}`, 'info');
            }
            
            updateAccessibilityUI() {
                // Update body classes based on settings
                document.body.classList.toggle('color-blind', this.state.settings.colorBlindMode);
                document.body.classList.toggle('high-contrast', this.state.settings.highContrastMode);
                
                // Update button states
                this.dom.colorBlindBtn.classList.toggle('active', this.state.settings.colorBlindMode);
                this.dom.highContrastBtn.classList.toggle('active', this.state.settings.highContrastMode);
            }
            
            // === HISTORY MANAGEMENT ===
            
            handleUndo() {
                const state = this.historyManager.undo();
                if (state) {
                    this.state = state.state;
                    this.updateUI();
                    this.showToast(`Undo: ${state.action}`, 'info');
                    this.updateUndoRedoButtons();
                }
            }
            
            handleRedo() {
                const state = this.historyManager.redo();
                if (state) {
                    this.state = state.state;
                    this.updateUI();
                    this.showToast(`Redo: ${state.action}`, 'info');
                    this.updateUndoRedoButtons();
                }
            }
            
            updateUndoRedoButtons() {
                this.dom.undoBtn.disabled = !this.historyManager.canUndo();
                this.dom.redoBtn.disabled = !this.historyManager.canRedo();
            }
            
            // === TOAST NOTIFICATIONS ===
            
            showToast(message, type = 'info') {
                const toastId = `toast_${Date.now()}_${this.currentToastId++}`;
                
                const icons = {
                    success: 'âœ…',
                    error: 'âŒ',
                    warning: 'âš ï¸',
                    info: 'ðŸ’¡'
                };
                
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="document.getElementById('${toastId}').remove()">Ã—</button>
                `;
                
                this.dom.toastContainer.appendChild(toast);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    const toastEl = document.getElementById(toastId);
                    if (toastEl) {
                        toastEl.style.opacity = '0';
                        toastEl.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            if (toastEl.parentNode) {
                                toastEl.parentNode.removeChild(toastEl);
                            }
                        }, 300);
                    }
                }, 5000);
            }
            
            // === STATE MANAGEMENT ===
            
            saveState() {
                try {
                    const stateToSave = {
                        protocol: this.state.protocol,
                        settings: this.state.settings,
                        patients: Array.from(this.state.patients.entries()),
                        currentPatient: this.state.currentPatient,
                        session: this.state.session,
                        mode: this.state.mode
                    };
                    localStorage.setItem('spirolite_professional_state', JSON.stringify(stateToSave));
                } catch (error) {
                    console.error('Failed to save state:', error);
                }
            }
            
            loadState() {
                try {
                    const saved = localStorage.getItem('spirolite_professional_state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        
                        // Restore protocol settings
                        if (state.protocol) {
                            this.state.protocol = { ...this.state.protocol, ...state.protocol };
                        }
                        
                        // Restore UI settings
                        if (state.settings) {
                            this.state.settings = { ...this.state.settings, ...state.settings };
                        }
                        
                        // Restore patients
                        if (state.patients) {
                            this.state.patients = new Map(state.patients);
                        }
                        
                        // Restore current patient
                        if (state.currentPatient && this.state.patients.has(state.currentPatient)) {
                            this.state.currentPatient = state.currentPatient;
                        }
                        
                        // Restore session
                        if (state.session) {
                            this.state.session = { ...this.state.session, ...state.session };
                        }
                        
                        // Restore mode
                        if (state.mode) {
                            this.state.mode = state.mode;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load state:', error);
                }
            }
            
            updateUI() {
                // Update patient info
                this.updatePatientInfo();
                
                // Update patient visits table
                this.updatePatientVisitsTable();
                
                // Update patients table
                this.updatePatientsTable();
                
                // Update navigation
                this.switchMode(this.state.mode);
                
                // Update accessibility
                this.updateAccessibilityUI();
                
                // Update baseline if exists
                if (this.state.session.quick.baseline) {
                    this.dom.baselineValueDisplay.textContent = `${this.state.session.quick.baseline.toFixed(2)} L`;
                    this.dom.baselineProgress.style.width = '100%';
                    this.dom.baselineActionBtn.disabled = false;
                    this.dom.baselineActionBtn.className = 'baseline-action-btn ready';
                    this.dom.baselineActionBtn.textContent = 'Update';
                }
            }
            
            // === KEYBOARD SHORTCUTS ===
            
            handleKeyboardShortcuts(e) {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }
                
                // Ctrl+Z for undo
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    this.handleUndo();
                }
                
                // Ctrl+Y for redo
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    this.handleRedo();
                }
                
                // Number keys for mode switching
                if (!e.ctrlKey && !e.altKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            this.switchMode('quick');
                            break;
                        case '2':
                            e.preventDefault();
                            this.switchMode('monitor');
                            break;
                        case '3':
                            e.preventDefault();
                            this.switchMode('full');
                            break;
                        case '4':
                            e.preventDefault();
                            this.switchMode('patients');
                            break;
                        case 'Escape':
                            const openModal = document.querySelector('.modal-overlay.active');
                            if (openModal) {
                                const closeBtn = openModal.querySelector('.modal-close');
                                if (closeBtn) closeBtn.click();
                            }
                            break;
                    }
                }
            }
            
            // === WINDOW RESIZE ===
            
            handleResize() {
                // Handle any resize-specific logic
                if (window.innerWidth < 768) {
                    // Mobile-specific adjustments
                }
                
                // Update charts if they exist
                if (this.charts.timeline) {
                    this.charts.timeline.resize();
                }
                if (this.charts.fev1) {
                    this.charts.fev1.resize();
                }
            }
        }
        
        // === INITIALIZE APPLICATION ===
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ“± DOM fully loaded, starting Spirolite Professional...');
            
            try {
                // Initialize the app
                window.spiroliteApp = new SpiroliteApp();
                
                console.log('ðŸŽ‰ Spirolite Professional initialized successfully!');
            } catch (error) {
                console.error('ðŸ’¥ Failed to initialize Spirolite:', error);
                
                // Fallback: Show error message
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.innerHTML = `
                        <div class="loading-content">
                            <div style="font-size: 3rem; margin-bottom: var(--space-4);">âš ï¸</div>
                            <h3 style="color: white; margin-bottom: var(--space-2);">Initialization Error</h3>
                            <p style="color: rgba(255,255,255,0.8); font-size: 0.875rem;">
                                Failed to load application. Please refresh the page.
                            </p>
                            <button onclick="window.location.reload()" 
                                    style="margin-top: var(--space-4); padding: var(--space-2) var(--space-4);
                                           background: white; border: none; border-radius: var(--radius-md);
                                           color: var(--primary); font-weight: 600; cursor: pointer;">
                                Refresh Page
                            </button>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>
