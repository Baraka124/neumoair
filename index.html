<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1A5F7A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Spirolite - Professional Lung Function Calculator & Tracker">
    <title>Spirolite | Calculate & Track</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg?v=1.4" id="favicon-svg">
    <link rel="alternate icon" type="image/png" sizes="192x192" href="icon-192.png?v=1.4">
    <link rel="alternate icon" type="image/png" sizes="512x512" href="icon-512.png?v=1.4">
    <link rel="apple-touch-icon" href="icon-192.png?v=1.4">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --primary: #1A5F7A;
            --primary-dark: #0D4B63;
            --primary-light: #2D9596;
            --secondary: #57C5B6;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-tertiary: #9CA3AF;
            --success: #059669;
            --warning: #D97706;
            --alert: #DC2626;
            --border: #E5E7EB;
            --chart-line: #1A5F7A;
            --chart-fill: rgba(26, 95, 122, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            --glass-blur: blur(10px);
            --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem;
            --space-5: 1.5rem; --space-6: 2rem; --space-7: 2.5rem; --space-8: 3rem;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-mono: 'SF Mono', 'Roboto Mono', monospace;
            --radius-sm: 6px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px;
            --radius-full: 9999px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --z-sticky: 100; --z-modal: 1000; --z-toast: 10000;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #2D9596; --primary-dark: #1A5F7A;
                --background: #111827; --surface: #1F2937;
                --text-primary: #F9FAFB; --text-secondary: #D1D5DB;
                --border: #374151; --glass-bg: rgba(31, 41, 55, 0.85);
                --glass-border: rgba(255, 255, 255, 0.1);
            }
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        @media (prefers-color-scheme: dark) {
            html { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        }
        
        body {
            font-family: var(--font-family);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100000; opacity: 1; transition: opacity 0.5s ease;
        }
        
        .loading-overlay.fade-out { opacity: 0; pointer-events: none; }
        .loading-content { text-align: center; padding: var(--space-6); max-width: 320px; width: 90%; }
        .loading-logo { 
            width: 120px; height: 120px; margin-bottom: var(--space-6); 
            animation: subtlePulse 2s ease-in-out infinite;
            color: white;
        }
        .loading-logo svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        }
        
        .loading-progress-container { width: 100%; max-width: 280px; margin: var(--space-5) 0; }
        .loading-progress-label { display: flex; justify-content: space-between; margin-bottom: var(--space-2);
            font-size: 0.75rem; color: white; font-weight: 500; opacity: 0.9; }
        .loading-progress { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full); overflow: hidden; position: relative; }
        .loading-progress-bar { height: 100%; background: linear-gradient(90deg, var(--secondary), white);
            width: 0%; border-radius: var(--radius-full); transition: width 0.5s ease; }
        
        @keyframes subtlePulse { 
            0%, 100% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.05); opacity: 0.95; } 
        }
        
        /* App Container */
        .app-container {
            display: flex; flex-direction: column; height: 100vh; height: -webkit-fill-available;
            max-width: 1200px; margin: 0 auto; background: transparent; opacity: 0; transition: opacity var(--transition-fast);
        }
        .app-container.loaded { opacity: 1; }
        @media (min-width: 768px) {
            .app-container { margin: var(--space-4) auto; height: calc(100vh - 2 * var(--space-4));
                max-height: 900px; border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg); }
        }
        
        /* Header */
        .app-header {
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border); padding: var(--space-3) var(--space-4);
            position: sticky; top: 0; z-index: var(--z-sticky); transition: all var(--transition-fast);
            display: flex; align-items: center; justify-content: space-between;
        }
        .app-header.collapsed { padding: var(--space-2) var(--space-4); transform: translateY(-100%); opacity: 0; pointer-events: none; }
        .header-toggle {
            width: 28px; height: 28px; border-radius: var(--radius-md); background: rgba(26, 95, 122, 0.1);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all var(--transition-fast); color: var(--primary); font-size: 0.75rem;
            border: 1px solid rgba(26, 95, 122, 0.2);
        }
        .header-toggle:hover { background: rgba(26, 95, 122, 0.2); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        .header-content { display: flex; justify-content: space-between; align-items: center; gap: var(--space-4); flex: 1; }
        .app-title { display: flex; align-items: center; gap: var(--space-3); flex: 1; min-width: 0; }
        .app-logo {
            width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-lg); flex-shrink: 0; position: relative; overflow: hidden;
            box-shadow: 0 4px 12px rgba(26, 95, 122, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app-logo svg {
            width: 70%;
            height: 70%;
            color: white;
        }
        .app-name h1 { font-size: 1.125rem; font-weight: 800; color: var(--text-primary); line-height: 1.2; }
        .app-name span { font-size: 0.6875rem; color: var(--text-secondary); font-weight: 500; }
        .header-actions { display: flex; gap: var(--space-1); flex-shrink: 0; align-items: center; }
        .header-btn {
            width: 40px; height: 40px; border-radius: var(--radius-md); background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all var(--transition-fast); font-size: 1rem;
        }
        .header-btn:hover { background: var(--primary-light); color: white; border-color: var(--primary);
            transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        .undo-redo-container { display: flex; gap: var(--space-1); align-items: center; }
        .undo-btn, .redo-btn {
            width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--glass-bg);
            border: 1px solid var(--glass-border); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all var(--transition-fast); font-size: 0.875rem;
        }
        .undo-btn:hover:not(:disabled), .redo-btn:hover:not(:disabled) {
            background: var(--primary-light); color: white; border-color: var(--primary); transform: translateY(-1px);
        }
        .undo-btn:disabled, .redo-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Patient Bar */
        .patient-bar {
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: var(--space-2) var(--space-4); border-bottom: 1px solid var(--glass-border);
            position: sticky; top: 0; z-index: var(--z-sticky); transition: all var(--transition-fast);
        }
        .patient-bar.collapsed { padding: var(--space-1) var(--space-4); transform: translateY(-100%); opacity: 0; pointer-events: none; }
        .patient-info-compact { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); }
        .patient-id-display { display: flex; align-items: center; gap: var(--space-2); min-width: 0; }
        .patient-avatar-small {
            width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 0.875rem; flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(26, 95, 122, 0.3); border: 2px solid white;
        }
        .patient-meta-compact { flex: 1; min-width: 0; }
        .patient-meta-compact .primary { font-family: var(--font-family-mono); font-weight: 700; font-size: 0.875rem;
            color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .patient-meta-compact .secondary { font-size: 0.625rem; color: var(--text-secondary);
            display: flex; gap: var(--space-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .patient-actions-compact { display: flex; gap: var(--space-1); flex-shrink: 0; }
        
        /* TX Date Indicator */
        .tx-date-indicator {
            display: flex; align-items: center; gap: var(--space-2); padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; margin-left: auto;
            background: rgba(26, 95, 122, 0.1); border: 1px solid rgba(26, 95, 122, 0.2); color: var(--text-secondary);
        }
        .tx-date-indicator.missing { background: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.2); color: var(--alert); }
        .tx-date-indicator.recent { background: rgba(217, 119, 6, 0.1); border-color: rgba(217, 119, 6, 0.2); color: var(--warning); }
        .tx-date-indicator.valid { background: rgba(5, 150, 105, 0.1); border-color: rgba(5, 150, 105, 0.2); color: var(--success); }
        .tx-date-indicator .tx-icon { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .tx-date-indicator.missing .tx-icon { background: var(--alert); }
        .tx-date-indicator.recent .tx-icon { background: var(--warning); }
        .tx-date-indicator.valid .tx-icon { background: var(--success); }
        
        /* Navigation */
        .app-navigation {
            display: flex; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border); padding: var(--space-2) var(--space-4); gap: var(--space-1);
            position: sticky; top: 0; z-index: var(--z-sticky); overflow-x: auto; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; transition: all var(--transition-fast);
        }
        .app-navigation.collapsed { top: -48px; }
        .app-navigation::-webkit-scrollbar { display: none; }
        .nav-btn {
            padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); background: transparent;
            color: var(--text-secondary); font-weight: 600; font-size: 0.75rem; cursor: pointer;
            transition: all var(--transition-fast); display: flex; flex-direction: column; align-items: center;
            gap: 2px; min-width: 75px; white-space: nowrap; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .nav-btn:hover { background: rgba(26, 95, 122, 0.1); color: var(--primary); transform: translateY(-1px); }
        .nav-btn.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;
            box-shadow: 0 4px 15px rgba(26, 95, 122, 0.3); }
        .nav-icon { font-size: 1rem; opacity: 0.9; }
        
        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
            padding: var(--space-4); padding-bottom: max(var(--space-4), env(safe-area-inset-bottom)); }
        .mode-section { display: none; animation: fadeIn var(--transition-fast); }
        .mode-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Card Component */
        .calculator-card {
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-xl); padding: var(--space-4); margin-bottom: var(--space-4);
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow);
        }
        .section-title { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: var(--space-4);
            display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); }
        .section-title .badge {
            background: linear-gradient(135deg, var(--primary-light), var(--primary)); color: white;
            padding: var(--space-1) var(--space-2); border-radius: var(--radius-full); font-size: 0.6875rem;
            font-weight: 600; white-space: nowrap; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        
        /* Form Components */
        .input-group { position: relative; margin-bottom: var(--space-3); }
        .input-label { display: flex; justify-content: space-between; align-items: center;
            font-size: 0.6875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-2);
            text-transform: uppercase; letter-spacing: 0.05em; }
        .input-help { color: var(--text-tertiary); font-weight: normal; text-transform: none; letter-spacing: normal; }
        .input-wrapper { position: relative; }
        .measurement-input {
            width: 100%; padding: var(--space-3); padding-right: 50px; border: 2px solid transparent;
            border-radius: var(--radius-lg); font-family: var(--font-family-mono); font-size: 1.25rem;
            font-weight: 700; color: var(--text-primary); text-align: left; transition: all var(--transition-fast);
            background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .measurement-input:focus { outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.2); transform: translateY(-1px); }
        .input-unit { position: absolute; right: var(--space-3); top: 50%; transform: translateY(-50%);
            color: var(--text-secondary); font-weight: 600; font-size: 0.75rem; pointer-events: none; }
        
        /* Validation */
        .validation-message { font-size: 0.6875rem; margin-top: var(--space-1); padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md); display: none; }
        .validation-message.warning { background: rgba(217, 119, 6, 0.1); color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.3); display: block; }
        .validation-message.error { background: rgba(220, 38, 38, 0.1); color: var(--alert);
            border: 1px solid rgba(220, 38, 38, 0.3); display: block; }
        .validation-message.success { background: rgba(5, 150, 105, 0.1); color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.3); display: block; }
        
        /* Quick Calc */
        .measurement-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4); }
        @media (max-width: 640px) { .measurement-inputs { grid-template-columns: 1fr; gap: var(--space-3); } }
        
        .comparison-selector { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg); padding: var(--space-3); margin: var(--space-4) 0; border: 1px solid var(--glass-border); }
        .comparison-title { font-size: 0.6875rem; font-weight: 600; color: var(--text-secondary);
            margin-bottom: var(--space-3); text-transform: uppercase; letter-spacing: 0.05em; }
        .comparison-options { display: flex; flex-direction: column; gap: var(--space-2); }
        .comparison-option {
            display: flex; align-items: center; padding: var(--space-2); border-radius: var(--radius-md);
            cursor: pointer; transition: all var(--transition-fast); border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        @media (prefers-color-scheme: dark) { .comparison-option { background: rgba(31, 41, 55, 0.5); } }
        .comparison-option:hover { background: rgba(26, 95, 122, 0.1); border-color: var(--primary); transform: translateY(-1px); }
        .comparison-option.selected { background: rgba(26, 95, 122, 0.15); border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(26, 95, 122, 0.2); }
        .option-radio { margin-right: var(--space-2); width: 16px; height: 16px; accent-color: var(--primary); }
        .option-content { flex: 1; }
        .option-label { font-weight: 600; color: var(--text-primary); font-size: 0.75rem; margin-bottom: 2px; }
        .option-input { margin-top: var(--space-2); padding: var(--space-2) var(--space-3); border: 1px solid var(--border);
            border-radius: var(--radius-md); width: 100%; font-family: var(--font-family-mono); font-size: 0.75rem;
            background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: var(--text-primary); }
        .option-note { font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px; display: block; }
        
        /* Results Panel */
        .results-panel { margin-top: var(--space-4); display: none; }
        .results-panel.visible { display: block; animation: fadeIn var(--transition-fast); }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3); }
        .results-title { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em; }
        .results-timestamp { font-size: 0.6875rem; color: var(--text-tertiary); }
        
        .current-measurements { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg); padding: var(--space-3); margin-bottom: var(--space-3); border: 1px solid var(--glass-border); }
        .measurements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); }
        @media (max-width: 480px) { .measurements-grid { grid-template-columns: 1fr; gap: var(--space-2); } }
        .measurement-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg); padding: var(--space-3); text-align: center; transition: all var(--transition-fast);
        }
        @media (prefers-color-scheme: dark) {
            .measurement-card { background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(30, 41, 59, 0.6)); }
        }
        .measurement-card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 8px 20px rgba(26, 95, 122, 0.15); }
        .measurement-label { font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em; display: block; }
        .measurement-unit { font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px; }
        .value-with-percent { display: flex; align-items: baseline; gap: var(--space-2); justify-content: center; }
        .primary-value { font-family: var(--font-family-mono); font-weight: 700; font-size: 1.5rem; color: var(--text-primary); }
        
        /* Percentage Display */
        .percent-display {
            font-size: 0.75rem; font-weight: 600; padding: 4px 8px; border-radius: var(--radius-full);
            transition: all var(--transition-fast); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .percent-display.good { background: rgba(5, 150, 105, 0.2); color: var(--success); border: 1px solid rgba(5, 150, 105, 0.3); }
        .percent-display.warning { background: rgba(217, 119, 6, 0.2); color: var(--warning); border: 1px solid rgba(217, 119, 6, 0.3); }
        .percent-display.alert { background: rgba(220, 38, 38, 0.2); color: var(--alert); border: 1px solid rgba(220, 38, 38, 0.3); }
        .percent-display.neutral { background: rgba(156, 163, 175, 0.2); color: var(--text-tertiary);
            border: 1px solid rgba(156, 163, 175, 0.3); }
        
        /* Color coding OFF */
        .color-coding-off .percent-display.good,
        .color-coding-off .percent-display.warning,
        .color-coding-off .percent-display.alert,
        .color-coding-off .visit-change.positive,
        .color-coding-off .visit-change.negative,
        .color-coding-off .baseline-percent.good,
        .color-coding-off .baseline-percent.warning,
        .color-coding-off .baseline-percent.alert,
        .color-coding-off .trend-arrow.up,
        .color-coding-off .trend-arrow.down {
            background: rgba(156, 163, 175, 0.2) !important; color: var(--text-secondary) !important;
            border-color: rgba(156, 163, 175, 0.3) !important;
        }
        
        .trend-arrow {
            font-size: 0.75rem; margin-right: 2px; display: inline-flex; align-items: center; justify-content: center;
            width: 18px; height: 18px; border-radius: 50%; background: rgba(156, 163, 175, 0.2);
        }
        .trend-arrow.up { color: var(--success); background: rgba(5, 150, 105, 0.2); }
        .trend-arrow.down { color: var(--alert); background: rgba(220, 38, 38, 0.2); }
        .trend-arrow.neutral { color: var(--text-tertiary); }
        
        /* Comparison Results */
        .comparison-results { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg); padding: var(--space-3); margin-bottom: var(--space-3); border: 1px solid var(--glass-border); }
        .comparison-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3); }
        .comparison-subtitle { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        .metric-list { display: flex; flex-direction: column; gap: var(--space-2); }
        .metric-item { display: flex; justify-content: space-between; align-items: center;
            padding: var(--space-2) 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .metric-item:last-child { border-bottom: none; }
        .metric-label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500;
            display: flex; align-items: center; gap: var(--space-1); }
        .metric-value { font-family: var(--font-family-mono); font-weight: 600; font-size: 0.875rem; }
        .metric-unit { font-size: 0.6875rem; color: var(--text-tertiary); min-width: 50px; text-align: right;
            display: flex; align-items: center; justify-content: flex-end; gap: var(--space-1); }
        
        .visit-change { transition: all var(--transition-fast); }
        .visit-change.positive { color: var(--success); }
        .visit-change.negative { color: var(--alert); }
        .visit-change.neutral { color: var(--text-tertiary); }
        
        .baseline-percent { transition: all var(--transition-fast); }
        .baseline-percent.good { background: rgba(5, 150, 105, 0.2); color: var(--success);
            padding: 4px 8px; border-radius: var(--radius-full); border: 1px solid rgba(5, 150, 105, 0.3); }
        .baseline-percent.warning { background: rgba(217, 119, 6, 0.2); color: var(--warning);
            padding: 4px 8px; border-radius: var(--radius-full); border: 1px solid rgba(217, 119, 6, 0.3); }
        .baseline-percent.alert { background: rgba(220, 38, 38, 0.2); color: var(--alert);
            padding: 4px 8px; border-radius: var(--radius-full); border: 1px solid rgba(220, 38, 38, 0.3); }
        
        /* Protocol Context */
        .protocol-context { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg); padding: var(--space-3); margin-top: var(--space-3); border: 1px solid var(--glass-border); }
        .protocol-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);
            flex-wrap: wrap; gap: var(--space-1); }
        .protocol-title { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: var(--space-1); }
        .threshold-display { display: flex; gap: var(--space-1); flex-wrap: wrap; }
        .threshold-badge {
            padding: 2px 6px; border-radius: var(--radius-full); font-size: 0.625rem; font-weight: 600;
            display: flex; align-items: center; gap: 2px; white-space: nowrap; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .threshold-badge.monitor { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .threshold-badge.review { background: rgba(220, 38, 38, 0.2); color: var(--alert); border: 1px solid rgba(220, 38, 38, 0.3); }
        .protocol-note { font-size: 0.75rem; line-height: 1.4; color: var(--text-secondary); padding: var(--space-2);
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md); border-left: 3px solid var(--primary); }
        @media (prefers-color-scheme: dark) { .protocol-note { background: rgba(31, 41, 55, 0.5); } }
        
        /* Action Buttons */
        .action-bar { display: flex; gap: var(--space-2); margin-top: var(--space-4); padding-top: var(--space-4);
            border-top: 1px solid rgba(255, 255, 255, 0.2); }
        @media (max-width: 640px) { .action-bar { flex-direction: column; gap: var(--space-2); } }
        .action-btn {
            flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg);
            font-weight: 600; font-size: 0.75rem; cursor: pointer; transition: all var(--transition-fast);
            display: flex; align-items: center; justify-content: center; gap: var(--space-1); min-height: 40px;
        }
        @media (max-width: 640px) { .action-btn { width: 100%; } }
        .action-btn.primary {
            background: linear-gradient(135deg, rgba(26, 95, 122, 0.9), rgba(13, 75, 99, 0.9));
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white;
            box-shadow: 0 4px 15px rgba(26, 95, 122, 0.3); border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .action-btn.primary:hover { box-shadow: 0 6px 20px rgba(26, 95, 122, 0.4); transform: translateY(-1px); }
        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary); border: 1px solid var(--glass-border);
        }
        @media (prefers-color-scheme: dark) { .action-btn.secondary { background: rgba(31, 41, 55, 0.8); } }
        .action-btn.secondary:hover { background: rgba(26, 95, 122, 0.1); color: var(--text-primary);
            border-color: var(--primary); transform: translateY(-1px); }
        
        /* Monitor Mode */
        .monitor-header { display: flex; justify-content: space-between; align-items: center;
            margin-bottom: var(--space-3); flex-wrap: wrap; gap: var(--space-2); }
        .view-toggle { display: flex; gap: 2px; background: var(--glass-bg); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border-radius: var(--radius-md); padding: 2px; border: 1px solid var(--glass-border); }
        .view-toggle-btn {
            padding: var(--space-1) var(--space-2); border: none; border-radius: var(--radius-sm);
            background: transparent; color: var(--text-secondary); font-weight: 600; font-size: 0.6875rem;
            cursor: pointer; transition: all var(--transition-fast); white-space: nowrap;
        }
        .view-toggle-btn:hover { background: rgba(26, 95, 122, 0.1); color: var(--primary); }
        .view-toggle-btn.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 2px 8px rgba(26, 95, 122, 0.3); }
        
        /* Baseline Control */
        .baseline-control { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3); }
        .baseline-value-display {
            font-family: var(--font-family-mono); font-weight: 700; color: var(--primary); font-size: 0.875rem;
            background: rgba(26, 95, 122, 0.1); padding: var(--space-1) var(--space-2); border-radius: var(--radius-md);
            border: 1px solid rgba(26, 95, 122, 0.2);
        }
        .baseline-set-btn {
            padding: var(--space-1) var(--space-2); border-radius: var(--radius-md); background: var(--success);
            color: white; border: none; font-size: 0.6875rem; font-weight: 600; cursor: pointer;
            transition: all var(--transition-fast); display: flex; align-items: center; gap: 4px;
        }
        .baseline-set-btn:hover { background: var(--success); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); }
        .baseline-set-btn:disabled { background: var(--text-tertiary); cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Entry Mode Selector */
        .entry-mode-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-2); margin: var(--space-3) 0; }
        @media (max-width: 640px) { .entry-mode-selector { grid-template-columns: 1fr; } }
        .entry-mode-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg); padding: var(--space-3); text-align: center; cursor: pointer;
            transition: all var(--transition-fast); display: flex; flex-direction: column; align-items: center; gap: var(--space-1);
        }
        @media (prefers-color-scheme: dark) {
            .entry-mode-card { background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(30, 41, 59, 0.6)); }
        }
        .entry-mode-card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 8px 20px rgba(26, 95, 122, 0.15); }
        .entry-mode-card.active { background: linear-gradient(135deg, rgba(26, 95, 122, 0.2), rgba(45, 149, 150, 0.2));
            border-color: var(--primary); box-shadow: 0 4px 15px rgba(26, 95, 122, 0.2); }
        .entry-mode-icon { font-size: 1.25rem; color: var(--primary); margin-bottom: var(--space-1); }
        .entry-mode-title { font-weight: 600; font-size: 0.75rem; color: var(--text-primary); }
        .entry-mode-desc { font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4; }
        
        /* Visit Entry Forms */
        .visit-entry-form {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); padding: var(--space-3); margin-bottom: var(--space-4); border: 1px solid var(--glass-border);
        }
        .form-row { display: flex; gap: var(--space-2); align-items: center; }
        @media (max-width: 640px) { .form-row { flex-wrap: wrap; } }
        .date-input {
            padding: var(--space-2); border: 1px solid var(--glass-border); border-radius: var(--radius-md);
            font-family: var(--font-family); font-size: 0.75rem; background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: var(--text-primary); flex: 1; min-width: 120px;
        }
        .date-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26, 95, 122, 0.2); }
        .date-input.invalid { border-color: var(--alert); background: rgba(220, 38, 38, 0.1); }
        .date-warning { font-size: 0.6875rem; color: var(--warning); margin-top: 2px; display: flex; align-items: center; gap: 4px; }
        .date-warning.error { color: var(--alert); }
        .bulk-textarea {
            width: 100%; min-height: 80px; padding: var(--space-2); border: 1px solid var(--glass-border);
            border-radius: var(--radius-md); font-family: var(--font-family-mono); font-size: 0.6875rem;
            background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: var(--text-primary); resize: vertical; margin-top: var(--space-2);
        }
        .clinical-notes-input {
            width: 100%; min-height: 60px; padding: var(--space-2); border: 1px solid var(--glass-border);
            border-radius: var(--radius-md); font-family: var(--font-family); font-size: 0.75rem;
            background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: var(--text-primary); resize: vertical;
        }
        .notes-hint { font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px; }
        
        /* Spreadsheet Table */
        .spreadsheet-table {
            width: 100%; border-collapse: separate; border-spacing: 0; background: var(--glass-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg); overflow: hidden; margin-top: var(--space-3);
        }
        .spreadsheet-table th {
            background: rgba(26, 95, 122, 0.1); padding: var(--space-2); font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em; border-bottom: 1px solid var(--glass-border);
            text-align: left; white-space: nowrap;
        }
        .spreadsheet-table td { padding: var(--space-2); border-bottom: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border); font-family: var(--font-family-mono); white-space: nowrap;
            vertical-align: top; background: transparent; transition: all var(--transition-fast); }
        .spreadsheet-table tr:last-child td { border-bottom: none; }
        .spreadsheet-table td:last-child { border-right: none; }
        .spreadsheet-table tr:hover td { background: rgba(26, 95, 122, 0.05); }
        .editable-cell { cursor: text; position: relative; }
        .editable-cell:focus { outline: none; background: rgba(26, 95, 122, 0.1) !important; box-shadow: inset 0 0 0 2px var(--primary); }
        
        /* Table View */
        .visits-table-container {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); border: 1px solid var(--glass-border); overflow: hidden; margin-bottom: var(--space-4);
            display: none;
        }
        .visits-table-container.visible { display: block; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3);
            background: rgba(26, 95, 122, 0.1); border-bottom: 1px solid var(--glass-border); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .medical-table {
            width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 800px;
        }
        .medical-table th {
            background: rgba(26, 95, 122, 0.1); padding: var(--space-2); font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em; border-bottom: 2px solid var(--glass-border);
            text-align: left; white-space: nowrap;
        }
        .medical-table td { padding: var(--space-2); border-bottom: 1px solid var(--glass-border);
            font-family: var(--font-family-mono); white-space: nowrap; vertical-align: top; }
        .medical-table tr:hover { background: rgba(26, 95, 122, 0.05); }
        .medical-table .alert-cell { text-align: center; }
        .alert-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--text-tertiary); }
        .color-coding-on .alert-indicator.monitor { background: var(--warning); }
        .color-coding-on .alert-indicator.review { background: var(--alert); }
        
        /* Timeline View */
        .timeline-view {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); border: 1px solid var(--glass-border); overflow: hidden;
            margin-bottom: var(--space-4); display: none;
        }
        .timeline-view.visible { display: block; }
        .timeline-container { padding: var(--space-3); }
        .timeline-chart-container { height: 200px; position: relative; margin-bottom: var(--space-3); }
        .timeline-milestones { display: flex; flex-direction: column; gap: var(--space-2); }
        .milestone {
            display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2);
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md); border: 1px solid var(--glass-border);
        }
        @media (prefers-color-scheme: dark) { .milestone { background: rgba(31, 41, 55, 0.5); } }
        .milestone-date { font-family: var(--font-family-mono); font-weight: 600; color: var(--primary);
            font-size: 0.75rem; min-width: 80px; }
        .milestone-label { font-size: 0.75rem; color: var(--text-primary); font-weight: 500; }
        .milestone-value { font-family: var(--font-family-mono); font-weight: 700; color: var(--text-primary);
            margin-left: auto; font-size: 0.75rem; }
        .timeline-summary {
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md); padding: var(--space-3); margin-top: var(--space-3); border: 1px solid var(--glass-border);
        }
        @media (prefers-color-scheme: dark) { .timeline-summary { background: rgba(31, 41, 55, 0.5); } }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: var(--space-2); }
        .summary-item:last-child { margin-bottom: 0; }
        .summary-label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        .summary-value { font-family: var(--font-family-mono); font-weight: 600; color: var(--text-primary); font-size: 0.75rem; }
        
        /* Visualization */
        .chart-container {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: var(--space-3); height: 250px;
            position: relative; margin-bottom: var(--space-3);
        }
        .visualization-section { display: none; }
        .visualization-section.visible { display: block; }
        
        /* Full Study */
        .full-study-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-3); }
        @media (max-width: 640px) { .full-study-inputs { grid-template-columns: 1fr; } }
        
        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: var(--z-modal);
            padding: var(--space-4); animation: fadeIn var(--transition-fast);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-radius: var(--radius-xl);
            width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: slideUp var(--transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (prefers-color-scheme: dark) {
            .modal-content { background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.85));
                border: 1px solid rgba(255, 255, 255, 0.2); }
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { padding: var(--space-4); border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .modal-close {
            width: 28px; height: 28px; border-radius: var(--radius-full); border: none;
            background: rgba(156, 163, 175, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all var(--transition-fast); font-size: 1rem;
        }
        .modal-close:hover { background: rgba(156, 163, 175, 0.3); color: var(--text-primary); transform: rotate(90deg); }
        .modal-body { padding: var(--space-4); }
        .modal-footer { padding: var(--space-3) var(--space-4); border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: flex-end; gap: var(--space-2); }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: var(--z-toast);
            display: flex; flex-direction: column; gap: var(--space-2);
        }
        @media (max-width: 640px) { .toast-container { left: 20px; right: 20px; bottom: 80px; } }
        .toast {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary); max-width: 300px; animation: slideInRight var(--transition-fast);
            display: flex; align-items: flex-start; gap: var(--space-2); border: 1px solid rgba(255, 255, 255, 0.3);
        }
        @media (prefers-color-scheme: dark) {
            .toast { background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
                border: 1px solid rgba(255, 255, 255, 0.2); }
        }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        .toast-icon { font-size: 0.875rem; flex-shrink: 0; margin-top: 2px; }
        .toast-content { flex: 1; }
        .toast-message { font-size: 0.6875rem; color: var(--text-secondary); line-height: 1.4; }
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.error { border-left-color: var(--alert); }
        
        /* Save Indicator */
        .save-indicator {
            position: fixed; bottom: 20px; right: 20px; padding: var(--space-2) var(--space-3);
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); border: 1px solid var(--glass-border); font-size: 0.75rem;
            color: var(--text-secondary); display: flex; align-items: center; gap: var(--space-2);
            z-index: var(--z-toast); opacity: 0; transform: translateY(10px); transition: all var(--transition-fast);
            box-shadow: var(--shadow-md);
        }
        .save-indicator.visible { opacity: 1; transform: translateY(0); }
        .save-indicator.saving { color: var(--warning); }
        .save-indicator.success { color: var(--success); }
        .save-indicator.error { color: var(--alert); }
        
        /* Utility */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: var(--space-2); } .mt-3 { margin-top: var(--space-3); } .mt-4 { margin-top: var(--space-4); }
        .mb-3 { margin-bottom: var(--space-3); } .mb-4 { margin-bottom: var(--space-4); }
        
        /* Visual Toggle */
        .visual-toggle-container { display: flex; align-items: center; gap: var(--space-2); }
        .visual-toggle-label { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; }
        .visual-toggle { position: relative; width: 48px; height: 26px; }
        .visual-toggle input { opacity: 0; width: 0; height: 0; }
        .visual-toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border); transition: .4s; border-radius: 34px;
        }
        .visual-toggle-slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .visual-toggle input:checked + .visual-toggle-slider { background-color: var(--primary); }
        .visual-toggle input:checked + .visual-toggle-slider:before { transform: translateX(22px); }
        
        /* Language Toggle */
        .language-toggle {
            padding: var(--space-1) var(--space-2); border-radius: var(--radius-md); background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            color: var(--text-secondary); font-weight: 600; font-size: 0.75rem; cursor: pointer;
            transition: all var(--transition-fast); text-transform: uppercase;
        }
        .language-toggle:hover { background: var(--primary-light); color: white; border-color: var(--primary); transform: translateY(-1px); }
        
        /* Breadcrumb */
        .breadcrumb {
            padding: var(--space-2) var(--space-4);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .breadcrumb .separator {
            opacity: 0.5;
        }
        
        /* Quick Actions */
        .quick-actions {
            position: fixed;
            bottom: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            z-index: var(--z-sticky);
        }
        
        .quick-action {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-action:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Date Shortcuts */
        .date-shortcuts {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
            margin-top: var(--space-2);
        }
        
        .date-shortcut {
            padding: var(--space-1) var(--space-2);
            background: rgba(26, 95, 122, 0.1);
            border: 1px solid rgba(26, 95, 122, 0.2);
            border-radius: var(--radius-full);
            font-size: 0.6875rem;
            color: var(--primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .date-shortcut:hover {
            background: rgba(26, 95, 122, 0.2);
            transform: translateY(-1px);
        }
        
        /* Protocol Settings Improvements */
        .threshold-setting {
            margin-bottom: var(--space-4);
        }
        
        .threshold-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }
        
        .threshold-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .threshold-level {
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.6875rem;
            font-weight: 600;
        }
        
        .threshold-level.monitor {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .threshold-level.review {
            background: rgba(220, 38, 38, 0.2);
            color: var(--alert);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        .threshold-value {
            font-family: var(--font-family-mono);
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
        }
        
        .threshold-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        
        .threshold-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--success), var(--warning), var(--alert));
            border-radius: var(--radius-full);
            outline: none;
        }
        
        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }
        
        .threshold-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }
        
        .threshold-input {
            width: 60px;
            padding: var(--space-1) var(--space-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-family-mono);
            font-size: 0.875rem;
            text-align: center;
            background: var(--glass-bg);
            color: var(--text-primary);
        }
        
        .threshold-percent {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .threshold-description {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }
        
        .stability-setting {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-top: var(--space-4);
        }
        
        .stability-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .stability-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex-wrap: wrap;
        }
        
        .stability-input-group span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .stability-input {
            width: 50px;
            padding: var(--space-1) var(--space-2);
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: var(--radius-md);
            font-family: var(--font-family-mono);
            font-size: 0.875rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-primary);
        }
        
        /* Tooltips */
        .has-tooltip {
            position: relative;
            border-bottom: 1px dotted var(--primary);
            cursor: help;
        }
        
        .has-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            color: var(--text-primary);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            white-space: normal;
            max-width: 200px;
            width: max-content;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            z-index: var(--z-modal);
            word-wrap: break-word;
        }
        
        /* Data Density */
        .data-density {
            display: flex;
            gap: var(--space-1);
            margin-left: auto;
        }
        
        .density-btn {
            padding: var(--space-1) var(--space-2);
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            border-radius: var(--radius-md);
            font-size: 0.6875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .density-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-logo">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 96 96"
                    fill="none"
                >
                    <path
                        d="M24 56
                           C24 32 38 24 46 30
                           V66
                           C46 74 38 82 28 82
                           C24 82 24 76 24 70
                           Z"
                        stroke="currentColor"
                        stroke-width="4"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                    <path
                        d="M72 56
                           C72 32 58 24 50 30
                           V66
                           C50 74 58 82 68 82
                           C72 82 72 76 72 70
                           Z"
                        stroke="currentColor"
                        stroke-width="4"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                    <line
                        x1="48"
                        y1="16"
                        x2="48"
                        y2="66"
                        stroke="currentColor"
                        stroke-width="4"
                        stroke-linecap="round"
                    />
                    <rect
                        x="42"
                        y="22"
                        width="12"
                        height="26"
                        rx="2"
                        fill="currentColor"
                    />
                    <rect
                        x="40"
                        y="16"
                        width="16"
                        height="6"
                        rx="2"
                        fill="currentColor"
                    />
                    <path
                        d="M40 34
                           Q48 42 56 34"
                        stroke="currentColor"
                        stroke-width="3"
                        stroke-linecap="round"
                        fill="none"
                    />
                    <path
                        d="M48 46
                           C42 44 38 40 36 36"
                        stroke="currentColor"
                        stroke-width="3"
                        stroke-linecap="round"
                    />
                    <path
                        d="M48 46
                           C54 44 58 40 60 36"
                        stroke="currentColor"
                        stroke-width="3"
                        stroke-linecap="round"
                    />
                </svg>
            </div>
            <div class="loading-progress-container">
                <div class="loading-progress-label">
                    <span id="loadingStep">Initializing Spirolite Professional</span>
                    <span id="loadingPercent">0%</span>
                </div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
            </div>
            <div class="loading-text" style="color: white; font-size: 0.75rem; margin-top: var(--space-2); opacity: 0.8;">
                Clinical Lung Function Analysis
            </div>
        </div>
    </div>
    
    <!-- Auto-save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <span class="save-icon"></span>
        <span class="save-text">Saved</span>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header" id="appHeader">
            <div class="header-toggle" id="headerToggle">
                <span class="toggle-icon"></span>
            </div>
            <div class="header-content">
                <div class="app-title">
                    <div class="app-logo" title="Spirolite">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 96 96"
                            fill="none"
                        >
                            <path
                                d="M24 56
                                   C24 32 38 24 46 30
                                   V66
                                   C46 74 38 82 28 82
                                   C24 82 24 76 24 70
                                   Z"
                                stroke="currentColor"
                                stroke-width="4"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                            <path
                                d="M72 56
                                   C72 32 58 24 50 30
                                   V66
                                   C50 74 58 82 68 82
                                   C72 82 72 76 72 70
                                   Z"
                                stroke="currentColor"
                                stroke-width="4"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                            <line
                                x1="48"
                                y1="16"
                                x2="48"
                                y2="66"
                                stroke="currentColor"
                                stroke-width="4"
                                stroke-linecap="round"
                            />
                            <rect
                                x="42"
                                y="22"
                                width="12"
                                height="26"
                                rx="2"
                                fill="currentColor"
                            />
                            <rect
                                x="40"
                                y="16"
                                width="16"
                                height="6"
                                rx="2"
                                fill="currentColor"
                            />
                            <path
                                d="M40 34
                                   Q48 42 56 34"
                                stroke="currentColor"
                                stroke-width="3"
                                stroke-linecap="round"
                                fill="none"
                            />
                            <path
                                d="M48 46
                                   C42 44 38 40 36 36"
                                stroke="currentColor"
                                stroke-width="3"
                                stroke-linecap="round"
                            />
                            <path
                                d="M48 46
                                   C54 44 58 40 60 36"
                                stroke="currentColor"
                                stroke-width="3"
                                stroke-linecap="round"
                            />
                        </svg>
                    </div>
                    <div class="app-name">
                        <h1><span class="spiro">Spiro</span><span class="lite">lite</span></h1>
                        <span>Calculate & Track</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="undo-redo-container">
                        <button class="undo-btn" id="undoBtn" title="Undo (Ctrl+Z)" disabled>
                            <span></span>
                        </button>
                        <button class="redo-btn" id="redoBtn" title="Redo (Ctrl+Y)" disabled>
                            <span></span>
                        </button>
                    </div>
                    <button class="header-btn" id="protocolSettingsBtn" title="Protocol Settings">
                        <span></span>
                    </button>
                    <button class="header-btn" id="exportBtn" title="Export All Data">
                        <span></span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Breadcrumb -->
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" data-mode="quick" id="breadcrumbQuick">Quick Calc</a>
            <span class="separator"></span>
            <span class="current" id="breadcrumbPatient">Select Patient</span>
        </div>
        
        <!-- Patient Bar -->
        <div class="patient-bar" id="patientBar">
            <div class="patient-info-compact">
                <div class="patient-id-display">
                    <div class="patient-avatar-small" id="patientAvatar">--</div>
                    <div class="patient-meta-compact">
                        <div class="primary" id="patientIdDisplay">Select Patient</div>
                        <div class="secondary">
                            <span id="patientStatusBadge">No data</span>
                            <span></span>
                            <span id="visitsCountCompact">0 visits</span>
                        </div>
                    </div>
                </div>
                <div class="patient-actions-compact">
                    <div class="tx-date-indicator" id="txDateIndicator">
                        <span class="tx-icon"></span>
                        <span id="txDateDisplay">No TX date</span>
                    </div>
                    <button class="header-btn small" id="newPatientBtn" title="New Patient">
                        <span></span>
                    </button>
                    <button class="header-btn small" id="patientListBtn" title="Patient List">
                        <span></span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="app-navigation" id="appNavigation">
            <button class="nav-btn active" data-mode="quick">
                <span class="nav-icon"></span>
                <span>Quick Calc</span>
            </button>
            <button class="nav-btn" data-mode="monitor">
                <span class="nav-icon"></span>
                <span>Monitor</span>
            </button>
            <button class="nav-btn" data-mode="full">
                <span class="nav-icon"></span>
                <span>Full Study</span>
            </button>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Calc Mode -->
            <div id="modeQuick" class="mode-section active">
                <div class="calculator-card">
                    <div class="section-title">
                        <span>Quick Calculation</span>
                        <span class="badge" id="quickPatientBadge">No Patient</span>
                    </div>
                    
                    <div class="measurement-inputs">
                        <div class="input-group">
                            <div class="input-label">
                                <span class="has-tooltip" data-tooltip="Forced Expiratory Volume in 1 second">FEV</span>
                                <span class="input-help">Forced Expiratory Volume in 1 second</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="8.0" class="measurement-input" 
                                       id="inputFev1" placeholder="2.85" autofocus required>
                                <span class="input-unit">L</span>
                            </div>
                            <div class="validation-message" id="fev1Validation"></div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-label">
                                <span class="has-tooltip" data-tooltip="Forced Vital Capacity">FVC</span>
                                <span class="input-help">Forced Vital Capacity (optional)</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="10.0" class="measurement-input" 
                                       id="inputFvc" placeholder="3.40">
                                <span class="input-unit">L</span>
                            </div>
                            <div class="validation-message" id="fvcValidation"></div>
                        </div>
                    </div>
                    
                    <!-- Date Input -->
                    <div class="input-group">
                        <div class="input-label">Measurement Date</div>
                        <input type="date" class="measurement-input" id="quickDate" value="">
                        <div class="date-shortcuts">
                            <button class="date-shortcut" data-offset="-7">1 week ago</button>
                            <button class="date-shortcut" data-offset="-30">1 month ago</button>
                            <button class="date-shortcut" data-offset="-90">3 months ago</button>
                            <button class="date-shortcut" data-offset="0">Today</button>
                        </div>
                    </div>
                    
                    <!-- Comparison Selector -->
                    <div class="comparison-selector">
                        <div class="comparison-title"> Comparison Reference</div>
                        <div class="comparison-options">
                            <label class="comparison-option" id="optionNone">
                                <input type="radio" name="comparison" class="option-radio" value="none" checked>
                                <div class="option-content">
                                    <div class="option-label">Current values only</div>
                                    <div class="option-note">Show raw measurements</div>
                                </div>
                            </label>
                            
                            <label class="comparison-option" id="optionBaseline">
                                <input type="radio" name="comparison" class="option-radio" value="baseline">
                                <div class="option-content">
                                    <div class="option-label">vs Baseline</div>
                                    <input type="number" step="0.01" class="option-input" id="baselineInput" placeholder="Baseline FEV (L)">
                                    <div class="option-note">Compare to baseline value</div>
                                </div>
                            </label>
                            
                            <label class="comparison-option" id="optionLast">
                                <input type="radio" name="comparison" class="option-radio" value="last">
                                <div class="option-content">
                                    <div class="option-label">vs Last Visit</div>
                                    <div class="option-note" id="lastVisitNote">No previous visits</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel" id="resultsPanel">
                    <div class="results-header">
                        <div class="results-title">Objective Measurements</div>
                        <div class="results-timestamp" id="resultsTimestamp"></div>
                    </div>
                    
                    <div class="current-measurements">
                        <div class="measurements-grid">
                            <div class="measurement-card">
                                <span class="measurement-label">FEV</span>
                                <div class="value-with-percent">
                                    <div class="primary-value" id="resultFev1Liters">--</div>
                                    <div class="percent-display neutral" id="resultFev1Percent">--%</div>
                                </div>
                                <span class="measurement-unit">Liters (Percentage)</span>
                            </div>
                            <div class="measurement-card">
                                <span class="measurement-label">FVC</span>
                                <div class="primary-value" id="resultFvc">--</div>
                                <span class="measurement-unit">Liters</span>
                            </div>
                            <div class="measurement-card">
                                <span class="measurement-label">FEV/FVC Ratio</span>
                                <div class="primary-value" id="resultRatio">--</div>
                                <span class="measurement-unit">Percentage</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-results hidden" id="comparisonResults">
                        <div class="comparison-header">
                            <div class="comparison-title">Comparison Analysis</div>
                            <div class="comparison-subtitle" id="comparisonSubtitle"></div>
                        </div>
                        
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">
                                    <span class="trend-arrow" id="visitTrendArrow"></span>
                                    <span> from Last Visit</span>
                                </span>
                                <span class="metric-value visit-change neutral" id="resultVisitDelta">--</span>
                                <span class="metric-unit" id="resultVisitPercent">--%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">
                                    <span class="trend-arrow" id="baselineTrendArrow"></span>
                                    <span>% of Baseline</span>
                                </span>
                                <span class="metric-value baseline-percent neutral" id="resultBaselinePercent">--%</span>
                                <span class="metric-unit" id="resultBaselineDelta">-- L</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-results hidden" id="timeContext">
                        <div class="comparison-header">
                            <div class="comparison-title">Time Context</div>
                        </div>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Days post-Tx</span>
                                <span class="metric-value" id="daysPostTx">--</span>
                                <span class="metric-unit" id="yearsPostTx">--</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Since last visit</span>
                                <span class="metric-value" id="daysSinceLast">--</span>
                                <span class="metric-unit" id="monthsSinceLast">--</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Rate of change</span>
                                <span class="metric-value visit-change neutral" id="rateOfChange">--</span>
                                <span class="metric-unit">L/month</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="protocol-context hidden" id="protocolContext">
                        <div class="protocol-header">
                            <div class="protocol-title"> Protocol Context</div>
                            <div class="threshold-display">
                                <div class="threshold-badge monitor">Monitor <span id="thresholdMonitorValue">10</span>%</div>
                                <div class="threshold-badge review">Review <span id="thresholdReviewValue">20</span>%</div>
                            </div>
                        </div>
                        <div class="protocol-note" id="protocolNote">
                            Using protocol thresholds for clinical context.
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearQuickBtn">
                        <span></span>
                        <span>Clear</span>
                    </button>
                    <button class="action-btn primary" id="calculateQuickBtn">
                        <span></span>
                        <span>Calculate</span>
                    </button>
                </div>
            </div>
            
            <!-- Monitor Mode -->
            <div id="modeMonitor" class="mode-section">
                <div class="calculator-card">
                    <div class="monitor-header">
                        <div class="section-title">
                            <span>First Year Monitoring</span>
                            <span class="badge" id="monitorPatientBadge">No Patient</span>
                        </div>
                        
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-view="table">
                                <span> Table</span>
                            </button>
                            <button class="view-toggle-btn" data-view="timeline">
                                <span> Timeline</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Baseline Control -->
                    <div class="baseline-control">
                        <div class="input-label">
                            <span>Baseline FEV</span>
                            <span class="input-help">Set or update manually</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2); flex: 1;">
                            <input type="number" step="0.01" min="0.5" max="8.0" class="measurement-input compact" 
                                   id="manualBaselineInput" placeholder="Enter baseline FEV" style="flex: 1;">
                            <button class="baseline-set-btn" id="setBaselineBtn" disabled>
                                <span></span>
                                <span>Set</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Data Entry Mode Selector -->
                    <div class="entry-mode-selector" id="entryModeSelector">
                        <div class="entry-mode-card active" data-mode="single">
                            <div class="entry-mode-icon"></div>
                            <div class="entry-mode-title">Single Entry</div>
                            <div class="entry-mode-desc">Enter one visit at a time</div>
                        </div>
                        <div class="entry-mode-card" data-mode="bulk">
                            <div class="entry-mode-icon"></div>
                            <div class="entry-mode-title">Bulk Import</div>
                            <div class="entry-mode-desc">Paste multiple visits</div>
                        </div>
                        <div class="entry-mode-card" data-mode="spreadsheet">
                            <div class="entry-mode-icon"></div>
                            <div class="entry-mode-title">Spreadsheet</div>
                            <div class="entry-mode-desc">Table-style data entry</div>
                        </div>
                    </div>
                    
                    <!-- Single Entry Form -->
                    <div class="visit-entry-form" id="singleEntryForm">
                        <div class="input-label">
                            <span>Add Visit</span>
                            <span class="input-help">Enter spirometry measurements</span>
                        </div>
                        <div class="form-row">
                            <div style="flex: 1; min-width: 120px;">
                                <input type="date" class="date-input" id="visitDate" required>
                                <div class="date-warning hidden" id="dateIntervalWarning"></div>
                            </div>
                            <input type="number" step="0.01" min="0.5" max="8.0" class="measurement-input compact" 
                                   id="visitFev1" placeholder="FEV (L)" required>
                            <input type="number" step="0.01" min="0.5" max="10.0" class="measurement-input compact" 
                                   id="visitFvc" placeholder="FVC (L)">
                            <button class="header-btn" id="addVisitBtn" title="Add Visit">
                                <span></span>
                            </button>
                        </div>
                        
                        <div class="date-shortcuts">
                            <button class="date-shortcut" data-offset="-7">1 week ago</button>
                            <button class="date-shortcut" data-offset="-30">1 month ago</button>
                            <button class="date-shortcut" data-offset="-90">3 months ago</button>
                            <button class="date-shortcut" data-offset="0">Today</button>
                        </div>
                        
                        <div class="mt-3">
                            <div class="input-label">
                                <span>Clinical Notes (Optional)</span>
                                <span class="input-help">Symptoms, medications, context</span>
                            </div>
                            <textarea class="clinical-notes-input" id="visitNotes" 
                                      placeholder="e.g., Recent URI, increased prednisone dose, feeling well..."></textarea>
                            <div class="notes-hint">Notes will appear as tooltips in the table</div>
                        </div>
                    </div>
                    
                    <!-- Bulk Import Form -->
                    <div class="visit-entry-form hidden" id="bulkEntryForm">
                        <div class="input-label">
                            <span>Bulk Import</span>
                            <span class="input-help">Paste multiple visits at once</span>
                        </div>
                        <textarea class="bulk-textarea" id="bulkImport" 
                                  placeholder="Format: YYYY-MM-DD, FEV1, FVC (optional), NOTES (optional)
Example:
2024-01-15, 2.85, 3.40, Doing well
2024-03-10, 3.10, 3.80, Post-antibiotics"></textarea>
                        <button class="action-btn secondary mt-2" id="importBulkBtn" style="width: 100%;">
                            <span></span>
                            <span>Import Visits</span>
                        </button>
                    </div>
                    
                    <!-- Spreadsheet Form -->
                    <div class="visit-entry-form hidden" id="spreadsheetEntryForm">
                        <div class="input-label">
                            <span>Spreadsheet Entry</span>
                            <span class="input-help">Click cells to edit, Tab to navigate</span>
                        </div>
                        <table class="spreadsheet-table" id="spreadsheetTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>FEV (L)</th>
                                    <th>FVC (L)</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="spreadsheetBody">
                                <tr>
                                    <td class="editable-cell" contenteditable="true" data-field="date"></td>
                                    <td class="editable-cell" contenteditable="true" data-field="fev1"></td>
                                    <td class="editable-cell" contenteditable="true" data-field="fvc"></td>
                                    <td class="editable-cell" contenteditable="true" data-field="notes"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="action-bar mt-3" style="border-top: none; margin-top: var(--space-2); padding-top: 0;">
                            <button class="action-btn secondary" id="addSpreadsheetRowBtn">
                                <span></span>
                                <span>Add Row</span>
                            </button>
                            <button class="action-btn primary" id="saveSpreadsheetBtn">
                                <span></span>
                                <span>Save All</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="visits-table-container visible" id="tableView">
                        <div class="table-header">
                            <span style="font-weight: 600; font-size: 0.75rem;">Visit History</span>
                            <div style="display: flex; gap: var(--space-2); align-items: center;">
                                <div class="data-density">
                                    <button class="density-btn active" data-density="compact">Compact</button>
                                    <button class="density-btn" data-density="detailed">Detailed</button>
                                    <button class="density-btn" data-density="summary">Summary</button>
                                </div>
                                <div class="visual-toggle-container">
                                    <label class="visual-toggle" title="Toggle color coding">
                                        <input type="checkbox" id="colorCodingToggle" checked>
                                        <span class="visual-toggle-slider"></span>
                                    </label>
                                    <span class="visual-toggle-label">Colors</span>
                                </div>
                                <button class="header-btn small" id="togglePercentageView" title="Toggle percentage view">
                                    <span>%</span>
                                </button>
                                <button class="language-toggle" id="languageToggle" title="Switch language">
                                    EN
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="medical-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Days</th>
                                        <th>FEV (L)</th>
                                        <th class="has-tooltip" data-tooltip="Percentage of Baseline">% of PB</th>
                                        <th>FVC</th>
                                        <th>Ratio</th>
                                        <th> Visit</th>
                                        <th> Baseline</th>
                                        <th>Rate</th>
                                        <th class="alert-cell">Alert</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody">
                                    <tr>
                                        <td colspan="11" class="text-center" style="padding: var(--space-4); color: var(--text-tertiary);">
                                            No visits yet. Add visits using the form above.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Timeline View -->
                    <div class="timeline-view" id="timelineView">
                        <div class="table-header">
                            <span style="font-weight: 600; font-size: 0.75rem;">Patient Timeline</span>
                            <div style="display: flex; gap: var(--space-2);">
                                <button class="header-btn small" id="exportTimelineBtn" title="Export Timeline">
                                    <span></span>
                                </button>
                            </div>
                        </div>
                        <div class="timeline-container">
                            <div class="timeline-chart-container">
                                <canvas id="timelineChart"></canvas>
                            </div>
                            <div class="timeline-milestones" id="timelineMilestones"></div>
                            <div class="timeline-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total Visits:</span>
                                    <span class="summary-value" id="timelineTotalVisits">0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Time Span:</span>
                                    <span class="summary-value" id="timelineTimeSpan">--</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Average Interval:</span>
                                    <span class="summary-value" id="timelineAvgInterval">--</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Current Status:</span>
                                    <span class="summary-value" id="timelineStatus">No data</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visualization Section -->
                    <div class="visualization-section hidden" id="visualizationSection">
                        <div class="section-title mt-3">
                            <span>Trend Visualization</span>
                            <span class="badge">Interactive</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="fev1Chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Monitor Actions -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearMonitorBtn">
                        <span></span>
                        <span>Clear Table</span>
                    </button>
                    <button class="action-btn primary" id="exportPDFBtn">
                        <span></span>
                        <span>Export PDF Report</span>
                    </button>
                    <button class="action-btn secondary" id="toggleVisualizationBtn">
                        <span></span>
                        <span>Show Charts</span>
                    </button>
                </div>
            </div>
            
            <!-- Full Study Mode -->
            <div id="modeFull" class="mode-section">
                <div class="calculator-card">
                    <div class="section-title">
                        <span>Full Patient Study</span>
                        <span class="badge" id="fullPatientBadge">No Patient</span>
                    </div>
                    
                    <!-- Timeline Setup -->
                    <div class="visit-entry-form">
                        <div class="input-label">Patient Timeline</div>
                        <div class="form-row">
                            <div style="flex: 1;">
                                <div class="input-label" style="margin-bottom: var(--space-1); font-size: 0.6875rem;">Transplant Date</div>
                                <input type="date" class="date-input" id="txDate" required>
                            </div>
                            <div style="flex: 1;">
                                <div class="input-label" style="margin-bottom: var(--space-1); font-size: 0.6875rem;">Baseline Established</div>
                                <input type="date" class="date-input" id="baselineDate">
                            </div>
                        </div>
                        <div class="date-shortcuts">
                            <button class="date-shortcut" data-offset="-365">1 year ago</button>
                            <button class="date-shortcut" data-offset="-730">2 years ago</button>
                            <button class="date-shortcut" data-offset="-1095">3 years ago</button>
                            <button class="date-shortcut" data-offset="0">Today</button>
                        </div>
                    </div>
                    
                    <!-- Spirometry Inputs -->
                    <div class="full-study-inputs">
                        <div class="input-group">
                            <div class="input-label">Current FEV</div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="8.0" class="measurement-input" 
                                       id="stdFev1" placeholder="Enter FEV" required>
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">Baseline FEV</div>
                            <div class="input-wrapper">
                                <input type="number" step="0.01" min="0.5" max="8.0" class="measurement-input" 
                                       id="stdBaselineFev1" placeholder="Enter baseline" required>
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clinical Notes -->
                    <div class="input-group">
                        <div class="input-label">Clinical Context</div>
                        <textarea class="bulk-textarea" id="clinicalNotes"
                                  placeholder="Enter clinical context, symptoms, medications, or other relevant information..."></textarea>
                        <div class="notes-hint">Optional: For your reference only</div>
                    </div>
                </div>
                
                <!-- Full Study Results -->
                <div class="results-panel" id="stdResultsPanel">
                    <div class="results-header">
                        <div class="results-title">Comprehensive Analysis</div>
                        <div class="results-timestamp" id="stdResultsTimestamp"></div>
                    </div>
                    
                    <div class="current-measurements">
                        <div class="measurements-grid">
                            <div class="measurement-card">
                                <span class="measurement-label">Current FEV</span>
                                <div class="value-with-percent">
                                    <div class="primary-value" id="stdCurrentFev1">--</div>
                                    <div class="percent-display neutral" id="stdCurrentPercent">--%</div>
                                </div>
                                <span class="measurement-unit">Liters (Percentage)</span>
                            </div>
                            <div class="measurement-card">
                                <span class="measurement-label">Baseline</span>
                                <div class="primary-value" id="stdBaseline">--</div>
                                <span class="measurement-unit">Liters</span>
                            </div>
                            <div class="measurement-card">
                                <span class="measurement-label">Time Period</span>
                                <div class="primary-value" id="stdTimePeriod">--</div>
                                <span class="measurement-unit">Days</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-results">
                        <div class="comparison-header">
                            <div class="comparison-title">Baseline Comparison</div>
                            <div class="comparison-subtitle" id="stdComparisonSubtitle"></div>
                        </div>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Cumulative Change</span>
                                <span class="metric-value visit-change neutral" id="stdCumulativeDelta">--</span>
                                <span class="metric-unit">L</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Percentage Change</span>
                                <span class="metric-value baseline-percent neutral" id="stdPercentDecline">--%</span>
                                <span class="metric-unit">%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Monthly Rate</span>
                                <span class="metric-value visit-change neutral" id="stdMonthlyRate">--</span>
                                <span class="metric-unit">L/month <span id="stdRateArrow"></span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="protocol-context">
                        <div class="protocol-header">
                            <div class="protocol-title"> Long-term Trend</div>
                        </div>
                        <div class="protocol-note" id="stdProtocolNote">
                            Using protocol thresholds for clinical context.
                        </div>
                    </div>
                </div>
                
                <!-- Full Study Actions -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearStdBtn">
                        <span></span>
                        <span>Clear All</span>
                    </button>
                    <button class="action-btn primary" id="saveStudyBtn">
                        <span></span>
                        <span>Save Full Study</span>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Floating Quick Actions -->
    <div class="quick-actions" id="quickActions">
        <button class="quick-action" data-action="new-visit" title="New Visit">
            <span></span>
        </button>
        <button class="quick-action" data-action="calculate" title="Calculate">
            <span></span>
        </button>
        <button class="quick-action" data-action="export" title="Export">
            <span></span>
        </button>
        <button class="quick-action" data-action="settings" title="Settings">
            <span></span>
        </button>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Protocol Settings Modal -->
    <div class="modal-overlay" id="protocolModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Protocol Settings</div>
                <button class="modal-close" id="closeProtocolModal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="protocol-settings">
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-3); font-size: 0.75rem;">
                        Set clinical thresholds for decline monitoring. Adjust based on your protocol requirements.
                    </p>
                    
                    <div class="threshold-setting">
                        <div class="threshold-header">
                            <div class="threshold-label">
                                <span>Monitor Threshold</span>
                                <span class="threshold-level monitor">Monitor</span>
                            </div>
                            <div class="threshold-value" id="monitorValue">10%</div>
                        </div>
                        <div class="threshold-input-group">
                            <input type="range" min="5" max="25" step="1" value="10" class="threshold-slider" 
                                   id="monitorSlider">
                            <input type="number" min="5" max="25" step="1" value="10" class="threshold-input" 
                                   id="monitorInput">
                            <span class="threshold-percent">%</span>
                        </div>
                        <div class="threshold-description">
                            Show monitor alert at this decline from baseline
                        </div>
                    </div>
                    
                    <div class="threshold-setting">
                        <div class="threshold-header">
                            <div class="threshold-label">
                                <span>Review Threshold</span>
                                <span class="threshold-level review">Review</span>
                            </div>
                            <div class="threshold-value" id="reviewValue">20%</div>
                        </div>
                        <div class="threshold-input-group">
                            <input type="range" min="10" max="40" step="1" value="20" class="threshold-slider" 
                                   id="reviewSlider">
                            <input type="number" min="10" max="40" step="1" value="20" class="threshold-input" 
                                   id="reviewInput">
                            <span class="threshold-percent">%</span>
                        </div>
                        <div class="threshold-description">
                            Show review alert at this decline from baseline
                        </div>
                    </div>
                    
                    <div class="stability-setting">
                        <div class="stability-label">
                            <span>Stability Criteria</span>
                            <span class="threshold-level" style="background: rgba(5, 150, 105, 0.2); color: var(--success); border: 1px solid rgba(5, 150, 105, 0.3);">Stable</span>
                        </div>
                        <div class="stability-input-group">
                            <span>Last</span>
                            <input type="number" min="3" max="8" step="1" value="4" class="stability-input" 
                                   id="stabilityVisits">
                            <span>visits with variation </span>
                            <input type="number" min="1" max="15" step="1" value="5" class="stability-input" 
                                   id="stabilityThreshold">
                            <span class="threshold-percent">%</span>
                        </div>
                        <div class="threshold-description">
                            Auto-suggest baseline after stable period detected
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="resetProtocolBtn">
                    <span></span>
                    <span>Reset Defaults</span>
                </button>
                <button class="action-btn primary" id="saveProtocolBtn">
                    <span></span>
                    <span>Save Protocol</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- New Patient Modal -->
    <div class="modal-overlay" id="newPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Patient</div>
                <button class="modal-close" id="closeNewPatientModal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <div class="input-label">Patient ID</div>
                    <input type="text" class="measurement-input compact" id="newPatientId"
                           placeholder="PT001" autofocus required pattern="[A-Za-z0-9]{3,10}">
                </div>
                <div class="input-group mb-3">
                    <div class="input-label">Transplant Date</div>
                    <input type="date" class="date-input" id="newTxDate" required>
                    <div class="validation-message" id="txDateValidation"></div>
                </div>
                <div class="input-group">
                    <div class="input-label">Description (Optional)</div>
                    <input type="text" class="measurement-input compact" id="newPatientDesc"
                           placeholder="e.g., Bilateral lung transplant">
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelNewPatientBtn">
                    <span></span>
                    <span>Cancel</span>
                </button>
                <button class="action-btn primary" id="createPatientBtn">
                    <span></span>
                    <span>Create Patient</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Patient List Modal -->
    <div class="modal-overlay" id="patientListModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Select Patient</div>
                <button class="modal-close" id="closePatientListModal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div id="patientList">
                    <div class="empty-state" style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">
                        <div style="font-size: 2rem; margin-bottom: var(--space-2);"></div>
                        <p>No patients yet</p>
                        <p class="notes-hint mt-2">Create your first patient to get started</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn primary" id="addNewPatientBtn">
                    <span></span>
                    <span>Add New Patient</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Baseline Conflict Modal -->
    <div class="modal-overlay" id="baselineConflictModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span></span> <span>Baseline Conflict</span>
                </div>
                <button class="modal-close" id="closeBaselineConflictModal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--space-3);">
                    <p id="baselineConflictMessage">Current patient has a different baseline. Which baseline would you like to use?</p>
                    <div class="current-measurements" style="margin: var(--space-3) 0;">
                        <div style="display: flex; gap: var(--space-3);">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Patient Baseline</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--primary);" 
                                     id="patientBaselineValue">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px;">From patient record</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Entered Baseline</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--secondary);" 
                                     id="enteredBaselineValue">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px;">From input field</div>
                            </div>
                        </div>
                    </div>
                    <div class="notes-hint" style="font-size: 0.6875rem; color: var(--text-tertiary);">
                        The selected baseline will be used for this calculation only.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="usePatientBaselineBtn">
                    <span></span>
                    <span>Use Patient Baseline</span>
                </button>
                <button class="action-btn secondary" id="useEnteredBaselineBtn">
                    <span></span>
                    <span>Use Entered Baseline</span>
                </button>
                <button class="action-btn primary" id="updatePatientBaselineBtn">
                    <span></span>
                    <span>Update Patient Record</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Duplicate Date Warning Modal -->
    <div class="modal-overlay" id="duplicateDateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><span></span> <span>Visit Already Exists</span></div>
                <button class="modal-close" id="closeDuplicateModal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--space-3);">
                    <p id="duplicateDateMessage"></p>
                    <div class="current-measurements" style="margin: var(--space-2) 0;">
                        <div style="display: flex; gap: var(--space-3);">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Existing FEV</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--primary);" 
                                     id="existingFev1">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Existing FVC</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--secondary);" 
                                     id="existingFvc">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="input-label">New Measurement</div>
                        <div style="display: flex; gap: var(--space-3); margin-top: var(--space-2);">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">New FEV</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--primary);" 
                                     id="newFev1">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">New FVC</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--secondary);" 
                                     id="newFvc">--</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notes-hint" style="font-size: 0.6875rem; color: var(--text-tertiary);">
                    What would you like to do?
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelDuplicateBtn">
                    <span></span>
                    <span>Cancel</span>
                </button>
                <button class="action-btn secondary" id="addAsNewBtn">
                    <span></span>
                    <span>Add as New Entry</span>
                </button>
                <button class="action-btn primary" id="replaceExistingBtn">
                    <span></span>
                    <span>Replace Existing</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Baseline Change Confirmation Modal -->
    <div class="modal-overlay" id="baselineChangeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><span></span> <span>Baseline Change Confirmation</span></div>
                <button class="modal-close" id="closeBaselineChangeModal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--space-3);">
                    <p style="margin-bottom: var(--space-3);">This affects ALL historical percentages!</p>
                    <div class="current-measurements" style="margin: var(--space-3) 0;">
                        <div style="display: flex; gap: var(--space-3);">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Previous</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--alert);" 
                                     id="previousBaselineValue">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px;" 
                                     id="previousBaselineDate">--</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">New</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--success);" 
                                     id="newBaselineValue">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px;">Today</div>
                            </div>
                        </div>
                    </div>
                    <div class="notes-hint" style="font-size: 0.6875rem; color: var(--text-tertiary);">
                        This change will recalculate all historical percentages.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelBaselineChangeBtn">
                    <span></span>
                    <span>Cancel</span>
                </button>
                <button class="action-btn secondary" id="keepOldBaselineBtn">
                    <span></span>
                    <span>Keep Old</span>
                </button>
                <button class="action-btn primary" id="updateAllBaselineBtn">
                    <span></span>
                    <span>Update All</span>
                </button>
            </div>
        </div>
    </div>
    
   <script>
// Complete JavaScript implementation for Spirolite Professional
class HistoryManager {
    constructor() {
        this.stack = [];
        this.index = -1;
        this.maxSize = 50;
    }
    
    push(state, action) {
        if (this.index < this.stack.length - 1) {
            this.stack = this.stack.slice(0, this.index + 1);
        }
        
        this.stack.push({
            state: JSON.parse(JSON.stringify(state)),
            action,
            timestamp: Date.now()
        });
        
        if (this.stack.length > this.maxSize) {
            this.stack.shift();
        }
        
        this.index = this.stack.length - 1;
    }
    
    canUndo() { return this.index > 0; }
    canRedo() { return this.index < this.stack.length - 1; }
    
    undo() {
        if (this.canUndo()) {
            this.index--;
            return this.stack[this.index];
        }
        return null;
    }
    
    redo() {
        if (this.canRedo()) {
            this.index++;
            return this.stack[this.index];
        }
        return null;
    }
}

class SpiroliteApp {
    constructor() {
        this.state = {
            mode: 'quick',
            language: 'en',
            protocol: {
                monitor: 10,
                review: 20,
                stabilityVisits: 4,
                stabilityThreshold: 5
            },
            colorCoding: true,
            percentageView: true,
            currentPatient: null,
            patients: new Map(),
            session: {
                quick: {
                    fev1: null,
                    fvc: null,
                    comparison: 'none',
                    baseline: null,
                    baselineSource: null,
                    lastVisit: null
                },
                full: {
                    txDate: null,
                    baselineDate: null,
                    fev1: null,
                    baselineFev1: null,
                    notes: ''
                },
                monitor: {
                    view: 'table',
                    visits: [],
                    entryMode: 'single'
                },
                duplicateDateData: null,
                baselineConflictData: null,
                baselineChangeData: null
            },
            uiCollapsed: false
        };
        
        this.history = new HistoryManager();
        this.dom = {};
        this.charts = {};
        this.undoActions = new Map();
        this.init();
    }
    
    async init() {
        this.showLoading('Initializing Spirolite Professional', 0);
        await this.cacheDOM();
        this.setupEventListeners();
        
        const loadingSteps = [
            { text: 'Loading application core...', percent: 25 },
            { text: 'Preparing clinical tools...', percent: 50 },
            { text: 'Configuring calculations...', percent: 75 },
            { text: 'Ready for clinical use', percent: 100 }
        ];
        
        let step = 0;
        const loadInterval = setInterval(() => {
            if (step < loadingSteps.length) {
                this.updateLoading(loadingSteps[step].text, loadingSteps[step].percent);
                step++;
            } else {
                clearInterval(loadInterval);
                setTimeout(() => {
                    this.hideLoading();
                    this.showToast('Spirolite Professional ready', 'success');
                }, 500);
            }
        }, 600);
        
        this.setViewportHeight();
        this.loadState();
        this.updateUI();
        
        const today = new Date().toISOString().split('T')[0];
        this.dom.visitDate.value = today;
        this.dom.visitDate.max = today;
        this.dom.quickDate.value = today;
        
        this.initPWA();
    }
    
    async initPWA() {
        if ('serviceWorker' in navigator) {
            try {
                await navigator.serviceWorker.register('sw.js?v=1.4', {
                    scope: './',
                    updateViaCache: 'none'
                });
            } catch (error) {
                console.error('Service Worker registration failed:', error);
            }
        }
    }
    
    // === LOADING AND INITIALIZATION ===
    
    updateLoading(text, percent) {
        const loadingStep = document.getElementById('loadingStep');
        const loadingPercent = document.getElementById('loadingPercent');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        if (loadingStep) loadingStep.textContent = text;
        if (loadingPercent) loadingPercent.textContent = `${percent}%`;
        if (loadingProgressBar) loadingProgressBar.style.width = `${percent}%`;
    }
    
    showLoading(text, percent) {
        const loadingOverlay = document.getElementById('loadingOverlay');
        this.updateLoading(text, percent);
        loadingOverlay.style.display = 'flex';
        document.body.classList.add('loading');
    }
    
    hideLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const appContainer = document.getElementById('appContainer');
        
        loadingOverlay.classList.add('fade-out');
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            appContainer.classList.add('loaded');
            document.body.classList.remove('loading');
        }, 300);
    }
    
    setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        
        window.addEventListener('resize', () => {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });
    }
    
    async cacheDOM() {
        // Loading elements
        this.dom.loadingOverlay = document.getElementById('loadingOverlay');
        this.dom.appContainer = document.getElementById('appContainer');
        
        // Header elements
        this.dom.appHeader = document.getElementById('appHeader');
        this.dom.patientBar = document.getElementById('patientBar');
        this.dom.appNavigation = document.getElementById('appNavigation');
        this.dom.headerToggle = document.getElementById('headerToggle');
        
        // Header actions
        this.dom.undoBtn = document.getElementById('undoBtn');
        this.dom.redoBtn = document.getElementById('redoBtn');
        this.dom.protocolSettingsBtn = document.getElementById('protocolSettingsBtn');
        this.dom.exportBtn = document.getElementById('exportBtn');
        this.dom.colorCodingToggle = document.getElementById('colorCodingToggle');
        this.dom.languageToggle = document.getElementById('languageToggle');
        
        // Breadcrumb
        this.dom.breadcrumb = document.getElementById('breadcrumb');
        this.dom.breadcrumbQuick = document.getElementById('breadcrumbQuick');
        this.dom.breadcrumbPatient = document.getElementById('breadcrumbPatient');
        
        // Patient context
        this.dom.patientAvatar = document.getElementById('patientAvatar');
        this.dom.patientIdDisplay = document.getElementById('patientIdDisplay');
        this.dom.patientStatusBadge = document.getElementById('patientStatusBadge');
        this.dom.visitsCountCompact = document.getElementById('visitsCountCompact');
        this.dom.txDateIndicator = document.getElementById('txDateIndicator');
        this.dom.txDateDisplay = document.getElementById('txDateDisplay');
        this.dom.newPatientBtn = document.getElementById('newPatientBtn');
        this.dom.patientListBtn = document.getElementById('patientListBtn');
        
        // Navigation
        this.dom.navBtns = document.querySelectorAll('.nav-btn');
        
        // Quick mode
        this.dom.modeQuick = document.getElementById('modeQuick');
        this.dom.quickPatientBadge = document.getElementById('quickPatientBadge');
        this.dom.inputFev1 = document.getElementById('inputFev1');
        this.dom.inputFvc = document.getElementById('inputFvc');
        this.dom.fev1Validation = document.getElementById('fev1Validation');
        this.dom.fvcValidation = document.getElementById('fvcValidation');
        this.dom.quickDate = document.getElementById('quickDate');
        this.dom.optionNone = document.getElementById('optionNone');
        this.dom.optionBaseline = document.getElementById('optionBaseline');
        this.dom.optionLast = document.getElementById('optionLast');
        this.dom.baselineInput = document.getElementById('baselineInput');
        this.dom.lastVisitNote = document.getElementById('lastVisitNote');
        
        // Quick results
        this.dom.resultsPanel = document.getElementById('resultsPanel');
        this.dom.resultsTimestamp = document.getElementById('resultsTimestamp');
        this.dom.resultFev1Liters = document.getElementById('resultFev1Liters');
        this.dom.resultFev1Percent = document.getElementById('resultFev1Percent');
        this.dom.resultFvc = document.getElementById('resultFvc');
        this.dom.resultRatio = document.getElementById('resultRatio');
        this.dom.comparisonResults = document.getElementById('comparisonResults');
        this.dom.comparisonSubtitle = document.getElementById('comparisonSubtitle');
        this.dom.visitTrendArrow = document.getElementById('visitTrendArrow');
        this.dom.baselineTrendArrow = document.getElementById('baselineTrendArrow');
        this.dom.resultVisitDelta = document.getElementById('resultVisitDelta');
        this.dom.resultVisitPercent = document.getElementById('resultVisitPercent');
        this.dom.resultBaselinePercent = document.getElementById('resultBaselinePercent');
        this.dom.resultBaselineDelta = document.getElementById('resultBaselineDelta');
        this.dom.timeContext = document.getElementById('timeContext');
        this.dom.daysPostTx = document.getElementById('daysPostTx');
        this.dom.yearsPostTx = document.getElementById('yearsPostTx');
        this.dom.daysSinceLast = document.getElementById('daysSinceLast');
        this.dom.monthsSinceLast = document.getElementById('monthsSinceLast');
        this.dom.rateOfChange = document.getElementById('rateOfChange');
        this.dom.protocolContext = document.getElementById('protocolContext');
        this.dom.thresholdMonitorValue = document.getElementById('thresholdMonitorValue');
        this.dom.thresholdReviewValue = document.getElementById('thresholdReviewValue');
        this.dom.protocolNote = document.getElementById('protocolNote');
        
        // Quick actions
        this.dom.clearQuickBtn = document.getElementById('clearQuickBtn');
        this.dom.calculateQuickBtn = document.getElementById('calculateQuickBtn');
        
        // Monitor mode
        this.dom.modeMonitor = document.getElementById('modeMonitor');
        this.dom.monitorPatientBadge = document.getElementById('monitorPatientBadge');
        this.dom.manualBaselineInput = document.getElementById('manualBaselineInput');
        this.dom.setBaselineBtn = document.getElementById('setBaselineBtn');
        this.dom.entryModeSelector = document.getElementById('entryModeSelector');
        this.dom.entryModeCards = document.querySelectorAll('.entry-mode-card');
        this.dom.singleEntryForm = document.getElementById('singleEntryForm');
        this.dom.bulkEntryForm = document.getElementById('bulkEntryForm');
        this.dom.spreadsheetEntryForm = document.getElementById('spreadsheetEntryForm');
        this.dom.visitDate = document.getElementById('visitDate');
        this.dom.visitFev1 = document.getElementById('visitFev1');
        this.dom.visitFvc = document.getElementById('visitFvc');
        this.dom.visitNotes = document.getElementById('visitNotes');
        this.dom.dateIntervalWarning = document.getElementById('dateIntervalWarning');
        this.dom.addVisitBtn = document.getElementById('addVisitBtn');
        this.dom.bulkImport = document.getElementById('bulkImport');
        this.dom.importBulkBtn = document.getElementById('importBulkBtn');
        this.dom.spreadsheetTable = document.getElementById('spreadsheetTable');
        this.dom.spreadsheetBody = document.getElementById('spreadsheetBody');
        this.dom.addSpreadsheetRowBtn = document.getElementById('addSpreadsheetRowBtn');
        this.dom.saveSpreadsheetBtn = document.getElementById('saveSpreadsheetBtn');
        
        // Monitor view toggle
        this.dom.viewToggle = document.querySelector('.view-toggle');
        this.dom.viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
        this.dom.tableView = document.getElementById('tableView');
        this.dom.timelineView = document.getElementById('timelineView');
        
        // Timeline view elements
        this.dom.timelineChart = document.getElementById('timelineChart');
        this.dom.timelineMilestones = document.getElementById('timelineMilestones');
        this.dom.timelineTotalVisits = document.getElementById('timelineTotalVisits');
        this.dom.timelineTimeSpan = document.getElementById('timelineTimeSpan');
        this.dom.timelineAvgInterval = document.getElementById('timelineAvgInterval');
        this.dom.timelineStatus = document.getElementById('timelineStatus');
        this.dom.exportTimelineBtn = document.getElementById('exportTimelineBtn');
        
        // Table view elements
        this.dom.togglePercentageView = document.getElementById('togglePercentageView');
        this.dom.visitsTableBody = document.getElementById('visitsTableBody');
        this.dom.dataDensityBtns = document.querySelectorAll('.density-btn');
        
        // Monitor actions
        this.dom.clearMonitorBtn = document.getElementById('clearMonitorBtn');
        this.dom.exportPDFBtn = document.getElementById('exportPDFBtn');
        this.dom.toggleVisualizationBtn = document.getElementById('toggleVisualizationBtn');
        this.dom.visualizationSection = document.getElementById('visualizationSection');
        this.dom.fev1Chart = document.getElementById('fev1Chart');
        
        // Full mode
        this.dom.modeFull = document.getElementById('modeFull');
        this.dom.fullPatientBadge = document.getElementById('fullPatientBadge');
        this.dom.txDate = document.getElementById('txDate');
        this.dom.baselineDate = document.getElementById('baselineDate');
        this.dom.stdFev1 = document.getElementById('stdFev1');
        this.dom.stdBaselineFev1 = document.getElementById('stdBaselineFev1');
        this.dom.clinicalNotes = document.getElementById('clinicalNotes');
        this.dom.stdResultsPanel = document.getElementById('stdResultsPanel');
        this.dom.stdResultsTimestamp = document.getElementById('stdResultsTimestamp');
        this.dom.stdCurrentFev1 = document.getElementById('stdCurrentFev1');
        this.dom.stdCurrentPercent = document.getElementById('stdCurrentPercent');
        this.dom.stdBaseline = document.getElementById('stdBaseline');
        this.dom.stdTimePeriod = document.getElementById('stdTimePeriod');
        this.dom.stdComparisonSubtitle = document.getElementById('stdComparisonSubtitle');
        this.dom.stdCumulativeDelta = document.getElementById('stdCumulativeDelta');
        this.dom.stdPercentDecline = document.getElementById('stdPercentDecline');
        this.dom.stdMonthlyRate = document.getElementById('stdMonthlyRate');
        this.dom.stdRateArrow = document.getElementById('stdRateArrow');
        this.dom.stdProtocolNote = document.getElementById('stdProtocolNote');
        this.dom.clearStdBtn = document.getElementById('clearStdBtn');
        this.dom.saveStudyBtn = document.getElementById('saveStudyBtn');
        
        // Quick Actions
        this.dom.quickActions = document.getElementById('quickActions');
        
        // Modals
        this.dom.protocolModal = document.getElementById('protocolModal');
        this.dom.closeProtocolModal = document.getElementById('closeProtocolModal');
        this.dom.monitorSlider = document.getElementById('monitorSlider');
        this.dom.monitorInput = document.getElementById('monitorInput');
        this.dom.monitorValue = document.getElementById('monitorValue');
        this.dom.reviewSlider = document.getElementById('reviewSlider');
        this.dom.reviewInput = document.getElementById('reviewInput');
        this.dom.reviewValue = document.getElementById('reviewValue');
        this.dom.stabilityVisits = document.getElementById('stabilityVisits');
        this.dom.stabilityThreshold = document.getElementById('stabilityThreshold');
        this.dom.resetProtocolBtn = document.getElementById('resetProtocolBtn');
        this.dom.saveProtocolBtn = document.getElementById('saveProtocolBtn');
        
        this.dom.newPatientModal = document.getElementById('newPatientModal');
        this.dom.closeNewPatientModal = document.getElementById('closeNewPatientModal');
        this.dom.newPatientId = document.getElementById('newPatientId');
        this.dom.newTxDate = document.getElementById('newTxDate');
        this.dom.newPatientDesc = document.getElementById('newPatientDesc');
        this.dom.txDateValidation = document.getElementById('txDateValidation');
        this.dom.cancelNewPatientBtn = document.getElementById('cancelNewPatientBtn');
        this.dom.createPatientBtn = document.getElementById('createPatientBtn');
        
        this.dom.patientListModal = document.getElementById('patientListModal');
        this.dom.closePatientListModal = document.getElementById('closePatientListModal');
        this.dom.patientList = document.getElementById('patientList');
        this.dom.addNewPatientBtn = document.getElementById('addNewPatientBtn');
        
        this.dom.baselineConflictModal = document.getElementById('baselineConflictModal');
        this.dom.closeBaselineConflictModal = document.getElementById('closeBaselineConflictModal');
        this.dom.baselineConflictMessage = document.getElementById('baselineConflictMessage');
        this.dom.patientBaselineValue = document.getElementById('patientBaselineValue');
        this.dom.enteredBaselineValue = document.getElementById('enteredBaselineValue');
        this.dom.usePatientBaselineBtn = document.getElementById('usePatientBaselineBtn');
        this.dom.useEnteredBaselineBtn = document.getElementById('useEnteredBaselineBtn');
        this.dom.updatePatientBaselineBtn = document.getElementById('updatePatientBaselineBtn');
        
        this.dom.duplicateDateModal = document.getElementById('duplicateDateModal');
        this.dom.closeDuplicateModal = document.getElementById('closeDuplicateModal');
        this.dom.duplicateDateMessage = document.getElementById('duplicateDateMessage');
        this.dom.existingFev1 = document.getElementById('existingFev1');
        this.dom.existingFvc = document.getElementById('existingFvc');
        this.dom.newFev1 = document.getElementById('newFev1');
        this.dom.newFvc = document.getElementById('newFvc');
        this.dom.cancelDuplicateBtn = document.getElementById('cancelDuplicateBtn');
        this.dom.addAsNewBtn = document.getElementById('addAsNewBtn');
        this.dom.replaceExistingBtn = document.getElementById('replaceExistingBtn');
        
        this.dom.baselineChangeModal = document.getElementById('baselineChangeModal');
        this.dom.closeBaselineChangeModal = document.getElementById('closeBaselineChangeModal');
        this.dom.previousBaselineValue = document.getElementById('previousBaselineValue');
        this.dom.previousBaselineDate = document.getElementById('previousBaselineDate');
        this.dom.newBaselineValue = document.getElementById('newBaselineValue');
        this.dom.cancelBaselineChangeBtn = document.getElementById('cancelBaselineChangeBtn');
        this.dom.keepOldBaselineBtn = document.getElementById('keepOldBaselineBtn');
        this.dom.updateAllBaselineBtn = document.getElementById('updateAllBaselineBtn');
        
        // Save indicator
        this.dom.saveIndicator = document.getElementById('saveIndicator');
        
        // Toast container
        this.dom.toastContainer = document.getElementById('toastContainer');
        
        // Date shortcuts
        this.dom.dateShortcuts = document.querySelectorAll('.date-shortcut');
    }
    
    setupEventListeners() {
        // Enhanced collapsible header
        this.dom.headerToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleUICollapse();
        });
        
        this.dom.appHeader.addEventListener('click', () => this.toggleUICollapse());
        this.dom.patientBar.addEventListener('click', () => this.toggleUICollapse());
        
        // Undo/Redo buttons
        this.dom.undoBtn.addEventListener('click', () => this.handleUndo());
        this.dom.redoBtn.addEventListener('click', () => this.handleRedo());
        
        // Color coding toggle
        this.dom.colorCodingToggle.addEventListener('change', () => this.toggleColorCoding());
        
        // Language toggle
        this.dom.languageToggle.addEventListener('click', () => this.toggleLanguage());
        
        // Navigation
        this.dom.navBtns.forEach(btn => {
            btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
        });
        
        // Breadcrumb
        this.dom.breadcrumbQuick.addEventListener('click', (e) => {
            e.preventDefault();
            this.switchMode('quick');
        });
        
        // Header actions
        this.dom.protocolSettingsBtn.addEventListener('click', () => this.showModal('protocolModal'));
        this.dom.exportBtn.addEventListener('click', () => this.exportAllData());
        this.dom.newPatientBtn.addEventListener('click', () => this.showModal('newPatientModal'));
        this.dom.patientListBtn.addEventListener('click', () => this.showPatientList());
        
        // Quick mode
        this.dom.inputFev1.addEventListener('input', (e) => {
            this.validateRealTime(e.target, 'fev1');
            this.handleQuickInput();
        });
        
        this.dom.inputFvc.addEventListener('input', (e) => {
            this.validateRealTime(e.target, 'fvc');
            this.handleQuickInput();
        });
        
        this.dom.quickDate.addEventListener('change', () => this.handleQuickInput());
        
        this.dom.baselineInput.addEventListener('input', (e) => {
            this.validateRealTime(e.target, 'baseline');
            this.handleComparisonChange();
        });
        
        [this.dom.optionNone, this.dom.optionBaseline, this.dom.optionLast].forEach(option => {
            option.addEventListener('click', (e) => this.handleComparisonSelection(e));
        });
        
        // Quick actions
        this.dom.clearQuickBtn.addEventListener('click', () => this.clearQuickCalc());
        this.dom.calculateQuickBtn.addEventListener('click', () => this.calculateQuick());
        
        // Date shortcuts
        this.dom.dateShortcuts.forEach(shortcut => {
            shortcut.addEventListener('click', (e) => {
                const offset = parseInt(e.target.dataset.offset);
                const date = new Date();
                date.setDate(date.getDate() + offset);
                const dateStr = date.toISOString().split('T')[0];
                
                // Find nearest date input
                const activeMode = this.state.mode;
                if (activeMode === 'quick') {
                    this.dom.quickDate.value = dateStr;
                    this.handleQuickInput();
                } else if (activeMode === 'monitor') {
                    this.dom.visitDate.value = dateStr;
                    this.checkDateInterval();
                } else if (activeMode === 'full') {
                    const target = e.target.closest('.date-shortcuts');
                    if (target && target.previousElementSibling) {
                        const inputs = target.previousElementSibling.querySelectorAll('input[type="date"]');
                        if (inputs.length > 0) {
                            // Set first date input
                            inputs[0].value = dateStr;
                            this.updateTimeline();
                        }
                    }
                }
                
                this.showToast(`Date set to ${date.toLocaleDateString()}`, 'info');
            });
        });
        
        // Monitor mode
        this.dom.manualBaselineInput.addEventListener('input', (e) => {
            this.validateRealTime(e.target, 'baseline');
            const value = parseFloat(this.dom.manualBaselineInput.value);
            this.dom.setBaselineBtn.disabled = !value || isNaN(value) || value < 0.5 || value > 8.0;
        });
        
        this.dom.setBaselineBtn.addEventListener('click', () => this.setManualBaseline());
        
        // Monitor mode - View toggle
        this.dom.viewToggleBtns.forEach(btn => {
            btn.addEventListener('click', () => this.switchMonitorView(btn.dataset.view));
        });
        
        // Monitor mode - Entry mode selection
        this.dom.entryModeCards.forEach(card => {
            card.addEventListener('click', () => this.switchEntryMode(card.dataset.mode));
        });
        
        // Monitor mode - Single entry
        this.dom.visitDate.addEventListener('change', () => this.checkDateInterval());
        this.dom.visitFev1.addEventListener('input', (e) => this.validateRealTime(e.target, 'fev1'));
        this.dom.visitFvc.addEventListener('input', (e) => this.validateRealTime(e.target, 'fvc'));
        this.dom.addVisitBtn.addEventListener('click', () => this.addVisit());
        
        // Monitor mode - Bulk import
        this.dom.importBulkBtn.addEventListener('click', () => this.importBulkVisits());
        
        // Monitor mode - Spreadsheet
        this.dom.addSpreadsheetRowBtn.addEventListener('click', () => this.addSpreadsheetRow());
        this.dom.saveSpreadsheetBtn.addEventListener('click', () => this.saveSpreadsheetData());
        
        // Data density buttons
        this.dom.dataDensityBtns.forEach(btn => {
            btn.addEventListener('click', () => this.switchDataDensity(btn.dataset.density));
        });
        
        // Monitor mode - Table actions
        this.dom.togglePercentageView.addEventListener('click', () => this.togglePercentageView());
        this.dom.clearMonitorBtn.addEventListener('click', () => this.clearMonitorData());
        this.dom.exportPDFBtn.addEventListener('click', () => this.exportProfessionalPDF());
        this.dom.exportTimelineBtn.addEventListener('click', () => this.exportTimelinePDF());
        this.dom.toggleVisualizationBtn.addEventListener('click', () => this.toggleVisualization());
        
        // Full mode
        this.dom.txDate.addEventListener('change', () => this.updateTimeline());
        this.dom.baselineDate.addEventListener('change', () => this.updateTimeline());
        this.dom.stdFev1.addEventListener('input', (e) => {
            this.validateRealTime(e.target, 'fev1');
            this.handleFullInput();
        });
        this.dom.stdBaselineFev1.addEventListener('input', (e) => {
            this.validateRealTime(e.target, 'baseline');
            this.handleFullInput();
        });
        this.dom.clearStdBtn.addEventListener('click', () => this.clearFullStudy());
        this.dom.saveStudyBtn.addEventListener('click', () => this.saveFullStudy());
        
        // Protocol modal
        this.dom.closeProtocolModal.addEventListener('click', () => this.hideModal('protocolModal'));
        this.dom.resetProtocolBtn.addEventListener('click', () => this.resetProtocol());
        this.dom.saveProtocolBtn.addEventListener('click', () => this.saveProtocol());
        
        // Protocol sliders and inputs
        ['monitor', 'review'].forEach(type => {
            const slider = document.getElementById(`${type}Slider`);
            const input = document.getElementById(`${type}Input`);
            const value = document.getElementById(`${type}Value`);
            
            if (slider && input && value) {
                slider.addEventListener('input', () => {
                    input.value = slider.value;
                    value.textContent = `${slider.value}%`;
                });
                
                input.addEventListener('input', () => {
                    slider.value = input.value;
                    value.textContent = `${input.value}%`;
                });
            }
        });
        
        // Stability settings
        this.dom.stabilityVisits.addEventListener('input', () => {
            this.state.protocol.stabilityVisits = parseInt(this.dom.stabilityVisits.value);
        });
        
        this.dom.stabilityThreshold.addEventListener('input', () => {
            this.state.protocol.stabilityThreshold = parseInt(this.dom.stabilityThreshold.value);
        });
        
        // New patient modal
        this.dom.closeNewPatientModal.addEventListener('click', () => this.hideModal('newPatientModal'));
        this.dom.cancelNewPatientBtn.addEventListener('click', () => this.hideModal('newPatientModal'));
        this.dom.createPatientBtn.addEventListener('click', () => this.createPatient());
        this.dom.newTxDate.addEventListener('change', (e) => this.validateTxDate(e.target));
        
        // Patient list modal
        this.dom.closePatientListModal.addEventListener('click', () => this.hideModal('patientListModal'));
        this.dom.addNewPatientBtn.addEventListener('click', () => {
            this.hideModal('patientListModal');
            this.showModal('newPatientModal');
        });
        
        // Baseline conflict modal
        this.dom.closeBaselineConflictModal.addEventListener('click', () => this.hideModal('baselineConflictModal'));
        this.dom.usePatientBaselineBtn.addEventListener('click', () => this.handleBaselineConflict('patient'));
        this.dom.useEnteredBaselineBtn.addEventListener('click', () => this.handleBaselineConflict('entered'));
        this.dom.updatePatientBaselineBtn.addEventListener('click', () => this.handleBaselineConflict('update'));
        
        // Duplicate date modal
        this.dom.closeDuplicateModal.addEventListener('click', () => this.hideModal('duplicateDateModal'));
        this.dom.cancelDuplicateBtn.addEventListener('click', () => this.hideModal('duplicateDateModal'));
        this.dom.addAsNewBtn.addEventListener('click', () => this.handleDuplicateAddAsNew());
        this.dom.replaceExistingBtn.addEventListener('click', () => this.handleDuplicateReplace());
        
        // Baseline change modal
        this.dom.closeBaselineChangeModal.addEventListener('click', () => this.hideModal('baselineChangeModal'));
        this.dom.cancelBaselineChangeBtn.addEventListener('click', () => this.hideModal('baselineChangeModal'));
        this.dom.keepOldBaselineBtn.addEventListener('click', () => this.handleBaselineChange('keep'));
        this.dom.updateAllBaselineBtn.addEventListener('click', () => this.handleBaselineChange('update'));
        
        // Quick Actions
        this.dom.quickActions.addEventListener('click', (e) => {
            const action = e.target.closest('.quick-action')?.dataset.action;
            if (!action) return;
            
            switch(action) {
                case 'new-visit':
                    if (this.state.mode === 'monitor') {
                        this.dom.visitFev1.focus();
                    } else {
                        this.switchMode('monitor');
                        setTimeout(() => this.dom.visitFev1.focus(), 100);
                    }
                    break;
                case 'calculate':
                    if (this.state.mode === 'quick') {
                        this.calculateQuick();
                    } else if (this.state.mode === 'full') {
                        this.saveFullStudy();
                    }
                    break;
                case 'export':
                    if (this.state.mode === 'monitor') {
                        this.exportProfessionalPDF();
                    } else {
                        this.exportAllData();
                    }
                    break;
                case 'settings':
                    this.showModal('protocolModal');
                    break;
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
        
        // Modal close on overlay click
        [this.dom.protocolModal, this.dom.newPatientModal, this.dom.patientListModal, 
         this.dom.baselineConflictModal, this.dom.duplicateDateModal, this.dom.baselineChangeModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) this.hideModal(modal.id);
            });
        });
        
        // Spreadsheet editing
        this.setupSpreadsheetEditing();
        
        // Enhanced touch events for mobile
        this.setupTouchEvents();
        
        // Auto-save on page unload
        window.addEventListener('beforeunload', (e) => {
            if (this.hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
    }
    
    setupTouchEvents() {
        let touchStartY = 0;
        let touchEndY = 0;
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        });
        
        document.addEventListener('touchend', (e) => {
            touchEndY = e.changedTouches[0].clientY;
            const touchDuration = Date.now() - touchStartTime;
            const diff = touchStartY - touchEndY;
            
            if (touchDuration < 300 && Math.abs(diff) > 50) {
                if (diff > 0 && !this.state.uiCollapsed) {
                    this.toggleUICollapse(true);
                } else if (diff < 0 && this.state.uiCollapsed) {
                    this.toggleUICollapse(false);
                }
            }
        });
    }
    
    setupSpreadsheetEditing() {
        this.dom.spreadsheetBody.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const current = e.target;
                const cells = Array.from(this.dom.spreadsheetBody.querySelectorAll('.editable-cell'));
                const currentIndex = cells.indexOf(current);
                
                if (e.shiftKey) {
                    if (currentIndex > 0) {
                        cells[currentIndex - 1].focus();
                    }
                } else {
                    if (currentIndex < cells.length - 1) {
                        cells[currentIndex + 1].focus();
                    } else {
                        this.addSpreadsheetRow();
                        setTimeout(() => {
                            const newCells = Array.from(this.dom.spreadsheetBody.querySelectorAll('.editable-cell'));
                            newCells[cells.length].focus();
                        }, 10);
                    }
                }
            }
        });
    }
    
    // === UI METHODS ===
    
    toggleUICollapse(forceCollapse = null) {
        this.state.uiCollapsed = forceCollapse !== null ? forceCollapse : !this.state.uiCollapsed;
        
        const toggleIcon = this.dom.headerToggle.querySelector('.toggle-icon');
        toggleIcon.textContent = this.state.uiCollapsed ? '' : '';
        
        if (this.state.uiCollapsed) {
            this.dom.appHeader.classList.add('collapsed');
            this.dom.patientBar.classList.add('collapsed');
            this.dom.appNavigation.classList.add('collapsed');
            this.dom.breadcrumb.classList.add('collapsed');
        } else {
            this.dom.appHeader.classList.remove('collapsed');
            this.dom.patientBar.classList.remove('collapsed');
            this.dom.appNavigation.classList.remove('collapsed');
            this.dom.breadcrumb.classList.remove('collapsed');
        }
    }
    
    switchMode(mode) {
        if (this.state.mode === mode) return;
        
        this.state.mode = mode;
        
        // Update navigation buttons
        this.dom.navBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        // Update breadcrumb
        this.dom.breadcrumbPatient.textContent = this.getCurrentPatientName();
        
        // Hide all mode sections
        document.querySelectorAll('.mode-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show active mode section
        document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
        
        // Update patient badges
        this.updatePatientBadges();
        
        // Initialize mode-specific features
        if (mode === 'monitor') {
            this.updateVisitsTable();
            this.updateTimelineChart();
        } else if (mode === 'quick') {
            this.dom.inputFev1.focus();
        }
        
        this.showToast(`Switched to ${mode} mode`, 'info');
    }
    
    switchMonitorView(view) {
        this.state.session.monitor.view = view;
        
        // Update toggle buttons
        this.dom.viewToggleBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });
        
        // Show/hide views
        this.dom.tableView.classList.toggle('visible', view === 'table');
        this.dom.timelineView.classList.toggle('visible', view === 'timeline');
        
        if (view === 'timeline') {
            this.updateTimelineChart();
        }
    }
    
    switchEntryMode(mode) {
        this.state.session.monitor.entryMode = mode;
        
        // Update cards
        this.dom.entryModeCards.forEach(card => {
            card.classList.toggle('active', card.dataset.mode === mode);
        });
        
        // Show/hide forms
        this.dom.singleEntryForm.classList.toggle('hidden', mode !== 'single');
        this.dom.bulkEntryForm.classList.toggle('hidden', mode !== 'bulk');
        this.dom.spreadsheetEntryForm.classList.toggle('hidden', mode !== 'spreadsheet');
        
        if (mode === 'spreadsheet') {
            this.populateSpreadsheet();
        }
    }
    
    switchDataDensity(density) {
        this.dom.dataDensityBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.density === density);
        });
        
        // Update table view based on density
        this.updateVisitsTable();
        this.showToast(`Switched to ${density} view`, 'info');
    }
    
    toggleColorCoding() {
        this.state.colorCoding = !this.state.colorCoding;
        this.dom.colorCodingToggle.checked = this.state.colorCoding;
        
        if (this.state.colorCoding) {
            document.body.classList.remove('color-coding-off');
        } else {
            document.body.classList.add('color-coding-off');
        }
        
        this.updateVisitsTable();
        this.saveState();
        this.showToast(`Color coding ${this.state.colorCoding ? 'enabled' : 'disabled'}`, 'info');
    }
    
    togglePercentageView() {
        this.state.percentageView = !this.state.percentageView;
        this.updateVisitsTable();
        this.showToast(`Percentage view ${this.state.percentageView ? 'enabled' : 'disabled'}`, 'info');
    }
    
    toggleLanguage() {
        this.state.language = this.state.language === 'en' ? 'es' : 'en';
        this.dom.languageToggle.textContent = this.state.language.toUpperCase();
        this.updateUI();
        this.showToast(`Language switched to ${this.state.language === 'en' ? 'English' : 'Spanish'}`, 'info');
    }
    
    toggleVisualization() {
        const isVisible = this.dom.visualizationSection.classList.toggle('visible');
        this.dom.toggleVisualizationBtn.innerHTML = isVisible ? 
            '<span></span><span>Hide Charts</span>' : 
            '<span></span><span>Show Charts</span>';
        
        if (isVisible) {
            this.renderFev1Chart();
        }
    }
    
    // === VALIDATION METHODS ===
    
    validateRealTime(input, type) {
        const value = parseFloat(input.value);
        let isValid = true;
        let message = '';
        
        switch(type) {
            case 'fev1':
                if (value < 0.5 || value > 8.0) {
                    isValid = false;
                    message = 'FEV should be between 0.5 and 8.0 L';
                }
                break;
            case 'fvc':
                if (value < 0.5 || value > 10.0) {
                    isValid = false;
                    message = 'FVC should be between 0.5 and 10.0 L';
                }
                break;
            case 'baseline':
                if (value < 0.5 || value > 8.0) {
                    isValid = false;
                    message = 'Baseline should be between 0.5 and 8.0 L';
                }
                break;
        }
        
        // Update validation UI
        const validationEl = input.parentElement.nextElementSibling;
        if (validationEl && validationEl.classList.contains('validation-message')) {
            if (!isValid && input.value) {
                validationEl.textContent = message;
                validationEl.className = 'validation-message error';
                validationEl.style.display = 'block';
                input.classList.add('invalid');
            } else {
                validationEl.style.display = 'none';
                input.classList.remove('invalid');
            }
        }
        
        return isValid;
    }
    
    validateTxDate(input) {
        const selectedDate = new Date(input.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate > today) {
            this.dom.txDateValidation.textContent = 'Transplant date cannot be in the future';
            this.dom.txDateValidation.className = 'validation-message error';
            this.dom.txDateValidation.style.display = 'block';
            input.classList.add('invalid');
            return false;
        } else {
            this.dom.txDateValidation.style.display = 'none';
            input.classList.remove('invalid');
            return true;
        }
    }
    
    // === QUICK CALC METHODS ===
    
    handleQuickInput() {
        const fev1 = parseFloat(this.dom.inputFev1.value);
        const fvc = parseFloat(this.dom.inputFvc.value);
        const date = this.dom.quickDate.value;
        
        this.state.session.quick.fev1 = fev1;
        this.state.session.quick.fvc = fvc || null;
        this.state.session.quick.date = date;
        
        // Enable/disable calculate button
        this.dom.calculateQuickBtn.disabled = !fev1 || isNaN(fev1);
    }
    
    handleComparisonSelection(e) {
        const option = e.currentTarget;
        const value = option.querySelector('.option-radio').value;
        
        // Update UI
        document.querySelectorAll('.comparison-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        option.classList.add('selected');
        
        // Update state
        this.state.session.quick.comparison = value;
        
        // Handle specific options
        if (value === 'baseline') {
            this.dom.baselineInput.focus();
        }
        
        // Update last visit note if needed
        if (value === 'last' && this.state.currentPatient) {
            const patient = this.state.patients.get(this.state.currentPatient);
            if (patient && patient.visits && patient.visits.length > 0) {
                const lastVisit = patient.visits[patient.visits.length - 1];
                this.dom.lastVisitNote.textContent = `Last visit: ${lastVisit.date} (${lastVisit.fev1}L)`;
            }
        }
    }
    
    handleComparisonChange() {
        const baselineValue = parseFloat(this.dom.baselineInput.value);
        if (baselineValue && !isNaN(baselineValue)) {
            this.state.session.quick.baseline = baselineValue;
            this.state.session.quick.baselineSource = 'manual';
        }
    }
    
    calculateQuick() {
        const fev1 = parseFloat(this.dom.inputFev1.value);
        const fvc = parseFloat(this.dom.inputFvc.value) || null;
        const date = this.dom.quickDate.value;
        
        if (!fev1 || isNaN(fev1)) {
            this.showToast('Please enter a valid FEV value', 'error');
            this.dom.inputFev1.focus();
            return;
        }
        
        // Calculate ratio if FVC is provided
        let ratio = null;
        if (fvc && fvc > 0) {
            ratio = (fev1 / fvc * 100).toFixed(1);
        }
        
        // Update results display
        this.dom.resultFev1Liters.textContent = fev1.toFixed(2);
        this.dom.resultFvc.textContent = fvc ? fvc.toFixed(2) : '--';
        this.dom.resultRatio.textContent = ratio ? `${ratio}%` : '--';
        
        // Calculate percentages and comparisons
        this.calculateQuickComparisons(fev1, fvc, date);
        
        // Show results panel
        this.dom.resultsPanel.classList.add('visible');
        this.dom.resultsTimestamp.textContent = `Calculated ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        
        this.pushHistory('Quick calculation performed');
        this.showToast('Calculation completed', 'success');
    }
    
    calculateQuickComparisons(fev1, fvc, date) {
        const comparison = this.state.session.quick.comparison;
        const patient = this.state.currentPatient ? this.state.patients.get(this.state.currentPatient) : null;
        
        // Baseline comparison
        let baseline = null;
        if (comparison === 'baseline' && this.state.session.quick.baseline) {
            baseline = this.state.session.quick.baseline;
        } else if (patient && patient.baselineFev1) {
            baseline = patient.baselineFev1;
        }
        
        if (baseline) {
            const percentOfBaseline = (fev1 / baseline * 100).toFixed(1);
            const delta = (fev1 - baseline).toFixed(2);
            
            this.dom.resultBaselinePercent.textContent = `${percentOfBaseline}%`;
            this.dom.resultBaselineDelta.textContent = `${delta} L`;
            
            // Color coding
            const percentNum = parseFloat(percentOfBaseline);
            let baselineClass = 'neutral';
            let arrow = '';
            
            if (percentNum >= 90) {
                baselineClass = 'good';
                arrow = '';
            } else if (percentNum >= 80) {
                baselineClass = 'warning';
                arrow = '';
            } else {
                baselineClass = 'alert';
                arrow = '';
            }
            
            this.dom.resultBaselinePercent.className = `baseline-percent ${baselineClass}`;
            this.dom.baselineTrendArrow.textContent = arrow;
            this.dom.baselineTrendArrow.className = `trend-arrow ${arrow === '' ? 'up' : arrow === '' ? 'down' : 'neutral'}`;
            
            this.dom.comparisonResults.classList.remove('hidden');
            this.dom.comparisonSubtitle.textContent = `vs Baseline (${baseline}L)`;
        }
        
        // Last visit comparison
        if (comparison === 'last' && patient && patient.visits && patient.visits.length > 0) {
            const lastVisit = patient.visits[patient.visits.length - 1];
            const lastFev1 = lastVisit.fev1;
            const delta = (fev1 - lastFev1).toFixed(2);
            const percentChange = ((fev1 - lastFev1) / lastFev1 * 100).toFixed(1);
            
            this.dom.resultVisitDelta.textContent = `${delta > 0 ? '+' : ''}${delta} L`;
            this.dom.resultVisitPercent.textContent = `${percentChange > 0 ? '+' : ''}${percentChange}%`;
            
            // Color coding
            let visitClass = 'neutral';
            let arrow = '';
            
            if (delta > 0.1) {
                visitClass = 'positive';
                arrow = '';
            } else if (delta < -0.1) {
                visitClass = 'negative';
                arrow = '';
            }
            
            this.dom.resultVisitDelta.className = `visit-change ${visitClass}`;
            this.dom.visitTrendArrow.textContent = arrow;
            this.dom.visitTrendArrow.className = `trend-arrow ${arrow === '' ? 'up' : arrow === '' ? 'down' : 'neutral'}`;
            
            this.dom.comparisonResults.classList.remove('hidden');
            if (!this.dom.comparisonSubtitle.textContent) {
                this.dom.comparisonSubtitle.textContent = `vs Last Visit (${lastVisit.date})`;
            }
        }
        
        // Time context if patient has transplant date
        if (patient && patient.txDate) {
            const txDate = new Date(patient.txDate);
            const currentDate = new Date(date);
            const daysDiff = Math.floor((currentDate - txDate) / (1000 * 60 * 60 * 24));
            const yearsDiff = (daysDiff / 365.25).toFixed(1);
            
            this.dom.daysPostTx.textContent = daysDiff;
            this.dom.yearsPostTx.textContent = `${yearsDiff} years`;
            this.dom.timeContext.classList.remove('hidden');
        }
        
        // Protocol context
        if (baseline) {
            const percentOfBaseline = (fev1 / baseline * 100);
            this.dom.protocolContext.classList.remove('hidden');
            
            let note = 'Within normal range.';
            if (percentOfBaseline < (100 - this.state.protocol.review)) {
                note = ` Review recommended: ${(100 - percentOfBaseline).toFixed(1)}% decline from baseline`;
            } else if (percentOfBaseline < (100 - this.state.protocol.monitor)) {
                note = ` Monitor closely: ${(100 - percentOfBaseline).toFixed(1)}% decline from baseline`;
            }
            
            this.dom.protocolNote.textContent = note;
        }
    }
    
    clearQuickCalc() {
        this.dom.inputFev1.value = '';
        this.dom.inputFvc.value = '';
        this.dom.quickDate.value = new Date().toISOString().split('T')[0];
        this.dom.baselineInput.value = '';
        this.dom.optionNone.querySelector('.option-radio').checked = true;
        this.dom.resultsPanel.classList.remove('visible');
        
        // Reset comparison options
        document.querySelectorAll('.comparison-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.dom.optionNone.classList.add('selected');
        
        this.state.session.quick = {
            fev1: null,
            fvc: null,
            comparison: 'none',
            baseline: null,
            baselineSource: null,
            lastVisit: null
        };
        
        this.showToast('Quick calculator cleared', 'info');
        this.dom.inputFev1.focus();
    }
    
    // === MONITOR MODE METHODS ===
    
    checkDateInterval() {
        const date = new Date(this.dom.visitDate.value);
        const patient = this.state.currentPatient ? this.state.patients.get(this.state.currentPatient) : null;
        
        if (!patient || !patient.visits || patient.visits.length === 0) {
            this.dom.dateIntervalWarning.classList.add('hidden');
            return;
        }
        
        const lastVisit = patient.visits[patient.visits.length - 1];
        const lastDate = new Date(lastVisit.date);
        const daysDiff = Math.floor((date - lastDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 0) {
            this.dom.dateIntervalWarning.textContent = 'Date is before last visit';
            this.dom.dateIntervalWarning.classList.remove('hidden');
            this.dom.dateIntervalWarning.classList.add('error');
        } else if (daysDiff < 7) {
            this.dom.dateIntervalWarning.textContent = 'Visit interval is less than 1 week';
            this.dom.dateIntervalWarning.classList.remove('hidden');
            this.dom.dateIntervalWarning.classList.remove('error');
        } else {
            this.dom.dateIntervalWarning.classList.add('hidden');
        }
    }
    
    addVisit() {
        const date = this.dom.visitDate.value;
        const fev1 = parseFloat(this.dom.visitFev1.value);
        const fvc = parseFloat(this.dom.visitFvc.value) || null;
        const notes = this.dom.visitNotes.value.trim();
        
        if (!date || !fev1 || isNaN(fev1)) {
            this.showToast('Please enter a valid date and FEV value', 'error');
            return;
        }
        
        if (!this.state.currentPatient) {
            this.showToast('Please select a patient first', 'error');
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient) return;
        
        // Check for duplicate date
        const duplicateIndex = patient.visits.findIndex(v => v.date === date);
        if (duplicateIndex !== -1) {
            this.state.session.duplicateDateData = {
                date,
                existing: patient.visits[duplicateIndex],
                new: { fev1, fvc, notes }
            };
            this.showDuplicateDateModal();
            return;
        }
        
        const visit = {
            date,
            fev1,
            fvc,
            notes,
            timestamp: Date.now()
        };
        
        patient.visits.push(visit);
        patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        this.savePatient(patient);
        this.updateVisitsTable();
        this.updateTimelineChart();
        this.updatePatientContext();
        
        // Clear form
        this.dom.visitFev1.value = '';
        this.dom.visitFvc.value = '';
        this.dom.visitNotes.value = '';
        
        this.showToast('Visit added successfully', 'success');
        this.pushHistory('Visit added');
    }
    
    importBulkVisits() {
        const text = this.dom.bulkImport.value.trim();
        if (!text) {
            this.showToast('Please enter data to import', 'error');
            return;
        }
        
        if (!this.state.currentPatient) {
            this.showToast('Please select a patient first', 'error');
            return;
        }
        
        const lines = text.split('\n').filter(line => line.trim());
        const visits = [];
        let successCount = 0;
        let errorCount = 0;
        
        lines.forEach((line, index) => {
            const parts = line.split(',').map(part => part.trim());
            if (parts.length < 2) {
                errorCount++;
                return;
            }
            
            const date = parts[0];
            const fev1 = parseFloat(parts[1]);
            const fvc = parts.length > 2 ? parseFloat(parts[2]) : null;
            const notes = parts.length > 3 ? parts.slice(3).join(', ') : '';
            
            if (!date || isNaN(fev1)) {
                errorCount++;
                return;
            }
            
            visits.push({ date, fev1, fvc, notes });
            successCount++;
        });
        
        if (visits.length === 0) {
            this.showToast('No valid visits found in the imported data', 'error');
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        patient.visits.push(...visits);
        patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        this.savePatient(patient);
        this.updateVisitsTable();
        this.updateTimelineChart();
        this.updatePatientContext();
        
        this.dom.bulkImport.value = '';
        this.showToast(`Imported ${successCount} visits${errorCount > 0 ? `, ${errorCount} errors` : ''}`, 'success');
        this.pushHistory('Bulk visits imported');
    }
    
    addSpreadsheetRow() {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="editable-cell" contenteditable="true" data-field="date"></td>
            <td class="editable-cell" contenteditable="true" data-field="fev1"></td>
            <td class="editable-cell" contenteditable="true" data-field="fvc"></td>
            <td class="editable-cell" contenteditable="true" data-field="notes"></td>
        `;
        this.dom.spreadsheetBody.appendChild(row);
    }
    
    populateSpreadsheet() {
        this.dom.spreadsheetBody.innerHTML = '';
        
        const patient = this.state.currentPatient ? this.state.patients.get(this.state.currentPatient) : null;
        if (patient && patient.visits && patient.visits.length > 0) {
            patient.visits.forEach(visit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable-cell" contenteditable="true" data-field="date">${visit.date}</td>
                    <td class="editable-cell" contenteditable="true" data-field="fev1">${visit.fev1}</td>
                    <td class="editable-cell" contenteditable="true" data-field="fvc">${visit.fvc || ''}</td>
                    <td class="editable-cell" contenteditable="true" data-field="notes">${visit.notes || ''}</td>
                `;
                this.dom.spreadsheetBody.appendChild(row);
            });
        } else {
            this.addSpreadsheetRow();
        }
    }
    
    saveSpreadsheetData() {
        if (!this.state.currentPatient) {
            this.showToast('Please select a patient first', 'error');
            return;
        }
        
        const rows = Array.from(this.dom.spreadsheetBody.querySelectorAll('tr'));
        const visits = [];
        let errorCount = 0;
        
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('.editable-cell');
            const date = cells[0].textContent.trim();
            const fev1 = parseFloat(cells[1].textContent);
            const fvc = cells[2].textContent.trim() ? parseFloat(cells[2].textContent) : null;
            const notes = cells[3].textContent.trim();
            
            if (!date || isNaN(fev1)) {
                errorCount++;
                return;
            }
            
            visits.push({ date, fev1, fvc, notes });
        });
        
        if (visits.length === 0) {
            this.showToast('No valid visits found in the spreadsheet', 'error');
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        patient.visits = visits.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        this.savePatient(patient);
        this.updateVisitsTable();
        this.updateTimelineChart();
        this.updatePatientContext();
        
        this.showToast(`Saved ${visits.length} visits${errorCount > 0 ? `, ${errorCount} errors` : ''}`, 'success');
        this.pushHistory('Spreadsheet data saved');
    }
    
    setManualBaseline() {
        const baselineValue = parseFloat(this.dom.manualBaselineInput.value);
        if (!baselineValue || isNaN(baselineValue)) {
            this.showToast('Please enter a valid baseline value', 'error');
            return;
        }
        
        if (!this.state.currentPatient) {
            this.showToast('Please select a patient first', 'error');
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient) return;
        
        // Check if baseline already exists
        if (patient.baselineFev1 && patient.baselineFev1 !== baselineValue) {
            this.state.session.baselineChangeData = {
                previous: patient.baselineFev1,
                previousDate: patient.baselineDate,
                new: baselineValue
            };
            this.showBaselineChangeModal();
        } else {
            this.updatePatientBaseline(baselineValue);
        }
    }
    
    updatePatientBaseline(baselineValue) {
        const patient = this.state.patients.get(this.state.currentPatient);
        const previousBaseline = patient.baselineFev1;
        
        patient.baselineFev1 = baselineValue;
        patient.baselineDate = new Date().toISOString().split('T')[0];
        
        this.savePatient(patient);
        this.updateVisitsTable();
        this.updatePatientContext();
        
        this.dom.manualBaselineInput.value = '';
        this.dom.setBaselineBtn.disabled = true;
        
        this.showToast(`Baseline updated to ${baselineValue}L`, 'success');
        this.pushHistory(previousBaseline ? 'Baseline updated' : 'Baseline set');
    }
    
    updateVisitsTable() {
        if (!this.state.currentPatient) {
            this.dom.visitsTableBody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center" style="padding: var(--space-4); color: var(--text-tertiary);">
                        No patient selected. Select or create a patient to begin.
                    </td>
                </tr>`;
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient || !patient.visits || patient.visits.length === 0) {
            this.dom.visitsTableBody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center" style="padding: var(--space-4); color: var(--text-tertiary);">
                        No visits yet. Add visits using the form above.
                    </td>
                </tr>`;
            return;
        }
        
        let html = '';
        const baseline = patient.baselineFev1;
        
        patient.visits.forEach((visit, index) => {
            const date = new Date(visit.date);
            const daysSinceTx = patient.txDate ? 
                Math.floor((date - new Date(patient.txDate)) / (1000 * 60 * 60 * 24)) : '--';
            
            // Calculate percentages and changes
            let percentOfBaseline = '--';
            let baselineDelta = '--';
            let visitDelta = '--';
            let visitPercent = '--';
            let rate = '--';
            
            if (baseline) {
                percentOfBaseline = ((visit.fev1 / baseline) * 100).toFixed(1);
                baselineDelta = (visit.fev1 - baseline).toFixed(2);
            }
            
            if (index > 0) {
                const prevVisit = patient.visits[index - 1];
                const prevDate = new Date(prevVisit.date);
                const daysBetween = Math.floor((date - prevDate) / (1000 * 60 * 60 * 24));
                visitDelta = (visit.fev1 - prevVisit.fev1).toFixed(2);
                visitPercent = ((visit.fev1 - prevVisit.fev1) / prevVisit.fev1 * 100).toFixed(1);
                
                if (daysBetween > 0) {
                    const monthlyRate = ((visit.fev1 - prevVisit.fev1) / daysBetween * 30.44).toFixed(3);
                    rate = monthlyRate;
                }
            }
            
            // Calculate FEV1/FVC ratio
            const ratio = visit.fvc ? ((visit.fev1 / visit.fvc) * 100).toFixed(1) : '--';
            
            // Determine alert status
            let alertClass = '';
            let alertText = '';
            if (baseline) {
                const percent = parseFloat(percentOfBaseline);
                if (percent < (100 - this.state.protocol.review)) {
                    alertClass = 'review';
                    alertText = '';
                } else if (percent < (100 - this.state.protocol.monitor)) {
                    alertClass = 'monitor';
                    alertText = '';
                }
            }
            
            html += `
                <tr>
                    <td>${visit.date}</td>
                    <td>${daysSinceTx}</td>
                    <td>${visit.fev1.toFixed(2)}</td>
                    <td>${percentOfBaseline}%</td>
                    <td>${visit.fvc ? visit.fvc.toFixed(2) : '--'}</td>
                    <td>${ratio}%</td>
                    <td class="${visitDelta > 0 ? 'positive' : visitDelta < 0 ? 'negative' : ''}">
                        ${visitDelta > 0 ? '+' : ''}${visitDelta}
                    </td>
                    <td class="${baselineDelta > 0 ? 'positive' : baselineDelta < 0 ? 'negative' : ''}">
                        ${baselineDelta > 0 ? '+' : ''}${baselineDelta}
                    </td>
                    <td>${rate}</td>
                    <td class="alert-cell">
                        <span class="alert-indicator ${alertClass}">${alertText}</span>
                    </td>
                    <td title="${visit.notes || ''}">${visit.notes ? '' : ''}</td>
                </tr>`;
        });
        
        this.dom.visitsTableBody.innerHTML = html;
        this.updateUndoRedoButtons();
    }
    
    clearMonitorData() {
        if (!this.state.currentPatient) {
            this.showToast('No patient selected', 'error');
            return;
        }
        
        if (confirm('Are you sure you want to clear all visits for this patient?')) {
            const patient = this.state.patients.get(this.state.currentPatient);
            const previousVisits = [...patient.visits];
            patient.visits = [];
            
            this.savePatient(patient);
            this.updateVisitsTable();
            this.updateTimelineChart();
            this.updatePatientContext();
            
            // Store for undo
            this.undoActions.set('clearVisits', {
                patientId: this.state.currentPatient,
                visits: previousVisits
            });
            
            this.showToast('All visits cleared', 'success');
            this.pushHistory('Visits cleared');
        }
    }
    
    // === FULL STUDY MODE METHODS ===
    
    handleFullInput() {
        const fev1 = parseFloat(this.dom.stdFev1.value);
        const baselineFev1 = parseFloat(this.dom.stdBaselineFev1.value);
        const txDate = this.dom.txDate.value;
        const baselineDate = this.dom.baselineDate.value;
        const notes = this.dom.clinicalNotes.value;
        
        this.state.session.full.fev1 = fev1;
        this.state.session.full.baselineFev1 = baselineFev1;
        this.state.session.full.txDate = txDate;
        this.state.session.full.baselineDate = baselineDate;
        this.state.session.full.notes = notes;
        
        // Enable/disable save button
        this.dom.saveStudyBtn.disabled = !fev1 || !baselineFev1 || !txDate;
        
        // Auto-calculate if all fields are filled
        if (fev1 && baselineFev1 && txDate) {
            this.calculateFullStudy();
        }
    }
    
    calculateFullStudy() {
        const fev1 = this.state.session.full.fev1;
        const baselineFev1 = this.state.session.full.baselineFev1;
        const txDate = this.state.session.full.txDate;
        const baselineDate = this.state.session.full.baselineDate || txDate;
        
        if (!fev1 || !baselineFev1 || !txDate) {
            return;
        }
        
        // Calculate time periods
        const currentDate = new Date();
        const txDateObj = new Date(txDate);
        const baselineDateObj = new Date(baselineDate);
        
        const daysSinceTx = Math.floor((currentDate - txDateObj) / (1000 * 60 * 60 * 24));
        const daysSinceBaseline = Math.floor((currentDate - baselineDateObj) / (1000 * 60 * 60 * 24));
        
        // Calculate changes
        const cumulativeDelta = (fev1 - baselineFev1).toFixed(2);
        const percentDecline = ((1 - (fev1 / baselineFev1)) * 100).toFixed(1);
        const monthlyRate = (cumulativeDelta / (daysSinceBaseline / 30.44)).toFixed(3);
        
        // Update results display
        this.dom.stdCurrentFev1.textContent = fev1.toFixed(2);
        this.dom.stdCurrentPercent.textContent = `${(fev1 / baselineFev1 * 100).toFixed(1)}%`;
        this.dom.stdBaseline.textContent = baselineFev1.toFixed(2);
        this.dom.stdTimePeriod.textContent = daysSinceBaseline;
        
        this.dom.stdCumulativeDelta.textContent = `${cumulativeDelta > 0 ? '+' : ''}${cumulativeDelta}`;
        this.dom.stdCumulativeDelta.className = `visit-change ${cumulativeDelta > 0 ? 'positive' : cumulativeDelta < 0 ? 'negative' : 'neutral'}`;
        
        this.dom.stdPercentDecline.textContent = `${percentDecline}%`;
        const percentNum = Math.abs(parseFloat(percentDecline));
        let declineClass = 'neutral';
        if (percentNum >= this.state.protocol.review) {
            declineClass = 'alert';
        } else if (percentNum >= this.state.protocol.monitor) {
            declineClass = 'warning';
        } else if (percentNum < 5) {
            declineClass = 'good';
        }
        this.dom.stdPercentDecline.className = `baseline-percent ${declineClass}`;
        
        this.dom.stdMonthlyRate.textContent = `${monthlyRate > 0 ? '+' : ''}${monthlyRate}`;
        this.dom.stdMonthlyRate.className = `visit-change ${monthlyRate > 0 ? 'positive' : monthlyRate < 0 ? 'negative' : 'neutral'}`;
        this.dom.stdRateArrow.textContent = monthlyRate > 0 ? '' : monthlyRate < 0 ? '' : '';
        
        // Update protocol note
        let note = 'Within normal range.';
        if (percentNum >= this.state.protocol.review) {
            note = ` Review recommended: ${percentDecline}% decline from baseline over ${Math.floor(daysSinceBaseline/30)} months`;
        } else if (percentNum >= this.state.protocol.monitor) {
            note = ` Monitor closely: ${percentDecline}% decline from baseline`;
        } else if (percentNum < 5) {
            note = ' Stable: Minimal change from baseline';
        }
        this.dom.stdProtocolNote.textContent = note;
        
        // Update comparison subtitle
        this.dom.stdComparisonSubtitle.textContent = `Baseline established ${baselineDate}`;
        
        // Show results panel
        this.dom.stdResultsPanel.classList.add('visible');
        this.dom.stdResultsTimestamp.textContent = `Calculated ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    }
    
    saveFullStudy() {
        const fev1 = this.state.session.full.fev1;
        const baselineFev1 = this.state.session.full.baselineFev1;
        const txDate = this.state.session.full.txDate;
        const baselineDate = this.state.session.full.baselineDate || txDate;
        const notes = this.state.session.full.notes;
        
        if (!fev1 || !baselineFev1 || !txDate) {
            this.showToast('Please fill in all required fields', 'error');
            return;
        }
        
        // Create or update patient
        if (!this.state.currentPatient) {
            // Generate a patient ID
            const patientId = `PT${Date.now().toString().slice(-6)}`;
            this.createFullStudyPatient(patientId, fev1, baselineFev1, txDate, baselineDate, notes);
        } else {
            this.updateFullStudyPatient(fev1, baselineFev1, txDate, baselineDate, notes);
        }
        
        this.calculateFullStudy();
        this.showToast('Full study saved', 'success');
        this.pushHistory('Full study saved');
    }
    
    createFullStudyPatient(patientId, fev1, baselineFev1, txDate, baselineDate, notes) {
        const patient = {
            id: patientId,
            txDate,
            baselineFev1,
            baselineDate,
            description: notes || 'Full study patient',
            visits: [{
                date: new Date().toISOString().split('T')[0],
                fev1,
                fvc: null,
                notes: 'Initial full study measurement',
                timestamp: Date.now()
            }]
        };
        
        this.state.patients.set(patientId, patient);
        this.state.currentPatient = patientId;
        
        this.saveState();
        this.updateUI();
        this.updatePatientContext();
    }
    
    updateFullStudyPatient(fev1, baselineFev1, txDate, baselineDate, notes) {
        const patient = this.state.patients.get(this.state.currentPatient);
        
        patient.txDate = txDate;
        patient.baselineFev1 = baselineFev1;
        patient.baselineDate = baselineDate;
        if (notes) {
            patient.description = notes;
        }
        
        // Add current measurement as a visit
        patient.visits.push({
            date: new Date().toISOString().split('T')[0],
            fev1,
            fvc: null,
            notes: 'Full study measurement',
            timestamp: Date.now()
        });
        
        patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        this.savePatient(patient);
        this.updateVisitsTable();
        this.updatePatientContext();
    }
    
    clearFullStudy() {
        this.dom.txDate.value = '';
        this.dom.baselineDate.value = '';
        this.dom.stdFev1.value = '';
        this.dom.stdBaselineFev1.value = '';
        this.dom.clinicalNotes.value = '';
        this.dom.stdResultsPanel.classList.remove('visible');
        
        this.state.session.full = {
            txDate: null,
            baselineDate: null,
            fev1: null,
            baselineFev1: null,
            notes: ''
        };
        
        this.showToast('Full study cleared', 'info');
    }
    
    updateTimeline() {
        const txDate = this.dom.txDate.value;
        const baselineDate = this.dom.baselineDate.value;
        
        if (txDate) {
            this.state.session.full.txDate = txDate;
        }
        
        if (baselineDate) {
            this.state.session.full.baselineDate = baselineDate;
        }
        
        this.handleFullInput();
    }
    
    // === PATIENT MANAGEMENT ===
    
    createPatient() {
        const patientId = this.dom.newPatientId.value.trim().toUpperCase();
        const txDate = this.dom.newTxDate.value;
        const description = this.dom.newPatientDesc.value.trim();
        
        if (!patientId || !txDate) {
            this.showToast('Please enter Patient ID and Transplant Date', 'error');
            return;
        }
        
        if (this.state.patients.has(patientId)) {
            this.showToast('Patient ID already exists', 'error');
            return;
        }
        
        if (!this.validateTxDate(this.dom.newTxDate)) {
            return;
        }
        
        const patient = {
            id: patientId,
            txDate,
            baselineFev1: null,
            baselineDate: null,
            description: description || 'Lung transplant patient',
            visits: []
        };
        
        this.state.patients.set(patientId, patient);
        this.state.currentPatient = patientId;
        
        this.saveState();
        this.hideModal('newPatientModal');
        this.updateUI();
        this.updatePatientContext();
        this.updateVisitsTable();
        
        this.showToast(`Patient ${patientId} created successfully`, 'success');
        this.pushHistory('Patient created');
    }
    
    showPatientList() {
        this.dom.patientList.innerHTML = '';
        
        if (this.state.patients.size === 0) {
            this.dom.patientList.innerHTML = `
                <div class="empty-state" style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">
                    <div style="font-size: 2rem; margin-bottom: var(--space-2);"></div>
                    <p>No patients yet</p>
                    <p class="notes-hint mt-2">Create your first patient to get started</p>
                </div>`;
        } else {
            Array.from(this.state.patients.entries()).forEach(([id, patient]) => {
                const card = document.createElement('div');
                card.className = `comparison-option ${id === this.state.currentPatient ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="option-content">
                        <div class="option-label">${patient.id}</div>
                        <div class="option-note">
                            <span>TX: ${patient.txDate}</span>
                            <span></span>
                            <span>${patient.visits.length} visits</span>
                            ${patient.baselineFev1 ? `<span></span><span>Baseline: ${patient.baselineFev1}L</span>` : ''}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 4px;">
                            ${patient.description}
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => this.selectPatient(id));
                this.dom.patientList.appendChild(card);
            });
        }
        
        this.showModal('patientListModal');
    }
    
    selectPatient(patientId) {
        this.state.currentPatient = patientId;
        this.hideModal('patientListModal');
        this.updateUI();
        this.updatePatientContext();
        this.updateVisitsTable();
        this.updateTimelineChart();
        
        const patient = this.state.patients.get(patientId);
        this.showToast(`Selected patient: ${patientId}`, 'success');
        
        // Update quick mode baseline input if applicable
        if (patient.baselineFev1) {
            this.dom.baselineInput.value = patient.baselineFev1;
            this.state.session.quick.baseline = patient.baselineFev1;
            this.state.session.quick.baselineSource = 'patient';
        }
    }
    
    savePatient(patient) {
        this.state.patients.set(patient.id, patient);
        this.saveState();
        this.updatePatientContext();
    }
    
    updatePatientContext() {
        if (!this.state.currentPatient) {
            // No patient selected
            this.dom.patientAvatar.textContent = '--';
            this.dom.patientIdDisplay.textContent = 'Select Patient';
            this.dom.patientStatusBadge.textContent = 'No data';
            this.dom.visitsCountCompact.textContent = '0 visits';
            this.dom.txDateIndicator.className = 'tx-date-indicator missing';
            this.dom.txDateDisplay.textContent = 'No TX date';
            this.dom.manualBaselineInput.value = '';
            this.dom.setBaselineBtn.disabled = true;
            
            // Update breadcrumb
            this.dom.breadcrumbPatient.textContent = 'Select Patient';
            
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient) return;
        
        // Update avatar (first two letters of ID)
        this.dom.patientAvatar.textContent = patient.id.substring(0, 2).toUpperCase();
        
        // Update patient info
        this.dom.patientIdDisplay.textContent = patient.id;
        this.dom.patientStatusBadge.textContent = this.getPatientStatus(patient);
        this.dom.visitsCountCompact.textContent = `${patient.visits.length} ${patient.visits.length === 1 ? 'visit' : 'visits'}`;
        
        // Update transplant date indicator
        this.dom.txDateDisplay.textContent = patient.txDate ? `TX: ${patient.txDate}` : 'No TX date';
        
        if (!patient.txDate) {
            this.dom.txDateIndicator.className = 'tx-date-indicator missing';
        } else {
            const txDate = new Date(patient.txDate);
            const today = new Date();
            const daysSinceTx = Math.floor((today - txDate) / (1000 * 60 * 60 * 24));
            
            if (daysSinceTx < 90) {
                this.dom.txDateIndicator.className = 'tx-date-indicator recent';
            } else {
                this.dom.txDateIndicator.className = 'tx-date-indicator valid';
            }
        }
        
        // Update manual baseline input
        if (patient.baselineFev1) {
            this.dom.manualBaselineInput.value = patient.baselineFev1;
            this.dom.setBaselineBtn.disabled = true; // Already set
        } else {
            this.dom.manualBaselineInput.value = '';
            this.dom.setBaselineBtn.disabled = false;
        }
        
        // Update breadcrumb
        this.dom.breadcrumbPatient.textContent = patient.id;
        
        // Update patient badges in all modes
        this.updatePatientBadges();
    }
    
    getPatientStatus(patient) {
        if (!patient.visits || patient.visits.length === 0) return 'No visits';
        
        const lastVisit = patient.visits[patient.visits.length - 1];
        if (!patient.baselineFev1) return 'No baseline';
        
        const percentOfBaseline = (lastVisit.fev1 / patient.baselineFev1 * 100);
        
        if (percentOfBaseline < (100 - this.state.protocol.review)) {
            return 'Needs review';
        } else if (percentOfBaseline < (100 - this.state.protocol.monitor)) {
            return 'Monitor';
        } else {
            return 'Stable';
        }
    }
    
    getCurrentPatientName() {
        if (!this.state.currentPatient) return 'Select Patient';
        const patient = this.state.patients.get(this.state.currentPatient);
        return patient ? patient.id : 'Select Patient';
    }
    
    updatePatientBadges() {
        const patientName = this.getCurrentPatientName();
        this.dom.quickPatientBadge.textContent = patientName;
        this.dom.monitorPatientBadge.textContent = patientName;
        this.dom.fullPatientBadge.textContent = patientName;
    }
    
    // === PROTOCOL SETTINGS ===
    
    showProtocolModal() {
        // Set current values
        this.dom.monitorSlider.value = this.state.protocol.monitor;
        this.dom.monitorInput.value = this.state.protocol.monitor;
        this.dom.monitorValue.textContent = `${this.state.protocol.monitor}%`;
        
        this.dom.reviewSlider.value = this.state.protocol.review;
        this.dom.reviewInput.value = this.state.protocol.review;
        this.dom.reviewValue.textContent = `${this.state.protocol.review}%`;
        
        this.dom.stabilityVisits.value = this.state.protocol.stabilityVisits;
        this.dom.stabilityThreshold.value = this.state.protocol.stabilityThreshold;
        
        this.showModal('protocolModal');
    }
    
    saveProtocol() {
        this.state.protocol.monitor = parseInt(this.dom.monitorInput.value);
        this.state.protocol.review = parseInt(this.dom.reviewInput.value);
        this.state.protocol.stabilityVisits = parseInt(this.dom.stabilityVisits.value);
        this.state.protocol.stabilityThreshold = parseInt(this.dom.stabilityThreshold.value);
        
        // Update UI
        this.dom.thresholdMonitorValue.textContent = this.state.protocol.monitor;
        this.dom.thresholdReviewValue.textContent = this.state.protocol.review;
        
        this.saveState();
        this.hideModal('protocolModal');
        this.updateVisitsTable();
        
        this.showToast('Protocol settings saved', 'success');
        this.pushHistory('Protocol updated');
    }
    
    resetProtocol() {
        if (confirm('Reset to default protocol settings?')) {
            this.state.protocol = {
                monitor: 10,
                review: 20,
                stabilityVisits: 4,
                stabilityThreshold: 5
            };
            
            this.showProtocolModal(); // Re-open with defaults
            this.showToast('Protocol reset to defaults', 'info');
        }
    }
    
    // === MODAL MANAGEMENT ===
    
    showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    showDuplicateDateModal() {
        const data = this.state.session.duplicateDateData;
        if (!data) return;
        
        this.dom.duplicateDateMessage.textContent = `A visit already exists for ${data.date}`;
        this.dom.existingFev1.textContent = `${data.existing.fev1}L`;
        this.dom.existingFvc.textContent = data.existing.fvc ? `${data.existing.fvc}L` : '--';
        this.dom.newFev1.textContent = `${data.new.fev1}L`;
        this.dom.newFvc.textContent = data.new.fvc ? `${data.new.fvc}L` : '--';
        
        this.showModal('duplicateDateModal');
    }
    
    handleDuplicateAddAsNew() {
        // Add with a modified date (next day)
        const data = this.state.session.duplicateDateData;
        const patient = this.state.patients.get(this.state.currentPatient);
        
        const date = new Date(data.date);
        date.setDate(date.getDate() + 1);
        const newDate = date.toISOString().split('T')[0];
        
        const visit = {
            date: newDate,
            fev1: data.new.fev1,
            fvc: data.new.fvc,
            notes: data.new.notes,
            timestamp: Date.now()
        };
        
        patient.visits.push(visit);
        patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        this.savePatient(patient);
        this.updateVisitsTable();
        this.updateTimelineChart();
        
        this.hideModal('duplicateDateModal');
        this.state.session.duplicateDateData = null;
        
        this.showToast(`Visit added as ${newDate}`, 'success');
        this.pushHistory('Visit added with modified date');
    }
    
    handleDuplicateReplace() {
        const data = this.state.session.duplicateDateData;
        const patient = this.state.patients.get(this.state.currentPatient);
        
        const index = patient.visits.findIndex(v => v.date === data.date);
        if (index !== -1) {
            patient.visits[index] = {
                date: data.date,
                fev1: data.new.fev1,
                fvc: data.new.fvc,
                notes: data.new.notes,
                timestamp: Date.now()
            };
            
            this.savePatient(patient);
            this.updateVisitsTable();
            this.updateTimelineChart();
            
            this.hideModal('duplicateDateModal');
            this.state.session.duplicateDateData = null;
            
            this.showToast('Visit updated', 'success');
            this.pushHistory('Visit replaced');
        }
    }
    
    showBaselineChangeModal() {
        const data = this.state.session.baselineChangeData;
        if (!data) return;
        
        this.dom.previousBaselineValue.textContent = `${data.previous}L`;
        this.dom.previousBaselineDate.textContent = data.previousDate || 'Unknown date';
        this.dom.newBaselineValue.textContent = `${data.new}L`;
        
        this.showModal('baselineChangeModal');
    }
    
    handleBaselineChange(action) {
        const data = this.state.session.baselineChangeData;
        if (!data) return;
        
        if (action === 'update') {
            this.updatePatientBaseline(data.new);
        }
        // If 'keep', do nothing (keep old baseline)
        
        this.hideModal('baselineChangeModal');
        this.state.session.baselineChangeData = null;
    }
    
    handleBaselineConflict(action) {
        const data = this.state.session.baselineConflictData;
        if (!data) return;
        
        switch(action) {
            case 'patient':
                // Use patient baseline
                this.state.session.quick.baseline = data.patientBaseline;
                this.state.session.quick.baselineSource = 'patient';
                break;
            case 'entered':
                // Use entered baseline
                this.state.session.quick.baseline = data.enteredBaseline;
                this.state.session.quick.baselineSource = 'manual';
                break;
            case 'update':
                // Update patient record
                const patient = this.state.patients.get(this.state.currentPatient);
                patient.baselineFev1 = data.enteredBaseline;
                patient.baselineDate = new Date().toISOString().split('T')[0];
                this.savePatient(patient);
                this.updatePatientContext();
                
                this.state.session.quick.baseline = data.enteredBaseline;
                this.state.session.quick.baselineSource = 'patient';
                break;
        }
        
        this.hideModal('baselineConflictModal');
        this.state.session.baselineConflictData = null;
        this.calculateQuick();
    }
    
    // === CHART METHODS ===
    
    updateTimelineChart() {
        if (!this.state.currentPatient || this.state.mode !== 'monitor') return;
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient || !patient.visits || patient.visits.length < 2) return;
        
        const ctx = this.dom.timelineChart.getContext('2d');
        
        // Destroy existing chart
        if (this.charts.timeline) {
            this.charts.timeline.destroy();
        }
        
        // Prepare data
        const dates = patient.visits.map(v => v.date);
        const fev1Values = patient.visits.map(v => v.fev1);
        const baseline = patient.baselineFev1;
        
        // Calculate percentages if baseline exists
        const percentages = baseline ? 
            patient.visits.map(v => (v.fev1 / baseline * 100).toFixed(1)) : 
            null;
        
        this.charts.timeline = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'FEV (L)',
                    data: fev1Values,
                    borderColor: 'var(--primary)',
                    backgroundColor: 'rgba(26, 95, 122, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: 'var(--text-primary)',
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'var(--glass-bg)',
                        titleColor: 'var(--text-primary)',
                        bodyColor: 'var(--text-secondary)',
                        borderColor: 'var(--glass-border)',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(2) + 'L';
                                
                                if (baseline && percentages) {
                                    label += ` (${percentages[context.dataIndex]}%)`;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                            displayFormats: {
                                month: 'MMM YY'
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-secondary)',
                            maxRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-secondary)',
                            callback: function(value) {
                                return value.toFixed(1) + 'L';
                            }
                        }
                    }
                }
            }
        });
        
        // Update timeline summary
        this.updateTimelineSummary(patient);
    }
    
    updateTimelineSummary(patient) {
        if (!patient.visits || patient.visits.length === 0) return;
        
        const visits = patient.visits;
        const firstDate = new Date(visits[0].date);
        const lastDate = new Date(visits[visits.length - 1].date);
        
        // Time span
        const daysSpan = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
        const monthsSpan = (daysSpan / 30.44).toFixed(1);
        this.dom.timelineTimeSpan.textContent = `${daysSpan} days (${monthsSpan} months)`;
        
        // Average interval
        let totalDays = 0;
        for (let i = 1; i < visits.length; i++) {
            const prevDate = new Date(visits[i - 1].date);
            const currDate = new Date(visits[i].date);
            totalDays += Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
        }
        const avgInterval = totalDays / (visits.length - 1);
        this.dom.timelineAvgInterval.textContent = `${avgInterval.toFixed(0)} days`;
        
        // Current status
        this.dom.timelineStatus.textContent = this.getPatientStatus(patient);
        
        // Total visits
        this.dom.timelineTotalVisits.textContent = visits.length;
    }
    
    renderFev1Chart() {
        if (!this.state.currentPatient) return;
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient || !patient.visits || patient.visits.length < 2) return;
        
        const ctx = this.dom.fev1Chart.getContext('2d');
        
        // Destroy existing chart
        if (this.charts.fev1) {
            this.charts.fev1.destroy();
        }
        
        // Prepare data
        const visits = patient.visits;
        const dates = visits.map(v => v.date);
        const fev1Values = visits.map(v => v.fev1);
        
        // Calculate trend line
        const trendData = this.calculateTrendLine(dates, fev1Values);
        
        this.charts.fev1 = new Chart(ctx, {
            type: 'scatter',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'FEV Measurements',
                        data: fev1Values.map((value, index) => ({
                            x: new Date(dates[index]).getTime(),
                            y: value
                        })),
                        backgroundColor: 'var(--primary)',
                        borderColor: 'var(--primary)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Trend Line',
                        data: trendData,
                        type: 'line',
                        borderColor: 'var(--warning)',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: 'var(--text-primary)'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + 'L';
                                }
                                return label;
                            },
                            title: function(context) {
                                const date = new Date(context[0].parsed.x);
                                return date.toLocaleDateString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                            displayFormats: {
                                month: 'MMM YY'
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-secondary)',
                            maxRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'var(--text-secondary)',
                            callback: function(value) {
                                return value.toFixed(1) + 'L';
                            }
                        },
                        title: {
                            display: true,
                            text: 'FEV (Liters)',
                            color: 'var(--text-secondary)'
                        }
                    }
                }
            }
        });
    }
    
    calculateTrendLine(dates, values) {
        // Simple linear regression
        const xValues = dates.map((date, index) => new Date(date).getTime());
        const yValues = values;
        
        const n = xValues.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        
        for (let i = 0; i < n; i++) {
            sumX += xValues[i];
            sumY += yValues[i];
            sumXY += xValues[i] * yValues[i];
            sumXX += xValues[i] * xValues[i];
        }
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        // Generate trend points
        const trendData = [];
        if (n > 1) {
            const firstX = xValues[0];
            const lastX = xValues[n - 1];
            
            trendData.push({
                x: firstX,
                y: slope * firstX + intercept
            });
            
            trendData.push({
                x: lastX,
                y: slope * lastX + intercept
            });
        }
        
        return trendData;
    }
    
    // === EXPORT METHODS ===
    
    exportAllData() {
        if (this.state.patients.size === 0) {
            this.showToast('No patient data to export', 'warning');
            return;
        }
        
        const exportData = {
            app: 'Spirolite Professional',
            version: '1.4',
            exportDate: new Date().toISOString(),
            protocol: this.state.protocol,
            patients: Object.fromEntries(this.state.patients)
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `spirolite-export-${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        this.showToast('All data exported successfully', 'success');
    }
    
    exportProfessionalPDF() {
        if (!this.state.currentPatient) {
            this.showToast('Please select a patient first', 'error');
            return;
        }
        
        const patient = this.state.patients.get(this.state.currentPatient);
        if (!patient || patient.visits.length === 0) {
            this.showToast('No visit data to export', 'warning');
            return;
        }
        
        this.showToast('PDF export started...', 'info');
        
        // In a real implementation, you would use jsPDF here
        // For now, we'll create a CSV export as fallback
        this.exportPatientCSV(patient);
    }
    
    exportPatientCSV(patient) {
        const headers = ['Date', 'Days Post-Tx', 'FEV (L)', 'FVC (L)', 'FEV/FVC', '% of Baseline', ' from Previous', 'Notes'];
        const rows = [headers];
        
        let previousFev1 = null;
        
        patient.visits.forEach((visit, index) => {
            const date = new Date(visit.date);
            const daysSinceTx = patient.txDate ? 
                Math.floor((date - new Date(patient.txDate)) / (1000 * 60 * 60 * 24)) : '';
            
            const ratio = visit.fvc ? ((visit.fev1 / visit.fvc) * 100).toFixed(1) : '';
            const percentOfBaseline = patient.baselineFev1 ? 
                ((visit.fev1 / patient.baselineFev1) * 100).toFixed(1) : '';
            
            let delta = '';
            if (previousFev1 !== null) {
                delta = (visit.fev1 - previousFev1).toFixed(2);
            }
            previousFev1 = visit.fev1;
            
            rows.push([
                visit.date,
                daysSinceTx,
                visit.fev1.toFixed(2),
                visit.fvc ? visit.fvc.toFixed(2) : '',
                ratio,
                percentOfBaseline,
                delta,
                visit.notes || ''
            ]);
        });
        
        const csvContent = rows.map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `spirolite-${patient.id}-${new Date().toISOString().split('T')[0]}.csv`);
        link.click();
        
        URL.revokeObjectURL(url);
        
        this.showToast('CSV report exported', 'success');
    }
    
    exportTimelinePDF() {
        this.showToast('Timeline PDF export not yet implemented', 'warning');
    }
    
    // === UTILITY METHODS ===
    
    saveState() {
        try {
            const stateToSave = {
                protocol: this.state.protocol,
                colorCoding: this.state.colorCoding,
                percentageView: this.state.percentageView,
                patients: Array.from(this.state.patients.entries()),
                currentPatient: this.state.currentPatient,
                language: this.state.language
            };
            localStorage.setItem('spirolite_state', JSON.stringify(stateToSave));
            this.showSaveIndicator('success', 'Saved');
        } catch (error) {
            console.error('Failed to save state:', error);
            this.showSaveIndicator('error', 'Save failed');
        }
    }
    
    loadState() {
        try {
            const saved = localStorage.getItem('spirolite_state');
            if (saved) {
                const state = JSON.parse(saved);
                this.state.protocol = state.protocol || this.state.protocol;
                this.state.colorCoding = state.colorCoding !== undefined ? state.colorCoding : true;
                this.state.percentageView = state.percentageView !== undefined ? state.percentageView : true;
                this.state.patients = new Map(state.patients || []);
                this.state.currentPatient = state.currentPatient;
                this.state.language = state.language || 'en';
                
                // Update UI elements
                this.dom.colorCodingToggle.checked = this.state.colorCoding;
                this.dom.languageToggle.textContent = this.state.language.toUpperCase();
                
                // Update patient context
                this.updatePatientContext();
            }
        } catch (error) {
            console.error('Failed to load state:', error);
        }
    }
    
    hasUnsavedChanges() {
        // Check for unsaved patient data
        if (this.state.currentPatient && this.state.patients.has(this.state.currentPatient)) {
            const patient = this.state.patients.get(this.state.currentPatient);
            return patient.visits && patient.visits.length > 0;
        }
        return false;
    }
    
    pushHistory(action) {
        this.history.push(this.state, action);
        this.updateUndoRedoButtons();
    }
    
    handleUndo() {
        const state = this.history.undo();
        if (state) {
            this.state = state.state;
            this.updateUI();
            this.updateVisitsTable();
            this.updatePatientContext();
            this.showToast(`Undo: ${state.action}`, 'info');
        }
    }
    
    handleRedo() {
        const state = this.history.redo();
        if (state) {
            this.state = state.state;
            this.updateUI();
            this.updateVisitsTable();
            this.updatePatientContext();
            this.showToast(`Redo: ${state.action}`, 'info');
        }
    }
    
    updateUndoRedoButtons() {
        this.dom.undoBtn.disabled = !this.history.canUndo();
        this.dom.redoBtn.disabled = !this.history.canRedo();
    }
    
    handleKeyboardShortcuts(e) {
        // Don't trigger shortcuts when user is typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }
        
        // Ctrl+Z for undo
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            this.handleUndo();
        }
        
        // Ctrl+Y for redo
        if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            this.handleRedo();
        }
        
        // Number keys for quick mode switching
        if (!e.ctrlKey && !e.altKey) {
            switch(e.key) {
                case '1':
                    e.preventDefault();
                    this.switchMode('quick');
                    break;
                case '2':
                    e.preventDefault();
                    this.switchMode('monitor');
                    break;
                case '3':
                    e.preventDefault();
                    this.switchMode('full');
                    break;
                case 'Escape':
                    // Close any open modal
                    const openModal = document.querySelector('.modal-overlay.active');
                    if (openModal) {
                        this.hideModal(openModal.id);
                    }
                    break;
            }
        }
    }
    
    updateUI() {
        // Update language-specific elements
        this.updateLanguageText();
        
        // Update patient context
        this.updatePatientContext();
        
        // Update color coding
        if (this.state.colorCoding) {
            document.body.classList.remove('color-coding-off');
        } else {
            document.body.classList.add('color-coding-off');
        }
        
        // Update protocol threshold displays
        this.dom.thresholdMonitorValue.textContent = this.state.protocol.monitor;
        this.dom.thresholdReviewValue.textContent = this.state.protocol.review;
    }
    
    updateLanguageText() {
        // This would update all text elements based on current language
        // For now, we'll just update a few key elements
        if (this.state.language === 'es') {
            // Spanish translations
            this.dom.breadcrumbQuick.textContent = 'Clculo Rpido';
            this.dom.breadcrumbPatient.textContent = this.getCurrentPatientName();
            // Add more translations as needed
        } else {
            // English (default)
            this.dom.breadcrumbQuick.textContent = 'Quick Calc';
            this.dom.breadcrumbPatient.textContent = this.getCurrentPatientName();
        }
    }
    
    showSaveIndicator(type, text) {
        const indicator = this.dom.saveIndicator;
        indicator.className = `save-indicator visible ${type}`;
        indicator.querySelector('.save-text').textContent = text;
        
        setTimeout(() => {
            indicator.classList.remove('visible');
        }, 2000);
    }
    
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: '',
            warning: '',
            error: '',
            info: ''
        };
        
        toast.innerHTML = `
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <div class="toast-content">
                <div class="toast-message">${message}</div>
            </div>
        `;
        
        this.dom.toastContainer.appendChild(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(30px)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 4000);
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.spiroliteApp = new SpiroliteApp();
});
</script>
</body>
</html>
