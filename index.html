<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0D4B63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Spirolite - Precision Lung Function Tracking">
    
    <title>SPIROLITE | Precision Lung Tracking</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ===== COMPLETE CSS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }
        
        :root {
            --primary-blue: #0D4B63;
            --secondary-blue: #1A5F7A;
            --accent-teal: #2D9596;
            --accent-blue: #57C5B6;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(13, 75, 99, 0.1);
            --glass-blur: blur(20px);
            --success: #059669;
            --success-glass: rgba(5, 150, 105, 0.15);
            --warning: #D97706;
            --warning-glass: rgba(217, 119, 6, 0.15);
            --alert: #DC2626;
            --alert-glass: rgba(220, 38, 38, 0.15);
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-tertiary: #64748B;
            --bg-base: #F8FAFC;
            --bg-surface: #FFFFFF;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.5rem;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-mono: 'SF Mono', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --z-modal: 1000;
            --z-toast: 10000;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-blue: #57C5B6;
                --secondary-blue: #2D9596;
                --accent-teal: #1A5F7A;
                --glass-bg: rgba(30, 41, 59, 0.4);
                --glass-border: rgba(255, 255, 255, 0.1);
                --bg-base: #0F172A;
                --bg-surface: #1E293B;
                --text-primary: #F8FAFB;
                --text-secondary: #CBD5E1;
                --text-tertiary: #94A3B8;
            }
        }
        
        body {
            font-family: var(--font-family);
            background: var(--bg-base);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }
        
        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            opacity: 0;
        }
        
        .app-container.loaded {
            opacity: 1;
            transition: opacity 0.3s;
        }
        
        /* Glass Effects */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: var(--radius-lg);
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            transition: all var(--transition-fast);
        }
        
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(87, 197, 182, 0.1);
            outline: none;
        }
        
        /* Language Toggle */
        .language-toggle {
            position: relative;
            width: 56px;
            height: 28px;
        }
        
        .language-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .language-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            transition: .4s;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            padding: 0 4px;
        }
        
        .language-toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal));
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 2;
        }
        
        .language-flag {
            position: absolute;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1;
        }
        
        .language-flag.en { right: 8px; }
        .language-flag.es { left: 8px; }
        
        .language-toggle input:checked + .language-toggle-slider:before {
            transform: translateX(28px);
        }
        
        /* Header */
        .app-header {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-4);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .app-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .app-logo::before {
            content: '';
            position: absolute;
            width: 28px;
            height: 28px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .app-name h1 {
            font-size: 1.375rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Navigation */
        .app-navigation {
            display: flex;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--space-2) var(--space-4);
            gap: var(--space-1);
            position: sticky;
            top: 73px;
            z-index: 100;
        }
        
        .nav-btn {
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-lg);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            min-width: 80px;
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal));
            color: white;
            box-shadow: 0 4px 12px rgba(13, 75, 99, 0.2);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }
        
        .mode-section {
            display: none;
        }
        
        .mode-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .calculator-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }
        
        /* Inputs */
        .input-group {
            position: relative;
            margin-bottom: var(--space-4);
        }
        
        .input-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .measurement-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            font-family: var(--font-family-mono);
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
        }
        
        /* Data Entry Modes */
        .visual-data-entry {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-3);
        }
        
        .entry-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .entry-card:hover {
            background: rgba(87, 197, 182, 0.1);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .entry-card.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        /* Results */
        .results-panel {
            margin-top: var(--space-4);
            display: none;
        }
        
        .results-panel.visible {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .measurement-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        /* Stability Indicators */
        .stability-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: 0.6875rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .stability-indicator.stable {
            background: var(--success-glass);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .baseline-ready {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            background: linear-gradient(135deg, var(--success), rgba(5, 150, 105, 0.9));
            backdrop-filter: blur(10px);
            color: white;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
            margin-left: var(--space-2);
            border: none;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Charts */
        .chart-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            height: 300px;
            position: relative;
            margin-bottom: var(--space-3);
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-4);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Toasts */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .toast {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            max-width: 320px;
            animation: slideInRight 0.3s;
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Language Classes */
        .lang-en { display: block; }
        .lang-es { display: none; }
        
        html[lang="es"] .lang-en { display: none; }
        html[lang="es"] .lang-es { display: block; }
        
        /* Responsive */
        @media (max-width: 640px) {
            .measurements-grid {
                grid-template-columns: 1fr;
            }
            
            .visual-data-entry {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 2rem; margin-bottom: var(--space-4);">SPIROLITE</div>
            <div style="font-size: 0.875rem;">Precision Lung Tracking v2.0</div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-title">
                    <div class="app-logo"></div>
                    <div class="app-name">
                        <h1>SPIROLITE</h1>
                        <span class="lang-en" style="font-size: 0.6875rem; color: var(--text-secondary);">Precision Lung Tracking</span>
                        <span class="lang-es" style="font-size: 0.6875rem; color: var(--text-secondary);">Seguimiento Pulmonar de Precisi√≥n</span>
                    </div>
                </div>
                <div style="display: flex; gap: var(--space-2); align-items: center;">
                    <!-- Language Toggle -->
                    <label class="language-toggle" title="English / Espa√±ol">
                        <input type="checkbox" id="languageToggle">
                        <span class="language-toggle-slider">
                            <span class="language-flag en">EN</span>
                            <span class="language-flag es">ES</span>
                        </span>
                    </label>
                    
                    <button class="glass-panel" style="width: 36px; height: 36px; border: none; cursor: pointer;" id="exportBtn" title="Export">
                        üì§
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav class="app-navigation">
            <button class="nav-btn active" data-mode="quick">
                ‚ö°
                <span class="lang-en">Quick Calc</span>
                <span class="lang-es">C√°lculo R√°pido</span>
            </button>
            <button class="nav-btn" data-mode="monitor">
                üìä
                <span class="lang-en">Monitor</span>
                <span class="lang-es">Monitoreo</span>
            </button>
            <button class="nav-btn" data-mode="review">
                üëÅÔ∏è
                <span class="lang-en">Review</span>
                <span class="lang-es">Revisi√≥n</span>
            </button>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Calc Mode -->
            <div id="modeQuick" class="mode-section active">
                <div class="calculator-card">
                    <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-5); display: flex; justify-content: space-between; align-items: center;">
                        <span class="lang-en">Quick Calculation</span>
                        <span class="lang-es">C√°lculo R√°pido</span>
                        <span class="glass-panel" style="padding: var(--space-1) var(--space-3); font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="quickPatientBadge">--</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div class="input-group">
                            <div class="input-label">
                                <span>FEV‚ÇÅ</span>
                                <span style="color: var(--text-tertiary); font-weight: normal;">L</span>
                            </div>
                            <input type="number" step="0.01" min="0.5" max="8.0" class="measurement-input" id="inputFev1" placeholder="2.85" autofocus>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-label">
                                <span>FVC</span>
                                <span style="color: var(--text-tertiary); font-weight: normal;" class="lang-en">L (optional)</span>
                                <span style="color: var(--text-tertiary); font-weight: normal;" class="lang-es">L (opcional)</span>
                            </div>
                            <input type="number" step="0.01" min="0.5" max="10.0" class="measurement-input" id="inputFvc" placeholder="3.40">
                        </div>
                    </div>
                    
                    <!-- Comparison -->
                    <div class="glass-panel" style="padding: var(--space-4); margin: var(--space-4) 0;">
                        <div class="input-label">
                            <span class="lang-en">Comparison Reference</span>
                            <span class="lang-es">Referencia de Comparaci√≥n</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <label style="display: flex; align-items: center; padding: var(--space-2); border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                                <input type="radio" name="comparison" value="none" checked style="margin-right: var(--space-2);">
                                <span class="lang-en" style="font-size: 0.8125rem;">Current values only</span>
                                <span class="lang-es" style="font-size: 0.8125rem;">Solo valores actuales</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: var(--space-2); border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                                <input type="radio" name="comparison" value="baseline" style="margin-right: var(--space-2);">
                                <span class="lang-en" style="font-size: 0.8125rem;">vs Established Baseline</span>
                                <span class="lang-es" style="font-size: 0.8125rem;">vs L√≠nea Base</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Results -->
                <div class="results-panel" id="resultsPanel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                        <div class="input-label">
                            <span class="lang-en">Objective Measurements</span>
                            <span class="lang-es">Mediciones Objetivas</span>
                        </div>
                        <div style="font-size: 0.6875rem; color: var(--text-tertiary);" id="resultsTimestamp"></div>
                    </div>
                    
                    <div class="measurements-grid">
                        <div class="measurement-card">
                            <span class="input-label">FEV‚ÇÅ</span>
                            <div style="display: flex; align-items: baseline; gap: var(--space-2); justify-content: center; margin: var(--space-2) 0;">
                                <div style="font-family: var(--font-family-mono); font-weight: 600; font-size: 1.125rem; color: var(--text-primary);" id="resultFev1Liters">--</div>
                                <div style="font-size: 0.75rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: rgba(148, 163, 184, 0.1); color: var(--text-tertiary);" id="resultFev1Percent">--%</div>
                            </div>
                            <span style="font-size: 0.6875rem; color: var(--text-tertiary);">L</span>
                        </div>
                        <div class="measurement-card">
                            <span class="input-label">FVC</span>
                            <div style="font-family: var(--font-family-mono); font-weight: 600; font-size: 1.125rem; color: var(--text-primary); margin: var(--space-2) 0;" id="resultFvc">--</div>
                            <span style="font-size: 0.6875rem; color: var(--text-tertiary);">L</span>
                        </div>
                        <div class="measurement-card">
                            <span class="input-label">FEV‚ÇÅ/FVC</span>
                            <div style="font-family: var(--font-family-mono); font-weight: 600; font-size: 1.125rem; color: var(--text-primary); margin: var(--space-2) 0;" id="resultRatio">--</div>
                            <span style="font-size: 0.6875rem; color: var(--text-tertiary);">%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: var(--space-2); margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--glass-border);">
                    <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; color: var(--text-secondary);" id="clearQuickBtn">
                        üóëÔ∏è <span class="lang-en">Clear</span><span class="lang-es">Limpiar</span>
                    </button>
                    <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="calculateBtn">
                        üßÆ <span class="lang-en">Calculate</span><span class="lang-es">Calcular</span>
                    </button>
                </div>
            </div>
            
            <!-- Monitor Mode -->
            <div id="modeMonitor" class="mode-section">
                <div class="calculator-card">
                    <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-5); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-2);">
                        <span class="lang-en">First Year Monitoring</span>
                        <span class="lang-es">Monitoreo Primer A√±o</span>
                        <div style="display: flex; gap: var(--space-2); align-items: center;">
                            <span class="glass-panel" style="padding: var(--space-1) var(--space-3); font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="monitorPatientBadge">--</span>
                            <button id="baselineReadyBadge" class="baseline-ready hidden">
                                üéØ <span class="lang-en">Baseline Ready</span><span class="lang-es">Base Lista</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Data Entry Modes -->
                    <div class="visual-data-entry">
                        <div class="entry-card active" id="singleEntryCard">
                            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: var(--space-1);" class="lang-en">Single Entry</h4>
                            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: var(--space-1);" class="lang-es">Entrada √önica</h4>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4;" class="lang-en">Add individual visit data</p>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4;" class="lang-es">Agregar datos de visita individual</p>
                        </div>
                        <div class="entry-card" id="bulkEntryCard">
                            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: var(--space-1);" class="lang-en">Bulk Import</h4>
                            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: var(--space-1);" class="lang-es">Importaci√≥n Masiva</h4>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4;" class="lang-en">Import multiple visits</p>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4;" class="lang-es">Importar m√∫ltiples visitas</p>
                        </div>
                        <div class="entry-card" id="spreadsheetCard">
                            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: var(--space-1);" class="lang-en">Spreadsheet View</h4>
                            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: var(--space-1);" class="lang-es">Vista Hoja C√°lculo</h4>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4;" class="lang-en">Edit in table format</p>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); line-height: 1.4;" class="lang-es">Editar en formato tabla</p>
                        </div>
                    </div>
                    
                    <!-- Single Entry Form -->
                    <div id="singleEntryForm" style="margin-top: var(--space-4);">
                        <div class="input-label">
                            <span class="lang-en">Add Visit</span>
                            <span class="lang-es">Agregar Visita</span>
                        </div>
                        <div style="display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap;">
                            <input type="date" class="glass-input" style="flex: 1; min-width: 140px; padding: var(--space-2) var(--space-3);" id="visitDate">
                            <input type="number" step="0.01" class="glass-input" style="flex: 1; min-width: 100px; padding: var(--space-2) var(--space-3);" id="visitFev1" placeholder="FEV‚ÇÅ (L)">
                            <input type="number" step="0.01" class="glass-input" style="flex: 1; min-width: 100px; padding: var(--space-2) var(--space-3);" id="visitFvc" placeholder="FVC (L)">
                            <button class="glass-panel" style="width: 36px; height: 36px; border: none; cursor: pointer;" id="addVisitBtn" title="Add Visit">
                                ‚ûï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Import -->
                    <div id="bulkImportSection" style="margin-top: var(--space-4); display: none;">
                        <div class="input-label">
                            <span class="lang-en">Bulk Import</span>
                            <span class="lang-es">Importaci√≥n Masiva</span>
                        </div>
                        <textarea class="glass-input" style="width: 100%; min-height: 100px; padding: var(--space-3); font-family: monospace; font-size: 0.75rem; margin-top: var(--space-2); resize: vertical;" id="bulkImport" placeholder="YYYY-MM-DD, FEV1, FVC, NOTES"></textarea>
                        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-3);">
                            <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; color: var(--text-secondary);" id="clearBulkBtn">
                                üóëÔ∏è <span class="lang-en">Clear</span><span class="lang-es">Limpiar</span>
                            </button>
                            <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="importBulkBtn">
                                üì• <span class="lang-en">Import</span><span class="lang-es">Importar</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Spreadsheet View -->
                    <div id="spreadsheetSection" style="margin-top: var(--space-4); display: none;">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 600px;">
                                <thead>
                                    <tr style="background: rgba(13, 75, 99, 0.05);">
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">Date</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">FEV‚ÇÅ</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">FVC</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="spreadsheetBody">
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Visits Table -->
                    <div style="margin-top: var(--space-4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                            <span style="font-weight: 600; font-size: 0.8125rem;" class="lang-en">Visit History</span>
                            <span style="font-weight: 600; font-size: 0.8125rem;" class="lang-es">Historial de Visitas</span>
                            <div style="display: flex; gap: var(--space-2);">
                                <button class="glass-panel" style="width: 32px; height: 32px; border: none; cursor: pointer;" id="calculateBaselineBtn" title="Calculate Baseline">
                                    üßÆ
                                </button>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 800px;">
                                <thead>
                                    <tr style="background: rgba(13, 75, 99, 0.05);">
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">Date</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">FEV‚ÇÅ</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">% of PB</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">Œî Visit</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">Œî Baseline</th>
                                        <th style="padding: var(--space-2); text-align: left; font-weight: 600; color: var(--text-secondary);">Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody">
                                    <tr>
                                        <td colspan="6" style="padding: var(--space-6); text-align: center; color: var(--text-tertiary);">
                                            <span class="lang-en">No visits yet. Add visits using the form above.</span>
                                            <span class="lang-es">No hay visitas a√∫n. Agregue visitas usando el formulario arriba.</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Chart -->
                    <div id="chartSection" style="margin-top: var(--space-4); display: none;">
                        <div class="chart-container">
                            <canvas id="fev1Chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Monitor Actions -->
                <div style="display: flex; gap: var(--space-2); margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--glass-border);">
                    <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; color: var(--text-secondary);" id="clearMonitorBtn">
                        üóëÔ∏è <span class="lang-en">Clear Table</span><span class="lang-es">Limpiar Tabla</span>
                    </button>
                    <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="toggleChartBtn">
                        üìà <span class="lang-en">Show Chart</span><span class="lang-es">Mostrar Gr√°fico</span>
                    </button>
                </div>
            </div>
            
            <!-- Review Mode -->
            <div id="modeReview" class="mode-section">
                <div class="calculator-card">
                    <div style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-5); display: flex; justify-content: space-between; align-items: center;">
                        <span class="lang-en">Patient Review</span>
                        <span class="lang-es">Revisi√≥n del Paciente</span>
                        <span class="glass-panel" style="padding: var(--space-1) var(--space-3); font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="reviewPatientBadge">--</span>
                    </div>
                    
                    <!-- Patient Summary -->
                    <div class="glass-panel" style="padding: var(--space-4); margin-bottom: var(--space-4);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-3);">
                            <div style="text-align: center;">
                                <div style="font-family: var(--font-family-mono); font-size: 1rem; font-weight: 600; color: var(--primary-blue); margin: var(--space-1) 0;" id="reviewTxDays">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-en">Days Post-Tx</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-es">D√≠as Post-Tx</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: var(--font-family-mono); font-size: 1rem; font-weight: 600; color: var(--primary-blue); margin: var(--space-1) 0;" id="reviewVisits">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-en">Total Visits</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-es">Total Visitas</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: var(--font-family-mono); font-size: 1rem; font-weight: 600; color: var(--primary-blue); margin: var(--space-1) 0;" id="reviewLastFev1">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-en">Last FEV‚ÇÅ</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-es">√öltimo FEV‚ÇÅ</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: var(--font-family-mono); font-size: 1rem; font-weight: 600; color: var(--primary-blue); margin: var(--space-1) 0;" id="reviewBestFev1">--</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-en">Best FEV‚ÇÅ</div>
                                <div style="font-size: 0.6875rem; color: var(--text-secondary); font-weight: 600;" class="lang-es">Mejor FEV‚ÇÅ</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visits List -->
                    <div id="visitsList">
                        <div style="text-align: center; padding: var(--space-6); color: var(--text-tertiary);">
                            <div style="font-size: 2rem; margin-bottom: var(--space-3); opacity: 0.3;">üìä</div>
                            <p class="lang-en">No visit history available</p>
                            <p class="lang-es">No hay historial de visitas disponible</p>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: var(--space-2);" class="lang-en">Start by entering measurements in Quick Calc mode</p>
                            <p style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: var(--space-2);" class="lang-es">Comience ingresando mediciones en modo C√°lculo R√°pido</p>
                        </div>
                    </div>
                </div>
                
                <!-- Review Actions -->
                <div style="display: flex; gap: var(--space-2); margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--glass-border);">
                    <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; color: var(--text-secondary;" id="exportReviewBtn">
                        üìÑ <span class="lang-en">Export PDF</span><span class="lang-es">Exportar PDF</span>
                    </button>
                    <button class="glass-panel" style="flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="newAnalysisBtn">
                        üÜï <span class="lang-en">New Analysis</span><span class="lang-es">Nuevo An√°lisis</span>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Baseline Modal -->
    <div class="modal-overlay" id="baselineModal">
        <div class="modal-content">
            <div class="modal-header" style="padding: var(--space-4); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--space-2);">
                    <span class="lang-en">Baseline Calculation</span>
                    <span class="lang-es">C√°lculo de L√≠nea Base</span>
                    <span class="stability-indicator stable">
                        ‚úÖ <span class="lang-en">Stable Period</span><span class="lang-es">Per√≠odo Estable</span>
                    </span>
                </div>
                <button class="glass-panel" style="width: 32px; height: 32px; border: none; cursor: pointer;" id="closeBaselineModal">‚úï</button>
            </div>
            <div style="padding: var(--space-4);">
                <div class="glass-panel" style="padding: var(--space-3); margin-bottom: var(--space-4);">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-2);" class="lang-en">Stable Period Analysis</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-2);" class="lang-es">An√°lisis del Per√≠odo Estable</div>
                    <div style="height: 60px; position: relative; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: var(--space-2);" id="stabilityChart"></div>
                    <div style="font-size: 0.75rem; color: var(--text-tertiary);" id="stabilitySummary">
                        <!-- Will be filled by JS -->
                    </div>
                </div>
                
                <div class="glass-panel" style="padding: var(--space-3);">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2);" class="lang-en">Highest FEV‚ÇÅ Values from Stable Period:</div>
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2);" class="lang-es">Valores m√°s altos de FEV‚ÇÅ del Per√≠odo Estable:</div>
                    <div style="font-family: var(--font-family-mono); padding: var(--space-3); background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: var(--space-3);" id="highestValuesList"></div>
                    
                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                        <span style="font-weight: 600; color: var(--text-primary);" class="lang-en">Suggested baseline:</span>
                        <span style="font-weight: 600; color: var(--text-primary);" class="lang-es">Base sugerida:</span>
                        <input type="number" step="0.01" class="glass-input" style="flex: 2; padding: var(--space-2);" id="calculatedBaseline">
                        <span style="font-weight: 500; color: var(--text-secondary);">L</span>
                    </div>
                    
                    <div style="margin-top: var(--space-3);">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-2);" class="lang-en">Stability Analysis</div>
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-2);" class="lang-es">An√°lisis de Estabilidad</div>
                        <div style="font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.5;">
                            <div id="stabilityCriteria"></div>
                            <div id="stabilityVariation" style="margin-top: var(--space-2);"></div>
                            <div id="stabilityRate" style="margin-top: var(--space-2);"></div>
                            <div id="baselineRecommendation" style="margin-top: var(--space-2); color: var(--success); font-weight: 600;"></div>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--space-3);">
                        <span class="lang-en">Calculated from stable period measurements (average of 2 highest values).</span>
                        <span class="lang-es">Calculado de mediciones del per√≠odo estable (promedio de 2 valores m√°s altos).</span>
                    </div>
                </div>
            </div>
            <div style="padding: var(--space-3) var(--space-4); border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: var(--space-2);">
                <button class="glass-panel" style="padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; color: var(--text-secondary);" id="cancelBaselineBtn">
                    üö´ <span class="lang-en">Cancel</span><span class="lang-es">Cancelar</span>
                </button>
                <button class="glass-panel" style="padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 0.8125rem; cursor: pointer; background: linear-gradient(135deg, var(--primary-blue), var(--accent-teal)); color: white;" id="acceptBaselineBtn">
                    ‚úì <span class="lang-en">Accept as Baseline</span><span class="lang-es">Aceptar como Base</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== COMPLETE JAVASCRIPT IMPLEMENTATION ===== -->
    <script>
    class SpiroliteApp {
        constructor() {
            this.state = {
                mode: 'quick',
                language: 'en',
                protocol: {
                    monitor: 10,
                    review: 20,
                    stabilityVisits: 4,
                    stabilityThreshold: 5
                },
                colorCoding: true,
                currentPatient: null,
                patients: new Map(),
                session: {
                    quick: {
                        fev1: null,
                        fvc: null,
                        comparison: 'none',
                        baseline: null
                    },
                    monitor: {
                        visits: [],
                        entryMode: 'single',
                        chart: null,
                        stabilityChart: null
                    }
                }
            };
            
            this.dom = {};
            this.translations = {
                en: {
                    'No visits yet': 'No visits yet',
                    'Add visits using the form above': 'Add visits using the form above'
                },
                es: {
                    'No visits yet': 'No hay visitas a√∫n',
                    'Add visits using the form above': 'Agregue visitas usando el formulario arriba'
                }
            };
            
            this.init();
        }
        
        async init() {
            await this.cacheDOM();
            this.setupEventListeners();
            this.initCharts();
            this.loadState();
            this.updateUI();
            
            setTimeout(() => {
                this.dom.loadingOverlay.classList.add('fade-out');
                this.dom.appContainer.classList.add('loaded');
                setTimeout(() => {
                    this.dom.loadingOverlay.style.display = 'none';
                }, 500);
            }, 1000);
        }
        
        cacheDOM() {
            // Loading
            this.dom.loadingOverlay = document.getElementById('loadingOverlay');
            this.dom.appContainer = document.getElementById('appContainer');
            
            // Language Toggle
            this.dom.languageToggle = document.getElementById('languageToggle');
            
            // Navigation
            this.dom.navBtns = document.querySelectorAll('.nav-btn');
            
            // Quick Mode
            this.dom.modeQuick = document.getElementById('modeQuick');
            this.dom.inputFev1 = document.getElementById('inputFev1');
            this.dom.inputFvc = document.getElementById('inputFvc');
            this.dom.calculateBtn = document.getElementById('calculateBtn');
            this.dom.clearQuickBtn = document.getElementById('clearQuickBtn');
            this.dom.resultsPanel = document.getElementById('resultsPanel');
            this.dom.resultFev1Liters = document.getElementById('resultFev1Liters');
            this.dom.resultFev1Percent = document.getElementById('resultFev1Percent');
            this.dom.resultFvc = document.getElementById('resultFvc');
            this.dom.resultRatio = document.getElementById('resultRatio');
            this.dom.resultsTimestamp = document.getElementById('resultsTimestamp');
            this.dom.quickPatientBadge = document.getElementById('quickPatientBadge');
            
            // Monitor Mode
            this.dom.modeMonitor = document.getElementById('modeMonitor');
            this.dom.singleEntryCard = document.getElementById('singleEntryCard');
            this.dom.bulkEntryCard = document.getElementById('bulkEntryCard');
            this.dom.spreadsheetCard = document.getElementById('spreadsheetCard');
            this.dom.singleEntryForm = document.getElementById('singleEntryForm');
            this.dom.bulkImportSection = document.getElementById('bulkImportSection');
            this.dom.spreadsheetSection = document.getElementById('spreadsheetSection');
            this.dom.visitDate = document.getElementById('visitDate');
            this.dom.visitFev1 = document.getElementById('visitFev1');
            this.dom.visitFvc = document.getElementById('visitFvc');
            this.dom.addVisitBtn = document.getElementById('addVisitBtn');
            this.dom.bulkImport = document.getElementById('bulkImport');
            this.dom.clearBulkBtn = document.getElementById('clearBulkBtn');
            this.dom.importBulkBtn = document.getElementById('importBulkBtn');
            this.dom.spreadsheetBody = document.getElementById('spreadsheetBody');
            this.dom.visitsTableBody = document.getElementById('visitsTableBody');
            this.dom.calculateBaselineBtn = document.getElementById('calculateBaselineBtn');
            this.dom.baselineReadyBadge = document.getElementById('baselineReadyBadge');
            this.dom.clearMonitorBtn = document.getElementById('clearMonitorBtn');
            this.dom.toggleChartBtn = document.getElementById('toggleChartBtn');
            this.dom.chartSection = document.getElementById('chartSection');
            this.dom.monitorPatientBadge = document.getElementById('monitorPatientBadge');
            
            // Review Mode
            this.dom.modeReview = document.getElementById('modeReview');
            this.dom.reviewTxDays = document.getElementById('reviewTxDays');
            this.dom.reviewVisits = document.getElementById('reviewVisits');
            this.dom.reviewLastFev1 = document.getElementById('reviewLastFev1');
            this.dom.reviewBestFev1 = document.getElementById('reviewBestFev1');
            this.dom.visitsList = document.getElementById('visitsList');
            this.dom.exportReviewBtn = document.getElementById('exportReviewBtn');
            this.dom.newAnalysisBtn = document.getElementById('newAnalysisBtn');
            this.dom.reviewPatientBadge = document.getElementById('reviewPatientBadge');
            
            // Baseline Modal
            this.dom.baselineModal = document.getElementById('baselineModal');
            this.dom.closeBaselineModal = document.getElementById('closeBaselineModal');
            this.dom.stabilityChart = document.getElementById('stabilityChart');
            this.dom.stabilitySummary = document.getElementById('stabilitySummary');
            this.dom.highestValuesList = document.getElementById('highestValuesList');
            this.dom.calculatedBaseline = document.getElementById('calculatedBaseline');
            this.dom.stabilityCriteria = document.getElementById('stabilityCriteria');
            this.dom.stabilityVariation = document.getElementById('stabilityVariation');
            this.dom.stabilityRate = document.getElementById('stabilityRate');
            this.dom.baselineRecommendation = document.getElementById('baselineRecommendation');
            this.dom.cancelBaselineBtn = document.getElementById('cancelBaselineBtn');
            this.dom.acceptBaselineBtn = document.getElementById('acceptBaselineBtn');
            
            // Toast
            this.dom.toastContainer = document.getElementById('toastContainer');
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            if (this.dom.visitDate) this.dom.visitDate.value = today;
            
            return Promise.resolve();
        }
        
        setupEventListeners() {
            // Language Toggle
            this.dom.languageToggle.addEventListener('change', (e) => {
                this.switchLanguage(e.target.checked ? 'es' : 'en');
            });
            
            // Navigation
            this.dom.navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    this.switchMode(mode);
                });
            });
            
            // Quick Mode
            this.dom.calculateBtn.addEventListener('click', () => this.calculateQuick());
            this.dom.clearQuickBtn.addEventListener('click', () => this.clearQuick());
            this.dom.inputFev1.addEventListener('input', () => this.handleQuickInput());
            this.dom.inputFvc.addEventListener('input', () => this.handleQuickInput());
            
            // Monitor Mode - Entry Mode Switching
            this.dom.singleEntryCard.addEventListener('click', () => this.switchEntryMode('single'));
            this.dom.bulkEntryCard.addEventListener('click', () => this.switchEntryMode('bulk'));
            this.dom.spreadsheetCard.addEventListener('click', () => this.switchEntryMode('spreadsheet'));
            
            // Monitor Mode - Actions
            this.dom.addVisitBtn.addEventListener('click', () => this.addVisit());
            this.dom.clearBulkBtn.addEventListener('click', () => this.clearBulk());
            this.dom.importBulkBtn.addEventListener('click', () => this.importBulk());
            this.dom.calculateBaselineBtn.addEventListener('click', () => this.calculateBaseline());
            this.dom.baselineReadyBadge.addEventListener('click', () => this.calculateBaseline());
            this.dom.clearMonitorBtn.addEventListener('click', () => this.clearMonitor());
            this.dom.toggleChartBtn.addEventListener('click', () => this.toggleChart());
            
            // Review Mode
            this.dom.newAnalysisBtn.addEventListener('click', () => this.switchMode('quick'));
            
            // Baseline Modal
            this.dom.closeBaselineModal.addEventListener('click', () => this.hideModal('baselineModal'));
            this.dom.cancelBaselineBtn.addEventListener('click', () => this.hideModal('baselineModal'));
            this.dom.acceptBaselineBtn.addEventListener('click', () => this.acceptBaseline());
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && this.state.mode === 'monitor') {
                    if (this.state.session.monitor.entryMode === 'single') {
                        this.addVisit();
                    }
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (this.state.mode === 'quick') {
                        this.calculateQuick();
                    }
                }
            });
        }
        
        initCharts() {
            // Main FEV1 Chart
            const ctx = document.getElementById('fev1Chart')?.getContext('2d');
            if (ctx) {
                this.state.session.monitor.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'FEV‚ÇÅ',
                            data: [],
                            borderColor: '#57C5B6',
                            backgroundColor: 'rgba(87, 197, 182, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#57C5B6',
                            pointBorderColor: '#FFFFFF',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { callback: value => value + ' L' }
                            }
                        }
                    }
                });
            }
            
            // Stability Chart in Modal
            const stabilityCtx = this.dom.stabilityChart?.getContext('2d');
            if (stabilityCtx) {
                this.state.session.monitor.stabilityChart = new Chart(stabilityCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'FEV‚ÇÅ',
                                data: [],
                                borderColor: '#57C5B6',
                                backgroundColor: 'rgba(87, 197, 182, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                pointBackgroundColor: '#57C5B6',
                                pointBorderColor: '#FFFFFF',
                                pointBorderWidth: 1,
                                pointRadius: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            }
        }
        
        loadState() {
            try {
                const saved = localStorage.getItem('spirolite_v2');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.language) {
                        this.state.language = data.language;
                        this.dom.languageToggle.checked = data.language === 'es';
                        this.switchLanguage(data.language);
                    }
                    if (data.patients) {
                        data.patients.forEach(p => this.state.patients.set(p.id, p));
                    }
                    if (data.currentPatient) {
                        this.state.currentPatient = data.currentPatient;
                        this.updatePatientContext();
                    }
                }
            } catch (e) {
                console.log('Starting fresh');
            }
        }
        
        saveState() {
            const data = {
                language: this.state.language,
                patients: Array.from(this.state.patients.values()),
                currentPatient: this.state.currentPatient,
                version: '2.0'
            };
            localStorage.setItem('spirolite_v2', JSON.stringify(data));
        }
        
        switchLanguage(lang) {
            this.state.language = lang;
            document.documentElement.lang = lang;
            
            // Update all text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (this.translations[lang] && this.translations[lang][key]) {
                    el.textContent = this.translations[lang][key];
                }
            });
            
            // Update placeholders
            const placeholders = {
                'FVC (L)': lang === 'en' ? 'FVC (L) (optional)' : 'FVC (L) (opcional)'
            };
            
            Object.entries(placeholders).forEach(([selector, text]) => {
                const el = document.querySelector(`[placeholder="${selector}"]`);
                if (el) el.placeholder = text;
            });
            
            this.saveState();
            this.showToast(lang === 'en' ? 'Switched to English' : 'Cambiado a Espa√±ol', 'info');
        }
        
        switchMode(mode) {
            this.state.mode = mode;
            
            // Update navigation
            this.dom.navBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Update sections
            ['quick', 'monitor', 'review'].forEach(m => {
                const el = document.getElementById(`mode${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if (el) el.classList.toggle('active', m === mode);
            });
            
            // Update patient badges
            const patientBadges = [this.dom.quickPatientBadge, this.dom.monitorPatientBadge, this.dom.reviewPatientBadge];
            patientBadges.forEach(badge => {
                if (badge) badge.textContent = this.state.currentPatient || '--';
            });
            
            // Update content based on mode
            if (mode === 'review') {
                this.updateReviewMode();
            }
        }
        
        switchEntryMode(mode) {
            this.state.session.monitor.entryMode = mode;
            
            // Update UI
            ['single', 'bulk', 'spreadsheet'].forEach(m => {
                const card = document.getElementById(`${m}EntryCard`);
                const section = document.getElementById(`${m}EntryForm`) || 
                               document.getElementById(`${m}ImportSection`) || 
                               document.getElementById(`${m}Section`);
                
                if (card) card.classList.toggle('active', m === mode);
                if (section) section.style.display = m === mode ? 'block' : 'none';
            });
        }
        
        calculateQuick() {
            const fev1 = parseFloat(this.dom.inputFev1.value);
            const fvc = this.dom.inputFvc.value ? parseFloat(this.dom.inputFvc.value) : null;
            
            if (!fev1 || isNaN(fev1)) {
                this.showToast(this.state.language === 'en' ? 'Please enter FEV‚ÇÅ' : 'Ingrese FEV‚ÇÅ', 'error');
                return;
            }
            
            // Update results
            this.dom.resultFev1Liters.textContent = fev1.toFixed(2);
            this.dom.resultFvc.textContent = fvc ? fvc.toFixed(2) : '--';
            
            if (fvc && fvc > 0) {
                const ratio = (fev1 / fvc * 100).toFixed(1);
                this.dom.resultRatio.textContent = ratio + '%';
            } else {
                this.dom.resultRatio.textContent = '--';
            }
            
            // Update timestamp
            const now = new Date();
            this.dom.resultsTimestamp.textContent = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            this.dom.resultsPanel.style.display = 'block';
            
            this.showToast(this.state.language === 'en' ? 'Calculation complete' : 'C√°lculo completo', 'success');
        }
        
        clearQuick() {
            this.dom.inputFev1.value = '';
            this.dom.inputFvc.value = '';
            this.dom.resultsPanel.style.display = 'none';
        }
        
        handleQuickInput() {
            // Auto-calculate if both fields are filled
            const fev1 = this.dom.inputFev1.value;
            const fvc = this.dom.inputFvc.value;
            
            if (fev1 && fvc) {
                setTimeout(() => this.calculateQuick(), 300);
            }
        }
        
        async addVisit() {
            const date = this.dom.visitDate.value;
            const fev1 = parseFloat(this.dom.visitFev1.value);
            
            if (!date || !fev1 || isNaN(fev1)) {
                this.showToast(this.state.language === 'en' ? 'Please enter date and FEV‚ÇÅ' : 'Ingrese fecha y FEV‚ÇÅ', 'error');
                return;
            }
            
            // Create or get patient
            if (!this.state.currentPatient) {
                this.state.currentPatient = 'PT001';
                this.state.patients.set('PT001', {
                    id: 'PT001',
                    visits: [],
                    baseline: null,
                    createdAt: new Date().toISOString()
                });
                this.updatePatientContext();
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            const visit = {
                date,
                fev1,
                fvc: this.dom.visitFvc.value ? parseFloat(this.dom.visitFvc.value) : null,
                recordedAt: new Date().toISOString()
            };
            
            patient.visits.push(visit);
            patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Update UI
            this.updateVisitsTable();
            this.updateCalculateButton();
            this.updateChart();
            
            // Clear form
            this.dom.visitFev1.value = '';
            this.dom.visitFvc.value = '';
            
            this.showToast(this.state.language === 'en' ? 'Visit added' : 'Visita agregada', 'success');
            this.saveState();
        }
        
        clearBulk() {
            this.dom.bulkImport.value = '';
        }
        
        async importBulk() {
            const text = this.dom.bulkImport.value.trim();
            if (!text) {
                this.showToast(this.state.language === 'en' ? 'Please enter data' : 'Ingrese datos', 'error');
                return;
            }
            
            const lines = text.split('\n');
            let imported = 0;
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;
                
                const parts = trimmed.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    const date = parts[0];
                    const fev1 = parseFloat(parts[1]);
                    const fvc = parts.length > 2 ? parseFloat(parts[2]) : null;
                    
                    if (date && fev1 && !isNaN(fev1)) {
                        // Add visit
                        if (!this.state.currentPatient) {
                            this.state.currentPatient = 'PT001';
                            this.state.patients.set('PT001', {
                                id: 'PT001',
                                visits: [],
                                baseline: null,
                                createdAt: new Date().toISOString()
                            });
                        }
                        
                        const patient = this.state.patients.get(this.state.currentPatient);
                        patient.visits.push({
                            date,
                            fev1,
                            fvc,
                            recordedAt: new Date().toISOString()
                        });
                        imported++;
                    }
                }
            }
            
            if (imported > 0) {
                const patient = this.state.patients.get(this.state.currentPatient);
                patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                this.updateVisitsTable();
                this.updateCalculateButton();
                this.updateChart();
                this.clearBulk();
                
                this.showToast(
                    this.state.language === 'en' 
                        ? `Imported ${imported} visits` 
                        : `${imported} visitas importadas`, 
                    'success'
                );
                this.saveState();
            }
        }
        
        updateVisitsTable() {
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient || patient.visits.length === 0) {
                this.dom.visitsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: var(--space-6); text-align: center; color: var(--text-tertiary);">
                            ${this.state.language === 'en' ? 'No visits yet' : 'No hay visitas a√∫n'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            let previousFev1 = null;
            
            patient.visits.forEach((visit, index) => {
                const date = new Date(visit.date);
                const formattedDate = date.toLocaleDateString();
                
                // Calculate metrics
                const baselinePercent = patient.baseline ? ((visit.fev1 / patient.baseline) * 100).toFixed(1) : '--';
                const visitDelta = previousFev1 !== null ? (visit.fev1 - previousFev1).toFixed(2) : '--';
                const baselineDelta = patient.baseline ? (visit.fev1 - patient.baseline).toFixed(2) : '--';
                
                // Calculate monthly rate if possible
                let rate = '--';
                if (index > 0) {
                    const prevVisit = patient.visits[index - 1];
                    const prevDate = new Date(prevVisit.date);
                    const months = (date - prevDate) / (1000 * 60 * 60 * 24 * 30.44);
                    if (months > 0) {
                        rate = ((visit.fev1 - prevVisit.fev1) / months).toFixed(3);
                    }
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--glass-border);">
                        <td style="padding: var(--space-2);">${formattedDate}</td>
                        <td style="padding: var(--space-2); font-family: var(--font-family-mono);">${visit.fev1.toFixed(2)}</td>
                        <td style="padding: var(--space-2); font-family: var(--font-family-mono);">${baselinePercent}%</td>
                        <td style="padding: var(--space-2); font-family: var(--font-family-mono); ${visitDelta >= 0 ? 'color: var(--success);' : 'color: var(--alert);'}">${visitDelta}</td>
                        <td style="padding: var(--space-2); font-family: var(--font-family-mono);">${baselineDelta}</td>
                        <td style="padding: var(--space-2); font-family: var(--font-family-mono);">${rate}</td>
                    </tr>
                `;
                
                previousFev1 = visit.fev1;
            });
            
            this.dom.visitsTableBody.innerHTML = html;
        }
        
        updateCalculateButton() {
            const patient = this.state.patients.get(this.state.currentPatient);
            const hasEnoughVisits = patient && patient.visits.length >= this.state.protocol.stabilityVisits;
            
            this.dom.calculateBaselineBtn.disabled = !hasEnoughVisits;
            this.dom.calculateBaselineBtn.title = hasEnoughVisits 
                ? (this.state.language === 'en' ? 'Calculate baseline' : 'Calcular base')
                : (this.state.language === 'en' ? `Need ${this.state.protocol.stabilityVisits} visits` : `Necesita ${this.state.protocol.stabilityVisits} visitas`);
            
            // Show baseline ready badge if stable
            if (hasEnoughVisits) {
                const stability = this.checkStability(patient.visits);
                if (stability.stable) {
                    this.dom.baselineReadyBadge.classList.remove('hidden');
                } else {
                    this.dom.baselineReadyBadge.classList.add('hidden');
                }
            } else {
                this.dom.baselineReadyBadge.classList.add('hidden');
            }
        }
        
        checkStability(visits) {
            if (visits.length < this.state.protocol.stabilityVisits) {
                return { stable: false, variation: null };
            }
            
            const lastVisits = visits.slice(-this.state.protocol.stabilityVisits);
            const fev1Values = lastVisits.map(v => v.fev1);
            
            const max = Math.max(...fev1Values);
            const min = Math.min(...fev1Values);
            const avg = fev1Values.reduce((a, b) => a + b) / fev1Values.length;
            const variation = ((max - min) / avg) * 100;
            
            return {
                stable: variation <= this.state.protocol.stabilityThreshold,
                variation: variation.toFixed(1),
                visits: lastVisits,
                values: fev1Values
            };
        }
        
        calculateBaseline() {
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient || patient.visits.length < this.state.protocol.stabilityVisits) {
                this.showToast(
                    this.state.language === 'en' 
                        ? `Need ${this.state.protocol.stabilityVisits} visits` 
                        : `Necesita ${this.state.protocol.stabilityVisits} visitas`,
                    'error'
                );
                return;
            }
            
            const stability = this.checkStability(patient.visits);
            if (!stability.stable) {
                this.showToast(
                    this.state.language === 'en' 
                        ? 'Not enough stable visits' 
                        : 'No hay suficientes visitas estables',
                    'error'
                );
                return;
            }
            
            // Get highest 2 values
            const sortedValues = [...stability.values].sort((a, b) => b - a);
            const topValues = sortedValues.slice(0, 2);
            const suggestedBaseline = topValues.reduce((a, b) => a + b) / topValues.length;
            
            // Update modal
            this.dom.highestValuesList.innerHTML = topValues.map((v, i) => 
                `<div>${i + 1}. ${v.toFixed(2)} L</div>`
            ).join('');
            
            this.dom.calculatedBaseline.value = suggestedBaseline.toFixed(2);
            
            // Update stability chart
            this.updateStabilityChart(stability.visits, stability);
            
            // Update stability analysis
            const firstDate = new Date(stability.visits[0].date);
            const lastDate = new Date(stability.visits[stability.visits.length - 1].date);
            const days = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
            
            this.dom.stabilityCriteria.innerHTML = this.state.language === 'en'
                ? `‚úì ${stability.visits.length} visits over ${days} days`
                : `‚úì ${stability.visits.length} visitas en ${days} d√≠as`;
            
            this.dom.stabilityVariation.innerHTML = this.state.language === 'en'
                ? `üìä Variation: ${stability.variation}% (threshold: ‚â§${this.state.protocol.stabilityThreshold}%)`
                : `üìä Variaci√≥n: ${stability.variation}% (umbral: ‚â§${this.state.protocol.stabilityThreshold}%)`;
            
            this.dom.baselineRecommendation.innerHTML = this.state.language === 'en'
                ? `üí° Average of 2 highest values: ${suggestedBaseline.toFixed(2)} L`
                : `üí° Promedio de 2 valores m√°s altos: ${suggestedBaseline.toFixed(2)} L`;
            
            this.dom.stabilitySummary.textContent = this.state.language === 'en'
                ? `Stable period: ${stability.visits.length} visits with ¬±${stability.variation}% variation`
                : `Per√≠odo estable: ${stability.visits.length} visitas con ¬±${stability.variation}% variaci√≥n`;
            
            this.showModal('baselineModal');
        }
        
        updateStabilityChart(visits, stability) {
            const chart = this.state.session.monitor.stabilityChart;
            if (!chart) return;
            
            const labels = visits.map((v, i) => `Visit ${i + 1}`);
            const data = visits.map(v => v.fev1);
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            
            // Add stabilization zone
            const avg = data.reduce((a, b) => a + b) / data.length;
            const variation = parseFloat(stability.variation) / 100;
            
            // Clear previous datasets except the first one
            chart.data.datasets = [chart.data.datasets[0]];
            
            // Add upper bound
            chart.data.datasets.push({
                label: 'Upper Bound',
                data: data.map(() => avg * (1 + variation)),
                borderColor: 'transparent',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                borderWidth: 0,
                fill: '-1'
            });
            
            // Add lower bound
            chart.data.datasets.push({
                label: 'Lower Bound',
                data: data.map(() => avg * (1 - variation)),
                borderColor: 'transparent',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                borderWidth: 0,
                fill: '-2'
            });
            
            chart.update();
        }
        
        acceptBaseline() {
            const baselineValue = parseFloat(this.dom.calculatedBaseline.value);
            
            if (!baselineValue || isNaN(baselineValue)) {
                this.showToast(
                    this.state.language === 'en' ? 'Invalid baseline value' : 'Valor de base inv√°lido',
                    'error'
                );
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            patient.baseline = baselineValue;
            patient.baselineDate = new Date().toISOString();
            
            this.updateVisitsTable();
            this.updateCalculateButton();
            this.hideModal('baselineModal');
            
            this.showToast(
                this.state.language === 'en' 
                    ? `Baseline set to ${baselineValue.toFixed(2)} L` 
                    : `Base establecida en ${baselineValue.toFixed(2)} L`,
                'success'
            );
            this.saveState();
        }
        
        clearMonitor() {
            if (confirm(this.state.language === 'en' ? 'Clear all visits?' : '¬øBorrar todas las visitas?')) {
                const patient = this.state.patients.get(this.state.currentPatient);
                if (patient) {
                    patient.visits = [];
                    this.updateVisitsTable();
                    this.updateCalculateButton();
                    this.updateChart();
                    this.showToast(
                        this.state.language === 'en' ? 'Visits cleared' : 'Visitas borradas',
                        'success'
                    );
                    this.saveState();
                }
            }
        }
        
        toggleChart() {
            const isVisible = this.dom.chartSection.style.display !== 'none';
            this.dom.chartSection.style.display = isVisible ? 'none' : 'block';
            this.dom.toggleChartBtn.innerHTML = isVisible 
                ? 'üìà ' + (this.state.language === 'en' ? 'Show Chart' : 'Mostrar Gr√°fico')
                : 'üìâ ' + (this.state.language === 'en' ? 'Hide Chart' : 'Ocultar Gr√°fico');
            
            if (!isVisible) {
                this.updateChart();
            }
        }
        
        updateChart() {
            const chart = this.state.session.monitor.chart;
            const patient = this.state.patients.get(this.state.currentPatient);
            
            if (!chart || !patient || patient.visits.length === 0) return;
            
            const sortedVisits = [...patient.visits].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            chart.data.labels = sortedVisits.map(v => {
                const date = new Date(v.date);
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            });
            
            chart.data.datasets[0].data = sortedVisits.map(v => v.fev1);
            
            // Add stabilization zone if baseline exists and stable period detected
            if (patient.baseline) {
                const stability = this.checkStability(patient.visits);
                if (stability.stable) {
                    // Clear previous stabilization datasets
                    chart.data.datasets = chart.data.datasets.filter(ds => !ds.label.includes('Stable Zone'));
                    
                    // Find indices of stable visits
                    const stableIndices = [];
                    sortedVisits.forEach((visit, index) => {
                        if (stability.visits.some(v => v.date === visit.date)) {
                            stableIndices.push(index);
                        }
                    });
                    
                    if (stableIndices.length > 0) {
                        const startIndex = Math.min(...stableIndices);
                        const endIndex = Math.max(...stableIndices);
                        
                        // Create data for stable zone
                        const stableZoneData = sortedVisits.map((visit, index) => {
                            return index >= startIndex && index <= endIndex ? visit.fev1 : null;
                        });
                        
                        chart.data.datasets.push({
                            label: 'Stable Zone',
                            data: stableZoneData,
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(5, 150, 105, 0.15)',
                            borderWidth: 0,
                            fill: true,
                            pointRadius: 0
                        });
                    }
                }
            }
            
            chart.update();
        }
        
        updateReviewMode() {
            const patient = this.state.patients.get(this.state.currentPatient);
            
            if (!patient || patient.visits.length === 0) {
                this.dom.reviewTxDays.textContent = '--';
                this.dom.reviewVisits.textContent = '--';
                this.dom.reviewLastFev1.textContent = '--';
                this.dom.reviewBestFev1.textContent = '--';
                return;
            }
            
            // Calculate metrics
            this.dom.reviewVisits.textContent = patient.visits.length;
            
            const lastVisit = patient.visits[patient.visits.length - 1];
            this.dom.reviewLastFev1.textContent = lastVisit.fev1.toFixed(2);
            
            const bestFev1 = Math.max(...patient.visits.map(v => v.fev1));
            this.dom.reviewBestFev1.textContent = bestFev1.toFixed(2);
            
            // Update visits list
            let visitsHtml = '';
            patient.visits.forEach(visit => {
                const date = new Date(visit.date);
                visitsHtml += `
                    <div class="glass-panel" style="padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-family: var(--font-family-mono); font-weight: 500; color: var(--text-primary);">${date.toLocaleDateString()}</div>
                            ${patient.baseline ? `<div style="font-size: 0.75rem; color: var(--text-tertiary);">${((visit.fev1 / patient.baseline) * 100).toFixed(1)}% of baseline</div>` : ''}
                        </div>
                        <div style="font-family: var(--font-family-mono); font-weight: 600; color: var(--primary-blue);">${visit.fev1.toFixed(2)} L</div>
                    </div>
                `;
            });
            
            this.dom.visitsList.innerHTML = visitsHtml;
        }
        
        updatePatientContext() {
            const patientBadges = [this.dom.quickPatientBadge, this.dom.monitorPatientBadge, this.dom.reviewPatientBadge];
            patientBadges.forEach(badge => {
                if (badge) badge.textContent = this.state.currentPatient || '--';
            });
        }
        
        showModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.add('active');
        }
        
        hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('active');
        }
        
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="font-size: 1rem; margin-right: var(--space-2);">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ÑπÔ∏è'}</div>
                <div style="flex: 1;">
                    <div style="font-size: 0.8125rem; font-weight: 600; color: var(--text-primary);">${type.toUpperCase()}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${message}</div>
                </div>
            `;
            
            this.dom.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        updateUI() {
            // Set today's date in date inputs
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // Initialize language
            this.switchLanguage(this.state.language);
            
            // Focus first input
            setTimeout(() => {
                if (this.dom.inputFev1) {
                    this.dom.inputFev1.focus();
                }
            }, 100);
        }
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
        window.app = new SpiroliteApp();
    });
    </script>
</body>
</html>
